Chapter 1.The__PythonData__ModelA__NOTEFOR__EARLYRELEASE__READERSWith__EarlyRelease__ebooks,you__getbooks__intheir__earliestform__theauthor__sraw__andunedited__contentas__theywrite__soyou__cantake__advantageof__thesetechnologies__longbefore__theofficial__releaseof__these titles.This__willbe__the 1stchapter__ofthe__final book.Please__notethat__theGitHub__repowill__bemade__activelater__on.If__youhave__commentsabout__howwe__mightimprove__thecontent__and/orexamples__inthis__book,or__ifyou__noticemissing__materialwithin__this chapter,please__reachout__tothe__authorat__fluentpython2e@ramalho.org.Guido__ssense__ofthe__aestheticsof__languagedesign__is amazing.I__vemet__manyfine__languagedesigners__whocould__buildtheoretically__beautifullanguages__thatno__onewould__ever use,but__Guidois__oneof__thoserare__peoplewho__canbuild__alanguage__thatis__justslightly__lesstheoretically__beautifulbut__therebyis__ajoy__towrite__programs in.Jim__Hugunin,Creator__of Jython,cocreator__of AspectJ,architect__ofthe__.NetDLR__Oneof__thebest__qualitiesof__Pythonis__its consistency.After__workingwith__Pythonfor__a while,you__areable__tostart__making informed,correct__guessesabout__featuresthat__arenew__to you. However,if__youlearned__another object-orientedlanguage__before Python,you__mayfind__itstrange__touse__len(collection)instead__of collection.len().This__apparentoddity__isthe__tipof__aniceberg__that,when__properly understood,is__thekey__toeverything__wecall__Pythonic.The__icebergis__calledthe__PythonData__Model,and__itdescribes__theAPI__thatyou__canuse__tomake__yourown__objectsplay__wellwith__themost__idiomatic 1language__features.You__canthink__ofthe__datamodel__asa__descriptionof__Pythonas__a framework.It__formalizesthe__interfacesof__thebuilding__blocksof__thelanguage__itself,such__as sequences, iterators, functions, coroutines, classes,context__managers,and__so on.When__usinga__framework,we__spenda__lotof__timecoding__methodsthat__arecalled__bythe__framework.The__samehappens__whenwe__leveragethe__PythonData__Model.The__Pythoninterpreter__invokesspecial__methodsto__performbasic__object operations,often__triggeredby__special syntax.The__specialmethod__namesare__alwayswritten__withleading__andtrailing__doubleunderscores__(i.e., __getitem__).For__example,the__syntax obj[key]is__supportedby__the__getitem____special method.In__orderto__evaluate my_collection[key],the__interpretercalls__my_collection.__getitem__(key).The__specialmethod__namesallow__yourobjects__to implement, support,and__interactwith__fundamentallanguage__constructssuch__as: Collections;Attribute__access;Iteration__(includingasynchronous__iterationusing__async for);Operator__overloading;Function__andmethod__invocation;String__representationand__formatting;Asynchronous__programingusing__await;Object__creationand__destruction;Managed__contexts (includingasynchronous__contextmanagers__usingasync__with).MAGIC__ANDDUNDER__Theterm__magicmethod__isslang__forspecial__method,but__howdo__wetalk__abouta__specificmethod__like __getitem__?I__learnedto__say dunder-getitemfrom__authorand__teacherSteve__Holden.Most__experiencedPythonistas__understandthat__shortcut.As__a result,the__specialmethods__arealso__knownas__dunder methods.What__snew__inthis__chapterThis__chapterhad__fewchanges__fromthe__firstedition__becauseit__isan__introductionto__thePython__Data Model,which__isquite__stable.The__mostsignificant__changes are:Special__methodssupporting__asynchronousprogramming__andother__new features,added__tothe__tablesin__Overviewof__SpecialMethods__.Figure__1-2showing__theuse__ofspecial__methodsin__CollectionAPI__,including__the collections.abc.Collectionabstract__baseclass__introducedin__Python 3.6. Also,here__andthroughout__this 2ndedition__Ive__adoptedthe__f-stringsyntax__introducedin__Python 3.6,which__ismore__readableand__convenientthan__theolder__stringformatting__notations:the__str.format()method__andthe__% operator.The__mostcommon__reasonto__use my_fmt.format()is__tobuild__thetemplate__my_fmtat__runtime.That__isa__real need,but__doesnt__happenvery__often.A__PythonicCard__DeckExample__1-1is__very simple,but__itdemonstrates__thepower__ofimplementing__justtwo__special methods,__getitem____and __len__.Example__1-1.A__deckas__asequence__ofplaying__cardsimport__collectionsCard__= collections.namedtuple('Card', ['rank', 'suit'])class__FrenchDeck:ranks__= [str(n)for__nin__range(2, 11)] + list('JQKA')suits__= 'spadesdiamonds__clubs hearts'.split()def____init__(self): self._cards = [Card(rank, suit)for__suitin__self.suitsfor__rankin__self.ranks]def____len__(self):return__len(self._cards)def____getitem__(self, position):return__self._cards[position]The__firstthing__tonote__isthe__useof__collections.namedtupleto__constructa__simpleclass__torepresent__individual cards.Since__Python 2.6,we__canuse__namedtupleto__buildclasses__ofobjects__thatare__justbundles__ofattributes__withno__custom methods,like__adatabase__record.In__the example,we__useit__toprovide__anice__representationfor__thecards__inthe__deck,as__shownin__theconsole__session: >>>beer_card__= Card('7', 'diamonds') >>>beer_card__Card(rank='7', suit='diamonds')But__thepoint__ofthis__exampleis__theFrenchDeck__class.It__s short,but__itpacks__a punch. First,like__anystandard__Python collection,a__deckresponds__tothe__len()function__byreturning__thenumber__ofcards__in it: >>>deck__= FrenchDeck() >>> len(deck) 52Reading__specificcards__fromthe__deck say,the__firstor__thelast__shouldbe__aseasy__as deck[0]or__deck[-1],and__thisis__whatthe____getitem__method__provides: >>> deck[0] Card(rank='2', suit='spades') >>> deck[-1] Card(rank='A', suit='hearts')Should__wecreate__amethod__topick__arandom__card?No__need.Python__alreadyhas__afunction__toget__arandom__itemfrom__a sequence: random.choice.We__canjust__useit__ona__deck instance: >>>from__randomimport__choice >>> choice(deck) Card(rank='3', suit='hearts') >>> choice(deck) Card(rank='K', suit='spades') >>> choice(deck) Card(rank='2', suit='clubs')We__vejust__seentwo__advantagesof__usingspecial__methodsto__leveragethe__PythonData__Model:Users__ofyour__classesdon__thave__tomemorize__arbitrarymethod__namesfor__standardoperations__(How__toget__thenumber__of items?Is__it .size(), .length(),or__what? ).It__seasier__tobenefit__fromthe__richPython__standardlibrary__andavoid__reinventingthe__wheel,like__the random.choice function.But__itgets__better.Because__our__getitem____delegatesto__the []operator__of self._cards,our__deckautomatically__supports slicing.Here__show__welook__atthe__topthree__cardsfrom__abrand__new deck,and__thenpick__justthe__Acesby__startingat__index 12and__skipping 13cards__ata__time: >>> deck[:3] [Card(rank='2', suit='spades'), Card(rank='3', suit='spades'), Card(rank='4', suit='spades')] >>> deck[12::13] [Card(rank='A', suit='spades'), Card(rank='A', suit='diamonds'), Card(rank='A', suit='clubs'), Card(rank='A', suit='hearts')]Just__byimplementing__the__getitem____special method,our__deckis__also iterable: >>>for__cardin__deck: # doctest: +ELLIPSIS ... print(card) Card(rank='2', suit='spades') Card(rank='3', suit='spades') Card(rank='4', suit='spades') ...The__deckcan__alsobe__iteratedin__reverse: >>>for__cardin__reversed(deck): # doctest: +ELLIPSIS ... print(card) Card(rank='A', suit='hearts') Card(rank='K', suit='hearts') Card(rank='Q', suit='hearts') ...ELLIPSIS__INDOCTESTS__Whenever possible,the__Pythonconsole__listingsin__thisbook__wereextracted__fromdoctests__toensure__accuracy.When__theoutput__wastoo__long,the__elidedpart__ismarked__byan__ellipsis (...)like__inthe__lastline__inthe__preceding code.In__such cases,we__usedthe__# doctest: +ELLIPSISdirective__tomake__thedoctest__pass.If__youare__tryingthese__examplesin__theinteractive__console,you__mayomit__thedoctest__directives altogether.Iteration__isoften__implicit.If__acollection__hasno____contains__ method,the__inoperator__doesa__sequential scan.Case__in point:in__workswith__ourFrenchDeck__classbecause__itis__iterable.Check__it out: >>> Card('Q', 'hearts')in__deckTrue__>>> Card('7', 'beasts')in__deckFalse__Howabout__sorting?A__commonsystem__ofranking__cardsis__byrank__(withaces__being highest),then__bysuit__inthe__orderof__spades (highest),then__hearts, diamonds,and__clubs (lowest).Here__isa__functionthat__rankscards__bythat__rule,returning__0for__the 2of__clubsand__51for__theace__of spades:suit_values__= dict(spades=3, hearts=2, diamonds=1, clubs=0)def__spades_high(card):rank_value__= FrenchDeck.ranks.index(card.rank)return__rank_value * len(suit_values) + suit_values[card.suit]Given__spades_high,we__cannow__listour__deckin__orderof__increasing rank: >>>for__cardin__sorted(deck, key=spades_high): # doctest: +ELLIPSIS ... print(card) Card(rank='2', suit='clubs') Card(rank='2', suit='diamonds') Card(rank='2', suit='hearts') ... (46cards__omitted) Card(rank='A', suit='diamonds') Card(rank='A', suit='hearts') Card(rank='A', suit='spades')Although__FrenchDeckimplicitly__inheritsfrom__object,its__functionalityis__not inherited,but__comesfrom__leveragingthe__datamodel__and composition.By__implementingthe__specialmethods____len__and____getitem__,our__FrenchDeckbehaves__likea__standardPython__sequence,allowing__itto__benefitfrom__corelanguage__features (e.g.,iteration__and slicing)and__fromthe__standard library,as__shownby__theexamples__using random.choice, reversed,and__sorted.Thanks__to composition,the____len__and____getitem__implementations__candelegate__allthe__workto__alist__object, self._cards.HOW__ABOUT SHUFFLING?As__implementedso__far,a__FrenchDeckcannot__be shuffled,because__itis__immutable:the__cardsand__theirpositions__cannotbe__changed,except__byviolating__encapsulationand__handlingthe___cardsattribute__directly.In__[Linkto__Come],we__willfix__thatby__addinga__one-line__setitem____method.How__SpecialMethods__AreUsed__Thefirst__thingto__knowabout__specialmethods__isthat__theyare__meantto__becalled__bythe__Python interpreter,and__notby__you.You__dont__write my_object.__len__().You__write len(my_object) and,if__my_objectis__aninstance__ofa__user-defined class,then__Pythoncalls__the__len____methodyou__implemented.But__theinterpreter__takesa__shortcutwhen__dealingfor__built-intypes__like list, str, bytearray,or__extensionslike__theNumPy__arrays.Python__variable-sizedcollections__writtenin__Cinclude__astruct__called PyVarObject,which__hasan__ob_sizefield__holdingthe__numberof__itemsin__the collection. So,if__my_objectis__aninstance__ofone__ofthose__built-ins,then__len(my_object)retrieves__thevalue__ofthe__ob_size field,and__thisis__muchfaster__thancalling__a method.More__oftenthan__not,the__specialmethod__callis__implicit.For__example,the__statementfor__iin__x:actually__causesthe__invocationof__iter(x),which__inturn__maycall__x.__iter__()if__thatis__available,or__use x.__getitem__()--asin__theFrenchDeck__example. Normally,your__codeshould__nothave__manydirect__callsto__special methods.Unless__youare__doinga__lotof__metaprogramming,you__shouldbe__implementingspecial__methodsmore__oftenthan__invokingthem__explicitly.The__onlyspecial__methodthat__isfrequently__calledby__usercode__directlyis____init__,to__invokethe__initializerof__thesuperclass__inyour__own__init____implementation.If__youneed__toinvoke__aspecial__method,it__isusually__betterto__callthe__related built-infunction__(e.g., len, iter, str, etc).These__built-inscall__thecorresponding__special method,but__oftenprovide__otherservices__andfor__built-intypes__arefaster__thanmethod__calls. See,for__example, [Linkto__Come]in__[Linkto__Come].Avoid__creating arbitrary,custom__attributeswith__the__foo____syntaxbecause__suchnames__mayacquire__specialmeanings__inthe__future,even__ifthey__areunused__today. 2Emulating__NumericTypes__Severalspecial__methodsallow__userobjects__torespond__tooperators__suchas__+.We__willcover__thatin__moredetail__in [Linkto__Come],but__hereour__goalis__tofurther__illustratethe__useof__specialmethods__throughanother__simple example.We__willimplement__aclass__torepresent__two-dimensionalvectors__thatis__Euclideanvectors__likethose__usedin__mathand__physics (seeFigure__1-1).Figure__1-1.Example__of two-dimensionalvector__addition; Vector(2, 4) + Vector(2, 1)results__in Vector(4, 5).TIP__The built-incomplex__typecan__beused__torepresent__two-dimensional vectors,but__ourclass__canbe__extendedto__represent n-dimensional vectors.We__willdo__thatin__[Linkto__Come].We__willstart__bydesigning__theAPI__forsuch__aclass__bywriting__asimulated__consolesession__thatwe__canuse__lateras__a doctest.The__followingsnippet__teststhe__vectoraddition__picturedin__Figure 1-1: >>> v1 = Vector(2, 4) >>> v2 = Vector(2, 1) >>> v1 + v2 Vector(4, 5)Note__howthe__+operator__producesa__Vector result,which__isdisplayed__ina__friendlymanner__inthe__console.The__abs built-infunction__returnsthe__absolutevalue__ofintegers__and floats,and__themagnitude__ofcomplex__numbers,so__tobe__consistent,our__APIalso__usesabs__tocalculate__themagnitude__ofa__vector: >>>v__= Vector(3, 4) >>> abs(v) 5.0We__canalso__implementthe__*operator__toperform__scalarmultiplication__(i.e.,multiplying__avector__bya__numberto__producea__newvector__withthe__samedirection__anda__multiplied magnitude): >>>v__* 3 Vector(9, 12) >>> abs(v * 3) 15.0Example__1-2is__aVector__classimplementing__theoperations__just described,through__theuse__ofthe__specialmethods____repr__, __abs__,__add____and __mul__.Example__1-2.A__simple two-dimensionalvector__classimport__mathclass__Vector:def____init__(self, x=0, y=0): self.x =x__self.y =y__def __repr__(self):return__f'Vector({self.x!r}, {self.y!r})'def____abs__(self):return__math.hypot(self.x, self.y)def____bool__(self):return__bool(abs(self))def____add__(self, other):x__= self.x + other.xy__= self.y + other.yreturn__Vector(x, y)def____mul__(self, scalar):return__Vector(self.x * scalar, self.y * scalar)We__implementedsix__special methods,but__notethat__noneof__themis__directlycalled__withinthe__classor__inthe__typicalusage__ofthe__classillustrated__bythe__console listings.As__mentioned before,the__Pythoninterpreter__isthe__onlyfrequent__callerof__mostspecial__methods.In__thefollowing__sections,we__discussthe__codefor__thespecial__methodsin__Vector.String__RepresentationThe____repr__special__methodis__calledby__therepr__built-into__getthe__stringrepresentation__ofthe__objectfor__inspection.If__wedid__notimplement____repr__,vector__instanceswould__beshown__inthe__consolelike__.The__interactiveconsole__anddebugger__callrepr__onthe__resultsof__theexpressions__evaluated,as__doesthe__%rplaceholder__inclassic__formattingwith__the % operator,and__the !rconversion__fieldin__thenew__FormatString__Syntaxused__in f-stringsthe__str.format method.Note__thatthe__f-stringin__our __repr__,uses__!rto__getthe__standardrepresentation__ofthe__attributesto__be displayed.This__isgood__practice,because__itshows__thecrucial__differencebetween__Vector(1, 2)and__Vector('1', '2')the__latterwould__notwork__inthe__contextof__this example,because__theconstructor__sarguments__shouldbe__numbers,not__str.The__stringreturned__by__repr____shouldbe__unambiguous and,if__possible,match__thesource__codenecessary__to re-createthe__represented object.That__iswhy__ourVector__representationlooks__likecalling__theconstructor__ofthe__class (e.g., Vector(3, 4)).Contrast____repr__with____str__,which__iscalled__bythe__str()constructor__andimplicitly__usedby__theprint__function.__str____shouldreturn__astring__suitablefor__displayto__end users.If__youonly__implementone__ofthese__special methods,choose____repr__,because__whenno__custom__str____is available,the____str__method__inheritedfrom__theobject__classcalls____repr__as__a fallback.TIP__Differencebetween____str__and____repr__in__Pythonis__aStack__Overflowquestion__withexcellent__contributionsfrom__PythonistasAlex__Martelliand__Martijn Pieters.Arithmetic__OperatorsExample__1-2implements__two operators: +and__*,to__showbasic__usageof____add__and____mul__.Note__thatin__both cases,the__methodscreate__andreturn__anew__instanceof__Vector,and__donot__modifyeither__operandself__orother__aremerely__read.This__isthe__expectedbehavior__ofinfix__operators:to__createnew__objectsand__nottouch__their operands.I__willhave__alot__moreto__sayabout__thatin__[Linkto__Come].WARNING__As implemented,Example__1-2allows__multiplyinga__Vectorby__a number,but__nota__numberby__a Vector,which__violatesthe__commutativeproperty__ofscalar__multiplication.We__willfix__thatwith__thespecial__method__rmul____in [Linkto__Come].Boolean__Valueof__aCustom__TypeAlthough__Pythonhas__abool__type,it__acceptsany__objectin__aboolean__context,such__asthe__expressioncontrolling__anif__orwhile__statement,or__asoperands__to and, or,and__not.To__determinewhether__avalue__xis__truthyor__falsy,Python__applies bool(x),which__alwaysreturns__Trueor__False.By__default,instances__of user-definedclasses__areconsidered__truthy,unless__either__bool____or__len____is implemented. Basically, bool(x)calls__x.__bool__()and__usesthe__result.If____bool__is__not implemented,Python__triesto__invoke x.__len__(),and__ifthat__returns zero,bool__returns False.Otherwise__boolreturns__True.Our__implementationof____bool__is__conceptually simple:it__returnsFalse__ifthe__magnitudeof__thevector__is zero,True__otherwise.We__convertthe__magnitudeto__aBoolean__using bool(abs(self))because____bool__is__expectedto__returna__boolean.Note__howthe__specialmethod____bool__allows__yourobjects__tobe__consistentwith__thetruth__valuetesting__rulesdefined__inthe__Built-inTypes__chapterof__ThePython__StandardLibrary__documentation.NOTE__Afaster__implementationof__Vector.__bool__is__this:def____bool__(self):return__bool(self.xor__self.y)This__isharder__to read,but__avoidsthe__tripthrough__abs, __abs__,the__squares,and__square root.The__explicitconversion__tobool__isneeded__because__bool____mustreturn__aboolean__andor__returnseither__operandas__is:x__ory__evaluatesto__xif__thatis__truthy,otherwise__theresult__is y,whatever__that is.Collection__APIFigure__1-2documents__theinterfaces__ofthe__essentialcollection__typesin__the language.All__theclasses__inthe__diagramare__ABCsabstract__base classes.ABCs__andthe__collections.abcmodule__arecovered__in [Linkto__Come].The__goalof__thisbrief__sectionis__togive__apanoramic__viewof__Pythons__mostimportant__collection interfaces,showing__howthey__arebuilt__fromspecial__methods.Figure__1-2.UML__classdiagram__withfundamental__collection types.Method__namesin__italicare__abstract,so__theymust__beimplemented__byconcrete__subclassessuch__aslist__and dict.The__remainingmethods__haveconcrete__implementations,therefore__subclassescan__inherit them.Each__ofthe__topABCs__hasa__singlespecial__method.The__CollectionABC__(newin__Python 3.6)unifies__thethree__essentialinterfaces__thatevery__collectionshould__implement:Iterable__tosupport__for,comprehensions__andother__formsof__iteration;Sized__tosupport__thelen__built-in function;Contains__tosupport__thein__operator.Python__doesnot__requireconcrete__classesto__actuallyinherit__fromany__ofthese__ABCs.Any__classthat__implements__len____satisfiesthe__Sized interface.Three__veryimportant__specializationsof__Collection are: Sequence,formalizing__theinterface__of built-inslike__list,and__str; Mapping,implemented__bydict__and collections.defaultdict; Set:the__interfaceof__theset__andfrozenset__built-ins.Only__Sequenceis__Reversible,because__sequencessupport__arbitraryordering__oftheir__contents,while__mappingsand__setsdo__not.NOTE__SincePython__3.7,the__dicttype__isofficially__ordered ,but__thatonly__meansthat__thekey__insertionorder__is preserved.You__cannotrearrange__thekeys__ina__dicthowever__you like.All__butone__ofthe__specialmethods__inthe__SetABC__implementinfix__operators.For__example,a__&b__computesthe__intersectionof__setsa__and b,and__isimplemented__inthe____and__special__method.The__nextthree__chapterswill__cover built-in sequences, mappings,and__setsin__detail.Now__lets__considerhe__majorcategories__ofspecial__methodsdefined__inthe__PythonData__Model.Overview__ofSpecial__MethodsThe__DataModel__chapterof__ThePython__LanguageReference__listsmore__than 80special__method names.More__thanhalf__ofthem__implement arithmetic, bitwise,and__comparison operators.As__anoverview__ofwhat__is available,see__following tables.Table__1-1shows__specialmethod__namesexcluding__thoseused__toimplement__infixoperators__orcore__mathfunctions__like abs.Most__ofthese__methodswill__becovered__indetail__throughoutthe__book,including__themost__recent additions:asynchronous__specialmethods__suchas____anext__ (addedin__Python 3.5),and__theclass__customization hook,__init_subclass____(fromPython__3.6).Table__1-1.Special__methodnames__(operators excluded)Category__Methodnames__String/bytesrepresentation____repr__, __str__, __format__, __bytes__,__fspat__h__Conversion__tonumber____abs__, __bool__, __complex__, __int__,__float____, __hash__,__index____Emulatingcollections____len__, __getitem__, __setitem__, __delitem__,____contains__Iteration____iter__, __aiter__, __next__, __anext__,__rever__sed__Callable__orcoroutine__execution __call__,__await____Contextmanagement____enter__, __aenter__, __exit__,__aexit____Instancecreation__anddestruction____new__, __init__,__del____Attributemanagement____getattr__, __getattribute__, __setattr__,__d__elattr__,__dir____Attributedescriptors____get__, __set__, __delete__,__set_name____Classservices____prepare__, __init_subclass__,__instancechec__k__,__subclasscheck____Infixand__numericaloperators__aresupported__bythe__specialmethods__in 1-2.Here__themost__recentnames__are __matmul__, __rmatmul__,and____imatmul__,added__inPython__3.5to__supportthe__useof__@as__aninfix__operatorfor__matrix multiplication,as__well__seein__[Linkto__Come].Table__1-2.Special__methodnames__foroperators__CategoryMethod__namesand__relatedoperators__Unarynumeric__operators__neg____-,__pos____+,__abs____abs()Rich__comparisonoperators____lt__ <,__le____<=,__eq____==,__ne____!=,__gt____>,__ge____ >=Arithmetic__operators__add____+,__sub____-,__mul____*,__truediv____/,__floord__iv__ //,__mod____%,__divmod____divmod() ,__pow____**or__po w(),__round____round(),__matmul____@Reversed__arithmeticoperators____radd__, __rsub__, __rmul__, __rtruediv__,__rfloord__iv__, __rmod__, __rdivmod__, __rpow__,__rmatmul____Augmentedassignment__arithmeticoperators____iadd__, __isub__, __imul__, __itruediv__,__ifloord__iv__, __imod__, __ipow__,__imatmul____Bitwiseoperators____invert__ ~,__lshift____<<,__rshift____>>,__and____&,__or____|,__xor____^Reversed____rlshift__, __rrshift__, __rand__, __rxor__,__ror____bitwiseoperators__Augmentedassignment__bitwiseoperators____ilshift__, __irshift__, __iand__, __ixor__,__ior____TIPThe__reversedoperators__arefallbacks__usedwhen__operandsare__swapped (b *a__insteadof__a * b),while__augmentedassignments__areshortcuts__combiningan__infixoperator__withvariable__assignment (a =a__*b__becomesa__*= b). [Linkto__Come]explains__bothreversed__operatorsand__augmentedassignment__in detail.Why__lenIs__Nota__MethodI__askedthis__questionto__coredeveloper__RaymondHettinger__in 2013and__thekey__tohis__answerwas__aquote__fromThe__Zenof__Python:practicality__beats purity.In__HowSpecial__MethodsAre__Used ,I__describedhow__len(x)runs__veryfast__whenx__isan__instanceof__a built-in type.No__methodis__calledfor__the built-inobjects__of CPython:the__lengthis__simplyread__froma__fieldin__aC__struct.Getting__thenumber__ofitems__ina__collectionis__acommon__operationand__mustwork__efficientlyfor__suchbasic__anddiverse__typesas__str, list, memoryview,and__so on.In__other words,len__isnot__calledas__amethod__becauseit__getsspecial__treatmentas__partof__thePython__Data Model,just__like abs.But__thanksto__thespecial__method __len__,you__canalso__makelen__workwith__yourown__custom objects.This__isa__faircompromise__betweenthe__needfor__efficient built-inobjects__andthe__consistencyof__the language.Also__fromThe__Zenof__Python:Special__casesaren__tspecial__enoughto__breakthe__rules.NOTE__Ifyou__thinkof__absand__lenas__unary operators,you__maybe__moreinclined__toforgive__theirfunctional__look-and-feel,as__opposedto__themethod__callsyntax__onemight__expectin__anOO__language.In__fact,the__ABClanguage__adirect__ancestorof__Pythonthat__pioneeredmany__ofits__featureshad__an #operator__thatwas__theequivalent__oflen__(youd__write #s).When__usedas__aninfix__operator,written__x#s,it__countedthe__occurrencesof__xin__s,which__inPython__youget__as s.count(x),for__anysequence__s.Chapter__SummaryBy__implementingspecial__methods,your__objectscan__behavelike__the built-in__types,enabling__theexpressive__codingstyle__thecommunity__considers Pythonic.A__basicrequirement__fora__Pythonobject__isto__provideusable__stringrepresentations__of itself,one__usedfor__debuggingand__logging,another__forpresentation__toend__users.That__iswhy__thespecial__methods__repr____and__str____existin__thedata__model.Emulating__sequences,as__shownwith__theFrenchDeck__example,is__oneof__themost__widelyused__applicationsof__thespecial__methods.Making__themost__ofsequence__typesis__thesubject__ofChapter__2,and__implementingyour__ownsequence__willbe__coveredin__[Linkto__Come]when__wecreate__amultidimensional__extensionof__theVector__class.Thanks__tooperator__overloading,Python__offersa__richselection__ofnumeric__types,from__the built-insto__decimal.Decimaland__fractions.Fraction,all__supportinginfix__arithmetic operators.Implementing__operators,including__reversedoperators__andaugmented__assignment,will__beshown__in [Linkto__Come]via__enhancementsof__theVector__example.The__useand__implementationof__themajority__ofthe__remainingspecial__methodsof__thePython__DataModel__arecovered__throughoutthis__book.Further__ReadingThe__DataModel__chapterof__ThePython__LanguageReference__isthe__canonicalsource__forthe__subjectof__thischapter__andmuch__ofthis__book.Python__ina__Nutshell, 3rdEdition__(O Reilly)by__Alex Martelli,Anna__Ravenscroft,and__SteveHolden__hasexcellent__coverageof__thedata__model.Their__descriptionof__themechanics__ofattribute__accessis__themost__authoritativeI__veseen__apartfrom__theactual__Csource__codeof__CPython.Martelli__isalso__aprolific__contributorto__Stack Overflow,with__morethan__6,200answers__posted.See__hisuser__profileat__Stack Overflow.David__Beazleyhas__twobooks__coveringthe__datamodel__indetail__inthe__contextof__Python 3:Python__Essential Reference, 4thEdition__(Addison-Wesley__Professional),and__Python Cookbook, 3rdEdition__(O Reilly),coauthored__withBrian__K. Jones.The__Artof__theMetaobject__Protocol (AMOP,MIT__Press)by__Gregor Kiczales,Jim__des Rivieres,and__Daniel G.Bobrow__explainsthe__conceptof__ametaobject__protocol,of__whichthe__PythonData__Modelis__one example.SOAPBOX__DataModel__orObject__Model?What__thePython__documentationcalls__thePython__Data Model,most__authorswould__sayis__thePython__object model. Martelli,Ravenscroft__&Holden__sPython__ina__Nutshell 3E,and__DavidBeazley__sPython__EssentialReference__4Eare__thebest__bookscovering__thePython__Data Model,but__theyrefer__toit__asthe__object model.On__Wikipedia,the__firstdefinition__ofobject__modelis__Theproperties__ofobjects__ingeneral__ina__specificcomputer__programming language.This__iswhat__thePython__DataModel__is about.In__this book,I__willuse__datamodel__becausethe__documentationfavors__thatterm__whenreferring__tothe__Pythonobject__model,and__becauseit__isthe__titleof__thechapter__ofThe__PythonLanguage__Referencemost__relevantto__our discussions.Magic__MethodsThe__Rubycommunity__callstheir__equivalentof__thespecial__methodsmagic__methods.Many__inthe__Pythoncommunity__adoptthat__termas__well.I__believethe__specialmethods__areactually__theopposite__of magic.Python__andRuby__empowertheir__userswith__arich__metaobjectprotocol__thatis__not magic,enabling__muggleslike__youand__Ito__emulatemany__ofthe__featuresavailable__tocore__developers.In__contrast,consider__Go.Some__objectsin__thatlanguage__havefeatures__thatare__magic,in__thesense__thatwe__cannotemulate__themin__ourown__user-defined types.For__example,Go__arrays, strings,and__mapssupport__theuse__bracketsfor__item access,as__in a[i].But__theres__noway__tomake__the []notation__workwith__anew__collectiontype__thatyou__define.Even__worse,Go__hasno__user-levelconcept__ofan__iterableinterface__oran__iterator object,therefore__its for/rangesyntax__islimited__tosupporting__fivemagic__built-in types,including__arrays,strings__and maps.Maybe__inthe__future,the__designersof__Gowill__enhanceits__metaobject protocol.But__currently,it__ismuch__morelimited__thanwhat__wehave__inPython__or Ruby.Metaobjects__TheArt__ofthe__MetaobjectProtocol__(AMOP)is__myfavorite__computerbook__title.Less__subjectively,the__termmetaobject__protocolis__usefulto__thinkabout__thePython__DataModel__andsimilar__featuresin__other languages.The__metaobjectpart__refersto__theobjects__thatare__thebuilding__blocksof__thelanguage__itself.In__this context,protocol__isa__synonymof__interface.So__ametaobject__protocolis__afancy__synonymfor__object model:an__APIfor__corelanguage__constructs.A__richmetaobject__protocolenables__extendinga__languageto__supportnew__programming paradigms.Gregor__Kiczales,the__firstauthor__ofthe__AMOP book,later__becamea__pioneerin__aspect-orientedprogramming__andthe__initialauthor__of AspectJ,an__extensionof__Javaimplementing__that paradigm. Aspect-orientedprogramming__ismuch__easierto__implementin__adynamic__languagelike__Python,and__severalframeworks__do it,but__themost__importantis__zope.interface,which__isbriefly__discussedin__[Linkto__Come]of__[Linkto__Come]. 1Story__of Jython,written__asa__Forewordto__JythonEssentials__(O Reilly, 2002),by__SamuelePedroni__andNoel__Rappin. 2A__Cstruct__isa__recordtype__withnamed__fields.Part__II.Data__StructuresChapter__2.An__Arrayof__SequencesA__NOTEFOR__EARLYRELEASE__READERSWith__EarlyRelease__ebooks,you__getbooks__intheir__earliestform__theauthor__sraw__andunedited__contentas__theywrite__soyou__cantake__advantageof__thesetechnologies__longbefore__theofficial__releaseof__these titles.This__willbe__the 2ndchapter__ofthe__final book.Please__notethat__theGitHub__repowill__bemade__activelater__on.If__youhave__commentsabout__howwe__mightimprove__thecontent__and/orexamples__inthis__book,or__ifyou__noticemissing__materialwithin__this chapter,please__reachout__tothe__authorat__fluentpython2e@ramalho.org.As__youmay__have noticed,several__ofthe__operationsmentioned__workequally__for texts,lists__and tables. Texts,lists__andtables__togetherare__called trains. [ ]The__FORcommand__alsoworks__genericallyon__trains. Geurts, Meertens,and__Pemberton,ABC__Programmers__HandbookBefore__creating Python,Guido__wasa__contributorto__theABC__languagea__10-yearresearch__projectto__designa__programmingenvironment__for beginners.ABC__introducedmany__ideaswe__nowconsider__Pythonic :generic__operationson__differenttypes__of sequences, built-intuple__andmapping__types,structure__by indentation,strong__typingwithout__variable declarations,and__more.It__sno__accidentthat__Pythonis__so user-friendly.Python__inheritedfrom__ABCthe__uniformhandling__of sequences. Strings, lists,byte__sequences, arrays,XML__elements,and__databaseresults__sharea__richset__ofcommon__operationsincluding__iteration, slicing, sorting,and__concatenation. 1Understanding__thevariety__ofsequences__availablein__Pythonsaves__usfrom__reinventingthe__wheel,and__theircommon__interfaceinspires__usto__createAPIs__thatproperly__supportand__leverageexisting__andfuture__sequence types.Most__ofthe__discussionin__thischapter__appliesto__sequencesin__general,from__thefamiliar__listto__thestr__andbytes__typesthat__arenew__inPython__3.Specific__topicson__lists, tuples, arrays,and__queuesare__alsocovered__here,but__thespecifics__ofUnicode__stringsand__bytesequences__appearin__Chapter 4. Also,the__ideahere__isto__coversequence__typesthat__areready__to use.Creating__yourown__sequencetypes__isthe__subjectof__[Linkto__Come].What__snew__inthis__chapterThe__sequencetypes__area__verystable__partof__Python,therefore__mostthe__changeshere__arenot__updatesbut__improvementsover__the 1edition__ofFluent__Python.The__mostsignificant__are:New__diagramand__descriptionof__theinternals__of sequences,contrasting__containersand__flat sequences.Brief__comparisonof__theperformance__andstorage__characteristicsof__listversus__tuple.Caveats__oftuples__withmutable__elements,and__howto__detectthem__if needed.Coverage__ofnamed__tuplesmoved__toClassic__NamedTuples__inChapter__5,where__theyare__comparedto__thenew__data classes.Overview__of Built-InSequences__stThe__standardlibrary__offersa__richselection__ofsequence__typesimplemented__in C:Container__sequences list, tuple,and__collections.dequecan__holditems__ofdifferent__types,including__nested containers.Flat__sequences str, bytes, bytearray, memoryview,and__array.arrayhold__itemsof__onesimple__type.A__containersequence__holdsreferences__tothe__objectsit__contains,which__maybe__ofany__type,while__aflat__sequencestores__thevalue__ofits__contentsin__itsown__memory space,and__notas__distinct objects.See__Figure 2-1.Figure__2-1.Simplified__memorydiagram__ofa__tupleand__an array,each__holding 3 items.Gray__cellsrepresent__the in-memoryheader__ofeach__Pythonobject__notdrawn__to proportion.The__tuplehas__anarray__ofreferences__toits__contents.Each__itemis__aseparate__Python object,possibly__holdingreferences__toother__Python objects,like__that 2-item list.In__contrast,the__Pythonarray__isa__single object,holding__aC__languagearray__of 3 doubles. Thus,flat__sequencesare__more compact,but__theyare__limitedto__holdingprimitive__machinevalues__like bytes, integers,and__floats.NOTE__EveryPython__objectin__memoryhas__aheader__with metadata.The__simplestPython__object,a__float,has__twometadata__fields.On__a 64-bitPython__build,the__structrepresenting__afloat__hasthese__64-bit fields: * ob_refcnt:the__objects__reference count; * *ob_type:a__pointerto__theobject__s type; * ob_fval:a__Cdouble__holdingthe__valueof__the float.That__swhy__anarray__withof__floatsis__muchmore__compactthan__atuple__of floats:the__arrayis__asingle__objectholding__theraw__valuesof__the floats,while__thetuple__isseveral__objectsthe__tupleitself__andeach__floatobject__containedin__it.Another__wayof__groupingsequence__typesis__by mutability:Mutable__sequences list, bytearray, array.array, collections.deque,and__memoryviewImmutable__sequences tuple, str,and__bytesFigure__2-2helps__visualizehow__mutablesequences__inheritall__methodsfrom__immutable sequences,and__implementseveral__additional methods.The__built-inconcrete__sequencetypes__donot__actuallysubclass__theSequence__andMutableSequence__abstractbase__classes (ABCs),but__theyare__virtualsubclasses__registeredwith__thoseABCs__aswe__llsee__inin__[Linkto__Come].Being__virtual subclasses,tuple__andlist__passthese__tests: >>>from__collectionsimport__abc >>> issubclass(tuple, abc.Sequence)True__>>> issubclass(list, abc.MutableSequence)True__Figure 2-2.Simplified__UMLclass__diagramfor__someclasses__from collections.abc (superclassesare__onthe__left;inheritance__arrowspoint__fromsubclasses__to superclasses;names__initalic__areabstract__classesand__abstract methods)Keep__inmind__thesecommon__traits:mutable__versus immutable;container__versus flat.They__arehelpful__toextrapolate__whatyou__knowabout__onesequence__typeto__others.The__mostfundamental__sequencetype__isthe__list:a__mutable container.I__expectyou__arevery__familiarwith__them,so__well__jumpright__intolist__comprehensions,a__powerfulway__ofbuilding__liststhat__issometimes__underusedbecause__thesyntax__maylook__unusualat__first.Mastering__listcomprehensions__opensthe__doorto__generator expressions,which__amongother__usescan__produceelements__tofill__upsequences__ofany__type.Both__arethe__subjectof__thenext__section.List__Comprehensionsand__GeneratorExpressions__Aquick__wayto__builda__sequenceis__usinga__listcomprehension__(ifthe__targetis__a list)or__agenerator__expression (forall__otherkinds__of sequences).If__youare__notusing__thesesyntactic__formson__adaily__basis,I__betyou__aremissing__opportunitiesto__writecode__thatis__morereadable__andoften__fasterat__thesame__time.If__youdoubt__myclaim__thatthese__constructsare__more readable,read__on.I__lltry__toconvince__you.TIP__For brevity,many__Pythonprogrammers__referto__listcomprehensions__as listcomps,and__generatorexpressions__as genexps.I__willuse__thesewords__as well.List__Comprehensionsand__ReadabilityHere__isa__test:which__doyou__findeasier__to read,Example__2-1or__Example 2-2?Example__2-1.Build__alist__ofUnicode__codepointsfrom__astring__>>>symbols__= '$ ' >>>codes__= [] >>>for__symbolin__symbols: ... codes.append(ord(symbol)) ... >>>codes__[36, 162, 163, 165, 8364, 164]Example__2-2.Build__alist__ofUnicode__codepointsfrom__a string,take__two >>>symbols__= '$ ' >>>codes__= [ord(symbol)for__symbolin__symbols] >>>codes__[36, 162, 163, 165, 8364, 164]Anybody__whoknows__alittle__bitof__Pythoncan__readExample__2-1. However,after__learningabout__listcomps,I__findExample__2-2more__readablebecause__itsintent__is explicit.A__forloop__maybe__usedto__dolots__ofdifferent__things:scanning__asequence__tocount__orpick__items,computing__aggregates (sums, averages),or__anynumber__ofother__processing tasks.The__codein__Example 2-1is__buildingup__a list.In__contrast,a__listcompis__more explicit.Its__goalis__tobuild__anew__list.Of__course,it__ispossible__toabuse__listcomprehensions__towrite__trulyincomprehensible__code.I__veseen__Pythoncode__withlistcomps__usedjust__torepeat__ablock__ofcode__forits__side effects.If__youare__notdoing__somethingwith__theproduced__list,you__shouldnot__usethat__syntax. Also,try__tokeep__it short.If__thelist__comprehensionspans__morethan__two lines,it__isprobably__bestto__breakit__apartor__rewriteas__aplain__oldfor__loop.Use__yourbest__judgment:for__Pythonas__for English,there__areno__hard-and-fastrules__forclear__writing.SYNTAX__TIPIn__Python code,line__breaksare__ignoredinside__pairsof__[], {},or__().So__youcan__buildmultiline__lists, listcomps, genexps,dictionaries__andthe__likewithout__usingthe__ugly \line__continuation escape. Also,when__thosedelimiters__areused__todefine__aliteral__witha__comma-separatedseries__of items,a__trailingcomma__willbe__ignored. So,for__example,when__codinga__multi-linelist__literal,it__isthoughtful__toput__acomma__afterthe__last item,making__ita__littleeasier__forthe__nextcoder__doadd__onemore__itemto__that list.LOCAL__SCOPEWITHIN__COMPREHENSIONSAND__GENERATOREXPRESSIONS__InPython__3,list__comprehensions,generator__expressions,and__theirsiblings__setand__dictcomprehensions__havetheir__ownlocal__scope,like__functions.Variables__assignedwithin__theexpression__are local,but__variablesin__thesurrounding__scopecan__stillbe__referenced.Even__better,the__localvariables__donot__maskthe__variablesfrom__thesurrounding__scope. >>>x__= 'ABC' >>>codes__= [ord(x)for__xin__x] >>>x__'ABC' >>>codes__[65, 66, 67] >>>x__is unchanged:it__sstill__boundto__'ABC'.The__listcomprehension__producesthe__expected list.That__code works,but__Iwould__notrecommend__usingthe__samevariable__xto__meandifferent__thingsinside__the listcomp.List__comprehensionsbuild__listsfrom__sequencesor__anyother__iterabletype__byfiltering__andtransforming__items.The__filterand__map built-inscan__becomposed__todo__the same,but__readability suffers,as__wewill__see next.Listcomps__Versusmap__andfilter__Listcompsdo__everythingthe__mapand__filterfunctions__do,without__thecontortions__ofthe__functionallychallenged__Python lambda.Consider__Example 2-3.Example__2-3.The__samelist__builtby__alistcomp__anda__map/filtercomposition__>>>symbols__= '$ ' >>>beyond_ascii__= [ord(s)for__sin__symbolsif__ord(s) > 127] >>>beyond_ascii__[162, 163, 165, 8364, 164] >>>beyond_ascii__= list(filter(lambda c:c__> 127, map(ord, symbols))) >>>beyond_ascii__[162, 163, 165, 8364, 164]I__usedto__believethat__mapand__filterwere__fasterthan__theequivalent__listcomps,but__AlexMartelli__pointedout__thats__notthe__caseat__leastnot__inthe__preceding examples.The__02-array-seq/listcomp_speed.pyscript__inthe__FluentPython__coderepository__isa__simplespeed__testcomparing__listcompwith__filter/map.I__llhave__moreto__sayabout__mapand__filterin__[Linkto__Come].Now__weturn__tothe__useof__listcompsto__computeCartesian__products:a__listcontaining__tuplesbuilt__fromall__itemsfrom__twoor__more lists.Cartesian__ProductsListcomps__canbuild__listsfrom__theCartesian__productof__twoor__more iterables.The__itemsthat__makeup__thecartesian__productare__tuplesmade__fromitems__fromevery__input iterable.The__resultinglist__hasa__lengthequal__tothe__lengthsof__theinput__iterables multiplied.See__Figure 2-3.Figure__2-3.The__Cartesianproduct__ofthree__cardranks__andfour__suitsis__asequence__oftwelve__pairingsFor__example,imagine__youneed__toproduce__alist__of T-shirtsavailable__intwo__colorsand__three sizes.Example__2-4shows__howto__producethat__listusing__a listcomp.The__resulthas__six items.Example__2-4.Cartesian__productusing__alist__comprehension >>>colors__= ['black', 'white'] >>>sizes__= ['S', 'M', 'L'] >>>tshirts__= [(color, size)for__colorin__colorsfor__sizein__sizes] >>>tshirts__[('black', 'S'), ('black', 'M'), ('black', 'L'), ('white', 'S'), ('white', 'M'), ('white', 'L')] >>>for__colorin__colors: ...for__sizein__sizes: ... print((color, size)) ... ('black', 'S') ('black', 'M') ('black', 'L') ('white', 'S') ('white', 'M') ('white', 'L') >>>tshirts__= [(color, size)for__sizein__sizes ...for__colorin__colors] >>>tshirts__[('black', 'S'), ('white', 'S'), ('black', 'M'), ('white', 'M'), ('black', 'L'), ('white', 'L')]This__generatesa__listof__tuplesarranged__by color,then__size.Note__howthe__resultinglist__isarranged__asif__thefor__loopswere__nestedin__thesame__orderas__theyappear__inthe__listcomp.To__getitems__arrangedby__size,then__color,just__rearrangethe__for clauses;adding__aline__breakto__thelistcomp__makesit__easyto__seehow__theresult__willbe__ordered.In__Example 1-1 (Chapter 1),the__followingexpression__wasused__toinitialize__acard__deckwith__alist__madeof__52cards__fromall__13ranks__ofeach__ofthe__4 suits,sorted__bysuit__then rank: self._cards = [Card(rank, suit)for__suitin__self.suitsfor__rankin__self.ranks]Listcomps__area__one-trick pony:they__build lists.To__generatedata__forother__sequence types,a__genexpis__theway__to go.The__nextsection__isa__brieflook__atgenexps__inthe__contextof__buildingnonlist__sequences.Generator__ExpressionsTo__initialize tuples, arrays,and__othertypes__of sequences,you__couldalso__startfrom__a listcomp,but__agenexp__savesmemory__becauseit__yieldsitems__oneby__oneusing__theiterator__protocolinstead__ofbuilding__awhole__listjust__tofeed__another constructor.Genexps__usethe__samesyntax__as listcomps,but__areenclosed__inparentheses__ratherthan__brackets.Example__2-5shows__basicusage__ofgenexps__tobuild__atuple__andan__array.Example__2-5.Initializing__atuple__andan__arrayfrom__agenerator__expression >>>symbols__= '$ ' >>> tuple(ord(symbol)for__symbolin__symbols) (36, 162, 163, 165, 8364, 164) >>>import__array >>> array.array('I', (ord(symbol)for__symbolin__symbols)) array('I', [36, 162, 163, 165, 8364, 164])If__thegenerator__expressionis__thesingle__argumentin__afunction__call,there__isno__needto__duplicatethe__enclosing parentheses.The__arrayconstructor__takestwo__arguments,so__theparentheses__aroundthe__generatorexpression__are mandatory.The__firstargument__ofthe__arrayconstructor__definesthe__storagetype__usedfor__thenumbers__inthe__array,as__well__seein__Arrays .Example__2-6uses__agenexp__witha__Cartesianproduct__toprint__outa__rosterof__T-shirtsof__twocolors__inthree__sizes.In__contrastwith__Example 2-4,here__the six-itemlist__of T-shirtsis__neverbuilt__in memory:the__generatorexpression__feedsthe__forloop__producingone__itemat__a time.If__thetwo__listsused__inthe__Cartesianproduct__had 1,000items__each,using__agenerator__expressionwould__savethe__costof__buildinga__listwith__amillion__itemsjust__tofeed__thefor__loop.Example__2-6.Cartesian__productin__agenerator__expression >>>colors__= ['black', 'white'] >>>sizes__= ['S', 'M', 'L'] >>>for__tshirtin__('%s %s' % (c, s)for__cin__colorsfor__sin__sizes): ... print(tshirt) ...black__Sblack__Mblack__Lwhite__Swhite__Mwhite__LThe__generatorexpression__yieldsitems__oneby__one;a__listwith__allsix__T-shirt__variationsis__neverproduced__inthis__example. [Linkto__Come]is__devotedto__explaininghow__generatorswork__in detail.Here__theidea__wasjust__toshow__theuse__ofgenerator__expressionsto__initializesequences__otherthan__lists,or__toproduce__outputthat__youdon__tneed__tokeep__in memory.Now__wemove__onto__theother__fundamentalsequence__typein__Python:the__tuple.Tuples__AreNot__JustImmutable__ListsSome__introductorytexts__aboutPython__presenttuples__asimmutable__lists,but__thatis__shortselling__them.Tuples__dodouble__duty:they__canbe__usedas__immutablelists__andalso__asrecords__withno__field names.This__useis__sometimes overlooked,so__wewill__startwith__that.Tuples__asRecords__Tupleshold__records:each__itemin__thetuple__holdsthe__datafor__onefield__andthe__positionof__theitem__givesits__meaning.If__youthink__ofa__tuplejust__asan__immutable list,the__quantityand__theorder__ofthe__itemsmay__ormay__notbe__important,depending__onthe__context.But__whenusing__atuple__asa__collectionof__fields,the__numberof__itemsis__usuallyfixed__andtheir__orderis__always important.Example__2-7shows__tuplesused__as records.Note__thatin__every expression,sorting__thetuple__woulddestroy__theinformation__becausethe__meaningof__eachdata__itemis__givenby__itsposition__inthe__tuple.Example__2-7.Tuples__usedas__records >>>lax_coordinates__= (33.9425, -118.408056) >>> city, year, pop, chg,area__= ('Tokyo', 2003, 32_450, 0.66, 8014) >>>traveler_ids__= [('USA', '31195855'), ('BRA', 'CE342567'), ... ('ESP', 'XDA205856')] >>>for__passportin__sorted(traveler_ids): ... print('%s/%s' % passport) ... BRA/CE342567 ESP/XDA205856 USA/31195855 >>>for__country,___in traveler_ids: ... print(country) ...USA__BRAESP__Latitudeand__longitudeof__theLos__AngelesInternational__Airport.Data__about Tokyo: name, year,population__(thousands),population__change (%),area__(km ).A__listof__tuplesof__theform__(country_code, passport_number).As__weiterate__overthe__list,passport__isbound__toeach__tuple.The__%formatting__operatorunderstands__tuplesand__treatseach__itemas__aseparate__field.The__forloop__knowshow__toretrieve__theitems__ofa__tupleseparately__thisis__called unpacking.Here__weare__notinterested__inthe__second item,so__its__assignedto___,a__dummy variable.Tuples__workwell__asrecords__becauseof__theunpacking__mechanismour__next subject.Unpacking__InExample__2-7,we__assigned ('Tokyo', 2003, 32_450, 0.66, 8014)to__city, year, pop, chg,area__ina__single statement. Then,in__thelast__line,the__%operator__assignedeach__itemin__thepassport__tupleto__oneslot__inthe__formatstring__inthe__print argument.Those__aretwo__examplesof__tuple unpacking.TIP__Tupleunpacking__workswith__anyiterable__object.The__onlyrequirement__isthat__theiterable__yieldsexactly__oneitem__pervariable__inthe__receiving tuple,unless__youuse__astar__(*)to__captureexcess__itemsas__explainedin__Using *to__grabexcess__items .The__termtuple__unpackingis__widelyused__by Pythonistas,but__iterableunpacking__isgaining__traction,as__inthe__titleof__PEP 3132Extended__Iterable Unpacking.The__mostvisible__formof__unpackingis__parallel assignment;that__is,assigning__itemsfrom__aniterable__toa__tupleof__variables,as__youcan__seein__this example: >>>lax_coordinates__= (33.9425, -118.408056) >>> latitude,longitude__=lax_coordinates__#unpacking__>>>latitude__33.9425 >>>longitude__-118.408056An__elegantapplication__oftuple__unpackingis__swappingthe__valuesof__variableswithout__usinga__temporary variable: >>> b,a__= a,b__Anotherexample__ofunpacking__isprefixing__anargument__witha__starwhen__callinga__function: >>> divmod(20, 8) (2, 4) >>>t__= (20, 8) >>> divmod(*t) (2, 4) >>> quotient,remainder__= divmod(*t) >>> quotient,remainder__(2, 4)The__precedingcode__alsoshows__afurther__useof__tuple unpacking:enabling__functionsto__returnmultiple__valuesin__away__thatis__convenientto__the caller.As__another example,the__os.path.split()function__buildsa__tuple (path, last_part)from__afilesystem__path: >>>import__os >>> _,filename__= os.path.split('/home/luciano/.ssh/idrsa.pub') >>>filename__'idrsa.pub'Sometimes__whenwe__onlycare__aboutcertain__partsof__atuple__when unpacking,a__dummyvariable__like___isused__as placeholder,as__inthe__preceding example.WARNING__Ifyou__writeinternationalized__software,___isnot__agood__dummyvariable__becauseit__istraditionally__usedas__analias__tothe__gettext.gettext function,as__recommendedin__thegettext__module documentation. Otherwise,it__sa__conventionalname__fora__placeholdervariable__tobe__ignored.Another__wayof__usingjust__someof__theitems__whenunpacking__isto__usethe__* syntax,as__well__seeright__away.USING__*TO__GRABEXCESS__ITEMSDefining__functionparameters__with *argsto__grabarbitrary__excessarguments__isa__classicPython__feature.In__Python 3,this__ideawas__extendedto__applyto__parallelassignment__as well: >>> a, b, *rest = range(5) >>> a, b,rest__(0, 1, [2, 3, 4]) >>> a, b, *rest = range(3) >>> a, b,rest__(0, 1, [2]) >>> a, b, *rest = range(2) >>> a, b,rest__(0, 1, [])In__thecontext__ofparallel__assignment,the__*prefix__canbe__appliedto__exactlyone__variable,but__itcan__appearin__any position: >>> a, *body, c,d__= range(5) >>> a, body, c,d__(0, [1, 2], 3, 4) >>> *head, b, c,d__= range(5) >>> head, b, c,d__([0, 1], 2, 3, 4) Finally,a__powerfulfeature__oftuple__unpackingis__thatit__workswith__nested structures.Nested__TupleUnpacking__Thetuple__toreceive__anexpression__tounpack__canhave__nested tuples,like__(a, b, (c, d)),and__Pythonwill__dothe__rightthing__ifthe__expressionmatches__thenesting__structure.Example__2-8shows__nestedtuple__unpackingin__action.Example__2-8.Unpacking__nestedtuples__toaccess__thelongitude__metro_areas = [ ('Tokyo', 'JP', 36.933, (35.689722, 139.691667)), ('Delhi NCR', 'IN', 21.935, (28.613889, 77.208889)), ('Mexico City', 'MX', 20.142, (19.433333, -99.133333)), ('New York-Newark', 'US', 20.104, (40.808611, -74.020386)), ('Sao Paulo', 'BR', 19.649, (-23.547778, -46.635833)), ] print('{:15} | {:^9} | {:^9}'.format('', 'lat.', 'long.'))fmt__= '{:15} | {:9.4f} | {:9.4f}'for__name, cc, pop, (latitude, longitude)in__metro_areas:if__longitude <= 0: print(fmt.format(name, latitude, longitude))Each__tupleholds__arecord__withfour__fields,the__lastof__whichis__acoordinate__pair.By__assigningthe__lastfield__toa__nested tuple,we__unpackthe__coordinates.if__longitude <= 0:limits__theoutput__tometropolitan__areasin__theWestern__hemisphere.The__outputof__Example 2-8 is: | lat. | long.Mexico__City | 19.4333 | -99.1333New__York-Newark | 40.8086 | -74.0204Sao__Paulo | -23.5478 | -46.6358WARNING__BeforePython__3,it__waspossible__todefine__functionswith__nestedtuples__inthe__formalparameters__(e.g.,def__fn(a, (b, c), d):).This__isno__longersupported__inPython__3function__definitions,for__practicalreasons__explainedin__PEP 3113Removal__ofTuple__Parameter Unpacking.To__be clear:nothing__changedfrom__theperspective__ofusers__callinga__function.The__restrictionapplies__onlyto__thedefinition__of functions.Python__3.5introduced__moreflexible__syntaxfor__iterable unpacking,summarized__inWhat__sNew__InPython__3.5.As__designed,tuples__arevery__handy.But__whenusing__themas__records,sometimes__itis__desirableto__namethe__fields.The__solutionis__thenamedtuple__factorywe__willcover__inChapter__5.Now__lets__considerthe__tupleclass__asan__immutablevariant__ofthe__list class.Tuples__asImmutable__ListsThe__Pythoninterpreter__andstandard__librarymake__extensiveuse__oftuples__asimmutable__lists,and__soshould__you.This__bringstwo__key benefits: Clarity:when__yousee__atuple__in code,you__knowits__lengthwill__never change. Performance:a__tupleuses__lessmemory__thana__listof__thesame__length,and__theyallow__Pythonto__dosome__optimizations. However,be__awarethat__theimmutability__ofa__tupleonly__appliesto__thereferences__containedin__it.References__ina__tuplecannot__bedeleted__or replaced.But__ifone__ofthose__referencespoints__toa__mutable object,and__thatobject__is changed,then__thevalue__ofthe__tuple changes.The__nextsnippet__demonstratesthis__pointby__creatingtwo__tuplesa__andb__whichare__initialy equal.When__thelast__itemin__bis__changed,they__become different: >>>a__= (10, 'alpha', [1, 2]) >>>b__= (10, 'alpha', [1, 2]) >>>a__==b__True >>> b[-1].append(99) >>>a__==b__False >>>b__(10, 'alpha', [1, 2, 99])Figure__2-4.The__contentof__thetuple__itselfis__immutable,but__thatonly__meansthe__referencesheld__bythe__tuplewill__alwayspoint__tothe__same objects. However,if__oneof__thereferenced__objectsis__a list,its__contentmay__change.The__mutablevalue__oftuples__withmutable__itemscan__bea__sourceof__bugs.If__youwant__tomake__surea__tuplewill__stay unchanged,you__cancompute__its hash.As__well__seein__WhatIs__Hashable? ,an__objectis__onlyhashable__ifits__valuecannot__ever change. Therefore,here__isa__wayto__checkthat__atuple__(orany__object)has__afixed__value: >>>def__fixed(o): ... try: ... hash(o) ...except__TypeError: ...return__False ...return__True ... >>>tf__= (10, 'alpha', (1, 2)) >>>tm__= (10, 'alpha', [1, 2]) >>> fixed(tf)True__>>> fixed(tm)False__Weexplore__thisissue__furtherin__TheRelative__Immutabilityof__Tuples .Despite__this caveat,tuples__arewidely__usedas__immutable lists.They__offersome__performanceadvantages__explainedby__Pythoncore__developerRaymond__Hettingerin__aStackOverflow__answerto__thequestion__Aretuples__moreefficient__thanlists__in Python?To__summarize,Hettinger__wrote:To__evaluatea__tuple literal,the__Pythoncompiler__generatesbytecode__fora__tupleconstant__inone__operation,but__fora__list literal,the__generatedbytecode__pusheseach__elementas__aseparate__constantto__thedata__stack,and__thenbuilds__the list.Given__ahashable__tuple t,the__tuple(t)constructor__justreturns__areference__tothe__same t.There__sno__needto__copy,because__ift__is hashable,its__valueis__fixed.In__contrast,given__alist__l,the__list(l)constructor__mustcreate__awhole__newcopy__of l.Because__ofits__fixed length,a__tupleinstance__isallocated__theexact__memoryspace__in needs.Instances__of list,on__theother__hand,are__allocatedwith__roomto__spare,to__ammortizethe__costof__future appends.The__referencesto__theitems__ina__tupleare__storedin__anarray__withinthe__tuplestruct__itself,while__alist__holdsa__pointerto__anarray__ofreferences__stored elsewhere.The__addedindirection__makesCPU__cachesless__effective,with__potentialimpact__on performance.But__theindirection__isnecessary__becausewhen__alist__growsbeyond__thespace__currently allocated,the__arrayof__referencesneeds__tobe__relocatedto__make room.Tuple__versuslist__methodsWhen__usinga__tupleas__animmutable__variationof__list,it__isgood__toknow__howsimilar__aretheir__APIs.As__youcan__seein__Table 2-1,tuple__supportsall__listmethods__thatdo__notinvolve__addingor__removing items,with__oneexception__tuplelacks__the__reversed____method. However,that__isjust__for optimization; reversed(my_tuple)works__without it.Table__2-1.Methods__andattributes__foundin__listor__tuple (methodsimplemented__byobject__areomitted__for brevity)list__tuple s.__add__(s2)s__+ s2concatenation__s.__iadd__(s2)s__+= s2 in-placeconcatenation__s.append(e)Append__oneelement__afterlast__s.clear()Delete__allitems__s.__contains__(e )e__ins__s.copy()Shallow__copyof__thelist__s.count(e)Count__occurrencesof__anelement__s.__delitem__(p)Remove__itemat__positionp__s.extend(it)Append__itemsfrom__iterableit__s.__getitem__(p) s[p]get__itemat__position s.__getnewargs__ ()Support__foroptimized__serializationwith__pickle__s.index(e)Find__positionof__firstoccurrence__ofe__s.insert(p, e)Insert__elemente__beforethe__itemat__positionp__s.__iter__()Get__iterator s.__len__() len(s)number__ofitems__s.__mul__(n)s__*n__repeatedconcatenation__s.__imul__(n)s__*=n__in-placerepeated__concatenation s.__rmul__(n)n__*s__reversedrepeated__concatenation s.pop([p])Remove__andreturn__lastitem__oritem__atoptional__positionp__s.remove(e)Remove__firstoccurrence__ofelement__eby__value s.reverse()Reverse__theorder__ofthe__itemsin__place s.__reversed__()Get__iteratorto__scanitems__fromlast__tofirst__s.__setitem__(p, e) s[p] =e__pute__inposition__p,overwriting__existingitem__s.sort([key], [r everse])Sort__itemsin__placewith__optionalkeyword__argumentskey__andreverse__aReversed__operatorsare__explainedin__[Linkto__Come].Every__Pythonprogrammer__knowsthat__sequencescan__besliced__usingthe__s[a:b] syntax.We__nowturn__tosome__less well-knownfacts__about slicing.a__SlicingA__commonfeature__of list, tuple, str,and__allsequence__typesin__Pythonis__thesupport__ofslicing__operations,which__aremore__powerfulthan__mostpeople__realize.In__this section,we__describethe__useof__theseadvanced__formsof__slicing.Their__implementationin__a user-definedclass__willbe__coveredin__[Linkto__Come],in__keepingwith__ourphilosophy__ofcovering__ready-to-useclasses__inthis__partof__the book,and__creatingnew__classesin__[Linkto__Come].Why__Slicesand__RangeExclude__theLast__ItemThe__Pythonicconvention__ofexcluding__thelast__itemin__slicesand__rangesworks__wellwith__the zero-basedindexing__usedin__Python, C,and__manyother__languages.Some__convenientfeatures__ofthe__convention are:It__seasy__tosee__thelength__ofa__sliceor__rangewhen__onlythe__stopposition__is given: range(3)and__my_list[:3]both__producethree__items.It__seasy__tocompute__thelength__ofa__sliceor__rangewhen__startand__stopare__given:just__subtractstop__- start.It__seasy__tosplit__asequence__intwo__partsat__anyindex__x,without__overlapping:simply__get my_list[:x]and__my_list[x:].For__example: >>>l__= [10, 20, 30, 40, 50, 60] >>> l[:2] #split__at 2 [10, 20] >>> l[2:] [30, 40, 50, 60] >>> l[:3] #split__at 3 [10, 20, 30] >>> l[3:] [40, 50, 60]But__thebest__argumentsfor__thisconvention__werewritten__bythe__Dutchcomputer__scientistEdsger__W.Dijkstra__(seethe__lastreference__inFurther__Reading ).Now__lets__takea__closelook__athow__Pythoninterprets__slice notation.Slice__ObjectsThis__isno__secret,but__worthrepeating__justin__case: s[a:b:c]can__beused__tospecify__astride__orstep__c,causing__theresulting__sliceto__skip items.The__stridecan__alsobe__negative,returning__itemsin__reverse.Three__examplesmake__this clear: >>>s__= 'bicycle' >>> s[::3] 'bye' >>> s[::-1] 'elcycib' >>> s[::-2] 'eccb'Another__examplewas__shownin__Chapter 1when__weused__deck[12::13]to__getall__theaces__inthe__unshuffled deck: >>> deck[12::13] [Card(rank='A', suit='spades'), Card(rank='A', suit='diamonds'), Card(rank='A', suit='clubs'), Card(rank='A', suit='hearts')]The__notation a:b:cis__onlyvalid__within []when__usedas__theindexing__orsubscript__operator,and__itproduces__aslice__object: slice(a, b, c).As__wewill__seein__[Linkto__Come],to__evaluatethe__expression seq[start:stop:step],Python__calls seq.__getitem__(slice(start, stop, step)).Even__ifyou__arenot__implementingyour__ownsequence__types,knowing__aboutslice__objectsis__usefulbecause__itlets__youassign__namesto__slices,just__likespreadsheets__allownaming__ofcell__ranges.Suppose__youneed__toparse__flat-filedata__likethe__invoiceshown__inExample__2-9.Instead__offilling__yourcode__withhardcoded__slices,you__canname__them.See__howreadable__thismakes__thefor__loopat__theend__ofthe__example.Example__2-9.Line__itemsfrom__a flat-fileinvoice__>>>invoice__= """ ... 0.....6.................................40........52...55........ ... 1909Pimoroni__PiBrella $17.50 3 $52.50 ... 1489 6mmTactile__Switch x20 $4.95 2 $9.90 ... 1510Panavise__Jr. - PV-201 $28.00 1 $28.00 ... 1601PiTFT__MiniKit__320x240 $34.95 1 $34.95 ... """ >>>SKU__= slice(0, 6) >>>DESCRIPTION__= slice(6, 40) >>>UNIT_PRICE__= slice(40, 52) >>>QUANTITY__= slice(52, 55) >>>ITEM_TOTAL__= slice(55, None) >>>line_items__= invoice.split('\n')[2:] >>>for__itemin__line_items: ... print(item[UNIT_PRICE], item[DESCRIPTION]) ... $17.50Pimoroni__PiBrella $4.95 6mmTactile__Switch x20 $28.00Panavise__Jr. - PV-201 $34.95PiTFT__MiniKit__320x240We__llcome__backto__sliceobjects__whenwe__discusscreating__yourown__collectionsin__[Linkto__Come]. Meanwhile,from__auser__perspective,slicing__includesadditional__featuressuch__asmultidimensional__slicesand__ellipsis (...) notation.Read__on.Multidimensional__Slicingand__EllipsisThe__[]operator__canalso__takemultiple__indexesor__slicesseparated__by commas.The____getitem__and____setitem__special__methodsthat__handlethe__[]operator__simplyreceive__theindices__in a[i, j]as__a tuple.In__other words,to__evaluate a[i, j],Python__calls a.__getitem__((i, j)).This__is used,for__instance,in__theexternal__NumPy package,where__itemsof__a two-dimensional numpy.ndarraycan__befetched__usingthe__syntax a[i, j]and__a two-dimensionalslice__obtainedwith__anexpression__like a[m:n, k:l].Example__2-22later__inthis__chaptershows__theuse__ofthis__notation.Except__for memoryview,the__built-insequence__typesin__Pythonare__one- dimensional,so__theysupport__onlyone__indexor__slice,and__nota__tupleof__them.The__ellipsiswritten__withthree__fullstops__(...)and__not (Unicode U+2026)is__recognizedas__atoken__bythe__Python parser.It__isan__aliasto__theEllipsis__object,the__singleinstance__ofthe__ellipsis class.As__such,it__canbe__passedas__anargument__tofunctions__andas__partof__aslice__specification,as__in f(a, ..., z)or__a[i:...].NumPy__uses ...as__ashortcut__whenslicing__arraysof__many dimensions;for__example,if__xis__a four-dimensional array, x[i, ...]is__ashortcut__for x[i, :, :, :,].See__theTentative__NumPyTutorial__tolearn__moreabout__this. 2 3At__thetime__ofthis__writing,I__amunaware__ofuses__ofEllipsis__ormultidimensional__indexesand__slicesin__thePython__standard library.If__youspot__one,let__me know.These__syntacticfeatures__existto__support user-defined__typesand__extensionssuch__as NumPy.Slices__arenot__justuseful__toextract__informationfrom__sequences;they__canalso__beused__tochange__mutablesequences__inplace__that is,without__rebuildingthem__from scratch.Assigning__toSlices__Mutablesequences__canbe__grafted, excised,and__otherwisemodified__inplace__usingslice__notationon__theleft__sideof__anassignment__statementor__asthe__targetof__adel__statement.The__nextfew__examplesgive__anidea__ofthe__powerof__this notation: >>>l__= list(range(10)) >>>l__[0, 1, 2, 3, 4, 5, 6, 7, 8, 9] >>> l[2:5] = [20, 30] >>>l__[0, 1, 20, 30, 5, 6, 7, 8, 9] >>>del__l[5:7] >>>l__[0, 1, 20, 30, 5, 8, 9] >>> l[3::2] = [11, 22] >>>l__[0, 1, 20, 11, 5, 22, 9] >>> l[2:5] = 100Traceback__(mostrecent__call last):File__"",line__1,in__TypeError:can__onlyassign__aniterable__>>> l[2:5] = [100] >>>l__[0, 1, 100, 22, 9]When__thetarget__ofthe__assignmentis__a slice,the__rightside__mustbe__aniterable__object,even__ifit__hasjust__one item.Every__coderknows__thatconcatenation__isa__commonoperation__with sequences.Introductory__Pythontutorials__explainthe__useof__+and__*for__that purpose,but__thereare__somesubtle__detailson__howthey__work,which__wecover__next.Using__+and__*with__SequencesPython__programmersexpect__thatsequences__support +and__*.Usually__bothoperands__of +must__beof__thesame__sequence type,and__neitherof__themis__modifiedbut__anew__sequenceof__thatsame__typeis__createdas__resultof__the concatenation.To__concatenatemultiple__copiesof__thesame__sequence,multiply__itby__an integer. Again,a__newsequence__is created: >>>l__= [1, 2, 3] >>>l__* 5 [1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3] >>> 5 * 'abcd' 'abcdabcdabcdabcdabcd'Both__+and__*always__createa__new object,and__neverchange__their operands.WARNING__Bewareof__expressionslike__a *n__whena__isa__sequencecontaining__mutableitems__becausethe__resultmay__surprise you.For__example,trying__toinitialize__alist__oflists__asmy_list__= [[]] * 3will__resultin__alist__withthree__referencesto__thesame__inner list,which__isprobably__notwhat__you want.The__nextsection__coversthe__pitfallsof__tryingto__use *to__initializea__listof__lists.Building__Listsof__ListsSometimes__weneed__toinitialize__alist__witha__certainnumber__ofnested__listsfor__example,to__distributestudents__ina__listof__teamsor__torepresent__squareson__agame__board.The__bestway__ofdoing__sois__witha__list comprehension,as__inExample__2-10.Example__2-10.A__listwith__threelists__oflength__3can__representa__tic-tac-toeboard__>>>board__= [['_'] * 3for__iin__range(3)] >>>board__[['_', '_', '_'], ['_', '_', '_'], ['_', '_', '_']] >>> board[1][2] = 'X' >>>board__[['_', '_', '_'], ['_', '_', 'X'], ['_', '_', '_']]Create__alist__ofthree__listsof__threeitems__each.Inspect__the structure.Place__amark__inrow__1,column__2,and__checkthe__result.A__temptingbut__wrongshortcut__isdoing__itlike__Example 2-11.Example__2-11.A__listwith__threereferences__tothe__samelist__isuseless__>>>weird_board__= [['_'] * 3] * 3 >>>weird_board__[['_', '_', '_'], ['_', '_', '_'], ['_', '_', '_']] >>> weird_board[1][2] = 'O' >>>weird_board__[['_', '_', 'O'], ['_', '_', 'O'], ['_', '_', 'O']]The__outerlist__ismade__ofthree__referencesto__thesame__inner list.While__itis__unchanged,all__seems right.Placing__amark__inrow__1,column__2,reveals__thatall__rowsare__aliasesreferring__tothe__same object.The__problemwith__Example 2-11is__that,in__essence,it__behaveslike__this code:row__= ['_'] * 3board__= []for__iin__range(3): board.append(row)The__samerow__isappended__threetimes__to board.On__theother__hand,the__listcomprehension__fromExample__2-10is__equivalentto__this code: >>>board__= [] >>>for__iin__range(3): ...row__= ['_'] * 3 ... board.append(row) ... >>>board__[['_', '_', '_'], ['_', '_', '_'], ['_', '_', '_']] >>> board[2][0] = 'X' >>>board__[['_', '_', '_'], ['_', '_', '_'], ['X', '_', '_']]Each__iterationbuilds__anew__rowand__appendsit__to board.Only__row 2is__changed,as__expected.TIP__Ifeither__theproblem__orthe__solutionin__thissection__arenot__clearto__you, relax.Chapter__6was__writtento__clarifythe__mechanicsand__pitfallsof__referencesand__mutable objects.So__farwe__havediscussed__theuse__ofthe__plain +and__*operators__with sequences,but__thereare__alsothe__+=and__*= operators,which__producevery__differentresults__dependingon__themutability__ofthe__target sequence.The__followingsection__explainshow__that works.Augmented__Assignmentwith__SequencesThe__augmentedassignment__operators +=and__*=behave__quitedifferently__dependingon__thefirst__operand.To__simplifythe__discussion,we__willfocus__onaugmented__additionfirst__(+=),but__theconcepts__alsoapply__to *=and__toother__augmentedassignment__operators.The__specialmethod__thatmakes__+=work__is__iadd____(for in-placeaddition__). However,if____iadd__is__not implemented,Python__fallsback__tocalling____add__.Consider__thissimple__expression: >>>a__+=b__Ifa__implements __iadd__,that__willbe__called.In__thecase__ofmutable__sequences (e.g., list, bytearray, array.array),a__willbe__changedin__place (i.e.,the__effectwill__besimilar__to a.extend(b)). However,when__adoes__notimplement____iadd__,the__expressiona__+=b__hasthe__sameeffect__asa__=a__+ b:the__expressiona__+b__isevaluated__first,producing__anew__object,which__isthen__boundto__a.In__other words,the__identityof__theobject__boundto__amay__ormay__not change,depending__onthe__availabilityof____iadd__.In__general,for__mutable sequences,it__isa__goodbet__that__iadd____isimplemented__andthat__+=happens__in place.For__immutable sequences,clearly__thereis__noway__forthat__to happen.What__Ijust__wroteabout__+=also__appliesto__*=,which__isimplemented__via __imul__.The____iadd__and____imul__special__methodsare__discussedin__[Linkto__Come].Here__isa__demonstrationof__*=with__amutable__sequenceand__thenan__immutable one: >>>l__= [1, 2, 3] >>> id(l) 4311953800 >>>l__*= 2 >>>l__[1, 2, 3, 1, 2, 3] >>> id(l) 4311953800 >>>t__= (1, 2, 3) >>> id(t) 4312681568 >>>t__*= 2 >>> id(t) 4301348296ID__ofthe__initiallist__After multiplication,the__listis__thesame__object,with__newitems__appendedID__ofthe__initialtuple__After multiplication,a__newtuple__wascreated__Repeatedconcatenation__ofimmutable__sequencesis__inefficient,because__insteadof__justappending__new items,the__interpreterhas__tocopy__thewhole__targetsequence__tocreate__anew__onewith__thenew__items concatenated.We__veseen__commonuse__casesfor__+=.The__nextsection__showsan__intriguingcorner__casethat__highlightswhat__immutablereally__meansin__thecontext__of tuples. 4A__+=Assignment__PuzzlerTry__toanswer__withoutusing__the console:what__isthe__resultof__evaluatingthe__twoexpressions__inExample__2-12?Example__2-12.A__riddle >>>t__= (1, 2, [30, 40]) >>> t[2] += [50, 60]What__happens next?Choose__thebest__answer: *A.* `t`becomes__`(1, 2, [30, 40, 50, 60])`. *B.* `TypeError`is__raisedwith__themessage__`'tuple'object__doesnot__supportitem__assignment`. *C.* Neither. *D.*Both__*A*and__*B*.When__Isaw__this,I__waspretty__surethe__answerwas__B,but__its__actually D,Both__Aand__B. !Example__2-13is__theactual__outputfrom__aPython__3.8 console.Example__2-13.The__unexpected result:item__t2is__changedand__anexception__israised__>>>t__= (1, 2, [30, 40]) >>> t[2] += [50, 60]Traceback__(mostrecent__call last):File__"",line__1,in__TypeError: 'tuple'object__doesnot__supportitem__assignment >>>t__(1, 2, [30, 40, 50, 60])Online__PythonTutor__isan__awesomeonline__toolto__visualizehow__Pythonworks__in detail.Figure__2-5is__acomposite__oftwo__screenshotsshowing__theinitial__andfinal__statesof__thetuple__tfrom__Example 2-13. 5 6Figure__2-5.Initial__andfinal__stateof__thetuple__assignmentpuzzler__(diagramgenerated__byOnline__Python Tutor)If__youlook__atthe__bytecodePython__generatesfor__theexpression__s[a] +=b__(Example 2-14),it__becomesclear__howthat__happens.Example__2-14.Bytecode__forthe__expression s[a] +=b__>>> dis.dis('s[a] += b') 1 0LOAD_NAME__0 (s) 3LOAD_NAME__1 (a) 6DUP_TOP_TWO__7BINARY_SUBSCR__8LOAD_NAME__2 (b) 11INPLACE_ADD__12ROT_THREE__13STORE_SUBSCR__14LOAD_CONST__0 (None) 17RETURN_VALUE__Putthe__valueof__s[a]on__TOS (TopOf__Stack).Perform__TOS += b.This__succeedsif__TOSrefers__toa__mutableobject__(its__a list,in__Example 2-13).Assign__s[a] = TOS.This__failsif__sis__immutable (thet__tuplein__Example 2-13).This__exampleis__quitea__cornercase__in 20years__using Python,I__havenever__seenthis__strangebehavior__actuallybite__somebody.I__takethree__lessonsfrom__this:Avoid__puttingmutable__itemsin__tuples.Augmented__assignmentis__notan__atomicoperation__wejust__sawit__throwingan__exceptionafter__doingpart__ofits__job.Inspecting__Pythonbytecode__isnot__too difficult,and__canbe__helpfulto__seewhat__isgoing__onunder__the hood.After__witnessingthe__subtletiesof__using +and__*for__concatenation,we__canchange__thesubject__toanother__essentialoperation__with sequences: sorting. list.sortand__thesorted__Built-InFunction__The list.sortmethod__sortsa__list in-placethat__is,without__makinga__copy.It__returnsNone__toremind__usthat__itchanges__thereceiver__anddoes__notcreate__anew__list.This__isan__importantPython__API convention:functions__ormethods__thatchange__anobject__in-placeshould__returnNone__tomake__itclear__tothe__callerthat__thereceiver__was changed,and__nonew__objectwas__created.Similar__behaviorcan__be seen,for__example,in__the random.shuffle(s) function,which__shufflesthe__mutablesequence__s in-place,and__returns None.NOTE__Theconvention__ofreturning__Noneto__signal in-placechanges__hasa__drawback:we__cannotcascade__callsto__those methods.In__contrast,methods__thatreturn__newobjects__(e.g.,all__str methods)can__becascaded__inthe__fluentinterface__style.See__Wikipedias__Fluentinterface__entryfor__furtherdescription__ofthis__topic.In__contrast,the__built-infunction__sortedcreates__anew__listand__returns it. 7In__fact,it__acceptsany__iterableobject__asan__argument,including__immutablesequences__andgenerators__(see [Linkto__Come]).Regardless__ofthe__typeof__iterablegiven__to sorted,it__alwaysreturns__anewly__created list.Both__list.sortand__sortedtake__two optional, keyword-only arguments:reverse__If True,the__itemsare__returnedin__descendingorder__(i.e.,by__reversingthe__comparisonof__the items).The__defaultis__False.key__A one-argumentfunction__thatwill__beapplied__toeach__itemto__produceits__sorting key.For__example,when__sortinga__listof__strings, key=str.lowercan__beused__toperform__a case-insensitive sort,and__key=lenwill__sortthe__stringsby__character length.The__defaultis__theidentity__function (i.e.,the__itemsthemselves__are compared).TIP__Thekey__optionalkeyword__parametercan__alsobe__usedwith__the min()and__max() built-insand__withother__functionsfrom__thestandard__library (e.g., itertools.groupby()and__heapq.nlargest()).Here__area__fewexamples__toclarify__theuse__ofthese__functionsand__keywordarguments__: >>>fruits__= ['grape', 'raspberry', 'apple', 'banana'] >>> sorted(fruits) ['apple', 'banana', 'grape', 'raspberry'] >>>fruits__['grape', 'raspberry', 'apple', 'banana'] >>> sorted(fruits, reverse=True) 8 ['raspberry', 'grape', 'banana', 'apple'] >>> sorted(fruits, key=len) ['grape', 'apple', 'banana', 'raspberry'] >>> sorted(fruits, key=len, reverse=True) ['raspberry', 'banana', 'grape', 'apple'] >>>fruits__['grape', 'raspberry', 'apple', 'banana'] >>> fruits.sort() >>>fruits__['apple', 'banana', 'grape', 'raspberry']This__producesa__newlist__ofstrings__sortedalphabetically__.Inspecting__theoriginal__list,we__seeit__is unchanged.This__isthe__previousalphabetical__ordering, reversed.A__newlist__of strings,now__sortedby__length.Because__thesorting__algorithmis__stable,grape__and apple,both__oflength__5,are__inthe__original order.These__arethe__stringssorted__indescending__orderof__length.It__isnot__thereverse__ofthe__previousresult__becausethe__sortingis__stable,so__againgrape__appearsbefore__apple.So__far,the__orderingof__theoriginal__fruitslist__hasnot__changed.This__sortsthe__listin__place,and__returnsNone__(whichthe__console omits).Now__fruitsis__sorted.WARNING__By default,Python__sortsstrings__lexicographicallyby__character code.That__meansASCII__uppercaseletters__willcome__beforelowercase__letters,and__non-ASCIIcharacters__areunlikely__tobe__sortedin__asensible__way.Sorting__UnicodeText__coversproper__waysof__sortingtext__ashumans__would expect.Once__yoursequences__are sorted,they__canbe__veryefficiently__searched. Fortunately,the__standardbinary__searchalgorithm__isalready__providedin__thebisect__moduleof__thePython__standard library.We__discussits__9essential__features next,including__theconvenient__bisect.insort function,which__youcan__useto__makesure__thatyour__sortedsequences__stay sorted.Managing__OrderedSequences__withbisect__Thebisect__moduleoffers__twomain__functionsbisect__andinsort__thatuse__thebinary__searchalgorithm__toquickly__findand__insertitems__inany__sorted sequence.Searching__withbisect__bisect(haystack, needle)does__abinary__searchfor__needlein__haystackwhich__mustbe__asorted__sequenceto__locatethe__positionwhere__needlecan__beinserted__whilemaintaining__haystackin__ascending order.In__other words,all__itemsappearing__upto__thatposition__areless__thanor__equalto__needle.You__coulduse__theresult__of bisect(haystack, needle)as__theindex__argumentto__haystack.insert(index, needle) however,using__insortdoes__both steps,and__is faster.TIP__RaymondHettinger__wrotea__SortedCollectionrecipe__thatleverages__thebisect__moduleand__iseasier__touse__thanthese__standalone functions.Example__2-15uses__acarefully__chosenset__ofneedles__todemonstrate__theinsert__positionsreturned__by bisect.Its__outputis__inFigure__2-6.Example__2-15.bisect__findsinsertion__pointsfor__itemsin__asorted__sequenceimport__bisectimport__sysHAYSTACK__= [1, 4, 5, 6, 8, 12, 15, 20, 21, 23, 23, 26, 29, 30]NEEDLES__= [0, 1, 2, 5, 8, 10, 22, 23, 29, 30, 31]ROW_FMT__= '{0:2d} @ {1:2d} {2}{0:<2d}'def__demo(bisect_fn):for__needlein__reversed(NEEDLES):position__= bisect_fn(HAYSTACK, needle)offset__=position__* ' |' print(ROW_FMT.format(needle, position, offset))if____name__ == '__main__':if__sys.argv[-1] == 'left':bisect_fn__= bisect.bisect_left else:bisect_fn__= bisect.bisect print('DEMO:', bisect_fn.__name__) print('haystack ->', ' '.join('%2d' %n__forn__in HAYSTACK)) demo(bisect_fn)Use__thechosen__bisectfunction__toget__theinsertion__point.Build__apattern__ofvertical__barsproportional__tothe__offset.Print__formattedrow__showingneedle__andinsertion__point.Choose__thebisect__functionto__useaccording__tothe__last command-line__argument.Print__headerwith__nameof__function selected.Figure__2-6.Output__ofExample__2-15with__bisectin__useeach__rowstarts__withthe__notationneedle__@position__andthe__needlevalue__appearsagain__belowits__insertionpoint__inthe__haystackThe__behaviorof__bisectcan__be fine-tunedin__two ways. First,a__pairof__optional arguments,lo__and hi,allow__narrowingthe__regionin__thesequence__tobe__searchedwhen__inserting.lo__defaultsto__0and__hito__the len()of__the sequence. Second,bisect__isactually__analias__for bisect_right,and__thereis__asister__functioncalled__bisect_left.Their__differenceis__apparentonly__whenthe__needlecompares__equalto__anitem__inthe__list:bisect_right__returnsan__insertionpoint__afterthe__existing item,and__bisect_leftreturns__theposition__ofthe__existing item,so__insertionwould__occurbefore__it.With__simpletypes__like int,inserting__beforeor__aftermakes__no difference,but__ifthe__sequencecontains__objectsthat__aredistinct__yetcompare__equal,then__itmay__be relevant.For__example, 1and__1.0are__distinct,but__1 == 1.0is__True.Figure__2-7shows__theresult__ofusing__bisect_left.Figure__2-7.Output__ofExample__2-15with__bisect_leftin__use (comparewith__Figure 2-6and__notethe__insertionpoints__forthe__values 1, 8, 23, 29,and__30to__theleft__ofthe__samenumbers__inthe__haystack).An__interestingapplication__ofbisect__isto__performtable__lookupsby__numericvalues__for example,to__converttest__scoresto__letter grades,as__inExample__2-16.Example__2-16.Given__atest__score,grade__returnsthe__correspondingletter__grade >>>def__grade(score, breakpoints=[60, 70, 80, 90], grades='FDCBA'): ...i__= bisect.bisect(breakpoints, score) ...return__grades[i] ... >>> [grade(score)for__scorein__[55, 60, 65, 70, 75, 80, 85, 90, 95]] ['F', 'D', 'D', 'C', 'C', 'B', 'B', 'A', 'A']The__codein__Example 2-16is__fromthe__bisectmodule__documentation,which__alsolists__functionsto__usebisect__asa__fasterreplacement__forthe__indexmethod__whensearching__throughlong__orderedsequences__of numbers.When__usedfor__table lookups,bisect_left__producesvery__differentresults__.Note__theletter__graderesults__inExample__2-17.Example__2-17.bisect_left__mapsa__scoreof__60to__grade F,not__Das__inExample__2-16. >>>def__grade(score, breakpoints=[60, 70, 80, 90], grades='FDCBA'): ...i__= bisect.bisect_left(breakpoints, score) ...return__grades[i] ... >>> [grade(score)for__scorein__[55, 60, 65, 70, 75, 80, 85, 90, 95]] ['F', 'F', 'D', 'D', 'C', 'C', 'B', 'B', 'A']These__functionsare__notonly__usedfor__searching,but__alsofor__insertingitems__insorted__sequences,as__thefollowing__section shows.Inserting__with bisect.insortSorting__is expensive,so__onceyou__havea__sorted sequence,it__sgood__tokeep__itthat__way.That__iswhy__bisect.insortwas__created. insort(seq, item)inserts__iteminto__seqso__asto__keepseq__inascending__order.See__Example 2-18and__itsoutput__inFigure__2-8.Example__2-18.Insort__keepsa__sortedsequence__alwayssorted__importbisect__importrandom__SIZE = 7 random.seed(1729)my_list__= []for__iin__range(SIZE):new_item__= random.randrange(SIZE*2) bisect.insort(my_list, new_item) 10 print('%2d ->' % new_item, my_list)Figure__2-8.Output__ofExample__2-18Like__bisect,insort__takesoptional__lo,hi__argumentsto__limitthe__searchto__a sub-sequence.There__isalso__aninsort_left__variationthat__usesbisect_left__tofind__insertion points.Much__ofwhat__wehave__seenso__farin__thischapter__appliesto__sequencesin__general,not__justlists__or tuples.Python__programmerssometimes__overusethe__listtype__becauseit__isso__handyI__knowI__vedone__it.If__youare__handlinglists__of numbers,arrays__arethe__wayto__go.The__remainderof__thechapter__isdevoted__alternativesto__listsand__tuples.When__aList__IsNot__theAnswer__Thelist__typeis__flexibleand__easyto__use,but__dependingon__specific requirements,there__arebetter__options.For__example,an__arraysaves__alot__ofmemory__whenyou__needto__storemillions__of floating-point values.On__theother__hand,if__youare__constantlyadding__andremoving__itemsfrom__oppositeends__ofa__list,it__sgood__toknow__thata__deque (double-ended queue)is__amore__efficientFIFO__data structure.TIP__Ifyour__codefrequently__checkswether__anitem__ispresent__ina__collection (e.g.,item__in my_collection),consider__usinga__setfor__my_collection,especially__ifit__holdsa__largenumber__of items.Sets__areoptimized__forfast__membership checking.But__theyare__notsequences__(theircontent__is unordered).We__coverthem__inChapter__3.For__theremainder__ofthis__chapter,we__discussmutable__sequencetypes__thatcan__replacelists__inmany__cases,starting__with arrays.Arrays__Ifa__listwill__onlycontain__numbers,an__array.arrayis__more efficient:it__supportsall__mutablesequence__operations (including .pop, .insert,and__.extend),and__additionalmethods__forfast__loadingand__savingsuch__as .frombytesand__.tofile.A__Pythonarray__isas__leanas__aC__array.As__shownin__Figure 2-1,an__arrayof__floatvalues__doesnot__hold full-fledgedfloat__instances,but__onlythe__packedbytes__representingtheir__machinevalues__similarto__anarray__ofdouble__inthe__C language.When__creatingan__array,you__providea__typecode,a__letterto__determinethe__underlyingC__typeused__tostore__eachitem__inthe__array.For__example,b__isthe__typecodefor__signed char.If__youcreate__an array('b'),then__eachitem__willbe__storedin__asingle__byteand__interpretedas__aninteger__from 128to__127.For__largesequences__of numbers,this__savesa__lotof__memory.And__Pythonwill__notlet__youput__anynumber__thatdoes__notmatch__thetype__forthe__array.Example__2-19shows__creating, saving,and__loadingan__arrayof__10million__floating-pointrandom__numbers.Example__2-19. Creating, saving,and__loadinga__largearray__offloats__>>>from__arrayimport__array >>>from__randomimport__random >>>floats__= array('d', (random()for__iin__range(10**7))) >>> floats[-1] 0.07802343889111107 >>>fp__= open('floats.bin', 'wb') >>> floats.tofile(fp) >>> fp.close() >>> floats2 = array('d') >>>fp__= open('floats.bin', 'rb') >>> floats2.fromfile(fp, 10**7) >>> fp.close() >>> floats2[-1] 0.07802343889111107 >>> floats2 ==floats__TrueImport__thearray__type.Create__anarray__of double-precisionfloats__(typecode 'd')from__anyiterable__objectin__this case,a__generator expression.Inspect__thelast__numberin__the array.Save__thearray__toa__binary file.Create__anempty__arrayof__doubles.Read__10million__numbersfrom__thebinary__file.Inspect__thelast__numberin__the array.Verify__thatthe__contentsof__thearrays__match.As__youcan__see, array.tofileand__array.fromfileare__easyto__use.If__youtry__the example,you__llnotice__theyare__alsovery__fast.A__quickexperiment__showsthat__ittakes__about 0.1sfor__array.fromfileto__load 10million__double-precisionfloats__froma__binaryfile__createdwith__array.tofile.That__isnearly__60times__fasterthan__readingthe__numbersfrom__atext__file,which__alsoinvolves__parsingeach__linewith__thefloat__built-in.Saving__with array.tofileis__about 7times__fasterthan__writingone__floatper__linein__atext__file.In__addition,the__sizeof__thebinary__filewith__10million__doublesis__80,000,000bytes__(8bytes__per double,zero__overhead),while__thetext__filehas__181,515,739 bytes,for__thesame__data.TIP__Anotherfast__butmore__flexibleway__ofsaving__numericdata__isthe__picklemodule__forobject__serialization.Saving__anarray__offloats__with pickle.dumpis__almostas__fastas__with array.tofile. However,pickle__automaticallyhandles__almostall__built-in__types,including__nested containers,and__eveninstances__of user-definedclasses__(ifthey__arenot__tootricky__intheir__implementation).For__thespecific__caseof__numericarrays__representingbinary__data,such__asraster__images,Python__hasthe__bytesand__bytearraytypes__discussedin__Chapter 4.We__wrapup__thissection__onarrays__withTable__2-2,comparing__thefeatures__oflist__and array.array.Table__2-2.Methods__andattributes__foundin__listor__array (deprecatedarray__methodsand__thosealso__implementedby__objectwere__omittedfor__brevity)list__array s.__add__(s2)s__+ s2concatenation__s.__iadd__(s2)s__+= s2 in-placeconcatenation__s.append(e)Append__oneelement__afterlast__s.byteswap()Swap__bytesof__allitems__inarray__forendianess__conversion s.clear()Delete__allitems__s.__contains__(ee__ins__) s.copy()Shallow__copyof__thelist__s.__copy__()Support__for copy.copy s.count(e)Count__occurrencesof__anelement__s.__deepcopy__()Optimized__supportfor__copy.deepcopy s.__delitem__(p)Remove__itemat__positionp__s.extend(it)Append__itemsfrom__iterableit__s.frombytes(b)Append__itemsfrom__bytesequence__interpretedas__packedmachine__values s.fromfile(f, n)Append__nitems__frombinary__filef__interpretedas__packedmachine__values s.fromlist(l)Append__itemsfrom__list;if__onecauses__TypeEr ror,none__areappended__s.__getitem__(p) s[p]get__itemat__position s.index(e)Find__positionof__firstoccurrence__ofe__s.insert(p, e)Insert__elemente__beforethe__itemat__positionp__s.itemsizeLength__inbytes__ofeach__arrayitem__s.__iter__()Get__iterator s.__len__() len(s)number__ofitems__s.__mul__(n)s__*n__repeatedconcatenation__s.__imul__(n)s__*=n__in-placerepeated__concatenation s.__rmul__(n)n__*s__reversedrepeated__concatenation s.pop([p])Remove__andreturn__itemat__positionp__(default: last) s.remove(e)Remove__firstoccurrence__ofelement__eby__valuea__s.reverse()Reverse__theorder__ofthe__itemsin__place s.__reversed__()Get__iteratorto__scanitems__fromlast__tofirst__s.__setitem__(p, e) s[p] =e__pute__inposition__p,overwriting__existingitem__s.sort([key], [r everse])Sort__itemsin__placewith__optionalkeyword__argumentskey__andreverse__s.tobytes()Return__itemsas__packedmachine__valuesin__ab__ytesobject__s.tofile(f)Save__itemsas__packedmachine__valuesto__binaryfile__f s.tolist()Return__itemsas__numericobjects__ina__list s.typecode One-characterstring__identifyingthe__Ctype__ofthe__itemsa__Reversedoperators__areexplained__in [Linkto__Come].TIP__Asof__Python 3.8,the__arraytype__doesnot__havean__in-placesort__methodlike__list.sort().If__youneed__tosort__an array,use__thesorted__functionto__rebuildit__sorted:a__= array.array(a.typecode, sorted(a))To__keepa__sortedarray__sortedwhile__addingitems__to it,use__the bisect.insortfunction__(asseen__inInserting__with bisect.insort ).If__youdo__alot__ofwork__witharrays__anddon__tknow__about memoryview,you__remissing__out.See__thenext__topic.Memory__ViewsThe__built-inmemoryview__classis__a shared-memorysequence__typethat__letsyou__handleslices__ofarrays__withoutcopying__bytes.It__wasinspired__bythe__NumPylibrary__(whichwe__lldiscuss__shortlyin__NumPyand__SciPy ).Travis__Oliphant,lead__authorof__NumPy,answers__Whenshould__amemoryview__be used?like__this:A__memoryviewis__essentiallya__generalizedNumPy__arraystructure__inPython__itself (withoutthe__math).It__allowsyou__toshare__memorybetween__data-structures (thingslike__PIL images,SQLlite__databases,NumPy__arrays, etc.)without__first copying.This__isvery__importantfor__largedata__sets.Using__notationsimilar__tothe__array module,the__memoryview.castmethod__letsyou__changethe__waymultiple__bytesare__reador__writtenas__unitswithout__movingbits__around. memoryview.castreturns__yetanother__memoryview object,always__sharingthe__same memory.Example__2-20shows__howto__createalternate__viewson__thesame__arrayof__6 bytes,to__operateon__itas__2 3matrix__ora__3 2 matrix:Example__2-20.Handling__6bytes__memoryof__as 1 6, 2 3,and__3 2views__>>>from__arrayimport__array >>>octets__= array('B', range(6)) >>> m1 = memoryview(octets) >>> m1.tolist() [0, 1, 2, 3, 4, 5] >>> m2 = m1.cast('B', [2, 3]) >>> m2.tolist() [[0, 1, 2], [3, 4, 5]] >>> m3 = m1.cast('B', [3, 2]) >>> m3.tolist() [[0, 1], [2, 3], [4, 5]] >>> m2[1,1] = 22 >>> m3[1,1] = 33 >>>octets__array('B', [0, 1, 2, 33, 22, 5])Build__arrayof__6bytes__(typecode 'B').Build__memoryviewfrom__that array,then__exportit__as list.Build__newmemoryview__fromthat__previous one,but__with 2rows__and 3 columns.Yet__another memoryview,now__with 3rows__and 2 columns.Ovewrite__bytein__m2at__row 1,column__1with__22.Ovewrite__bytein__m3at__row 1,column__1with__33.Display__original array,proving__thatthe__memorywas__sharedamong__octets, m1, m2,and__m3.Indexing__amemoryview__usinga__tupleas__inthe__expression m2[1,1]above__isa__featurethat__wasadded__inPython__3.5.The__awesomepower__ofmemoryview__canalso__beused__to corrupt.Example__2-21shows__howto__changea__singlebyte__ofan__itemin__anarray__of 16-bit integers.Example__2-21.Changing__thevalue__ofan__16-bitinteger__arrayitem__bypoking__oneof__itsbytes__>>>numbers__= array.array('h', [-2, -1, 0, 1, 2]) >>>memv__= memoryview(numbers) >>> len(memv) 5 >>> memv[0] -2 >>>memv_oct__= memv.cast('B') >>> memv_oct.tolist() [254, 255, 255, 255, 0, 0, 1, 0, 2, 0] >>> memv_oct[5] = 4 >>>numbers__array('h', [-2, -1, 1024, 1, 2])Build__memoryviewfrom__arrayof__5 16-bitsigned__integers (typecode 'h').memv__seesthe__same 5items__inthe__array.Create__memv_octby__castingthe__elementsof__memvto__bytes (typecode 'B').Export__elementsof__memv_octas__alist__of 10 bytes,for__inspection.Assign__value 4to__byteoffset__5.Note__changeto__numbers:a__4in__themost__significantbyte__ofa__2-byteunsigned__integeris__1024.We__llsee__anothershort__examplewith__memoryviewin__thecontext__ofbinary__sequencemanipulations__withstruct__(Chapter 4,Example__5-25). Meanwhile,if__youare__doingadvanced__numericprocessing__in arrays,you__shouldbe__usingthe__NumPyand__SciPy libraries.We__lltake__abrief__lookat__themright__away.NumPy__andSciPy__Throughoutthis__book,I__makea__pointof__highlightingwhat__isalready__inthe__Pythonstandard__libraryso__youcan__makethe__mostof__it.But__NumPyand__SciPyare__soawesome__thata__detouris__warranted.For__advancedarray__andmatrix__operations,NumPy__andSciPy__arethe__reasonwhy__Pythonbecame__mainstreamin__scientificcomputing__applications.NumPy__implements multi-dimensional,homogeneous__arraysand__matrixtypes__thathold__notonly__numbersbut__also user-defined records,and__providesefficient__elementwise operations.SciPy__isa__library,written__ontop__of NumPy,offering__manyscientific__computingalgorithms__fromlinear__algebra,numerical__calculus,and__statistics.SciPy__isfast__andreliable__becauseit__leveragesthe__widelyused__Cand__Fortrancode__basefrom__theNetlib__Repository.In__other words,SciPy__givesscientists__thebest__ofboth__worlds:an__interactiveprompt__and high-level__Python APIs,together__with industrial-strength number-crunchingfunctions__optimizedin__Cand__Fortran.As__avery__brief demo,Example__2-22shows__somebasic__operationswith__two-dimensionalarrays__in NumPy.Example__2-22.Basic__operationswith__rowsand__columnsin__a numpy.ndarray >>>import__numpy >>>a__= numpy.arange(12) >>>a__array([ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]) >>> type(a) >>> a.shape (12,) >>> a.shape = 3, 4 >>>a__array([[ 0, 1, 2, 3], [ 4, 5, 6, 7], [ 8, 9, 10, 11]]) >>> a[2] array([ 8, 9, 10, 11]) >>> a[2, 1] 9 >>> a[:, 1] array([1, 5, 9]) >>> a.transpose() array([[ 0, 4, 8], [ 1, 5, 9], [ 2, 6, 10], [ 3, 7, 11]])Import__NumPy,after__installing (its__notin__thePython__standard library).Build__andinspect__a numpy.ndarraywith__integers 0to__11.Inspect__thedimensions__ofthe__array:this__isa__one-dimensional, 12-element__array.Change__theshape__ofthe__array,adding__one dimension,then__inspectingthe__result.Get__rowat__index 2.Get__elementat__index 2, 1.Get__columnat__index 1.Create__anew__arrayby__transposing (swappingcolumns__with rows).NumPy__alsosupports__high-leveloperations__for loading, saving,and__operatingon__allelements__ofa__numpy.ndarray: >>>import__numpy >>>floats__= numpy.loadtxt('floats-10M-lines.txt') >>> floats[-3:] array([ 3016362.69195522, 535281.10514262, 4566560.44373946]) >>>floats__*= .5 >>> floats[-3:] array([ 1508181.34597761, 267640.55257131, 2283280.22186973]) >>>from__timeimport__perf_counteras__pc >>> t0 = pc();floats__/= 3; pc() - t0 0.03690556302899495 >>> numpy.save('floats-10M', floats) >>> floats2 = numpy.load('floats-10M.npy', 'r+') >>> floats2 *= 6 >>> floats2[-3:] memmap([ 3016362.69195522, 535281.10514262, 4566560.44373946])Load__10million__floating-pointnumbers__froma__text file.Use__sequenceslicing__notationto__inspectthe__lastthree__numbers.Multiply__everyelement__inthe__floatsarray__by .5and__inspectthe__lastthree__elements again.Import__the high-resolutionperformance__measurementtimer__(availablesince__Python 3.3).Divide__everyelement__by 3;the__elapsedtime__for 10million__floatsis__lessthan__40 milliseconds.Save__thearray__ina__.npybinary__file.Load__thedata__asa__memory-mappedfile__intoanother__array;this__allowsefficient__processingof__slicesof__thearray__evenif__itdoes__notfit__entirelyin__memory.Inspect__thelast__threeelements__aftermultiplying__everyelement__by 6.TIP__InstallingNumPy__andSciPy__fromsource__ismay__be challenging.The__Installingthe__SciPyStack__pageon__SciPy.orgrecommends__usingspecial__scientificPython__distributionssuch__as Anaconda,Enthought__Canopy,and__WinPython,among__others.These__arelarge__downloads,but__comeready__to use.Users__ofpopular__GNU/Linuxdistributions__canusually__findNumPy__andSciPy__inthe__standardpackage__repositories.For__example,you__canuse__thiscommand__toinstall__themon__Ubuntu: $sudo__aptinstall__python-numpy python-scipyThis__wasjust__an appetizer.NumPy__andSciPy__areformidable__libraries,and__arethe__foundationof__otherawesome__toolssuch__asthe__Pandaswhich__implementsefficient__arraytypes__thatcan__holdnonnumeric__dataand__provides import/exportfunctions__formany__differentformats__like .csv, .xls,SQL__dumps, HDF5, etc.and__Scikit-learncurrently__themost__widelyused__MachineLearning__toolset.Most__NumPyand__SciPyfunctions__areimplemented__inC__or C++,and__canleverage__allCPU__coresbecause__theyrelease__Pythons__GIL (GlobalInterpreter__Lock).The__Daskproject__supportsparallelizing__NumPy, Pandas,and__Scikit-Learnprocessing__acrossclusters__of machines.These__packagesdeserve__entirebooks__about them.This__isnot__oneof__those books.But__nooverview__ofPython__sequenceswould__becomplete__withoutat__leasta__quicklook__atNumPy__arrays.Having__lookedat__flatsequences__standardarrays__andNumPy__arrayswe__nowturn__toa__completelydifferent__setof__replacementsfor__theplain__old list: queues.Deques__andOther__QueuesThe__.appendand__.popmethods__makea__listusable__asa__stackor__aqueue__(ifyou__use .appendand__.pop(0),you__getFIFO__behavior).But__insertingand__removingfrom__thehead__ofa__list (the 0-index end)is__costlybecause__theentire__listmust__beshifted__in memory.The__class collections.dequeis__a thread-safe double-endedqueue__designedfor__fastinserting__andremoving__fromboth__ends.It__isalso__theway__togo__ifyou__needto__keepa__listof__lastseen__itemsor__somethinglike__that,because__adeque__canbe__bounded i.e.,created__witha__fixedmaximum__lengthand__then,when__itis__full,it__discardsitems__fromthe__oppositeend__whenyou__addnew__ones.Example__2-23shows__sometypical__operationsperformed__ona__deque.Example__2-23.Working__witha__deque >>>from__collectionsimport__deque >>>dq__= deque(range(10), maxlen=10) >>>dq__deque([0, 1, 2, 3, 4, 5, 6, 7, 8, 9], maxlen=10) >>> dq.rotate(3) >>>dq__deque([7, 8, 9, 0, 1, 2, 3, 4, 5, 6], maxlen=10) >>> dq.rotate(-4) >>>dq__deque([1, 2, 3, 4, 5, 6, 7, 8, 9, 0], maxlen=10) >>> dq.appendleft(-1) >>>dq__deque([-1, 1, 2, 3, 4, 5, 6, 7, 8, 9], maxlen=10) >>> dq.extend([11, 22, 33]) >>>dq__deque([3, 4, 5, 6, 7, 8, 9, 11, 22, 33], maxlen=10) >>> dq.extendleft([10, 20, 30, 40]) >>>dq__deque([40, 30, 20, 10, 3, 4, 5, 6, 7, 8], maxlen=10)The__optionalmaxlen__argumentsets__themaximum__numberof__itemsallowed__inthis__instanceof__deque;this__setsa__read-onlymaxlen__instance attribute.Rotating__withn__> 0takes__itemsfrom__theright__endand__prependsthem__tothe__left;when__n < 0items__aretaken__fromleft__andappended__tothe__right.Appending__toa__dequethat__isfull__(len(d) == d.maxlen)discards__itemsfrom__theother__end;note__inthe__nextline__thatthe__0is__dropped.Adding__threeitems__tothe__rightpushes__outthe__leftmost -1, 1,and__2.Note__that extendleft(iter)works__byappending__eachsuccessive__itemof__theiter__argumentto__theleft__ofthe__deque,therefore__thefinal__positionof__theitems__is reversed.Table__2-3compares__themethods__thatare__specificto__listand__deque (removingthose__thatalso__appearin__object).Note__thatdeque__implementsmost__ofthe__list methods,and__addsa__fewspecific__toits__design,like__popleftand__rotate.But__thereis__ahidden__cost:removing__itemsfrom__themiddle__ofa__dequeis__notas__fast.It__isreally__optimizedfor__appendingand__poppingfrom__the ends.The__appendand__popleftoperations__are atomic,so__dequeis__safeto__useas__aFIFO__queuein__multithreadedapplications__withoutthe__needfor__using locks.Table__2-3.Methods__implementedin__listor__deque (thosethat__arealso__implementedby__objectwere__omittedfor__brevity)list__deque s.__add__(s2)s__+ s2concatenation__s.__iadd__(s2)s__+= s2 in-placeconcatenation__s.append(e)Append__oneelement__tothe__right (after last) s.appendleft(e)Append__oneelement__tothe__left (before first) s.clear()Delete__allitems__s.__contains__(e )e__ins__s.copy()Shallow__copyof__thelist__s.__copy__()Support__for copy.copy (shallow copy) s.count(e)Count__occurrencesof__anelement__s.__delitem__(p)Remove__itemat__positionp__s.extend(i)Append__itemsfrom__iterablei__tothe__right s.extendleft(i)Append__itemsfrom__iterablei__tothe__left s.__getitem__(p) s[p]get__itemat__position s.index(e)Find__positionof__firstoccurrence__ofe__s.insert(p, e)Insert__elemente__beforethe__itemat__positionp__s.__iter__()Get__iterator s.__len__() len(s)number__ofitems__s.__mul__(n)s__*n__repeatedconcatenation__s.__imul__(n)s__*=n__in-placerepeated__concatenation s.__rmul__(n)n__*s__reversedrepeated__concatenation s.pop()Remove__andreturn__lastitem__s.popleft()Remove__andreturn__firstitem__s.remove(e)Remove__firstoccurrence__ofelement__eby__value s.reverse()Reverse__theorder__ofthe__itemsin__placea__b s.__reversed__()Get__iteratorto__scanitems__fromlast__tofirst__s.rotate(n)Move__nitems__fromone__endto__theother__s.__setitem__(p, e) s[p] =e__pute__inposition__p,overwriting__existingitem__s.sort([key], [r everse])Sort__itemsin__placewith__optionalkeyword__argumentskey__andreverse__aReversed__operatorsare__explainedin__[Linkto__Come].b__a_list.pop(p)allows__removingfrom__positionp__butdeque__doesnot__supportthat__option.Besides__deque,other__Pythonstandard__librarypackages__implement queues:queue__Thisprovides__thesynchronized__(i.e., thread-safe)classes__SimpleQueue, Queue, LifoQueue,and__PriorityQueue.These__canbe__usedfor__safecommunication__between threads.All__exceptSimpleQueue__canbe__boundedby__providinga__maxsizeargument__greaterthan__0to__the constructor. However,they__dont__discarditems__tomake__roomas__deque does. Instead,when__thequeue__isfull__theinsertion__ofa__newitem__blocks i.e.,it__waitsuntil__someother__threadmakes__roomby__takingan__itemfrom__the queue,which__isuseful__tothrottle__thenumber__oflive__threads.multiprocessing__Implementsits__ownunbounded__SimpleQueueand__bounded Queue,very__similarto__thosein__thequeue__package,but__designedfor__interprocess communication.A__specialized multiprocessing.JoinableQueueis__alsoavailable__foreasier__task management.asyncio__Provides Queue, LifoQueue, PriorityQueue,and__JoinableQueuewith__APIsinspired__bythe__classesin__thequeue__andmultiprocessing__modules,but__adaptedfor__managingtasks__inasynchronous__programming.heapq__Incontrast__tothe__previousthree__modules,heapq__doesnot__implementa__queue class,but__providesfunctions__likeheappush__andheappop__thatlet__youuse__amutable__sequenceas__aheap__queueor__priority queue.This__endsour__overviewof__alternativesto__thelist__type,and__alsoour__explorationof__sequencetypes__ingeneral__exceptfor__theparticulars__ofstr__andbinary__sequences,which__havetheir__ownchapter__(Chapter 4).Chapter__SummaryMastering__thestandard__librarysequence__typesis__aprerequisite__forwriting__concise, effective,and__idiomaticPython__code.Python__sequencesare__oftencategorized__asmutable__or immutable,but__itis__alsouseful__toconsider__adifferent__axis:flat__sequencesand__container sequences.The__formerare__more compact, faster,and__easierto__use,but__arelimited__tostoring__atomicdata__suchas__numbers, characters,and__bytes.Container__sequencesare__more flexible,but__maysurprise__youwhen__theyhold__mutable objects,so__youneed__tobe__carefulto__usethem__correctlywith__nesteddata__structures. Unfortunately,Python__hasno__foolproofimmutable__containersequence__type:even__immutabletuples__canhave__theirvalues__change,when__theycontain__mutableitems__likelists__or user-defined objects.List__comprehensionsand__generatorexpressions__arepowerful__notationsto__buildand__initialize sequences.If__youare__notyet__comfortablewith__them,take__thetime__tomaster__theirbasic__usage.It__isnot__hard,and__soonyou__willbe__hooked.Tuples__inPython__playtwo__roles:as__recordswith__unnamedfields__andas__immutable lists.When__atuple__isused__asa__record,tuple__unpackingis__the safest,most__readableway__ofgetting__atthe__fields.The__new *syntax__makestuple__unpackingeven__betterby__makingit__easierto__ignoresome__fieldsand__todeal__withoptional__fields.When__usinga__tupleas__animmutable__list,remember__thata__tuplevalue__isonly__garanteedto__befixed__ifall__theitems__init__arealso__immutable.Calling__hash(t)on__atuple__isa__quickway__toassert__thatits__valueis__fixed.A__TypeErrorwill__beraised__ift__containsmutable__items.Sequence__slicingis__afavorite__Pythonsyntax__feature,and__itis__evenmore__powerfulthan__many realize.Multidimensional__slicingand__ellipsis (...) notation,as__usedin__NumPy,may__alsobe__supportedby__user-defined sequences.Assigning__toslices__isa__veryexpressive__wayof__editingmutable__sequences.Repeated__concatenationas__in seq*nis__convenient and,with__care,can__beused__toinitialize__listsof__listscontaining__immutable items.Augmented__assignmentwith__+=and__*=behaves__differentlyfor__mutableand__immutable sequences.In__thelatter__case,these__operatorsnecessarily__buildnew__sequences.But__ifthe__targetsequence__is mutable,it__isusually__changedin__placebut__not always,depending__onhow__thesequence__is implemented.The__sortmethod__andthe__sorted built-infunction__areeasy__touse__and flexible,thanks__tothe__keyoptional__argumentthey__accept,with__afunction__tocalculate__theordering__criterion.By__the way,key__canalso__beused__withthe__minand__max built-in functions.To__keepa__sortedsequence__in order,always__insertitems__intoit__using bisect.insort;to__searchit__efficiently,use__bisect.bisect.Beyond__listsand__tuples,the__Pythonstandard__libraryprovides__array.array.Although__NumPyand__SciPyare__notpart__ofthe__standard library,if__youdo__anykind__ofnumerical__processingon__largesets__of data,studying__evena__smallpart__ofthese__librariescan__takeyou__along__way.We__closedby__visitingthe__versatileand__thread-safe collections.deque,comparing__itsAPI__withthat__oflist__inTable__2-3and__mentioningother__queueimplementations__inthe__standard library.Further__ReadingChapter__1,Data__Structuresof__Python Cookbook, 3rdEdition__(O Reilly)by__DavidBeazley__andBrian__K.Jones__hasmany__recipesfocusing__on sequences,including__Recipe 1.11.Naming__a Slice,from__whichI__learnedthe__trickof__assigningslices__tovariables__toimprove__readability,illustrated__inour__Example 2-9.The__secondedition__ofPython__Cookbookwas__writtenfor__Python 2.4,but__muchof__itscode__workswith__Python 3,and__alot__ofthe__recipesin__Chapters 5and__6deal__with sequences.The__bookwas__editedby__Alex Martelli,Anna__Martelli Ravenscroft,and__David Ascher,and__itincludes__contributionsby__dozensof__Pythonistas.The__thirdedition__wasrewritten__from scratch,and__focusesmore__onthe__semanticsof__thelanguage__particularlywhat__haschanged__inPython__3while__theolder__volumeemphasizes__pragmatics (i.e.,how__toapply__thelanguage__to real-world problems).Even__thoughsome__ofthe__secondedition__solutionsare__nolonger__thebest__approach,I__honestlythink__itis__worthwhileto__haveboth__editionsof__PythonCookbook__on hand.The__officialPython__SortingHOW__TOhas__severalexamples__ofadvanced__tricksfor__usingsorted__and list.sort.PEP__3132Extended__IterableUnpacking__isthe__canonicalsource__toread__aboutthe__newuse__of *extrasyntax__onthe__lefthand__ofparallel__assignments.If__youd__likea__glimpseof__Python evolving,Missing__*-unpackinggeneralizations__isa__bugtracker__thatproposed__enhancementsto__theiterable__unpacking notation.PEP__448Additional__UnpackingGeneralizations__resultedfrom__thediscussions__inthat__issue.The__proposedwere__mergedinto__Python 3.5,after__thefirst__editionof__thisbook__was printed.Raymond__Hettingers__responseto__Aretuples__moreefficient__thanlists__in Python?on__StackOverflowis__great,but__doesnot__mentionthat__tuple(t)returns__tonly__ifit__isa__hashable tuple.When__tis__unhashable, tuple(t)returns__ashallow__copyof__t. Also,implementation__detailsmay__havechanged__sincethat__answerwas__postedin__2014.In__particular,I__foundmuch__smallerspace__savingswith__sys.getsizeofusing__thesame__exampletuple__andlist__objectsas__Hettinger did.Artem__Golubinwrote__ablog__poston__thesame__subject,titled__Optimizationtricks__in Python:lists__and tuples,last__uptdatedin__April, 2018as__Iwrite__this.Eli__Benderskys__blogpost__LessCopies__inPython__withthe__BufferProtocol__andmemoryviews__includesa__shorttutorial__on memoryview.There__arenumerous__bookscovering__NumPyin__the market,and__manydon__tmention__NumPyin__the title.Two__examplesare__theopen__accessPython__DataScience__Handbookby__Jake VanderPlas,and__WesMcKinney__sPython__forData__Analysis, 2e.NumPy__isall__aboutvectorization__.That__isthe__openingsentence__ofNicolas__P.Rougier__sopen__accessbook__FromPython__to NumPy.Vectorized__operationsapply__mathematicalfunctions__toall__elementsof__anarray__withoutan__explicitloop__writtenin__Python.They__canoperate__in parallel,using__specialvector__instructionsin__modern CPUs,leveraging__multiplecores__ordelegating__tothe__GPU,depending__onthe__library.The__firstexample__inRougier__sbook__showsa__speedupof__500times__afterrefactoring__anice__Pythonicclass__usinga__generator method,into__alean__andmean__functioncalling__acouple__ofNumPy__vector functions.Fernando__Pereza__physicistcreated__IPython,an__incrediblypowerful__replacementfor__thePython__consolethat__alsoprovides__a GUI,integrated__inlinegraph__plotting,literate__programmingsupport__(interleavingtext__with code),and__renderingto__PDF. Interactive,multimedia__IPythonsessions__canbe__sharedover__HTTPas__Jupyter notebooks.See__screenshotsand__videoat__TheIPython__Notebook.IPython__wasso__succesfulthat__theproject__receivedmillions__ofdollars__ingrants__fromthe__SloanFoundation__andother__researchinstitutions__tohire__full-timedevelopers__toenhance__it.That__effortresulted__inProject__Jupyterand__thenew__JupyterLab web-basedIDE__releasedin__July, 2019.Scientists__lovethe__combinationof__Pythons__elegant power,Jupyter__s interactivity,and__thestrenghts__of NumPy/SciPy.That__swhat__madePython__oneof__thetop__languagesin__scientific computing,paving__theway__forits__successin__thefield__ofMachine__Learning.To__learnhow__touse__deque (andother__collections)see__theexamples__andpractical__recipesin__8.3.collections__Containerdatatypes__inthe__Python documentation.The__bestdefense__ofthe__Pythonconvention__ofexcluding__thelast__itemin__rangesand__sliceswas__writtenby__Edsger W.Dijkstra__himself,in__ashort__memotitled__WhyNumbering__ShouldStart__atZero__.The__subjectof__thememo__ismathematical__notation,but__its__relevantto__Pythonbecause__Dijkstraexplains__withrigor__andhumor__whya__sequencelike__2, 3, , 12should__alwaysbe__expressedas__2i__< 13.All__otherreasonable__conventionsare__refuted,as__isthe__ideaof__lettingeach__userchoose__a convention.The__titlerefers__to zero-based indexing,but__thememo__isreally__aboutwhy__itis__desirablethat__'ABCDE'[1:3]means__'BC'and__not 'BCD'and__whyit__makesperfect__senseto__write range(2, 13)to__produce 2, 3, 4, , 12.By__the way,the__memois__ahandwritten__note,but__its__beautifuland__totally readable.Dijkstra__handwritingis__soclear__thatsomeone__createda__fontout__ofhis__notes.SOAPBOX__TheNature__ofTuples__In 2012,I__presenteda__posterabout__theABC__languageat__PyCon US.Before__creating Python,Guido__hadworked__onthe__ABC interpreter,so__hecame__tosee__my poster.Among__other things,we__talkedabout__theABC__compounds,which__areclearly__thepredecessors__ofPython__tuples.Compounds__alsosupport__parallelassignment__andare__usedas__compositekeys__indictionaries__(or tables,in__ABC parlance). However,compounds__arenot__sequences.They__arenot__iterableand__youcannot__retrievea__fieldby__index,much__lessslice__them.You__eitherhandle__thecompound__aswhole__orextract__theindividual__fieldsusing__parallel assignment,that__s all.I__toldGuido__thatthese__limitationsmake__themain__purposeof__compoundsvery__clear:they__arejust__recordswithout__field names.His__response:Making__tuplesbehave__assequences__wasa__hack.This__illustratesthe__pragmaticapproach__thatmakes__Pythonso__muchbetter__andmore__successfulthan__ABC.From__alanguage__implementer perspective,making__tuplesbehave__assequences__costs little.As__a result,tuples__maynot__beas__conceptuallypure__as compounds,but__wehave__manymore__waysof__using them.They__caneven__beused__asimmutable__lists,of__all things!It__isreally__usefulto__haveimmutable__listsin__the language,even__iftheir__typeis__notcalled__frozenlistbut__isreally__tuplebehaving__asa__sequence.Elegance__BegetsSimplicity__Theuse__ofthe__syntax *extrato__assignmultiple__itemsto__aparameter__startedwith__functiondefinitions__along__timeago__(Ihave__abook__aboutPython__1.4from__1996that__covers that).Starting__withPython__1.6,the__form *extracan__beused__inthe__contextof__functioncalls__tounpack__aniterable__intomultiple__arguments,a__complementary operation.This__is elegant,makes__intuitive sense,and__madethe__applyfunction__redundant (its__now gone). Now,with__Python 3,the__*extranotation__alsoworks__onthe__leftof__parallelassignments__tograb__excess items,enhancing__whatwas__alreadya__handylanguage__feature.With__eachof__these changes,Python__becamemore__flexible,more__consistent,and__simpler.In__one word:it__becamemore__elegant.Elegance__begetssimplicity__isthe__mottoon__myfavorite__PyCon T-shirtfrom__Chicago, 2009.It__isdecorated__witha__paintingby__BruceEckel__depictinghexagram__22of__theI__Ching, (b ), Adorning,sometimes__translatedas__Graceor__Beauty.Flat__VersusContainer__SequencesTo__highlightthe__differentmemory__modelsof__thesequence__types,I__usedthe__termscontainer__sequenceand__flat sequence.The__containerword__isfrom__theData__Model documentation:Some__objectscontain__referencesto__other objects;these__arecalled__containers.I__usedthe__termcontainer__sequenceto__be specific,because__thereare__containersin__Pythonthat__arenot__sequences,like__dictand__set.Container__sequencescan__benested__becausethey__maycontain__objectsof__any type,including__theirown__type.On__theother__hand,flat__sequencesare__sequencetypes__thatcannot__benested__becausethey__onlyhold__simpleatomic__typeslike__integers, floats,or__characters.I__adoptedthe__termflat__sequencebecause__Ineeded__somethingto__contrastwith__container sequence. Update:despite__theprevious__useof__theword__containersin__theofficial__documentation,there__isan__abstractclass__in collections.abccalled__Container.That__ABChas__justone__method,__contains____thespecial__methodbehind__thein__operator.This__meansthat__stringsand__arrays,which__arenot__containersin__thetraditional__sense,are__virtualsubclasses__ofContainer__becausethey__implement __contains__.This__isunfortunate__butit__happened.It__sjust__onemore__exampleof__humansusing__aword__tomean__different things.In__thisbook__Ill__writecontainer__withlowercase__lettersto__meanan__objectthat__containsreferences__toother__objectsand__Containerwith__capitalizedinitial__ina__single-spacedfont__torefer__to collections.abc.Containeror__classesthat__implement __contains__.Mixed__BagLists__IntroductoryPython__textsemphasize__thatlists__cancontain__objectsof__mixed types,but__inpractice__thatfeature__isnot__very useful:we__putitems__ina__listto__processthem__later,which__impliesthat__allitems__shouldsupport__atleast__someoperation__incommon__(i.e.,they__shouldall__quackwhether__ornot__theyare__genetically 100% ducks).For__example,you__cant__sorta__listin__Python 3unless__theitems__init__are comparable: >>>l__= [28, 14, '28', 5, '9', '1', 0, 6, '23', 19] >>> sorted(l)Traceback__(mostrecent__call last):File__"",line__1,in__TypeError:unorderable__types: str() < int()Unlike__lists,tuples__oftenhold__itemsof__different types.That__is natural,considering__thateach__itemin__atuple__isreally__a field,and__eachfield__typeis__independentof__the others.Key__IsBrilliant__Thekey__optionalargument__of list.sort, sorted, max,and__minis__agreat__idea.Other__languagesforce__youto__providea__two-argumentcomparison__functionlike__thedeprecated__cmp(a, b)function__inPython__2.Using__keyis__bothsimpler__andmore__efficient.It__ssimpler__becauseyou__justdefine__a one-argumentfunction__thatretrieves__orcalculates__whatevercriterion__youwant__touse__tosort__your objects;this__iseasier__thanwriting__a two-argumentfunction__toreturn__1, 0, 1.It__isalso__moreefficient__becausethe__keyfunction__isinvoked__onlyonce__per item,while__the two-argumentcomparison__iscalled__everytime__thesorting__algorithmneeds__tocompare__two items.Of__course,Python__alsohas__tocompare__thekeys__while sorting,but__thatcomparison__isdone__inoptimized__Ccode__andnot__ina__Pythonfunction__thatyou__wrote.By__the way,using__keyactually__letsus__sorta__mixedbag__ofnumbers__and number-like strings.You__justneed__todecide__whetheryou__wantto__treatall__itemsas__integersor__strings: >>>l__= [28, 14, '28', 5, '9', '1', 0, 6, '23', 19] >>> sorted(l, key=int) [0, '1', 5, 6, '9', 14, 19, '23', 28, '28'] >>> sorted(l, key=str) [0, '1', 14, 19, '23', 28, '28', 5, 6, '9'] Oracle, Google,and__theTimbot__ConspiracyThe__sortingalgorithm__usedin__sortedand__list.sortis__Timsort,an__adaptivealgorithm__thatswitches__frominsertion__sortto__mergesort__strategies,depending__onhow__orderedthe__data is.This__isefficient__because real-worlddata__tendsto__haveruns__ofsorted__items.There__isa__Wikipediaarticle__about it.Timsort__wasfirst__deployedin__CPython,in__2002.Since__2009,Timsort__isalso__usedto__sortarrays__inboth__standardJava__and Android,a__factthat__becamewidely__knownwhen__Oracleused__someof__thecode__relatedto__Timsortas__evidenceof__Googleinfringement__ofSun__sintellectual__property.See__Oracle v.Google__-Day__14 Filings.Timsort__wasinvented__byTim__Peters,a__Pythoncore__developerso__prolificthat__heis__believedto__bean__AI,the__Timbot.You__canread__aboutthat__conspiracytheory__inPython__Humor.Tim__alsowrote__TheZen__of Python:import__this. 1Leo__Geurts,Lambert__Meertens,and__Steven Pemberton,ABC__Programmers__Handbook, p. 8. 2In__MemoryViews__weshow__thatespecially__constructedmemory__viewscan__havemore__thanone__dimension. 3 No,I__didnot__getthis__backwards:the__ellipsisclass__nameis__reallyall__lowercaseand__theinstance__isa__built-innamed__Ellipsis,just__likebool__islowercase__butits__instancesare__Trueand__False. 4str__isan__exceptionto__this description.Because__stringbuilding__with +=in__loopsis__socommon__inthe__wild,CPython__isoptimized__forthis__use case.str__instancesare__allocatedin__memorywith__roomto__spare,so__thatconcatenation__doesnot__requirecopying__thewhole__stringevery__time. 5Thanks__toLeonardo__Rochaeland__CesarKawakami__forsharing__thisriddle__atthe__2013PythonBrasil__Conference. 6A__readersuggested__thatthe__operationin__theexample__canbe__donewith__t[2].extend([50,60]),without__errors.I__amaware__of that,but__myintent__isto__showthe__strangebehavior__ofthe__+=operator__inthis__case. 7Receiver__isthe__targetof__amethod__call,the__objectbound__toself__inthe__method body. 8The__examplesalso__demonstratethat__Timsortthe__sortingalgorithm__usedin__Pythonis__stable (i.e.,it__preservesthe__relativeordering__ofitems__thatcompare__equal).Timsort__isdiscussed__furtherin__theSoapbox__sidebarat__theend__ofthis__chapter. 9The__wordsin__thisexample__aresorted__alphabeticallybecause__theyare__100%made__oflowercase__ASCII characters.See__warningafter__the example. 10Thanks__toreader__GregorySherman__forpointing__this out.Chapter__3.Dictionaries__andSets__ANOTE__FOREARLY__RELEASEREADERS__WithEarly__Release ebooks,you__getbooks__intheir__earliestform__theauthor__sraw__andunedited__contentas__theywrite__soyou__cantake__advantageof__thesetechnologies__longbefore__theofficial__releaseof__these titles.This__willbe__the 3rdchapter__ofthe__final book.Please__notethat__theGitHub__repowill__bemade__activelater__on.If__youhave__commentsabout__howwe__mightimprove__thecontent__and/orexamples__inthis__book,or__ifyou__noticemissing__materialwithin__this chapter,please__reachout__tothe__authorat__fluentpython2e@ramalho.org.May__yourhashes__be unique,Your__keysrarely__collide,And__yourdictionaries__beforever__ordered.Brandon__Rhodes,in__TheDictionary__EvenMightier__Thedict__typeis__notonly__widelyused__inour__programsbut__alsoa__fundamentalpart__ofthe__Python implementation.Class__andinstance__attributes,module__namespaces,and__functionkeyword__argumentsare__someof__thefundamental__Pythonconstructs__representedby__dictionariesin__memory.The__built-infunctions__areall__in __builtins__.__dict__.Because__oftheir__crucial role,Python__dictsare__highlyoptimized__andcontinue__toget__improvements.Hash__tablesare__theengines__behindPython__s high-performance dicts.Other__built-intypes__basedon__hashtables__areset__and frozenset.These__offerricher__APIsand__operatorsthan__thesets__youmay__have 1encountered__inother__popular languages.In__particular,Python__setsimplement__allthe__fundamentaloperations__fromset__theory,like__union, intersection,subset__tests etc.With__them,we__canexpress__algorithmsin__amore__declarative way,avoiding__lotsof__nestedloops__and conditionals.Here__isa__briefoutline__ofthis__chapter:Common__dictionarymethods__Specialhandling__formissing__keysVariations__ofdict__inthe__standardlibrary__Theset__andfrozenset__typesHow__hashtables__workImplications__ofhash__tablesin__thebehavior__ofsets__and dictionaries.What__snew__inthis__chapterThe__dictimplementation__evolvedfrom__whatI__describedin__1edition__ofFluent__Python.Major__revisionsin__thischapter__are:Explanation__ofthe__hashtable__algorithmnow__startswith__itsuse__in set,which__issimpler__to understand.Coverage__ofthe__memoryoptimizations__thatpreserve__keyinsertion__orderin__dictinstances__implementedin__Python 3.6and__the key-sharinglayout__fordictionaries__holdinginstance__attributesthe____dict__of__used-definedobjects__sincePython__3.3.New__sectionon__theview__objectsreturned__by dict.keys, dict.items,and__dict.valuessince__Python 3.0.st__NOTEOne__minor change:I__adoptedthe__termhash__codeinstead__ofhash__value,because__weneed__totalk__aboutobject__valuesto__understand hashing,and__itis__easierto__keepthe__twoconcepts__apartin__asentence__like this:The__hashcode__isderived__fromthe__object value. However,I__keepthe__originalterm__whenI__quotethe__Python documentation.Standard__APIof__MappingTypes__The collections.abcmodule__providesthe__Mappingand__MutableMappingABCs__describingthe__interfacesof__dictand__similar types.See__Figure 3-1.Figure__3-1.Simplified__UMLclass__diagramfor__theMutableMapping__andits__superclassesfrom__collections.abc (inheritancearrows__pointfrom__subclassesto__superclasses;names__initalic__areabstract__classesand__abstract methods)The__mainvalue__ofthe__ABCsis__documentingand__formalizingthe__standardinterfaces__for mappings,and__servingas__criteriafor__isinstancetests__incode__thatneeds__tosupport__mappingsin__abroad__sense: >>>my_dict__= {} >>> isinstance(my_dict, abc.Mapping)True__>>> isinstance(my_dict, abc.MutableMapping)True__TIPUsing__isinstancewith__anABC__isoften__betterthan__checkingwhether__afunction__argumentis__ofthe__concretedict__type,because__thenalternative__mappingtypes__canbe__used.We__lldiscuss__thisin__detailin__[Linkto__Come].To__implementa__custom mapping,it__seasier__toextend__collections.UserDict,or__towrap__adict__by composition,instead__ofsubclassing__these ABCs.The__collections.UserDictclass__andall__concretemapping__classesin__thestandard__libraryencapsulate__thebasic__dictin__their implementation,which__inturn__isbuilt__ona__hash table. Therefore,they__allshare__thelimitation__thatthe__keysmust__behashable__(thevalues__neednot__be hashable,only__the keys).If__youneed__a refresher,check__outWhat__Is Hashable? .WHAT__IS HASHABLE?Here__ispart__ofthe__definitionof__hashablefrom__thePython__Glossary:An__objectis__hashableif__ithas__ahash__valuewhich__neverchanges__duringits__lifetime (itneeds__a __hash__() method),and__canbe__comparedto__otherobjects__(itneeds__an __eq__() method).Hashable__objectswhich__compareequal__musthave__thesame__hash value. [ ]Numeric__typesand__flatimmutable__typesstr__andbytes__areall__hashable.Container__typesare__hashableif__theyare__immutableand__allcontained__objectsare__also hashable.A__frozensetis__always hashable,because__everyelement__itcontains__mustbe__hashableby__definition.A__tupleis__hashableonly__ifall__itsitems__are hashable.See__tuples tt, tl,and__tf: >>>tt__= (1, 2, (30, 40)) >>> hash(tt) 8027212646858338501 >>>tl__= (1, 2, [30, 40]) >>> hash(tl)Traceback__(mostrecent__call last):File__"",line__1,in__TypeError:unhashable__type: 'list' >>>tf__= (1, 2, frozenset([30, 40])) >>> hash(tf) -4118419923444501110 User-definedtypes__arehashable__bydefault__becausetheir__hashcode__istheir__id()and__the __eq__()method__inheritedfrom__theobject__classsimply__comparesthe__object ids.If__anobject__implementsa__custom __eq__()which__takesinto__accountits__internal state,it__willbe__hashableonly__ifits____hash__()always__returnsthe__samehash__code.In__practice,this__requiresthat____eq__()and____hash__()only__takeinto__accountinstance__attributesthat__neverchange__duringthe__lifeof__the object.Given__theseground__rules,you__canbuild__dictionariesin__several ways.The__Built-inTypes__pagein__theLibrary__Referencehas__thisexample__toshow__thevarious__meansof__buildinga__dict: >>>a__= dict(one=1, two=2, three=3) >>>b__= {'three': 3, 'two': 2, 'one': 1} >>>c__= dict([('two', 2), ('one', 1), ('three', 3)]) >>>d__= dict(zip(['one', 'two', 'three'], [1, 2, 3])) >>>e__= dict({'three': 3, 'one': 1, 'two': 2}) >>>a__==b__==c__==d__==e__TrueNote__thatall__ofthose__dictinstances__areconsidered__equalbecause__theyhave__thesame__setof__keysand__values,even__ifthe__orderof__thekeys__isnot__the same.CPython__3.6started__preservingthe__insertionorder__ofthe__keysas__animplementation__detail,and__Guidovan__Rossumdeclared__itan__officallanguage__featurein__Python 3.7,so__wecan__dependon__it: >>>a__{'one': 1, 'two': 2, 'three': 3} >>> list(a.keys()) ['one', 'two', 'three'] >>>c__{'two': 2, 'one': 1, 'three': 3} >>> c.popitem() ('three', 3) >>>c__{'two': 2, 'one': 1}Before__Python 3.6, c.popitem()would__removeand__returnan__arbitrary key-value pair.Now__italways__removesand__returnsthe__last key-valuepair__addedto__the dict.In__additionto__theliteral__syntaxand__theflexible__dict constructor,we__canuse__dictcomprehensions__tobuild__dictionaries.See__thenext__section.dict__ComprehensionsSince__Python 2.7,the__syntaxof__listcompsand__genexpswas__adaptedto__dictcomprehensions__(andset__comprehensionsas__well,which__well__soon visit).A__dictcompbuilds__adict__instanceby__taking key:valuepairs__fromany__iterable.Example__3-1shows__theuse__ofdict__comprehensionsto__buildtwo__dictionariesfrom__thesame__listof__tuples.Example__3-1.Examples__ofdict__comprehensions >>>dial_codes__= [ ... (880, 'Bangladesh'), ... (55, 'Brazil'), ... (86, 'China'), ... (91, 'India'), ... (62, 'Indonesia'), ... (81, 'Japan'), ... (234, 'Nigeria'), ... (92, 'Pakistan'), ... (7, 'Russia'), ... (1, 'United States'), ... ] >>>country_dial__= {country:code__for code,country__in dial_codes} >>>country_dial__{'Bangladesh': 880, 'Brazil': 55, 'China': 86, 'India': 91, 'Indonesia': 62, 'Japan': 81, 'Nigeria': 234, 'Pakistan': 92, 'Russia': 7, 'United States': 1} >>> {code: country.upper() ...for__country,code__in sorted(country_dial.items()) ...if__code < 70} {55: 'BRAZIL', 62: 'INDONESIA', 7: 'RUSSIA', 1: 'UNITED STATES'}An__iterableof__key-valuepairs__likedial_codes__canbe__passeddirectly__tothe__dict constructor,but__herewe__swapthe__pairs:country__isthe__key,and__codeis__the value.sSorting__country_dialby__name,reversing__thepairs__again,uppercasing__values,and__filteringitems__bycode__< 66.If__youre__usedto__liscomps,dictcomps__area__naturalnext__step.If__youaren__t,the__spreadof__thecomprehension__syntaxmeans__its__nowmore__profitablethan__everto__becomefluent__in it.We__nowmove__toa__panoramicview__ofthe__APIfor__mappings.Overview__ofCommon__MappingMethods__Thebasic__APIfor__mappingsis__quite rich.Table__3-1shows__themethods__implementedby__dictand__twoof__itsmost__useful variations:defaultdict__and OrderedDict,both__definedin__thecollections__module.Table__3-1.Methods__ofthe__mappingtypes__dict, collections.defaultdict,and__collections.OrderedDict (commonobject__methodsomitted__for brevity);optional__argumentsare__enclosedin__[ ]dict__defaultdictOrderedDict__d.clear()Remove__allitems__d.__contains_ _(k)k__ind__d.copy()Shallow__copy d.__copy__()Support__for copy.copy d.default_factory__Callableinvoked__by__m__issing__to__setmissing__values d.__delitem__ (k)del__d[k]remove__itemwith__keyk__d.fromkeys(it , [initial])New__mappingfrom__keysin__iterable,with__optionalinitial__value (defaultsto__N one) d.get(k, [def ault])Get__itemwith__key k,return__defaultor__None__ifmissing__d.__getitem__ (k) d[k]get__itemwith__keyk__d.items()Get__viewover__items (k ey, value)pairs__d.__iter__()Get__iteratorover__keys d.keys()Get__viewover__keys d.__len__() len(d)number__ofitems__d.__missing__ (k)Called__when__getite__m__cannot__findthe__key d.move_to_end (k, [last])Move__kfirst__orlast__position (lastis__Trueby__default) d.pop(k, [def ault])Remove__andreturn__valueat__k,or__defaultor__None__ifmissing__d.popitem()Remove__andreturn__thelast__inserteditem__as (kea__b y, value) d.__reversed_ _()Get__iteratorfor__keysfrom__lastto__firstinserted__d.setdefault( k, [default])If__kin__d,return__d[k];else__set d[k] =defau__ltand__returnit__d.__setitem__ (k, v) d[k] =v__putv__atk__d.update(m, [ **kargs])Update__dwith__itemsfrom__mappingor__iterableof__(k ey, value)pairs__d.values()Get__viewover__valuesa__default_factoryis__nota__method,but__acallable__attributeset__bythe__enduser__whena__defaultdictis__instantiated.b__OrderedDict.popitem(last=False)removes__thefirst__iteminserted__(FIFO).This__keywordargument__isnot__validfor__dictor__defaultdictas__ofPython__3.8.The__way d.update(m)handles__itsfirst__argumentm__isa__primeexample__ofduck__typing:it__firstchecks__whetherm__hasa__keysmethod__and,if__it does,assumes__itis__a mapping. Otherwise, update()falls__backto__iteratingover__m,assuming__itsitems__are (key, value) pairs.The__constructorfor__mostPython__mappingsuses__thelogic__of update() internally,which__meansthey__canbe__initializedfrom__othermappings__orfrom__anyiterable__objectproducing__(key, value) pairs.A__subtlemapping__methodis__setdefault().It__avoidsredundant__keylookups__whenthe__valueof__adictionary__itemis__mutableand__weneed__toupdate__it in-place.If__youare__notcomfortable__using it,the__followingsection__explains how,through__apractical__example.b__HandlingMissing__Keyswith__setdefaultIn__linewith__Pythons__fail-fast philosophy,dict__accesswith__d[k]raises__anerror__whenk__isnot__anexisting__key.Every__Pythonistaknows__that d.get(k, default)is__analternative__to d[k]whenever__adefault__valueis__moreconvenient__thanhandling__KeyError. However,when__updatingthe__mutablevalue__found,using__either d[k]or__getis__awkwardand__inefficient.Consider__ascript__toindex__text,producing__amapping__whereeach__keyis__aword__andthe__valueis__alist__ofpositions__wherethat__word occurs,as__shownin__Example 3-2.Example__3-2.Partial__outputfrom__Example 3-3processing__theZen__of Python;each__lineshows__aword__anda__listof__occurrencescoded__as pairs: (line_number, column_number) $ python3 index0.py zen.txta__[(19, 48), (20, 53)]Although__[(11, 1), (16, 1), (18, 1)]ambiguity__[(14, 16)]and__[(15, 23)]are__[(21, 12)]aren__[(10, 15)]at__[(16, 38)]bad__[(19, 50)]be__[(15, 14), (16, 27), (20, 50)]beats__[(11, 23)]Beautiful__[(3, 1)]better__[(3, 14), (4, 13), (5, 11), (6, 12), (7, 9), (8, 11), (17, 8), (18, 25)] ...Example__3-3,a__suboptimalscript__writtento__showone__casewhere__dict.getis__notthe__bestway__tohandle__amissing__key.I__adaptedit__froman__exampleby__Alex Martelli, . 2Example__3-3. index0.pyuses__dict.getto__fetchand__updatea__listof__wordoccurrences__fromthe__index (abetter__solutionis__inExample__3-4) """Buildan__indexmapping__word ->list__of occurrences"""import__sysimport__reWORD_RE__= re.compile(r'\w+')index__= {}with__open(sys.argv[1], encoding='utf-8')as__fp:for__line_no,line__in enumerate(fp, 1):for__matchin__WORD_RE.finditer(line):word__= match.group()column_no__= match.start()+1location__= (line_no, column_no) #this__is ugly;coded__likethis__tomake__apoint__occurrences = index.get(word, []) occurrences.append(location) index[word] =occurrences__#print__inalphabetical__orderfor__wordin__sorted(index, key=str.upper): print(word, index[word])Get__thelist__ofoccurrences__for word,or__[]if__not found.Append__newlocation__to occurrences.Put__changedoccurrences__intoindex__dict;this__entailsa__secondsearch__throughthe__index.In__the key=argument__ofsorted__Iam__notcalling__str.upper,just__passinga__referenceto__thatmethod__sothe__sortedfunction__canuse__itto__normalizethe__wordsfor__sorting.The__threelines__dealingwith__occurrencesin__Example 3-3can__bereplaced__bya__singleline__using dict.setdefault.Example__3-4is__closerto__AlexMartelli__soriginal__example.Example__3-4. index.pyuses__dict.setdefaultto__fetchand__updatea__listof__wordoccurrences__fromthe__indexin__asingle__line;contrast__withExample__3- 3 3 """Buildan__indexmapping__word ->list__of occurrences"""import__sysimport__reWORD_RE__= re.compile(r'\w+')index__= {}with__open(sys.argv[1], encoding='utf-8')as__fp:for__line_no,line__in enumerate(fp, 1):for__matchin__WORD_RE.finditer(line):word__= match.group()column_no__= match.start()+1location__= (line_no, column_no) index.setdefault(word, []).append(location) #print__inalphabetical__orderfor__wordin__sorted(index, key=str.upper): print(word, index[word])Get__thelist__ofoccurrences__for word,or__setit__to []if__not found;setdefault__returnsthe__value,so__itcan__beupdated__withoutrequiring__asecond__search.In__other words,the__endresult__ofthis__line my_dict.setdefault(key, []).append(new_value)is__thesame__asrunning__ifkey__notin__my_dict: my_dict[key] = [] my_dict[key].append(new_value)except__thatthe__lattercode__performsat__leasttwo__searchesfor__keythree__ifit__snot__foundwhile__setdefaultdoes__itall__witha__single lookup.A__related issue,handling__missingkeys__onany__lookup (andnot__onlywhen__inserting),is__thesubject__ofthe__next section.Mappings__withFlexible__KeyLookup__Sometimesit__isconvenient__tohave__mappingsthat__returnsome__made-upvalue__whena__missingkey__is searched.There__aretwo__mainapproaches__to this:one__isto__usea__defaultdictinstead__ofa__plain dict.The__otheris__tosubclass__dictor__anyother__mappingtype__andadd__a__missing____method.Both__solutionsare__covered next. defaultdict:Another__Takeon__MissingKeys__Example 3-5uses__collections.defaultdictto__provideanother__elegantsolution__tothe__problemin__Example 3-4.A__defaultdictis__configuredto__createitems__ondemand__whenevera__missingkey__is searched.Here__ishow__it works:when__instantiatinga__defaultdict,you__providea__callablethat__isused__toproduce__adefault__valuewhenever____getitem__is__passeda__nonexistentkey__argument.For__example,given__anempty__defaultdictcreated__asdd__= defaultdict(list),if__'new-key'is__notin__dd,the__expression dd['new-key']does__thefollowing__steps: 1.Calls__list()to__createa__new list. 2.Inserts__thelist__intodd__using 'new-key'as__key. 3.Returns__areference__tothat__list.The__callablethat__producesthe__defaultvalues__isheld__inan__instanceattribute__called default_factory.Example__3-5. index_default.py:using__aninstance__ofdefaultdict__insteadof__thesetdefault__method """Buildan__indexmapping__word ->list__of occurrences"""import__sysimport__reimport__collectionsWORD_RE__= re.compile(r'\w+')index__= collections.defaultdict(list)with__open(sys.argv[1], encoding='utf-8')as__fp:for__line_no,line__in enumerate(fp, 1):for__matchin__WORD_RE.finditer(line):word__= match.group()column_no__= match.start()+1location__= (line_no, column_no) index[word].append(location) #print__inalphabetical__orderfor__wordin__sorted(index, key=str.upper): print(word, index[word])Create__adefaultdict__withthe__listconstructor__as default_factory.If__wordis__notinitially__inthe__index,the__default_factoryis__calledto__producethe__missing value,which__inthis__caseis__anempty__listthat__isthen__assignedto__index[word]and__returned,so__the .append(location)operation__always succeeds.If__nodefault_factory__is provided,the__usualKeyError__israised__formissing__keys.WARNING__Thedefault_factory__ofa__defaultdictis__onlyinvoked__toprovide__defaultvalues__for__getitem____calls,and__notfor__theother__methods.For__example,if__ddis__a defaultdict,and__kis__amissing__key, dd[k]will__callthe__default_factoryto__createa__default value,but__dd.get(k)still__returns None.The__mechanismthat__makesdefaultdict__workby__callingdefault_factory__isthe____missing__special__method,a__featurethat__wediscuss__next.The____missing__Method__Underlyingthe__waymappings__dealwith__missingkeys__isthe__aptlynamed____missing__ method.This__methodis__notdefined__inthe__basedict__class,but__dictis__awareof__it:if__yousubclass__dictand__providea____missing__ method,the__standard dict.__getitem__will__callit__whenevera__keyis__not found,instead__ofraising__KeyError.WARNING__The__missing____methodis__onlycalled__by__getitem____(i.e.,for__the d[k] operator).The__presenceof__a__missing____methodhas__noeffect__onthe__behaviorof__othermethods__thatlook__up keys,such__asget__or__contains____(whichimplements__thein__operator).This__iswhy__thedefault_factory__ofdefaultdict__worksonly__with __getitem__,as__notedin__thewarning__atthe__endof__theprevious__section.Suppose__youd__likea__mappingwhere__keysare__convertedto__strwhen__looked up.A__concreteuse__caseis__adevice__libraryfor__IoT ,where__aprogrammable__boardwith__generalpurpose__I/Opins__(e.g.,a__RaspberryPi__oran__Arduino)is__representedby__aBoard__classwith__a my_board.pins attribute,which__isa__mappingof__physicalpin__identifiersto__pinsoftware__objects.The__physicalpin__identifiermay__bejust__anumber__ora__stringlike__4 "A0"or__"P9_12".For__consistency,it__isdesirable__thatall__keysin__board.pinsare__strings,but__itis__alsoconvenient__thatlooking__upa__pinby__number,as__in my_arduino.pin[13],so__thatbeginners__arenot__trippedwhen__theywant__toblink__theLED__onpin__13of__their Arduinos.Example__3-6shows__howsuch__amapping__would work.Example__3-6.When__searchingfor__anonstring__key, StrKeyDict0converts__itto__strwhen__itis__notfound__Testsfor__itemretrieval__using `d[key]` notation:: >>>d__= StrKeyDict0([('2', 'two'), ('4', 'four')]) >>> d['2'] 'two' >>> d[4] 'four' >>> d[1]Traceback__(mostrecent__call last): ... KeyError: '1'Tests__foritem__retrievalusing__`d.get(key)` notation:: >>> d.get('2') 'two' >>> d.get(4) 'four' >>> d.get(1, 'N/A') 'N/A'Tests__forthe__`in` operator:: >>> 2in__dTrue__>>> 1in__dFalse__Example 3-7implements__aclass__StrKeyDict0that__passesthe__preceding doctests.TIP__Abetter__wayto__createa__user-definedmapping__typeis__tosubclass__collections.UserDictinstead__ofdict__(aswe__lldo__inExample__3-8).Here__wesubclass__dictjust__toshow__that__missing____issupported__bythe__built-in dict.__getitem__ method.Example__3-7. StrKeyDict0converts__nonstringkeys__tostr__onlookup__(seetests__inExample__3-6)class__StrKeyDict0(dict):def____missing__(self, key):if__isinstance(key, str):raise__KeyError(key)return__self[str(key)]def__get(self, key, default=None): try:return__self[key]except__KeyError:return__defaultdef____contains__(self, key):return__keyin__self.keys()or__str(key)in__self.keys() StrKeyDict0inherits__from dict.Check__whetherkey__isalready__a str.If__it is,and__its__missing,raise__KeyError.Build__strfrom__keyand__lookit__up.The__getmethod__delegatesto____getitem__by__usingthe__self[key] notation;that__givesthe__opportunityfor__our__missing____to act.If__aKeyError__was raised,__missing____already failed,so__wereturn__the default.Search__forunmodified__key (theinstance__maycontain__non-str keys),then__fora__strbuilt__fromthe__key.Take__amoment__toconsider__whythe__test isinstance(key, str)is__necessaryin__the__missing____implementation.Without__that test,our____missing__method__wouldwork__OKfor__anykey__kstr__ornot__strwhenever__str(k)produced__anexisting__key.But__if str(k)is__notan__existing key,we__dhave__aninfinite__recursion.The__last line, self[str(key)]would__call__getitem____passingthat__str key,which__inturn__wouldcall____missing__ again.The____contains__method__isalso__neededfor__consistentbehavior__inthis__example,because__theoperation__kin__dcalls__it,but__themethod__inheritedfrom__dictdoes__notfall__backto__invoking __missing__.There__isa__subtledetail__inour__implementationof____contains__:we__donot__checkfor__thekey__inthe__usualPythonic__wayk__inmy_dict__because str(key)in__selfwould__recursivelycall____contains__.We__avoidthis__byexplicitly__lookingup__thekey__in self.keys().NOTE__Asearch__likek__in my_dict.keys()is__efficientin__Python 3even__forvery__largemappings__because dict.keys()returns__a view,which__issimilar__toa__set,as__well__seein__Setoperations__ondict__views . However,remember__thatk__inmy_dict__doesthe__same job,and__isfaster__becauseit__avoidsthe__attributelookup__tofind__the .keys method.I__hada__specificreason__touse__self.keys()in__the__contains____methodin__Example 3-7.The__checkfor__theunmodified__keykey__in self.keys()is__necessaryfor__correctnessbecause__StrKeyDict0does__notenforce__thatall__keysin__thedictionary__mustbe__oftype__str.Our__onlygoal__withthis__simpleexample__isto__makesearching__friendlierand__notenforce__types.So__farwe__havecovered__thedict__anddefaultdict__mapping types,but__thestandard__librarycomes__withother__mapping implementations,which__wediscuss__next.Variations__ofdict__Inthis__section,we__summarizethe__variousmapping__typesincluded__inthe__standard library,besides__defaultdict,already__coveredin__defaultdict:Another__Takeon__MissingKeys__.The__followingmapping__typesare__readyto__instantiateand__use: collections.OrderedDictMaintains__keysin__insertion order,allowing__iterationover__itemsin__apredictable__order.The__popitemmethod__ofan__OrderedDictpops__thelast__itemby__default,but__ifcalled__as my_odict.popitem(last=False),it__popsthe__firstitem__added.Now__thatthe__built-indict__alsokeeps__thekeys__orderedsince__Python 3.6,the__mainreason__touse__OrderedDictis__writingcode__thatis__backward-compatiblewith__earlierPython__versions. collections.ChainMapHolds__alist__ofmappings__thatcan__besearched__as one.The__lookupis__performedon__eachmapping__in order,and__succeedsif__thekey__isfound__inany__of them.This__isuseful__tointerpreters__forlanguages__withnested__scopes,where__eachmapping__representsa__scope context.The__ChainMapobjects__sectionof__thecollections__docshas__severalexamples__ofChainMap__usage,including__thissnippet__inspiredby__thebasic__rulesof__variablelookup__in Python:import__builtinspylookup__= ChainMap(locals(), globals(), vars(builtins)) collections.CounterA__mappingthat__holdsan__integercount__foreach__key.Updating__anexisting__keyadds__toits__count.This__canbe__usedto__countinstances__ofhashable__objectsor__asa__multiset (see below).Counter__implementsthe__+and__-operators__tocombine__tallies,and__otheruseful__methodssuch__as most_common([n]),which__returnsan__orderedlist__oftuples__withthe__nmost__commonitems__andtheir__counts;see__the documentation.Here__isCounter__usedto__countletters__in words: >>>ct__= collections.Counter('abracadabra') >>>ct__Counter({'a': 5, 'b': 2, 'r': 2, 'c': 1, 'd': 1}) >>> ct.update('aaaaazzz') >>>ct__Counter({'a': 10, 'z': 3, 'b': 2, 'r': 2, 'c': 1, 'd': 1}) >>> ct.most_common(3) [('a', 10), ('z', 3), ('b', 2)]Note__thatthe__'b'and__'r'keys__aretied__inthird__place,but__ct.most_common(3)shows__onlythree__counts.To__use collections.Counteras__a multiset,each__elementin__theset__isa__key,and__thecount__isthe__numberof__occurrencesof__thatelement__inthe__set. OrderedDict, ChainMap,and__Counterare__readyto__instantiatebut__canalso__becustomized__by subclassing.In__contrast,the__nextmappings__areintended__asbase__classesto__be extended.Building__custommappings__Thesemapping__typesare__notmeant__tobe__instantiated directly,but__forsubclassing__whenwe__needto__createcustom__types: collections.UserDictA__purePython__implementationof__amapping__thatbehaves__likea__standard dict.See__SubclassingUserDict__foran__extended explanation. typing.TypedDictUsing__newtype__declaration syntax,the__TypedDictclass__addedin__Python 3.8lets__youcreate__mappingtypes__thatonly__accepta__specificset__ofstring__keys,with__eachkey__constrainedto__acceptonly__valuesof__aspecific__type.This__iscovered__in [Linkto__Come],in__Chapter 5.The__collections.UserDictclass__behaveslike__a dict,but__itis__slowerbecause__itis__implementedin__Python,not__in C.We__llcover__itin__moredetail__next.Subclassing__UserDictIt__salmost__alwayseasier__tocreate__anew__mappingtype__byextending__UserDictrather__than dict.We__realizethat__whenwe__tryto__extendour__StrKeyDict0from__Example 3-7to__makesure__thatany__keysadded__tothe__mappingare__storedas__str.The__mainreason__whyit__sbetter__tosubclass__UserDictrather__thandict__isthat__the built-inhas__someimplementation__shortcutsthat__endup__forcingus__tooverride__methodsthat__wecan__justinherit__fromUserDict__withno__problems.Note__thatUserDict__doesnot__inheritfrom__dict,but__uses composition:it__hasan__internaldict__instance,called__data,which__holdsthe__actual items.This__avoidsundesired__recursionwhen__codingspecial__methodslike____setitem__,and__simplifiesthe__codingof____contains__,compared__toExample__3-7. 5Thanks__to UserDict,StrKeyDict__(Example 3-8)is__actuallyshorter__than StrKeyDict0 (Example 3-7),but__itdoes__more:it__storesall__keysas__str,avoiding__unpleasantsurprises__ifthe__instanceis__builtor__updatedwith__datacontaining__nonstring keys.Example__3-8.StrKeyDict__alwaysconverts__non-stringkeys__tostr__on insertion, update,and__lookupimport__collectionsclass__StrKeyDict(collections.UserDict):def____missing__(self, key):if__isinstance(key, str):raise__KeyError(key)return__self[str(key)]def____contains__(self, key):return__str(key)in__self.datadef____setitem__(self, key, item): self.data[str(key)] =item__StrKeyDictextends__UserDict.__missing____isexactly__asin__Example 3-7.__contains____is simpler:we__canassume__allstored__keysare__strand__wecan__checkon__self.datainstead__ofinvoking__self.keys()as__wedid__in StrKeyDict0.__setitem____convertsany__keyto__a str.This__methodis__easierto__overwritewhen__wecan__delegateto__the self.data attribute.Because__UserDictextends__abc.MutableMapping,the__remainingmethods__thatmake__StrKeyDicta__full-fledgedmapping__areinherited__from UserDict, MutableMapping,or__Mapping.The__latterhave__severaluseful__concrete methods,in__spiteof__beingabstract__baseclasses__(ABCs).The__followingmethods__areworth__noting: MutableMapping.updateThis__powerfulmethod__canbe__calleddirectly__butis__alsoused__by__init____toload__theinstance__fromother__mappings,from__iterablesof__(key, value) pairs,and__keyword arguments.Because__ituses__self[key] =value__toadd__items,it__endsup__callingour__implementationof____setitem__. Mapping.getIn__StrKeyDict0 (Example 3-7),we__hadto__codeour__ownget__toobtain__resultsconsistent__with __getitem__,but__inExample__3-8we__inherited Mapping.get,which__isimplemented__exactlylike__StrKeyDict0.get (seePython__source code).TIP__AntoinePitrou__authoredPEP__455Adding__a key-transformingdictionary__tocollections__anda__patchto__enhancethe__collectionsmodule__witha__TransformDict,that__ismore__generalthan__StrKeyDictand__preservesthe__keysas__theyare__provided,before__thatransformation__is applied.PEP__455was__rejectedin__May, 2015see__RaymondHettinger__srejection__message.To__experimentwith__TransformDict,I__extractedPitrou__spatch__from issue18986into__astandalone__module (03-dict-set/transformdict.pyin__theFluent__Python 2ndedition__code repository).We__knowthere__areimmutable__sequence types,but__howabout__animmutable__mapping? Well,there__isnt__areal__onein__thestandard__library,but__a stand-inis__available.Read__on.Immutable__MappingsThe__mappingtypes__providedby__thestandard__libraryare__all mutable,but__youmay__needto__guaranteethat__auser__cannotchange__amapping__by mistake.A__concreteuse__casecan__be found, again,in__ahardware__programminglibrary__The__missing____Method :the__board.pinsmapping__representsthe__physicalGPIO__pinson__the device.As__such,it__snice__toprevent__inadvertentupdates__to board.pinsbecause__thehardware__cant__bechanged__via software,so__anychange__inthe__mappingwould__makeit__inconsistentwith__thephysical__realityof__the device.Since__Python 3.3,the__typesmodule__providesa__wrapperclass__called MappingProxyType, which,given__a mapping,returns__amappingproxy__instancethat__isa__read-onlybut__dynamicproxy__forthe__original mapping.This__meansthat__updatesto__theoriginal__mappingcan__beseen__inthe__mappingproxy,but__changescannot__bemade__through it.See__Example 3-9for__abrief__demonstration.Example__3-9.MappingProxyType__buildsa__read-onlymappingproxy__instancefrom__adict__>>>from__typesimport__MappingProxyType >>>d__= {1: 'A'} >>>d_proxy__= MappingProxyType(d) >>>d_proxy__mappingproxy({1: 'A'}) >>> d_proxy[1] 'A' >>> d_proxy[2] = 'x'Traceback__(mostrecent__call last):File__"",line__1,in__TypeError: 'mappingproxy'object__doesnot__supportitem__assignment >>> d[2] = 'B' >>>d_proxy__mappingproxy({1: 'A', 2: 'B'}) >>> d_proxy[2] 'B' >>>Items__ind__canbe__seenthrough__d_proxy.Changes__cannotbe__madethrough__d_proxy.d_proxy__is dynamic:any__changein__dis__reflected.Here__ishow__thiscould__beused__inpractice__inthe__hardwareprogramming__scenario:the__constructorin__aconcrete__Boardsubclass__wouldfill__aprivate__mappingwith__thepin__objects,and__exposeit__toclients__ofthe__APIvia__apublic__.pinsattribute__implementedas__a mappingproxy.That__waythe__clientswould__notbe__ableto__add, remove,or__changepins__by accident. Next,we__llcover__oneof__themost__powerfulfeatures__ofdictionaries__inPython__3:dict__views.Dictionary__viewsThe__dictinstance__methods .keys(), .values(),and__.items()return__instancesof__classescalled__dict_keys, dict_values,and__dict_items,respectively__.These__dictionaryviews__are read-onlyprojections__ofthe__internaldata__structuresused__inthe__dict implementation.They__avoidthe__memoryoverhead__ofthe__equivalentPython__2methods__thatreturned__listsduplicating__dataalready__inthe__target dict,and__theyalso__replacethe__oldmethods__thatreturned__iterators.Example__3-10shows__somebasic__operationssupported__byall__dictionary views.Example__3-10.The__.values()method__returnsa__viewof__thevalues__ina__dict. >>>d__= dict(a=10, b=20, c=30) >>>values__= d.values() >>>values__dict_values([10, 20, 30]) >>> len(values) 3 >>> list(values) 6 [10, 20, 30] >>> reversed(values) >>> values[0]Traceback__(mostrecent__call last):File__"",line__1,in__TypeError: 'dict_values'object__isnot__subscriptableThe__reprof__aview__objectshows__its content.We__canquery__thelen__ofa__view.Views__are iterable,so__its__easyto__createlists__from them.Views__implement __reversed__,returning__acustom__iterator.We__cant__use []to__getindividual__itemsfrom__a view.A__viewobject__isa__dynamic proxy.If__thesource__dictis__updated,you__canimmediately__seethe__changesthrough__anexisting__view.Continuing__fromExample__3-10: >>> d['z'] = 99 >>>d__{'a': 10, 'b': 20, 'c': 30, 'z': 99} >>>values__dict_values([10, 20, 30, 99])The__classes dict_keys, dict_values,and__dict_itemsare__internal:they__arenot__availablevia____builtins__or__anystandard__library module,and__evenif__youget__areference__toone__of them,you__cant__useit__tocreate__aview__fromscratch__inPython__code: >>>values_class__= type({}.values()) >>>v__= values_class()Traceback__(mostrecent__call last):File__"",line__1,in__TypeError:cannot__create 'dict_values'instances__Thedict_values__classis__thesimplest__dictionaryview__itimplements__onlythe____len__, __iter__,and____reversed__special__methods.In__additionto__these methods,dict_keys__anddict_items__implementseveral__set methods,almost__asmany__asthe__frozenset class.After__wecover__sets,we__llhave__moreto__sayabout__dict_keysand__dict_itemsin__Setoperations__ondict__views .Now__thatwe__vecovered__mostmapping__typesin__thestandard__library,we__llreview__sets.Set__TheorySets__arenot__newin__Python,but__arestill__somewhat underused.The__settype__andits__immutablesibling__frozensetfirst__appearedas__modulesin__thePython__2.3standard__library,and__werepromoted__to built-insin__Python 2.6.NOTE__Inthis__book,I__usethe__wordset__torefer__bothto__setand__frozenset.When__talkingspecifically__aboutthe__set class,I__useconstant__width font: set.A__setis__acollection__ofunique__objects.A__basicuse__caseis__removing duplication: >>>l__= ['spam', 'spam', 'eggs', 'spam', 'bacon', 'eggs'] >>> set(l) {'eggs', 'spam', 'bacon'} >>> list(set(l)) ['eggs', 'spam', 'bacon']TIP__Ifyou__wantto__removeduplicates__butalso__preservethe__orderof__thefirst__ocurrenceof__each item,you__cannow__usea__plaindict__todo__it,like__this: >>> dict.fromkeys(l).keys() dict_keys(['spam', 'eggs', 'bacon']) >>> list(dict.fromkeys(l).keys()) ['spam', 'eggs', 'bacon']Set__elementsmust__be hashable.The__settype__isnot__hashable,so__youcan__tbuild__aset__withnested__set instances.But__frozensetis__hashable,so__youcan__havefrozenset__elementsinside__a set.In__additionto__enforcing uniqueness,the__settypes__implementmany__setoperations__asinfix__operators, so,given__twosets__aand__b,a__|b__returnstheir__union,a__&b__computesthe__intersection,a__-b__the difference,and__a ^b__thesymmetric__difference.Smart__useof__setoperations__canreduce__boththe__linecount__andthe__executiontime__ofPython__programs,at__thesame__timemaking__codeeasier__toread__andreason__aboutby__removingloops__andconditional__logic.For__example,imagine__youhave__alarge__setof__emailaddresses__(the haystack)and__asmaller__setof__addresses (the needles)and__youneed__tocount__howmany__needlesoccur__inthe__haystack.Thanks__toset__intersection (the & operator)you__cancode__thatin__asimple__line (seeExample__3-11).Example__3-11.Count__occurrencesof__needlesin__a haystack,both__oftype__setfound__= len(needles & haystack)Without__theintersection__operator,you__dhave__writeExample__3-12to__accomplishthe__sametask__asExample__3-11.Example__3-12.Count__occurrencesof__needlesin__ahaystack__(sameend__resultas__Example 3-11)found__= 0for__nin__needles:if__nin__haystack:found__+= 1Example__3-11runs__slightlyfaster__thanExample__3-12.On__theother__hand,Example__3-12works__forany__iterableobjects__needlesand__haystack,while__Example 3-11requires__thatboth__be sets. But,if__youdon__thave__setson__hand,you__canalways__buildthem__onthe__fly,as__shownin__Example 3-13.Example__3-13.Count__occurrencesof__needlesin__a haystack;these__lineswork__forany__iterabletypes__found = len(set(needles) & set(haystack)) #another__way:found__= len(set(needles).intersection(haystack))Of__course,there__isan__extracost__involvedin__buildingthe__setsin__Example 3-13,but__ifeither__theneedles__orthe__haystackis__alreadya__set,the__alternativesin__Example 3-13may__becheaper__thanExample__3-12.Any__oneof__thepreceding__examplesare__capableof__searching 1,000elements__ina__haystackof__10,000,000items__inabout__0.3milliseconds__thats__closeto__0.3microseconds__per element.Besides__theextremely__fastmembership__test (thanksto__theunderlying__hash table),the__setand__frozenset built-intypes__providea__richAPI__tocreate__newsets__or,in__thecase__of set,to__changeexisting__ones.We__willdiscuss__theoperations__shortly,but__firsta__noteabout__syntax.Set__LiteralsThe__syntaxof__setliterals__{1}, {1, 2}, etc.looks__exactlylike__themath__notation,with__oneimportant__exception:there__sno__literalnotation__forthe__empty set,so__wemust__rememberto__write set().SYNTAX__QUIRKDon__t forget:to__createan__empty set,you__shoulduse__theconstructor__withoutan__argument: set().If__youwrite__{},you__recreating__anempty__dictthis__hasnt__changedin__Python 3.In__Python 3,the__standardstring__representationof__setsalways__usesthe__{ } notation,except__forthe__empty set: >>>s__= {1} >>> type(s) >>>s__{1} >>> s.pop() 1 >>>s__set()Literal__setsyntax__like {1, 2, 3}is__bothfaster__andmore__readablethan__callingthe__constructor (e.g., set([1, 2, 3])).The__latterform__isslower__because,to__evaluate it,Python__hasto__lookup__theset__nameto__fetchthe__constructor,then__builda__list,and__finallypass__itto__the constructor.In__contrast,to__processa__literallike__{1, 2, 3},Python__runsa__specializedBUILD_SET__bytecode . 7There__isno__specialsyntax__torepresent__frozensetliterals__theymust__becreated__bycalling__the constructor.The__standardstring__representationin__Python 3looks__likea__frozensetconstructor__call.Note__theoutput__inthe__console session: >>> frozenset(range(10)) frozenset({0, 1, 2, 3, 4, 5, 6, 7, 8, 9})Speaking__of syntax,the__ideaof__listcompswas__adaptedto__buildsets__as well.Set__ComprehensionsSet__comprehensions (setcomps)were__addedin__Python 2.7,together__withthe__dictcompsthat__wesaw__indict__Comprehensions .Example__3-14shows__how.Example__3-14.Build__aset__of Latin-1characters__thathave__theword__SIGNin__theirUnicode__names >>>from__unicodedataimport__name >>> {chr(i)for__iin__range(32, 256)if__'SIGN'in__name(chr(i),'')} {' ', '=', ' ', '#', ' ', '<', ' ', ' ', ' ', '$', ' ', ' ', ' ', ' ', '+', ' ', ' ', '>', ' ', ' ', '%'}Import__namefunction__fromunicodedata__toobtain__character names.Build__setof__characterswith__codesfrom__32to__255that__havethe__word 'SIGN'in__their names.Syntax__matters aside,let__snow__reviewthe__richassortment__ofoperations__providedby__sets.Set__OperationsFigure__3-2gives__anoverview__ofthe__methodsyou__canuse__onmutable__andimmutable__sets.Many__ofthem__arespecial__methodsthat__overloadoperators__suchas__&and__>=.Table__3-2shows__themath__setoperators__thathave__correspondingoperators__ormethods__in Python.Note__thatsome__operatorsand__methodsperform__in-placechanges__onthe__targetset__(e.g., &=, difference_update, etc.).Such__operationsmake__nosense__inthe__idealworld__ofmathematical__sets,and__arenot__implementedin__frozenset.Figure__3-2.Simplified__UMLclass__diagramfor__MutableSetand__itssuperclasses__from collections.abc (namesin__italicare__abstractclasses__andabstract__methods;reverse__operatormethods__omittedfor__brevity)TIP__Theinfix__operatorsin__Table 3-2require__thatboth__operandsbe__sets,but__allother__methodstake__oneor__moreiterable__arguments.For__example,to__producethe__unionof__four collections, a, b, c,and__d,you__cancall__a.union(b, c, d),where__amust__bea__set,but__b, c,and__dcan__beiterables__ofany__type.Table__3-2.Mathematical__set operations:these__methodseither__producea__newset__orupdate__thetarget__setin__place,if__its__mutableMath__Pythonsymbol__operatorMethod__DescriptionS__Zs__&z__s.__and__(z)Intersection__ofs__andz__z &s__s.__rand__(z)Reversed__&operator__s.intersection(i t, )Intersection__ofs__andall__setsbuilt__fromiterables__it, etc.s__&=z__s.__iand__(z)s__updatedwith__intersectionof__sand__z s.intersection_u pdate(it, )s__updatedwith__intersectionof__sand__allsets__builtfrom__iterables it, etc.S__Zs__|z__s.__or__(z)Union__ofs__andz__z |s__s.__ror__(z)Reversed__| s.union(it, )Union__ofs__andall__setsbuilt__fromiterables__it, etc.s__|=z__s.__ior__(z)s__updatedwith__unionof__sand__z s.update(it, )s__updatedwith__unionof__sand__allsets__builtfrom__iterables it, etc.S__\Z__s -z__s.__sub__(z)Relative__complementor__differencebetween__sand__zz__-s__s.__rsub__(z)Reversed__-operator__s.difference(it, )Difference__betweens__andall__setsbuilt__fromiterables__it, etc.s__-=z__s.__isub__(z)s__updatedwith__differencebetween__sand__z s.difference_upd ate(it, )s__updatedwith__differencebetween__sand__allsets__builtfrom__iterables it, etc. s.symmetric_diff erence(it)Complement__ofs__& set(it) ( )S__Zs__^z__s.__xor__(z)Symmetric__difference (thecomplement__ofthe__intersections__& z)z__^s__s.__rxor__(z)Reversed__^operator__s.symmetric_diff erence_update(it , )s__updatedwith__symmetricdifference__ofs__andall__setsbuilt__fromiterables__i t, etc.s__^=z__s.__ixor__(z)s__updatedwith__symmetricdifference__ofs__andz__Table 3-3lists__set predicates:operators__andmethods__thatreturn__Trueor__False.Table__3-3.Set__comparisonoperators__andmethods__thatreturn__abool__Mathsymbol__Pythonoperator__MethodDescription__s.isdisjoint (z)s__andz__aredisjoint__(noelements__in common)e__Se__ins__s.__contains __(e)Element__eis__amember__ofs__SZ__s <=z__s.__le__(z)s__isa__subsetof__thez__set s.issubset(i t)s__isa__subsetof__theset__builtfrom__theiterable__itS__Zs__<z__s.__lt__(z)s__isa__propersubset__ofthe__zset__SZ__s >=z__s.__ge__(z)s__isa__supersetof__thez__set s.issuperset (it)s__isa__supersetof__theset__builtfrom__theiterable__itS__Zs__>z__s.__gt__(z)s__isa__propersuperset__ofthe__zset__Inaddition__tothe__operatorsand__methodsderived__frommath__set theory,the__settypes__implementother__methodsof__practical use,summarized__inTable__3-4.Table__3-4.Additional__setmethods__setfrozenset__s.add(e)Add__elemente__tos__s.clear()Remove__allelements__ofs__s.copy()Shallow__copyof__s s.discard (e)Remove__elemente__froms__ifit__ispresent__s.__iter_ _()Get__iteratorover__s s.__len__ () len(s) s.pop()Remove__andreturn__anelement__from s,raising__KeyError__ifs__isempty__s.remove( e)Remove__elemente__from s,raising__KeyErrorif__enot__ins__Thiscompletes__ouroverview__ofthe__featuresof__sets.As__promisedin__Dictionaryviews__,we__llnow__seehow__twoof__thedictionary__viewtypes__behavevery__muchlike__a frozenset.Set__operationson__dictviews__Table 3-5shows__thatthe__viewobjects__returnedby__thedict__methods .keys()and__.items()are__remarkablysimilar__to frozenset.Table__3-5.Methods__implementedby__frozenset, dict_keys,and__dict_i tems.frozenset__dict_keysdict_items__Description s.__and__(z)s__&z__(intersectionof__sand__z) s.__rand__(z)Reversed__&operator__s.__contains__()e__ins__s.copy()Shallow__copyof__s s.difference(it, )Difference__betweens__anditerables__it, etc. s.intersection(it , )Intersection__ofs__anditerables__it, etc. s.isdisjoint(z)s__andz__aredisjoint__(noelements__in common) s.issubset(it)s__isa__subsetof__iterableit__s.issuperset(it)s__isa__supersetof__iterableit__s.__iter__()Get__iteratorover__s s.__len__() len(s) s.__or__(z)s__|z__(unionof__sand__z) s.__ror__()Reversed__|operator__s.__reversed__()Get__iteratorover__sin__reverseorder__s.__rsub__(z)Reversed__-operator__s.__sub__(z)s__-z__(differencebetween__sand__z) s.symmetric_diffe rence(it)Complement__ofs__& set(it) s.union(it, )Union__ofs__anditerables__it, etc. s.__xor__()s__^z__(symmetricdifference__ofs__and z) s.__rxor__()Reversed__^operator__In particular,dict_keys__anddict_items__implementthe__specialmethods__tosupport__thepowerful__setoperators__& (intersection), | (union), - (difference)and__^ (symmetric difference).This__means,for__example,that__findingthe__keysthat__appearin__twodictionaries__isas__easyas__this: >>> d1 = dict(a=1, b=2, c=3, d=4) >>> d2 = dict(b=20, d=40, e=50) >>> d1.keys() & d2.keys() {'b', 'd'}Note__thatthe__returnvalue__of &is__a set.Even__better:the__setoperators__indictonary__viewsare__compatiblewith__set instances.Check__this out: >>>s__= {'a', 'e', 'i'} >>> d1.keys() &s__{'a'} >>> d1.keys() |s__{'a', 'c', 'b', 'd', 'i', 'e'}This__willsave__alot__ofloops__andifs__wheninspecting__thecontents__ofdictionaries__inyour__code.We__nowchange__gearsto__discusshow__setsand__dictionariesare__implementedwith__hash tables.After__readingthe__restof__this chapter,you__shouldno__longerbe__surprisedby__thebehavior__of dict, set,and__otherdata__structurespowered__byhash__tables.Internals__ofsets__anddicts__Understandinghow__Pythondictionaries__andsets__arebuilt__withhash__tablesis__helpfulto__makesense__oftheir__strengthsand__limitations.NOTE__Considerthis__section optional.You__dont__needto__knowall__ofthese__detailsto__makegood__useof__dicionariesand__sets.But__theimplementation__ideasare__beautifulthat__swhy__Icovered__them.For__practical advice,you__canskip__toPractical__Consequencesof__HowSets__Workand__PracticalConsequences__ofHow__dictWorks__.Here__aresome__questionsthis__sectionwill__answer:How__efficientare__Pythondict__and set?Why__areset__elements unordered?Why__cant__weuse__anyPython__objectas__adict__keyor__set element?Why__doesthe__orderof__thedict__keysdepend__oninsertion__order?Why__doesthe__orderof__setelements__seem random?To__motivatethe__studyof__hash tables,we__startby__showcasingthe__amazingperformance__ofdict__andset__witha__simpletest__involvingmillions__of items.A__PerformanceExperiment__From experience,all__Pythonistasknow__thatdicts__andsets__are fast.We__llconfirm__thatwith__acontrolled__experiment.To__seehow__thesize__ofa__dict, set,or__listaffects__theperformance__ofsearch__usingthe__in operator,I__generatedan__arrayof__10million__distinct double-precision floats,the__haystack.I__thengenerated__anarray__of needles: 1,000 floats,with__500picked__fromthe__haystackand__500verified__notto__bein__it.For__thedict__benchmark,I__used dict.fromkeys()to__createa__dictnamed__haystackwith__1,000 floats.This__wasthe__setupfor__thedict__test.The__actualcode__Iclocked__withthe__timeitmodule__isExample__3-15 (likeExample__3-12).Example__3-15.Search__forneedles__inhaystack__andcount__thosefound__found = 0for__nin__needles:if__nin__haystack:found__+= 1I__repeatedthe__benchmarkfive__times,each__timeincreasing__tenfoldthe__sizeof__haystack,from__1,000to__10,000,000 items.The__resultof__thedict__performancetest__isin__Table 3-6.Table__3-6.Total__timefor__usingin__operatorto__searchfor__1,000needles__inhaystack__dictsof__fivesizes__ona__2.2GHz__Core i7laptop__runningPython__3.8.0 (teststimed__theloop__inExample__3-15)len__ofhaystack__Factordict__timeFactor__1,000 1 0.099ms 1.00 10,000 10 0.109ms 1.10 100,000 100 0.156ms 1.58 1,000,000 1,000 0.372ms 3.76 10,000,000 10,000 0.512ms 5.17In__concrete terms,to__checkfor__thepresence__of 1,000 floating-pointkeys__ina__dictionarywith__1,000 items,the__processingtime__onmy__laptopwas__99 s,and__thesame__searchin__adict__with 10,000,000items__took 512 s.In__other words,the__averagetime__foreach__searchin__thehaystack__with 10million__itemswas__0.512s__yes,that__sabout__halfmicrosecond__per needle.When__thesearch__spacebecame__10,000times__larger,the__searchtime__increaseda__littleover__5 times. Nice.To__comparewith__other collections,I__repeatedthe__benchmarkwith__thesame__haystacksof__increasing size,but__storingthe__haystackas__aset__oras__list.For__theset__tests,in__additionto__timingthe__forloop__inExample__3-15,I__alsotimed__the one-linerin__Example 3-16,which__producesthe__same result:count__thenumber__ofelements__fromneedles__thatare__alsoin__haystackif__bothare__sets.Example__3-16.Use__setintersection__tocount__theneedles__thatoccur__inhaystack__found = len(needles & haystack)Table__3-7shows__thetests__sideby__side.The__besttimes__arein__the set&time__column,which__displaysresults__forthe__set &operator__usingthe__codefrom__Example 3-16.As__expected,the__worsttimes__arein__thelist__time column,because__thereis__nohash__tableto__supportsearches__withthe__inoperator__ona__list,so__afull__scanmust__bemade__ifthe__needleis__not present,resulting__intimes__thatgrow__linearlywith__thesize__ofthe__haystack.Table__3-7.Total__timefor__usingin__operatorto__searchfor__1,000keys__inhaystacks__of 5 sizes,stored__as dicts, sets,and__listson__a 2.2GHz__Core i7laptop__runningPython__3.8.0 (teststimed__theloop__inExample__3-15except__the set&,which__usesExample__3-16)len__ofhaystack__Factordict__timeFactor__settime__Factor set&time__Factorlist__tim 1,000 1 0.099ms 1.00 0.107ms 1.00 0.083ms 1.00 9.115m 10,000 10 0.109ms 1.10 0.119ms 1.11 0.094ms 1.13 78.219m 100,000 100 0.156ms 1.58 0.147ms 1.37 0.122ms 1.47 767.975 1,000,000 1,000 0.372ms 3.76 0.264ms 2.47 0.240ms 2.89 8,020.3 10,000,000 10,000 0.512ms 5.17 0.330ms 3.08 0.298ms 3.59 78,558.If__yourprogram__doesany__kindof__I/O,the__lookuptime__forkeys__indicts__orsets__is negligible,regardless__ofthe__dictor__setsize__(aslong__asit__fitsin__RAM).See__thecode__usedto__generateTable__3-7and__accompanyingdiscussion__in [Linkto__Come], [Linkto__Come].Now__thatwe__haveconcrete__evidenceof__thespeed__ofdicts__and sets,let__sexplore__howthat__isachieved__withthe__helpof__hash tables.Set__hashtables__underthe__hoodHash__tablesare__awonderful__invention.Let__ssee__howa__hashtable__isused__whenadding__elementsto__a set.Let__ssay__wehave__aset__withabbreviated__workdays,created__like this: >>>workdays__= {'Mon', 'Tue', 'Wed', 'Thu', 'Fri'} >>>workdays__{'Tue', 'Mon', 'Wed', 'Fri', 'Thu'}The__coredata__structureof__aPython__setis__ahash__tablewith__atleast__8 rows. Traditionally,the__rowsin__hashtable__arecalled__buckets .A__hashtable__holdingthe__elementsof__workdayslooks__likeFigure__3-3. 8Figure__3-3.Hash__tablefor__theset__{'Mon', 'Tue', 'Wed', 'Thu', 'Fri'}.Each__buckethas__two fields:the__hashcode__anda__pointerto__theelement__value.Empty__bucketshave__-1in__thehash__code field.The__orderinglooks__random.In__CPythonbuilt__fora__64-bit CPU,each__bucketin__aset__hastwo__fields:a__64-bithash__code,and__a 64-bitpointer__tothe__elementvalue__whichis__aPython__objectstored__elsewherein__memory.Because__bucketshave__afixed__size,access__toan__individualbucket__isdone__by offset.There__isno__fieldfor__theindexes__from 0to__7in__Figure 3-3.Before__coveringthe__hashtable__algorithm,we__needto__knowmore__abouthash__codes,and__howthey__relateto__equality.HASHES__ANDEQUALITY__The hash() built-infunction__worksdirectly__with built-intypes__andfalls__backto__calling__hash____for user-defined types.If__twoobjects__compare equal,their__hashcodes__mustalso__be equal,otherwise__thehash__tablealgorithm__doesnot__work.For__example,because__1 == 1.0is__True, hash(1) == hash(1.0)must__alsobe__True,even__thoughthe__internalrepresentation__ofan__intand__afloat__arevery__different. Also,to__beeffective__ashash__table indexes,hash__codesshould__scatteraround__theindex__spaceas__muchas__possible.This__means that, ideally,objects__thatare__similarbut__notequal__shouldhave__hashcodes__thatdiffer__widely.Example__3-17is__theoutput__ofa__scriptto__comparethe__bitpatterns__ofhash__codes.Note__howthe__hashesof__1and__1.0are__the same,but__thoseof__1.0001, 1.0002,and__1.0003are__very different.Example__3-17.Comparing__hashbit__patternsof__1, 1.0001, 1.0002,and__1.0003on__a 32-bitbuild__ofPython__(bitsthat__aredifferent__inthe__hashesabove__andbelow__arehighlighted__with !and__theright__columnshows__thenumber__ofbits__that differ) 9 32-bitPython__build 1 00000000000000000000000000000001 != 0 1.0 00000000000000000000000000000001 ------------------------------------------------ 1.0 00000000000000000000000000000001 ! !!! ! !! ! ! ! ! !! !!! != 16 1.0001 00101110101101010000101011011101 ------------------------------------------------ 1.0001 00101110101101010000101011011101 !!! !!!! !!!!! !!!!! !! ! != 20 1.0002 01011101011010100001010110111001 ------------------------------------------------ 1.0002 01011101011010100001010110111001 ! ! ! !!! ! ! !! ! ! ! !!!! != 17 1.0003 00001100000111110010000010010110 ------------------------------------------------The__codeto__produceExample__3-17is__in [Linkto__Come].Most__ofit__dealswith__formattingthe__output,but__itis__listedas__[Linkto__Come]for__completeness.NOTE__Startingwith__Python 3.3,a__randomsalt__valueis__includedwhen__computinghash__codesfor__str, bytes,and__datetime objects,as__documentedin__Issue 13703Hash__collisionsecurity__issue.The__saltvalue__isconstant__withina__Pythonprocess__butvaries__betweeninterpreter__runs.With__PEP-456,Python__3.4adopted__theSipHash__cryptographicfunction__tocompute__hashcodes__forstr__andbytes__objects.The__randomsalt__andSipHash__aresecurity__measuresto__preventDoS__attacks.Details__arein__anote__inthe__documentationfor__the__hash____special method.HASH__COLLISIONSAs__mentioned,on__64-bitCPython__ahash__codeis__a 64-bit number,and__thats__2possible__valueswhich__ismore__than 10 .But__mostPython__typescan__representmany__moredifferent__values.For__example,a__stringmade__of 10ASCII__printablecharacters__pickedat__randomhas__100 64 19 10possible__valuesmore__than 2 . Therefore,the__hashcode__ofan__objectusually__hasless__informationthan__theactual__object value.This__meansthat__objectsthat__aredifferent__mayhave__thesame__hash code.TIP__Whencorrectly__implemented,hashing__guaranteesthat__differenthash__codesalways__implydifferent__objects,but__thereverse__isnot__true:different__objectsdon__talways__havedifferent__hash codes.When__differentobjects__havethe__samehash__code,that__sa__hash collision.With__thisbasic__understandingof__hashcodes__andobject__equality,we__areready__todive__intothe__algorithmthat__makeshash__tables work,and__howhash__collisionsare__handled.The__hashtable__algorithmWe__willfocus__onthe__internalsof__set first,and__latertransfer__theconcepts__to dict.NOTE__Thisis__asimplified__viewof__howPython__usesa__hashtable__toimplement__a set.For__all details,see__commentedsource__codefor__CPythons__setand__frozensetin__Include/setobject.hand__Objects/setobject.c.Let__ssee__howPython__buildsa__setlike__{'Mon', 'Tue', 'Wed', 'Thu', 'Fri'},step__by step.The__algorithmis__illustratedby__theflowchart__inFigure__3-4,and__described next. 66Figure__3-4.Flowchart__foralgorithm__toadd__elementto__thehash__tableof__a set.Step__0:initialize__hashtable__Asmentioned__earlier,the__hashtable__fora__setstarts__with 8empty__buckets.As__elementsare__added,Python__makessure__atleast__ofthe__bucketsare__emptydoubling__thesize__ofthe__hashtable__whenmore__spaceis__needed.The__hashcode__fieldof__eachbucket__isinitialized__with -1,which__meansno__hashcode__.Step__1:compute__thehash__codefor__theelement__Giventhe__literal {'Mon', 'Tue', 'Wed', 'Thu', 'Fri'},Python__getsthe__hashcode__forthe__first element, 'Mon'.For__example,here__isa__realistichash__codefor__'Mon'you__llprobably__geta__differentresult__becauseof__therandom__saltPython__usesto__computethe__hashcode__of strings: >>> hash('Mon') 4199492796428269555Step__2:probe__hashtable__atindex__derivedfrom__hashcode__10Python__takesthe__modulusof__thehash__codewith__thetable__sizeto__finda__hashtable__index.Here__thetable__sizeis__8,and__themodulus__is 3: >>> 4199492796428269555 % 8 3Probing__consistsof__computingthe__indexfrom__the hash,then__lookingat__thecorresponding__bucketin__thehash__table.In__this case,Python__looksat__thebucket__atoffset__3and__finds -1in__thehash__code field,marking__anempty__bucket.Step__3:put__theelement__inthe__emptybucket__Pythonstores__thehash__codeof__thenew__element, 4199492796428269555,in__thehash__codefield__atoffset__3,and__apointer__tothe__stringobject__'Mon'in__theelement__field.Figure__3-5shows__thecurrent__stateof__thehash__table.Figure__3-5.Hash__tablefor__theset__{'Mon'}.STEPS__FORREMAINING__ITEMSFor__thesecond__element, 'Tue',steps__1, 2, 3above__are repeated.The__hashcode__for 'Tue'is__2414279730484651250,and__theresulting__indexis__2. >>> hash('Tue') 2414279730484651250 >>> hash('Tue') % 8 2The__hashand__pointerto__element 'Tue'are__placedin__bucket 2,which__wasalso__empty.Now__wehave__Figure 3-6Figure__3-6.Hash__tablefor__theset__{'Mon', 'Tue'}.Note__thatelement__orderingis__notpreserved__inthe__hash table.STEPS__FORA__COLLISIONWhen__adding 'Wed'to__the set,Python__computesthe__hash -5145319347887138165and__index 3.Python__probesbucket__3and__seesthat__itis__already taken.But__thehash__codestored__there, 4199492796428269555is__different.As__discussedin__Hashesand__equality ,if__twoobjects__havedifferent__hashes,then__theirvalue__isalso__different.This__isan__index collision.Python__thenprobes__thenext__bucketand__findsit__empty.So__'Wed'ends__upat__index 4,as__shownin__Figure 3-7.Figure__3-7.Hash__tablefor__theset__{'Mon', 'Tue', 'Wed'}.After__the collision, 'Wed'is__putat__index 4.Adding__thenext__element, 'Thu',is__boring:there__sno__collision,and__itlands__inits__natural bucket,at__index 7.Placing__'Fri'is__more interesting.Its__hash, 7021641685991143771implies__index 3,which__istaken__by 'Mon'.Probing__thenext__bucket 4Python__findsthe__hashfor__'Wed'stored__there.The__hashcodes__dont__match,so__thisis__anotherindex__collision.Python__probesthe__next bucket.It__s empty,so__'Fri'ends__upat__index 5.The__endstate__ofthe__hashtable__isshown__inFigure__3-8.NOTE__Incrementingthe__indexafter__acollision__iscalled__linear probing.This__canlead__toclusters__ofoccupied__buckets,which__candegrade__thehash__table performance,so__CPythoncounts__thenumber__oflinear__probesand__aftera__certain threshold,applies__apseudo__randomnumber__generatorto__obtaina__differentindex__fromother__bitsof__thehash__code.This__optimizationis__particularyimportant__inlarge__sets.Figure__3-8.Hash__tablefor__theset__{'Mon', 'Tue', 'Wed', 'Thu', 'Fri'}.It__isnow__62.5%full__closeto__the threshold.When__thereis__anelement__inthe__probedbucket__andthe__hashcodes__match,Python__alsoneeds__tocompare__theactual__object values.That__s because,as__explainedin__Hashcollisions__,it__spossible__thattwo__differentobjects__havethe__samehash__codealthough__thats__rarefor__strings,thanks__tothe__qualityof__theSiphash__algorithm .This__explainswhy__hashableobjects__mustimplement__both__hash____and __eq__.If__anew__elementwere__addedto__ourexample__hash table,it__wouldbe__morethan__full,therefore__increasingthe__chancesof__index collisions.To__prevent that,Python__wouldalocate__anew__hashtable__with 16 buckets,and__reinsertall__elements there.All__thismay__seemlike__alot__of work,but__evenwith__millionsof__itemsin__a set,many__insertionshappen__withno__collisions,and__theaverage__numberof__collisionsper__insertionis__betweenone__and two.Under__normal usage,even__theunluckiest__elementscan__beplaced__aftera__handfulof__collisionsare__resolved. 11 Now,given__whatwe__veseen__so far,follow__theflowchart__inFigure__3-4to__answerthe__followingpuzzle__withoutusing__the computer.Given__thefollowing__set,what__happenswhen__youadd__aninteger__1to__it? >>>s__= {1.0, 2.0, 3.0} >>> s.add(1)How__manyelements__arein__s now?Does__1replace__theelement__1.0?When__youhave__your answer,use__thePython__consoleto__verify it.SEARCHING__ELEMENTSIN__AHASH__TABLEConsider__theworkdays__setwith__thehash__tableshown__inFigure__3-8.Is__'Sat'in__it?This__isthe__simplestexecution__pathfor__theexpression__'Sat'in__workdays: 1.Call__hash('Sat')to__geta__hash code.Let__ssay__itis__4910012646790914166 2.Derive__ahash__tableindex__fromthe__hash code,using__hash_code % table_size.In__this case,the__indexis__6. 3.Probe__offset 6:it__s empty.This__means 'Sat'is__notin__the set.Return__False.Now__considerthe__simplestpath__foran__elementthat__ispresent__inthe__set.To__evaluate 'Thu'in__workdays: 1.Call__hash('Tue').Pretend__resultis__6166047609348267525. 2.Compute__index: 6166047609348267525 % 8is__5. 3.Probe__offset 5: a.Compare__hash codes.They__are equal. b.Compare__theobject__values.They__are equal.Return__True.Collisions__arehandled__inthe__waydescribed__whenadding__an element.In__fact,the__flowchartin__Figure 3-4applies__tosearches__as well,with__theexception__ofthe__terminalnodes__therectangles__withrounded__corners.If__anempty__bucketis__found,the__elementis__not present,so__Pythonreturns__False; otherwise,when__boththe__hashcode__andthe__valuesof__thesought__elementmatch__anelement__inthe__hash table,the__returnis__True.PRACTICAL__CONSEQUENCESOF__HOWSETS__WORKThe__setand__frozensettypes__areboth__implementedwith__ahash__table,which__hasthese__effects:Set__elementsmust__behashable__objects.They__mustimplement__proper__hash____and__eq____methodsas__describedin__WhatIs__Hashable? .Membership__testingis__very efficient.A__setmay__havemillions__of elements,but__thebucket__foran__elementcan__belocated__directlyby__computingthe__hashcode__ofthe__elementand__derivingan__index offset,with__thepossible__overheadof__asmall__numberof__probesto__finda__matchingelement__oran__empty bucket.Sets__havea__significantmemory__overhead.The__mostcompact__internaldata__structurefor__acontainer__wouldbe__anarray__ofpointers__.Compared__to that,a__hashtable__addsa__hashcode__per entry,and__atleast__ofempty__bucketsto__minimize collisions.Element__orderingdepends__oninsertion__order,but__notin__auseful__orreliable__way.If__twoelements__areinvolved__ina__collision,the__bucketwere__eachis__storeddepends__onwhich__elementis__added first.Adding__elementsto__aset__maychange__theorder__ofother__elements. 12That__s because,as__thehash__tableis__filled,Python__mayneed__torecreate__itto__keepat__leastof__thebuckets__empty.When__this happens,elements__arereinserted__anddifferent__collisionsmay__occur.Hash__tableusage__indict__Since 2012,the__implementationof__thedict__typehad__twomajor__optimizationsto__reducememory__usage.The__firstone__wasproposed__asPEP__412 Key-SharingDictionary__andimplemented__inPython__3.3 .The__secondis__calledcompact__dict",and__landedin__Python 3.6.As__aside__effect,the__compactdict__spaceoptimization__preserveskey__insertion order.In__thenext__sectionswe__lldiscuss__thecompact__dictand__thenew__key-sharingscheme__inthis__order,for__easier presentation.HOW__COMPACTDICT__SAVESSPACE__NOTEThis__isa__highlevel__explanationof__thePython__dict implementation.One__differenceis__thatthe__actualusable__fractionof__adict__hashtable__is ,and__notas__in sets.The__actualfraction__wouldrequire__16buckets__tohold__the 4items__inmy__example dict,and__thediagrams__inthis__sectionwould__becometoo__tall,so__Ipretend__theusable__fractionis__inthese__explanations.One__commentin__Objects/dictobject.cexplains__thatany__fractionbetween__andseem__towork__wellin__practice .Consider__adict__holdingthe__abbreviatednames__forthe__weekdaysfrom__'Mon'through__'Thu',and__thenumber__ofstudents__enrolledin__swimmingclass__oneach__day: >>>swimmers__= {'Mon': 14, 'Tue': 12, 'Wed': 14, 'Thu': 11} 13Before__thecompact__dict optimization,the__hashtable__underlyingthe__swimmersdictionary__wouldlook__likeFigure__3-9.As__youcan__see,in__a 64-bit Python,each__bucketholds__three 64-bit fields:the__hashcode__ofthe__key,a__pointerto__thekey__object,and__apointer__tothe__value object.That__s 24bytes__per bucket.Figure__3-9.Old__hashtable__formatfor__adict__with 4 key-value pairs.Each__bucketis__astruct__withthe__hashcode__ofthe__key,a__pointerto__the key,and__apointer__tothe__value.The__firsttwo__fieldsplay__thesame__roleas__theydo__inthe__implementationof__sets.To__finda__key,Python__computesthe__hashcode__ofthe__key,derives__anindex__fromthe__key,then__probesthe__hashtable__tofind__abucket__witha__matchinghash__codeand__amatching__key object.The__thirdfield__providesthe__mainfeature__ofa__dict:mapping__akey__toan__arbitrary value.The__keymust__bea__hashable object,and__thehash__tablealgorithm__ensuresit__willbe__uniquein__the dict.But__thevalue__maybe__anyobject__itdoesn__tneed__tobe__hashableor__unique.Raymond__Hettingerobserved__thatsignificant__savingscould__bemade__ifthe__hashcode__andpointers__tokey__andvalue__wereheld__inan__entriesarray__withno__empty rows,and__theactual__hashtable__werea__sparsearray__withmuch__smallerbuckets__holdingindexes__intothe__entriesarray__.In__his 14original__messageto__python-dev,Hettinger__calledthe__hashtable__indices.The__widthof__thebuckets__inindices__variesas__thedict__grows,starting__at 8-bitsper__bucketenough__toindex__upto__128 entries,while__reservingnegative__valuesfor__special purposes,such__as -1for__emptyand__-2for__deleted.As__an example,the__swimmersdictionary__wouldthen__bestored__asshown__inFigure__3-10.Figure__3-10.Compact__storagefor__adict__with 4 key-value pairs.Hash__codesand__pointersto__keysand__valuesare__storedin__insertionorder__inthe__entries array,and__theentry__offsetsderived__fromthe__hashcodes__areheld__inthe__indicessparse__array,where__anindex__valueof__-1signals__anempty__bucket.Assuming__a 64-bitbuild__of CPython,our__4-itemswimmers__dictionarywould__take 192bytes__ofmemory__inthe__old scheme: 24bytes__per bucket,times__8 rows.The__equivalentcompact__dictuses__104bytes__in total: 96bytes__inentries__(24 * 4),plus__8bytes__forthe__bucketsin__indicesconfigured__asan__arrayof__8 bytes.The__nextsection__describeshow__thosetwo__arrarysare__used.ALGORITHM__FORADDING__ITEMSTO__COMPACT DICT.Step__0:set__upindices__Theindices__tableis__initiallyset__upas__anarray__ofsigned__bytes,with__8 buckets,each__initializedwith__-1to__signalempty__bucket .Up__to 5of__thesebuckets__willeventually__holdindices__torows__inthe__entries array,leaving__ofthem__with -1.The__other array, entries,will__hold key/valuedata__withthe__samethree__fieldsas__inthe__oldscheme__butin__insertion order.Step__1:compute__hashcode__forthe__keyTo__addthe__key-valuepair__('Mon', 14)to__theswimmers__dictionary,Python__firstcalls__hash('Mon')to__computethe__hashcode__ofthat__key.Step__2:probe__entriesvia__indicesPython__computes hash('Mon') % len(indices).In__our example,this__is 3.Offset__3in__indicesholds__-1:it__san__empty bucket.Step__3:put__key-valuein__entries,updating__indices.The__entriesarray__is empty,so__thenext__availableoffset__thereis__0.Python__puts 0at__offset 3in__indicesand__storesthe__hashcode__ofthe__key,a__pointerto__thekey__object 'Mon',and__apointer__tothe__intvalue__14at__offset 0in__entries.Figure__3-11shows__thestate__ofthe__arrayswhen__thevalue__ofswimmers__is {'Mon': 14}.Figure__3-11.Compact__storagefor__the {'Mon': 14}: indices[3]holds__theoffset__ofthe__first entry: entries[0].STEPS__FORNEXT__ITEMTo__add ('Tue', 12)to__swimmers: 1.Compute__hashcode__ofkey__'Tue'. 2.Compute__offsetinto__indices,as__hash('Tue') % len(indices).This__is 2. indices[2]has__-1.No__collisionso__far. 3.Put__thenext__availableentries__offset, 1,in__indices[2],then__storeentry__at entries[1].Now__thestate__isFigure__3-12.Note__thatentries__holdsthe__key-valuepairs__ininsertion__order.Figure__3-12.Compact__storagefor__the {'Mon': 14, 'Tue': 12}.STEPS__FORA__COLLISION 1.Compute__hashcode__ofkey__'Wed'. 2. Now, hash('Wed') % len(indices)is__3. indices[3]has__0,pointing__toan__existing entry.Look__atthe__hashcode__in entries[0].That__sthe__hashcode__for 'Mon',which__happensto__bedifferent__thanthe__hashcode__for 'Wed'.This__mismatchsignals__a collision.Probes__thenext__index: indices[4].That__s -1,so__itcan__be used. 3.Make__indices[4] = 2,because__2is__thenext__availableoffset__at entries.Then__fill entries[2]as__usual.After__adding ('Wed', 14),we__haveFigure__3-13Figure__3-13.Compact__storagefor__the {'Mon': 14, 'Tue': 12, 'Wed': 14}.HOW__ACOMPACT__DICTGROWS__Recallthat__thebuckets__inthe__indicesarray__are 8signed__bytes initially,enough__tohold__offsetsfor__upto__5 entries,leaving__ofthe__buckets empty.When__the 6thitem__isadded__tothe__dict,indices__isreallocated__to 16buckets__enoughfor__10entry__offsets.The__sizeof__indicesis__doubledas__needed,while__stillholding__signed bytes,until__thetime__comesto__addthe__129thitem__tothe__dict.At__this point,the__indicesarray__has 256 8-bit buckets. However,a__signedbyte__isnot__enoughto__holdoffsets__after 128 entries,so__theindices__arrayis__rebuiltto__hold 256 16-bitbuckets__tohold__signedintegers__wideenough__torepresent__offsetsto__32,768rows__inthe__entries table.The__nextresizing__happensat__the 171st addition,when__indiceswould__becomemore__than full.Then__thenumber__ofbuckets__inindices__isdoubled__to 512,but__eachbucket__still 16-bitswide__each.In__summary,the__indicesarray__growsby__doublingthe__numberof__buckets,and__alsoless__oftenby__doublingthe__widthof__eackbucket__toaccomodate__agrowing__numberof__rowsin__entries.This__concludesour__summaryof__thecompact__dict implementation.I__ommitedmany__details,but__nowlet__stake__alook__atthe__other space-savingoptimization__for dictionaries: key-sharing. Key-sharingdictionary__Instancesof__user-definedclasses__usuallyhold__theirattributes__ina____dict__attribute__whichis__aregular__dictionary .In__aninstance____dict__,the__keysare__theattribute__names,and__thevalues__arethe__attribute values.Most__ofthe__time,all__instanceshave__thesame__attributeswith__different values.When__that happens, 2of__the 3fields__inthe__entriestable__forevery__instancehas__theexact__same content:the__hashcode__ofthe__attribute name,and__apointer__tothe__attribute name.Only__thepointer__tothe__attributevalue__is different.In__PEP 412 Key-Sharing Dictionary,Mark__Shannonproposed__tosplit__thestorage__ofdictionaries__usedas__instance __dict__,so__thateach__attributehash__codeand__pointeris__storedonly__once,linked__tothe__class,and__theattribute__valuesare__keptin__parallelarrays__ofpointers__attachedto__each instance.Given__aMovie__classwhere__allinstances__havethe__sameattributes__named 'title', 'release', 'directors',and__'actors',Figure__3-14shows__thearrangement__of key-sharingin__asplit__dictionaryalso__implementedwith__thenew__compact layout. 15Figure__3-14.Split__storagefor__the__dict____ofa__classand__three instances.PEP__412introduced__theterms__combined-tableto__discussthe__oldlayout__andand__split-tablefor__theproposed__optimization.The__combined-tablelayout__isstill__thedefault__whenyou__createa__dictusing__literalsyntax__orcall__dict().A__split-tabledictionary__iscreated__tofill__the__dict____specialattribute__ofan__instance,when__itis__thefirst__instanceof__a class.The__keystable__(seeFigure__3-14)is__thencached__inthe__class object.This__leveragesthe__factthat__mostObject__OrientedPython__codeassigns__allinstance__attributesin__the__init____method.That__firstinstance__(andall__instancesafter__it)will__holdonly__itsown__avalue__array.If__aninstance__getsa__newattribute__notfound__inthe__sharedkeys__table,then__thisinstance__s__dict____isconverted__to combined-table form. However,if__thisinstance__isthe__onlyone__inits__class,the____dict__is__convertedback__to split-table,since__itis__assumedthat__furtherinstances__willhave__thesame__setof__attributesand__keysharing__willbe__useful.The__PyDictObjectstruct__thatrepresents__adict__inthe__CPythonsource__codeis__thesame__forboth__combined-tableand__split-table dictionaries.When__adict__convertsfrom__onelayout__tothe__other,the__changehappens__inPyDictObject__fields,with__thehelp__ofother__internaldata__structures.Practical__Consequencesof__Howdict__WorksKeys__mustbe__hashable objects.They__mustimplement__proper__hash____and__eq____methodsas__describedin__WhatIs__Hashable? .Key__searchesare__nearlyas__fastas__elementsearches__in sets.Item__orderingis__preservedin__theentries__tablethis__wasimplemented__inCPython__3.6,and__becamean__officiallanguage__featurein__3.7.To__save memory,avoid__creatinginstance__attributesoutside__ofthe____init__ method.If__allinstance__attributesare__createdin____init__,the____dict__of__yourinstances__willuse__the split-table__layout,sharing__thesame__indicesand__keyentries__arraystored__withthe__class.Chapter__SummaryDictionaries__area__keystoneof__Python.Beyond__thebasic__dict,the__standardlibrary__offers handy, ready-to-usespecialized__mappingslike__defaultdict, ChainMap,and__Counter,all__definedin__thecollections__module.With__thenew__dict implementantion,OrderedDict__isnot__asuseful__as before,but__shouldremain__inthe__standardlibrary__for backward-compatibilityand__itoffers__the .popitem(last=False)method__optionto__dropand__returnthe__first item,which__dictdoesn__tyet__have.Also__inthe__collectionsmodule__isthe__easy-to-extendUserDict__class.Two__powerfulmethods__availablein__mostmappings__aresetdefault__and update.The__setdefaultmethod__isused__toupdate__itemsholding__mutable values,for__example,in__adict__oflist__values,to__avoidredundant__searchesfor__thesame__key.The__updatemethod__allowsbulk__insertionor__overwritingof__itemsfrom__anyother__mapping,from__iterablesproviding__(key, value)pairs__andfrom__keyword arguments.Mapping__constructorsalso__useupdate__internally,allowing__instancesto__beinitialized__from mappings, iterables,or__keyword arguments.A__cleverhook__inthe__mappingAPI__isthe____missing__ method,which__letsyou__customizewhat__happenswhen__akey__isnot__foundwhen__usingthe__d[k]syntax__whichinvokes____getitem__.The__collections.abcmodule__providesthe__Mappingand__MutableMappingabstract__baseclasses__asstandard__interfaces,useful__for run-timetype__checking.The__little-knownMappingProxyType__fromthe__typesmodule__createsimmutable__mappings.There__arealso__ABCsfor__Setand__MutableSet.Dictionary__viewsare__agreat__additionin__Python 3,without__thememory__overheadof__thePython__2 .keys(), .values()and__.items()methods__thatbuilt__listsduplicating__datain__thetarget__dict instance.In__addition,the__dict_keysand__dict_itemsclasses__supportthe__mostuseful__methodsand__operatorsof__frozenset.The__hashtable__implementationunderlying__setis__extremely fast.Understanding__itslogic__explainswhy__elementsare__apparentlyunordered__andmay__evenbe__reorderedbehind__our backs.There__isa__priceto__payfor__allthis__speed,and__theprice__isin__memory. Finally,we__sawhow__optimizationsin__thehash__tablesunderlying__dictsave__memoryand__preservekey__insertion order.Further__ReadingIn__ThePython__StandardLibrary__documentation, 8.3.collections__Containerdatatypes__includesexamples__andpractical__recipeswith__severalmapping__types.The__Pythonsource__codefor__themodule__Lib/collections/__init__.pyis__agreat__referencefor__anyonewho__wantsto__createa__newmapping__typeor__grokthe__logicof__theexisting__ones.Chapter__1of__Python Cookbook,Third__edition (O Reilly)by__DavidBeazley__andBrian__K.Jones__has 20handy__andinsightful__recipeswith__datastructures__themajority__usingdict__inclever__ways.Greg__Gandenbergeradvocates__forthe__continueduse__of collections.Orderedict,on__thegrounds__thatexplicit__isbetter__thanimplicit__,backward__compatibility,and__thefact__thatsome__toolsand__librariesassume__theordering__ofdict__keysis__irrelevanthis__post:Python__DictionariesAre__Now Ordered.Keep__Using OrderedDict..PEP__3106Revamping__dict.keys(), .values()and__.items()is__whereGuido__vanRossum__presentedthe__dictionaryviews__featurefor__Python 3.In__the abstract,he__wrotethe__ideacame__theJava__Collections Framework.Pypy__wasthe__firstPython__interpreterto__implementRaymond__Hettingers__proposalof__compact dicts,and__theyblogged__aboutit__in Faster,more__memoryefficient__andmore__ordereddictionaries__on PyPy,acknowledging__thata__similarlayout__wasadopted__inPHP__7,descibed__inPHP__snew__hashtable implementation.It__salways__greatwhen__creatorscite__prior art.At__PyCon 2017,Brandon__Rhodespresented__TheDictionary__Even Mightier,a__sequelto__hisclassic__animatedpresentation__TheMighty__Dictionaryincluding__animatedhash__collisions!Another__up-to-date,but__more in-depthvideo__onthe__internalsof__Pythons__dictis__ModernDictionaries__byRaymond__Hettinger,where__hetells__thatafter__initiallyfailing__tosell__compactdicts__tothe__CPythoncore__devs,he__lobbiedthe__Pypy team,they__adopted it,the__ideagained__traction,and__wasfinally__contributedto__CPython 3.6by__byINADA__Naoki.For__all details,check__outthe__extensivecomments__inthe__CPythoncode__for Objects/dictobject.cand__Objects/dict-common.h,as__wellas__thedesign__document Objects/dictnotes.txt.The__rationalefor__addingsets__toPython__isdocumented__inPEP__218Adding__a Built-InSet__Object Type.When__PEP 218was__approved,no__specialliteral__syntaxwas__adoptedfor__sets.The__setliterals__werecreated__forPython__3and__backportedto__Python 2.7,along__withdict__andset__comprehensions.At__PyCon 2019,I__presentedSet__Practice:learning__fromPython__sset__types (slides),describing__usecases__ofsets__inreal__programs,covering__theirAPI__design,and__theimplementantion__of uintset,a__setclass__forinteger__elementsusing__abit__vectorinstead__ofa__hash table,inspired__byan__examplein__chapter 6of__theexcellent__TheGo__Programming Language,by__Donovan & Kernighan.IEEE__sSpectrum__magazinehas__astory__aboutHans__Peter Luhn,a__prolifcinventor__whopatented__apunched__carddeck__toselect__cocktailrecipes__dependingon__ingredients available,among__otherdiverse__inventionsincluding__hash tables!See__inHans__PeterLuhn__andthe__Birthof__theHashing__Algorithm.SOAPBOX__Thefundamental__theoremof__softwareengineering__Myfriend__GeraldoCohen__onceremarked__thatPython__issimple__and correct.The__followingquote__iscalled__withsome__ironythe__fundamentaltheorem__ofsoftware__engineering:Any__problemin__computerscience__canbe__solvedwith__anotherlevel__ofindirection__.David__WheelerIn__thebusiness__of software,a__usefulvariation__is:Any__problemin__softwareengineering__canbe__solvedwith__anotherlevel__of abstraction,except__forthe__problemof__toomany__levelsof__abstracion.anonymous__Pythons__compactdict__andthe__key-sharingscheme__areboth__primeexamples__ofindirection__solving problems.But__theyare__transparentto__theend__user,so__theydon__tforce__usto__learnnew__abstractionsthey__justmake__ourlife__easier.Simple__and correct.Syntactic__sugarHere__isanother__famouscomputer__science quote:Syntactic__sugarcauses__cancerof__the semicolon.Alan__PerlisSome__computerlanguage__puristslike__todismiss__syntaxas__unimportant,but__codersknow__itmatters__in practice. 16Before__finding Python,I__haddone__webprogramming__using Perl, PHP,and__JavaScript.The__syntaxfor__mappingsin__theselanguages__isvery__useful,and__Ibadly__missit__wheneverI__haveto__useJava__or C.A__goodliteral__syntaxfor__mappingsmakes__iteasy__todo__configuration, table-driven implementations,and__tohold__datafor__prototypingand__testing.The__lackof__itpushed__theJava__communityto__adoptthe__verboseand__overlycomplex__XMLas__adata__format.JSON__wasproposed__asThe__Fat-FreeAlternative__toXML__andbecame__ahuge__success,replacing__XMLin__many contexts.A__concisesyntax__forlists__anddictionaries__makesan__excellentdata__interchange format.PHP__andRuby__imitatedthe__hashsyntax__from Perl,using__=>to__linkkeys__to values.JavaScript__followedthe__leadof__Pythonand__uses :.Why__usetwo__characterswhen__oneis__readable enough?JSON__camefrom__JavaScript,but__italso__happensto__bean__almostexact__subsetof__Python syntax.JSON__iscompatible__withPython__exceptfor__thespelling__ofthe__values true, false,and__null.Armin__Ronachertweeted__thathe__likesto__hackPython__s__builtin____toadd__JSON-compatiblealiases__forPython__s True, False,and__Noneso__hecan__pasteJSON__directlyin__the console.The__basic idea: >>> true, false,null__= True, False,None__>>>fruit__= { ... "type": "banana", ... "avg_weight": 123.2, ... "edible_peel": false, ... "species": ["acuminata", "balbisiana", "paradisiaca"], ... "issues": null, ... } >>>fruit__{'type': 'banana', 'avg_weight': 123.2, 'edible_peel': False, 'species': ['acuminata', 'balbisiana', 'paradisiaca'], 'issues': None}The__syntaxeverybody__nowuses__forexchanging__datais__Pythons__dictand__list syntax.Simple__and correct. 1PyCon__2017 talk;video__availableat__https://youtu.be/66P5FMkWoVU?t=56 2The__originalscript__appearsin__slide 41of__Martellis__Re-learningPython__presentation.His__scriptis__actuallya__demonstrationof__dict.setdefault,as__shownin__ourExample__3-4. 3This__isan__exampleof__usinga__methodas__a first-class function,the__subjectof__[Linkto__Come]. 4One__suchlibrary__is Pingo.io,no__longerunder__active development. 5The__exactproblem__withsubclassing__dictand__other built-insis__coveredin__[Linkto__Come]. 6Dictionary__viewswere__backportedto__Python 2.7and__arereturned__bythe__dictmethods__.viewkeys(), .viewvalues(),and__.viewitems().I__hopethis__informationis__ofno__useto__you,dear__reader,as__Python 2.7is__now history. 7This__maybe__interesting,but__isnot__super important.The__speedup__willhappen__onlywhen__aset__literalis__evaluated,and__thathappens__atmost__onceper__Pythonprocess__whena__moduleis__initially compiled.If__youre__curious,import__thedis__functionfrom__thedis__moduleand__useit__todisassemble__thebytecodes__fora__setliteral__e.g. dis('{1}')and__aset__call dis('set([1])') 8The__wordbucket__makesmore__senseto__describehash__tablesthat__holdmore__thanone__elementper__row.Python__storesonly__oneelement__per row,but__wewill__stickwith__thecolorful__traditional term. 9Since__Ijust__mentioned int,here__isa__CPythonimplementation__detail:the__hashcode__ofan__intthat__fitsin__amachine__wordis__thevalue__ofthe__int itself,except__thehash__codeof__-1,which__is -2. 10The__hash() built-innever__returns -1for__anyPython__object.If__x.__hash__()returns__-1, hash(x)returns__-2. 11On__64-bit CPython,string__hashcollisions__areso__uncommonthat__Iwas__unableto__producean__examplefor__this explanation.If__youfind__one,let__me know. 12That__show__tuplesare__stored. 13That__wasbefore__Istarted__writingthe__1st__editionof__Fluent Python,but__Imissed__it. 14It__sironic__thatthe__bucketsin__thehash__tablehere__donot__containhash__codes,but__onlyindexes__tothe__entriesarray__wherethe__hashcodes__are. But, conceptually,the__indexarray__isreally__thehash__tablein__this implementation,even__ifthere__areno__hashesin__its buckets. 15Unless__theclass__hasa____slots__ atribute,as__well__seein__chapterXXX__16Quoted__inButler__Lampsons__Turinglecture__slidesPrinciples__forComputer__SystemDesign__Chapter 4.Text__versusBytes__ANOTE__FOREARLY__RELEASEREADERS__WithEarly__Release ebooks,you__getbooks__intheir__earliestform__theauthor__sraw__andunedited__contentas__theywrite__soyou__cantake__advantageof__thesetechnologies__longbefore__theofficial__releaseof__these titles.This__willbe__the 4thchapter__ofthe__final book.Please__notethat__theGitHub__repowill__bemade__activelater__on.If__youhave__commentsabout__howwe__mightimprove__thecontent__and/orexamples__inthis__book,or__ifyou__noticemissing__materialwithin__this chapter,please__reachout__tothe__authorat__fluentpython2e@ramalho.org.Humans__use text.Computers__speak bytes.Esther__Namand__Travis Fischer,Character__Encodingand__Unicodein__PythonPython__3introduced__asharp__distinctionbetween__stringsof__humantext__andsequences__ofraw__bytes.Implicit__conversionof__bytesequences__toUnicode__textis__athing__ofthe__past.This__chapterdeals__withUnicode__strings,binary__sequences,and__theencodings__usedto__convertbetween__them.Depending__onyour__Pythonprogramming__context,a__deeperunderstanding__ofUnicode__mayor__maynot__beof__vitalimportance__to you.In__the end,most__ofthe__issuescovered__inthis__chapterdo__notaffect__programmerswho__dealonly__withASCII__text.But__evenif__thatis__your case,there__isno__escapingthe__strversus__byte divide.As__a bonus,you__llfind__thatthe__specializedbinary__sequencetypes__providefeatures__thatthe__all-purposePython__2str__typedoes__not have.In__this chapter,we__willvisit__thefollowing__topics: Characters,code__points,and__byterepresentations__1Unique__featuresof__binary sequences: bytes, bytearray,and__memoryviewCodecs__forfull__Unicodeand__legacycharacter__setsAvoiding__anddealing__withencoding__errorsBest__practiceswhen__handlingtext__filesThe__defaultencoding__trapand__standard I/Oissues__SafeUnicode__textcomparisons__withnormalization__Utilityfunctions__for normalization,case__folding,and__brute-forcediacritic__removalProper__sortingof__Unicodetext__withlocale__andthe__PyUCAlibrary__Charactermetadata__inthe__Unicodedatabase__Dual-modeAPIs__thathandle__strand__bytesBuilding__emojisfrom__charactercombinations__Whats__newin__thischapter__Supportfor__Unicodein__Python 3has__beencomprehensive__andstable__fora__while,so__thebiggest__changein__thischapter__isa__newsection__onemojis__notbecause__ofchanges__in Python,but__becauseof__thegrowing__popularityof__emojisand__emoji combinations.Unicode__13,released__in 2020,supports__morethan__3000 emojis,and__manyof__themthat__arebuilt__bycombining__Unicode characters. Multi-characteremojis__explains.Also__newin__this 2edition__isFinding__charactersby__nameincluding__sourcecode__forutility__forsearching__theUnicode__database,a__greatway__tofind__circleddigits__andsmiling__catsfrom__the command-line.nd__Aminor__changeworth__mentioningis__theUnicode__supporton__Windows,which__isbetter__andsimpler__sincePython__3.6,as__well__seein__Encoding Defaults:A__Madhouse .Let__sstart__withthe__not-so-new,but__fundamentalconcepts__of characters,code__points,and__bytes.Character__IssuesThe__conceptof__stringis__simple enough:a__stringis__asequence__of characters.The__problemlies__inthe__definitionof__character.In__2020,the__bestdefinition__ofcharacter__wehave__isa__Unicode character. Accordingly,the__itemsyou__getout__ofa__Python 3str__areUnicode__characters,just__likethe__itemsof__aunicode__objectin__Python 2and__notthe__rawbytes__youget__froma__Python 2 str.The__Unicodestandard__explicitlyseparates__theidentity__ofcharacters__fromspecific__byte representations:The__identityof__acharacter__itscode__pointis__anumber__from 0to__1,114,111 (base 10),shown__inthe__Unicodestandard__as 4to__6hex__digitswith__a U+ prefix,from__U+0000to__U+10FFFF.For__example,the__codepoint__forthe__letterA__is U+0041,the__Eurosign__is U+20AC,and__themusical__symbolG__clefis__assignedto__codepoint__U+1D11E.About__12%of__thevalid__codepoints__havecharacters__assignedto__themin__Unicode 12.1,the__standardused__inPython__3.8.The__actualbytes__thatrepresent__acharacter__dependon__theencoding__in use.An__encodingis__analgorithm__thatconverts__codepoints__tobyte__sequencesand__vice versa.The__codepoint__forthe__letterA__(U+0041)is__encodedas__thesingle__byte \x41in__the UTF- 8 encoding,or__asthe__bytes \x41\x00in__UTF-16LE encoding.As__another example, UTF-8requires__threebytes__\xe2\x82\xacto__encodethe__Eurosign__(U+20AC)but__in UTF-16LEthe__samecode__pointis__encodedas__two bytes: \xac\x20.Converting__fromcode__pointsto__bytesis__encoding;converting__frombytes__tocode__pointsis__decoding.See__Example 4-1.Example__4-1.Encoding__anddecoding__>>>s__= 'caf ' >>> len(s) 4 >>>b__= s.encode('utf8') >>>b__b'caf\xc3\xa9' >>> len(b) 5 >>> b.decode('utf8') 'caf 'The__str 'caf 'has__fourUnicode__characters.Encode__strto__bytesusing__UTF-8 encoding.bytes__literalshave__ab__prefix.bytes__bhas__fivebytes__(thecode__pointfor__isencoded__astwo__bytesin__UTF-8).Decode__bytesto__strusing__UTF-8 encoding.TIP__Ifyou__needa__memoryaid__tohelp__distinguish .decode()from__.encode(),convince__yourselfthat__bytesequences__canbe__crypticmachine__coredumps__whileUnicode__strobjects__arehuman__text. Therefore,it__makessense__thatwe__decodebytes__tostr__toget__human-readable text,and__weencode__strto__bytesfor__storageor__transmission.Although__thePython__3str__ispretty__muchthe__Python 2unicode__typewith__anew__name,the__Python 3bytes__isnot__simplythe__oldstr__renamed,and__thereis__alsothe__closelyrelated__bytearray type.So__itis__worthwhileto__takea__lookat__thebinary__sequencetypes__beforeadvancing__to encoding/decoding issues.Byte__EssentialsThe__newbinary__sequencetypes__areunlike__thePython__2str__inmany__regards.The__firstthing__toknow__isthat__thereare__twobasic__built-intypes__forbinary__sequences:the__immutablebytes__typeintroduced__inPython__3and__themutable__bytearray,added__inPython__2.6.Each__itemin__bytesor__bytearrayis__aninteger__from 0to__255,and__nota__one-characterstring__likein__thePython__2 str. However,a__sliceof__abinary__sequencealways__producesa__binarysequence__ofthe__sametype__includingslices__oflength__1.See__Example 4-2.Example__4-2.A__five-bytesequence__asbytes__andas__bytearray >>>cafe__= bytes('caf ', encoding='utf_8') >>>cafe__b'caf\xc3\xa9' >>> cafe[0] 99 >>> cafe[:1] b'c' >>>cafe_arr__= bytearray(cafe) >>>cafe_arr__bytearray(b'caf\xc3\xa9') >>> cafe_arr[-1:] bytearray(b'\xa9')bytes__canbe__builtfrom__a str,given__an encoding.Each__itemis__aninteger__in range(256). 2Slices__ofbytes__arealso__byteseven__slicesof__asingle__byte.There__isno__literalsyntax__for bytearray:they__areshown__as bytearray()with__abytes__literalas__argument.A__sliceof__bytearrayis__alsoa__bytearray.WARNING__Thefact__that my_bytes[0]retrieves__anint__but my_bytes[:1]returns__abytes__objectof__length 1may__be surprising,and__makesit__harderto__supportboth__Python 2.7and__3in__programsthat__dealwith__binary data.But__itis__consistentwith__manyother__languagesand__alsowith__otherPython__sequencetypes__exceptfor__str,which__isthe__onlysequence__typewhere__s[0] == s[:1].Although__binarysequences__arereally__sequencesof__integers,their__literalnotation__reflectsthe__factthat__ASCIItext__isoften__embeddedin__them. Therefore,three__differentdisplays__are used,depending__oneach__byte value:For__bytesin__theprintable__ASCIIrange__fromspace__to ~the__ASCIIcharacter__itselfis__used.For__bytescorresponding__to tab, newline,carriage__return,and__\,the__escapesequences__\t, \n, \r,and__\\are__used.For__everyother__byte value,a__hexadecimalescape__sequenceis__used (e.g., \x00is__thenull__byte).That__iswhy__inExample__4-2you__see b'caf\xc3\xa9':the__firstthree__bytes b'caf'are__inthe__printableASCII__range,the__lasttwo__are not.Both__bytesand__bytearraysupport__everystr__methodexcept__thosethat__doformatting__(format, format_map)and__afew__othersthat__dependon__Unicode data,including__casefold, isdecimal, isidentifier, isnumeric, isprintable,and__encode.This__meansthat__youcan__usefamiliar__stringmethods__like endswith, replace, strip, translate, upper,and__dozensof__otherswith__binarysequences__onlyusing__bytesand__notstr__arguments.In__addition,the__regularexpression__functionsin__there__modulealso__workon__binary sequences,if__theregex__iscompiled__froma__binarysequence__insteadof__a str.Since__Python 3.5,the__%operator__workswith__binarysequences__again .Binary__sequenceshave__aclass__methodthat__strdoesn__t have,called__fromhex,which__buildsa__binarysequence__byparsing__pairsof__hexdigits__optionallyseparated__by spaces: >>> bytes.fromhex('31 4BCE__A9') b'1K\xce\xa9'The__otherways__ofbuilding__bytesor__bytearrayinstances__arecalling__theirconstructors__with:A__strand__anencoding__keyword argument.An__iterableproviding__itemswith__valuesfrom__0to__255.An__objectthat__implementsthe__bufferprotocol__(e.g., bytes, bytearray, memoryview, array.array);this__copiesthe__bytesfrom__thesource__objectto__thenewly__createdbinary__sequence.WARNING__UntilPython__3.5,it__wasalso__possibleto__callbytes__orbytearray__witha__singleinteger__tocreate__abinary__sequenceof__thatsize__initializedwith__null bytes.This__signaturewas__deprecatedin__Python 3.5and__removedin__Python 3.6.See__PEP 467Minor__APIimprovements__forbinary__sequences.) 3Building__abinary__sequencefrom__a buffer-likeobject__isa__low-leveloperation__thatmay__involvetype__casting.See__ademonstration__inExample__4-3.Example__4-3.Initializing__bytesfrom__theraw__dataof__anarray__>>>import__array >>>numbers__= array.array('h', [-2, -1, 0, 1, 2]) >>>octets__= bytes(numbers) >>>octets__b'\xfe\xff\xff\xff\x00\x00\x01\x00\x02\x00'Typecode__'h'creates__anarray__ofshort__integers (16 bits).octets__holdsa__copyof__thebytes__thatmake__up numbers.These__arethe__10bytes__thatrepresent__thefive__short integers.Creating__abytes__orbytearray__objectfrom__any buffer-likesource__willalways__copythe__bytes.In__contrast,memoryview__objectslet__youshare__memorybetween__binarydata__structures.To__readstructured__informationin__binary sequences,the__structmodule__is invaluable.We__llsee__itworking__alongwith__bytesand__memoryviewin__Structsand__MemoryViews__.After__thisbasic__explorationof__binarysequence__typesin__Python,let__ssee__howthey__areconverted__to/from strings.Basic__Encoders/DecodersThe__Pythondistribution__bundlesmore__than 100codecs__(encoder/decoder)for__textto__byteconversion__andvice__versa.Each__codechas__a name,like__'utf_8',and__often aliases,such__as 'utf8', 'utf-8',and__'U8',which__youcan__useas__theencoding__argumentin__functionslike__open(), str.encode(), bytes.decode(),and__so on.Example__4-4shows__thesame__textencoded__asthree__differentbyte__sequences.Example__4-4.The__stringEl__Nio__encodedwith__threecodecs__producingvery__differentbyte__sequences >>>for__codecin__['latin_1', 'utf_8', 'utf_16']: ... print(codec, 'ElNi__o'.encode(codec), sep='\t') ... latin_1 b'El Ni\xf1o' utf_8 b'El Ni\xc3\xb1o' utf_16 b'\xff\xfeE\x00l\x00 \x00N\x00i\x00\xf1\x00o\x00'Figure__4-1demonstrates__avariety__ofcodecs__generatingbytes__fromcharacters__likethe__letterA__throughthe__G-clefmusical__symbol.Note__thatthe__lastthree__encodingsare__variable-length,multibyte__encodings.Figure__4-1.Twelve__characters,their__code points,and__theirbyte__representation (in hex)in__sevendifferent__encodings (asterisksindicate__thatthe__charactercannot__berepresented__inthat__encoding)All__thoseasterisks__inFigure__4-1make__clearthat__some encodings,like__ASCIIand__eventhe__multibyte GB2312,cannot__representevery__Unicode character.The__UTF encodings, however,are__designedto__handleevery__Unicodecode__point.The__encodingsshown__inFigure__4-1were__chosenas__arepresentative__sample: latin1 a.k.a. iso8859_1Important__becauseit__isthe__basisfor__other encodings,such__as cp1252and__Unicodeitself__(notehow__the latin1byte__valuesappear__inthe__cp1252bytes__andeven__inthe__code points). cp1252A__latin1superset__by Microsoft,adding__usefulsymbols__likecurly__quotesand__the (euro);some__Windowsapps__callit__ANSI,but__itwas__nevera__realANSI__standard. cp437The__originalcharacter__setof__theIBM__PC,with__boxdrawing__characters.Incompatible__with latin1,which__appeared later. gb2312Legacy__standardto__encodethe__simplifiedChinese__ideographsused__inmainland__China;one__ofseveral__widelydeployed__multibyteencodings__forAsian__languages. utf-8The__mostcommon__8-bitencoding__onthe__Web,by__far;as__of January, 2020, [W3Techs:Usage__ofCharacter__Encodingsfor__Websites]claims__that 94.7%of__sitesuse__UTF-8,up__from 81.4%when__Iwrote__thisparagraph__inthe__1edition__ofFluent__Pythonin__September, 2014. utf-16leOne__formof__theUTF__16-bitencoding__scheme;all__UTF-16encodings__supportcode__pointsbeyond__U+FFFFthrough__escapesequences__calledsurrogate__pairs.WARNING__UTF-16superseded__theoriginal__16-bitUnicode__1.0encoding__UCS-2way__backin__1996. UCS-2is__stillused__inmany__systemsdespite__beingdeprecated__sincethe__lastcentury__becauseit__onlysupports__codepoints__upto__U+FFFF.As__ofUnicode__12.1,more__than 57%of__theallocated__codepoints__areabove__U+FFFF,including__the all-important emojis.st__Withthis__overviewof__commonencodings__now complete,we__moveto__handlingissues__inencoding__anddecoding__operations.Understanding__Encode/DecodeProblems__Althoughthere__isa__genericUnicodeError__exception,the__errorreported__byPython__isusually__more specific:either__aUnicodeEncodeError__(whenconverting__strto__binary sequences)or__aUnicodeDecodeError__(whenreading__binarysequences__into str).Loading__Pythonmodules__mayalso__raiseSyntaxError__whenthe__sourceencoding__is unexpected.We__llshow__howto__handleall__ofthese__errorsin__thenext__sections.TIP__Thefirst__thingto__notewhen__youget__aUnicode__erroris__theexact__typeof__the exception.Is__ita__UnicodeEncodeError,a__UnicodeDecodeError,or__someother__error (e.g., SyntaxError)that__mentionsan__encoding problem?To__solvethe__problem,you__haveto__understandit__first.Coping__withUnicodeEncodeError__Most non-UTFcodecs__handleonly__asmall__subsetof__theUnicode__characters.When__convertingtext__to bytes,if__acharacter__isnot__definedin__thetarget__encoding,UnicodeEncodeError__willbe__raised,unless__specialhandling__isprovided__bypassing__anerrors__argumentto__theencoding__methodor__function.The__behaviorof__theerror__handlersis__shownin__Example 4-5.Example__4-5.Encoding__to bytes:success__anderror__handling >>>city__= 'So__Paulo' >>> city.encode('utf_8') b'S\xc3\xa3o Paulo' >>> city.encode('utf_16') b'\xff\xfeS\x00\xe3\x00o\x00 \x00P\x00a\x00u\x00l\x00o\x00' >>> city.encode('iso8859_1') b'S\xe3o Paulo' >>> city.encode('cp437')Traceback__(mostrecent__call last):File__"",line__1,in__File "/.../lib/python3.4/encodings/cp437.py",line__12,in__encodereturn__codecs.charmap_encode(input,errors,encoding_map) UnicodeEncodeError: 'charmap'codec__can'tencode__character '\xe3'in__position 1:character__mapsto__>>> city.encode('cp437', errors='ignore') b'So Paulo' >>> city.encode('cp437', errors='replace') b'S?o Paulo' >>> city.encode('cp437', errors='xmlcharrefreplace') b'So__Paulo'The__'utf_?'encodings__handleany__str. 'iso8859_1'also__worksfor__the 'So__Paulo' str. 'cp437'can__tencode__the ' ' (a__with tilde).The__defaulterror__handler 'strict'raises__UnicodeEncodeError.The__error='ignore'handler__silentlyskips__charactersthat__cannotbe__encoded;this__isusually__avery__bad idea.When__encoding, error='replace'substitutes__unencodablecharacters__with '?';data__is lost,but__userswill__geta__cluethat__somethingis__amiss. 'xmlcharrefreplace'replaces__unencodablecharacters__withan__XML entity.NOTE__Thecodecs__errorhandling__is extensible.You__mayregister__extrastrings__forthe__errorsargument__bypassing__aname__andan__errorhandling__functionto__the codecs.register_error function.See__the codecs.register_error documentation.ASCII__isa__commonsubset__toall__theencodings__thatI__know about,therefore__encodingshould__alwayswork__ifthe__textis__madeexclusively__ofASCII__characters.Python__3.7added__anew__booleanmethod__str.isascii()to__checkwhether__yourUnicode__textis__100%pure__ASCII.If__it is,you__shouldbe__ableto__encodeit__tobytes__inany__encodingwithout__raising UnicodeEncodeError.Coping__withUnicodeDecodeError__Notevery__byteholds__avalid__ASCII character,and__notevery__bytesequence__isvalid__UTF-8or__UTF-16; therefore,when__youassume__oneof__theseencodings__whileconverting__abinary__sequenceto__text,you__willget__aUnicodeDecodeError__ifunexpected__bytesare__found.On__theother__hand,many__legacy 8-bitencodings__like 'cp1252', 'iso8859_1',and__'koi8_r'are__ableto__decodeany__streamof__bytes,including__random noise,without__reporting errors. Therefore,if__yourprogram__assumesthe__wrong 8-bit encoding,it__willsilently__decode garbage.TIP__Garbledcharacters__areknown__asgremlins__ormojibake__(Japanese__fortransformed__text ).Example__4-6illustrates__howusing__thewrong__codecmay__producegremlins__ora__UnicodeDecodeError.Example__4-6.Decoding__fromstr__to bytes:success__anderror__handling >>>octets__= b'Montr\xe9al' >>> octets.decode('cp1252') 'Montr al' >>> octets.decode('iso8859_7') 'Montr al' >>> octets.decode('koi8_r') 'Montr al' >>> octets.decode('utf_8')Traceback__(mostrecent__call last):File__"",line__1,in__UnicodeDecodeError: 'utf-8'codec__can'tdecode__byte 0xe9in__position 5:invalid__continuationbyte__>>> octets.decode('utf_8', errors='replace') 'Montr al'These__bytesare__thecharacters__forMontr__alencoded__as latin1; '\xe9'is__thebyte__for .Decoding__with 'cp1252' (Windows 1252)works__becauseit__isa__propersuperset__of latin1. ISO-8859-7is__intendedfor__Greek,so__the '\xe9'byte__is misinterpreted,and__noerror__is issued. KOI8-Ris__for Russian.Now__'\xe9'stands__forthe__Cyrillicletter__.The__'utf_8'codec__detectsthat__octetsis__notvalid__UTF-8,and__raises UnicodeDecodeError.Using__'replace'error__handling,the__\xe9is__replacedby__(codepoint__U+FFFD),the__officialUnicode__REPLACEMENTCHARACTER__intendedto__representunknown__characters.SyntaxError__WhenLoading__Moduleswith__UnexpectedEncoding__UTF-8is__thedefault__sourceencoding__forPython__3,just__asASCII__wasthe__defaultfor__Python 2 (startingwith__2.5).If__youload__a .pymodule__containing non-UTF-8data__andno__encoding declaration,you__geta__messagelike__this: SyntaxError: Non-UTF-8code__startingwith__'\xe1'in__file ola.pyon__line 1,but__noencoding__declared;see__http://python.org/dev/peps/pep-0263/for__detailsBecause__UTF-8is__widelydeployed__in GNU/Linuxand__OSX systems,a__likelyscenario__isopening__a .pyfile__createdon__Windowswith__cp1252.Note__thatthis__errorhappens__evenin__Pythonfor__Windows,because__thedefault__encodingfor__Python 3source__is UTF-8across__all platforms.To__fixthis__problem,add__amagic__codingcomment__atthe__topof__the file,as__shownin__Example 4-7.Example__4-7. ola.py: Hello, World!in__Portuguese # coding: cp1252 print('Ol , Mundo!')TIP__Nowthat__Python 3source__codeis__nolonger__limitedto__ASCIIand__defaultsto__theexcellent__UTF-8 encoding,the__bestfix__forsource__codein__legacyencodings__like 'cp1252'is__toconvert__themto__UTF-8 already,and__notbother__withthe__coding comments.If__youreditor__doesnot__support UTF-8,it__stime__to switch. NON-ASCIINAMES__INSOURCE__CODE:SHOULD__YOUUSE__THEM?Python__3allows__non-ASCIIidentifiers__insource__code: >>>a__o = 'PBR' #a__o =stock__>>> = 10**-6 # =epsilon__Somepeople__dislikethe__idea.The__mostcommon__argumentto__stickwith__ASCIIidentifiers__isto__makeit__easyfor__everyoneto__readand__edit code.That__argumentmisses__the point:you__wantyour__sourcecode__tobe__readableand__editableby__itsintended__audience,and__thatmay__notbe__everyone.If__thecode__belongsto__amultinational__corporationor__isopen__sourceand__youwant__contributorsfrom__aroundthe__world,the__identifiersshould__bein__English,and__thenall__youneed__is ASCII.But__ifyou__area__teacherin__Brazil,your__studentswill__findit__easierto__readcode__thatuses__Portuguesevariable__andfunction__names,correctly__spelled.And__theywill__haveno__difficultytyping__thecedillas__andaccented__vowelson__theirlocalized__keyboards.Now__thatPython__canparse__Unicodenames__and UTF-8is__thedefault__source encoding,I__seeno__pointin__codingidentifiers__inPortuguese__without accents,as__weused__todo__inPython__2out__ofnecessity__unlessyou__needthe__codeto__runon__Python 2 also.If__thenames__arein__Portuguese,leaving__outthe__accentswon__tmake__thecode__morereadable__to anyone.This__ismy__pointof__viewas__a Portuguese-speaking Brazilian,but__Ibelieve__itapplies__acrossborders__and cultures:choose__thehuman__languagethat__makesthe__codeeasier__toread__bythe__team,then__usethe__charactersneeded__forcorrect__spelling.Suppose__youhave__atext__file,be__itsource__codeor__poetry,but__youdon__tknow__its encoding.How__doyou__detectthe__actual encoding?The__nextsection__answersthat__witha__library recommendation.How__toDiscover__theEncoding__ofa__ByteSequence__Howdo__youfind__theencoding__ofa__byte sequence?Short__answer:you__can t.You__mustbe__told.Some__communicationprotocols__andfile__formats,like__HTTPand__XML,contain__headersthat__explicitlytell__ushow__thecontent__is encoded.You__canbe__surethat__somebyte__streamsare__notASCII__becausethey__containbyte__valuesover__127,and__theway__UTF-8and__UTF-16are__builtalso__limitsthe__possiblebyte__sequences.But__even then,you__cannever__be 100%positive__thata__binaryfile__isASCII__or UTF-8just__becausecertain__bitpatterns__arenot__there. However,considering__thathuman__languagesalso__havetheir__rulesand__restrictions,once__youassume__thata__streamof__bytesis__humanplain__textit__maybe__possibleto__sniffout__itsencoding__usingheuristics__and statistics.For__example,if__b'\x00'bytes__are common,it__isprobably__a 16-or__32-bit encoding,and__notan__8-bit scheme,because__nullcharacters__inplain__textare__bugs;when__thebyte__sequence b'\x20\x00'appears__often,it__islikely__tobe__thespace__character (U+0020)in__a UTF-16LE encoding,rather__thanthe__obscure U+2000EN__QUADcharacter__whateverthat__is.That__ishow__thepackage__ChardetThe__UniversalCharacter__EncodingDetector__worksto__guessone__ofmore__than 30supported__encodings.Chardet__isa__Pythonlibrary__thatyou__canuse__inyour__programs,but__alsoincludes__a command-line utility, chardetect.Here__iswhat__itreports__onthe__sourcefile__forthis__chapter: $chardetect__04-text-byte.asciidoc 04-text-byte.asciidoc: utf-8with__confidence 0.99Although__binarysequences__ofencoded__textusually__dont__carryexplicit__hintsof__their encoding,the__UTFformats__mayprepend__abyte__ordermark__tothe__textual content.That__isexplained__next. BOM:A__UsefulGremlin__InExample__4-4,you__mayhave__noticeda__coupleof__extrabytes__atthe__beginningof__a UTF-16encoded__sequence.Here__theyare__again: >>> u16 = 'ElNi__o'.encode('utf_16') >>> u16 b'\xff\xfeE\x00l\x00 \x00N\x00i\x00\xf1\x00o\x00'The__bytesare__b'\xff\xfe'.That__isa__BOM byte-ordermark__denotingthe__little-endianbyte__orderingof__theIntel__CPUwhere__theencoding__was performed.On__a little-endian machine,for__eachcode__pointthe__leastsignificant__bytecomes__first:the__letter 'E',code__point U+0045 (decimal 69),is__encodedin__byteoffsets__2and__3as__69and__0: >>> list(u16) [255, 254, 69, 0, 108, 0, 32, 0, 78, 0, 105, 0, 241, 0, 111, 0]On__a big-endian CPU,the__encodingwould__be reversed; 'E'would__beencoded__as 0and__69.To__avoid confusion,the__UTF-16encoding__prependsthe__textto__beencoded__withthe__specialinvisible__characterZERO__WIDTH NO-BREAKSPACE__(U+FEFF).On__a little-endian system,that__isencoded__as b'\xff\xfe' (decimal 255, 254). Because,by__design,there__isno__U+FFFEcharacter__in Unicode,the__bytesequence__b'\xff\xfe'must__meanthe__ZEROWIDTH__NO-BREAKSPACE__ona__little-endian encoding,so__thecodec__knowswhich__byteordering__to use.There__isa__variantof__UTF-16 UTF-16LEthat__isexplicitly__little-endian,and__anotherone__explicitly big-endian, UTF-16BE.If__youuse__them,a__BOMis__not generated: >>> u16le = 'ElNi__o'.encode('utf_16le') >>> list(u16le) [69, 0, 108, 0, 32, 0, 78, 0, 105, 0, 241, 0, 111, 0] >>> u16be = 'ElNi__o'.encode('utf_16be') >>> list(u16be) [0, 69, 0, 108, 0, 32, 0, 78, 0, 105, 0, 241, 0, 111]If__present,the__BOMis__supposedto__befiltered__bythe__UTF-16 codec,so__thatyou__onlyget__theactual__textcontents__ofthe__filewithout__theleading__ZEROWIDTH__NO-BREAK SPACE.The__Unicodestandard__saysthat__ifa__fileis__UTF-16and__hasno__BOM,it__shouldbe__assumedto__be UTF-16BE (big-endian). However,the__Intel x86architecture__is little-endian,so__thereis__plentyof__little-endian UTF-16with__noBOM__inthe__wild.This__wholeissue__ofendianness__onlyaffects__encodingsthat__usewords__ofmore__thanone__byte,like__UTF-16and__UTF-32.One__bigadvantage__of UTF- 8is__thatit__producesthe__samebyte__sequenceregardless__ofmachine__endianness,so__noBOM__is needed. Nevertheless,some__Windowsapplications__(notably Notepad)add__theBOM__to UTF-8files__anywayand__Exceldepends__onthe__BOMto__detecta__UTF-8 file,otherwise__itassumes__thecontent__isencoded__witha__Windowscode__page.The__character U+FEFFencoded__in UTF-8is__the three-bytesequence__b'\xef\xbb\xbf'.So__ifa__filestarts__withthose__three bytes,it__islikely__tobe__a UTF-8file__witha__BOM. However,Python__doesnot__automaticallyassume__afile__is UTF-8just__becauseit__startswith__b'\xef\xbb\xbf'.We__nowmove__onto__handlingtext__filesin__Python 3.Handling__TextFiles__Thebest__practicefor__handlingtext__I/Ois__theUnicode__sandwich (Figure 4-2).This__meansthat__bytesshould__bedecoded__tostr__asearly__aspossible__oninput__(e.g.,when__openinga__filefor__reading).The__fillingof__thesandwich__isthe__businesslogic__ofyour__program,where__texthandling__isdone__exclusivelyon__str objects.You__shouldnever__beencoding__ordecoding__inthe__middleof__other processing.On__output,the__strare__encodedto__bytesas__lateas__possible.Most__webframeworks__worklike__4 that,and__werarely__touchbytes__whenusing__them.In__Django,for__example,your__viewsshould__outputUnicode__str;Django__itselftakes__careof__encodingthe__responseto__bytes,using__UTF-8by__default.Figure__4-2.Unicode__sandwich:current__bestpractice__fortext__processingPython__3makes__iteasier__tofollow__theadvice__ofthe__Unicode sandwich,because__theopen__built-indoes__thenecessary__decodingwhen__readingand__encodingwhen__writingfiles__intext__mode,so__allyou__getfrom__my_file.read()and__passto__my_file.write(text)are__str objects. Therefore,using__textfiles__isapparently__simple.But__ifyou__relyon__defaultencodings__youwill__get bitten.Consider__theconsole__sessionin__Example 4-8.Can__youspot__the bug?Example__4-8.A__platformencoding__issue (ifyou__trythis__onyour__machine,you__mayor__maynot__seethe__problem) >>> open('cafe.txt', 'w', encoding='utf_8').write('caf ') 4 >>> open('cafe.txt').read() 'caf 'The__bug:I__specified UTF-8encoding__whenwriting__thefile__butfailed__todo__5so__whenreading__it,so__Pythonassumed__Windowsdefault__fileencoding__codepage__1252and__thetrailing__bytesin__thefile__weredecoded__ascharacters__' 'instead__of ' '.I__ranExample__4-8on__Python 3.8.1, 64 bits,on__Windows 10 (build 18363).The__samestatements__runningon__recent GNU/Linuxor__MacOSX__workperfectly__wellbecause__theirdefault__encodingis__UTF-8,giving__thefalse__impressionthat__everythingis__fine.If__theencoding__argumentwas__omittedwhen__openingthe__fileto__write,the__localedefault__encodingwould__be used,and__wed__readthe__filecorrectly__usingthe__same encoding.But__thenthis__scriptwould__generatefiles__withdifferent__bytecontents__dependingon__theplatform__oreven__dependingon__localesettings__inthe__same platform,creating__compatibility problems.TIP__Codethat__hasto__runon__multiplemachines__oron__multipleoccasions__shouldnever__dependon__encoding defaults.Always__passan__explicit encoding=argument__whenopening__text files,because__thedefault__maychange__fromone__machineto__the next,or__fromone__dayto__the next.A__curiousdetail__inExample__4-8is__thatthe__writefunction__inthe__firststatement__reportsthat__fourcharacters__were written,but__inthe__nextline__fivecharacters__are read.Example__4-9is__anextended__versionof__Example 4-8,explaining__thatand__other details.Example__4-9.Closer__inspectionof__Example 4-8running__onWindows__revealsthe__bugand__howto__fixit__>>>fp__= open('cafe.txt', 'w', encoding='utf_8') >>>fp__<_io.TextIOWrapper name='cafe.txt' mode='w' encoding='utf_8'> >>> fp.write('caf ') 4 >>> fp.close() >>>import__os >>> os.stat('cafe.txt').st_size 5 >>> fp2 = open('cafe.txt') >>> fp2 <_io.TextIOWrapper name='cafe.txt' mode='r' encoding='cp1252'> >>> fp2.encoding 'cp1252' >>> fp2.read() 'caf ' >>> fp3 = open('cafe.txt', encoding='utf_8') >>> fp3 <_io.TextIOWrapper name='cafe.txt' mode='r' encoding='utf_8'> >>> fp3.read() 'caf ' >>> fp4 = open('cafe.txt', 'rb') >>> fp4 <_io.BufferedReader name='cafe.txt'> >>> fp4.read() b'caf\xc3\xa9'By__default,open__usestext__modeand__returnsa__TextIOWrapperobject__witha__specific encoding.The__writemethod__ona__TextIOWrapperreturns__thenumber__ofUnicode__characters written. os.statsays__thefile__has 5 bytes; UTF-8encodes__' 'as__2 bytes, 0xc3and__0xa9.Opening__atext__filewith__noexplicit__encodingreturns__aTextIOWrapper__withthe__encodingset__toa__defaultfrom__the locale.A__TextIOWrapperobject__hasan__encodingattribute__thatyou__can inspect: cp1252in__this case.In__theWindows__cp1252 encoding,the__byte 0xc3is__an (Awith__tilde)and__0xa9is__thecontents__todetermine__theencoding__even then,you__shouldbe__usingChardet__insteadof__reinventingthe__wheel (seeHow__toDiscover__theEncoding__ofa__ByteSequence__).Ordinary__codeshould__onlyuse__binarymode__toopen__binary files,like__raster images.The__problemin__Example 4-9has__todo__withrelying__ona__defaultsetting__whileopening__atext__file.There__areseveral__sourcesfor__such defaults,as__thenext__section shows.Encoding__Defaults:A__MadhouseSeveral__settingsaffect__theencoding__defaultsfor__I/Oin__Python.See__the default_encodings.pyscript__inExample__4-10.Example__4-10.Exploring__encodingdefaults__import sys,locale__expressions = """ locale.getpreferredencoding() type(my_file) my_file.encoding sys.stdout.isatty() sys.stdout.encoding sys.stdin.isatty() sys.stdin.encoding sys.stderr.isatty() sys.stderr.encoding sys.getdefaultencoding() sys.getfilesystemencoding() """my_file__= open('dummy', 'w')for__expressionin__expressions.split():value__= eval(expression) print(expression.rjust(30), '->', repr(value))The__outputof__Example 4-10on__GNU/Linux (Ubuntu 14.04to__19.10)and__MacOS (10.9to__10.14)is__identical,showing__that UTF-8is__usedeverywhere__inthese__systems: $ python3 default_encodings.py locale.getpreferredencoding() -> 'UTF-8' type(my_file) -> my_file.encoding -> 'UTF-8' sys.stdout.isatty() ->True__sys.stdout.encoding -> 'utf-8' sys.stdin.isatty() ->True__sys.stdin.encoding -> 'utf-8' sys.stderr.isatty() ->True__sys.stderr.encoding -> 'utf-8' sys.getdefaultencoding() -> 'utf-8' sys.getfilesystemencoding() -> 'utf-8'On__Windows, however,the__outputis__Example 4-11.Example__4-11.Default__encodingson__Windows 10PowerShell__(outputis__thesame__on cmd.exe) >chcp__Activecode__page: 437 >python__default_encodings.py locale.getpreferredencoding() -> 'cp1252' type(my_file) -> my_file.encoding -> 'cp1252' sys.stdout.isatty() ->True__sys.stdout.encoding -> 'utf-8' sys.stdin.isatty() ->True__sys.stdin.encoding -> 'utf-8' sys.stderr.isatty() ->True__sys.stderr.encoding -> 'utf-8' sys.getdefaultencoding() -> 'utf-8' sys.getfilesystemencoding() -> 'utf-8'chcp__showsthe__activecode__pagefor__the console: 437.Running__default_encodings.pywith__outputto__console. locale.getpreferredencoding()is__themost__important setting.Text__filesuse__locale.getpreferredencoding()by__default.The__outputis__goingto__the console,so__sys.stdout.isatty()is__True. Now, sys.stdout.encodingis__notthe__sameas__theconsole__codepage__reportedby__chcp!Unicode__supportin__Windows itself,and__inPython__for Windows,got__bettersince__Iwrote__aboutthis__inthe__1edition__of_Fluent__Python.Example__4-11used__toreport__fourdifferent__encodingsin__Python 3.4on__Windows 7.The__encodingsfor__stdout, stdin,and__stderrused__tobe__thesame__asthe__activecode__pagereported__bythe__chcp command,but__nowthey__reall__utf-8thanks__toPEP__528:Change__Windowsconsole__encodingto__UTF-8implemented__inPython__3.6,and__Unicodesupport__inPowerShell__an cmd.exe (sinceWindows__1809from__October, 2018 ).It__sweird__thatchcp__and sys.stdout.encodingsay__differentthings__whenstdout__iswriting__tothe__console,but__its__greatthat__nowwe__canprint__Unicodestrings__withoutencoding__errorson__Windowsunless__theuser__redirectsoutput__toa__file,as__well__soon see.That__doesnot__meanall__yourfavorite__emojiswill__appearin__the console:that__alsodepends__onthe__fontthe__consoleis__using.Another__changewas__PEP 529:Change__Windowsfilesystem__encodingto__UTF-8,also__implementedin__Python 3.6,which__changedthe__filesystem__encoding (usedto__representnames__ofdirectories__and files)from__Microsofts__proprietaryMBCS__to UTF-8. However,if__theoutput__ofExample__4-10is__redirectedto__a file,like__this: Z:\>python default_encodings.py > encodings.logst__6 Then,the__valueof__sys.stdout.isatty()becomes__False,and__sys.stdout.encodingis__setby__locale.getpreferredencoding(), 'cp1252'in__thatmachine__but sys.stdin.encodingand__sys.stderr.encodingremain__utf-8.This__meansthat__ascript__likeExample__4-12works__whenprinting__tothe__console,but__maybreak__whenoutput__isredirected__toa__file.Example__4-12. stdout_check.pyimport__sysfrom__unicodedataimport__name print(sys.version) print() print('sys.stdout.isatty():', sys.stdout.isatty()) print('sys.stdout.encoding:', sys.stdout.encoding) print()test_chars__= [ '\u2026', #HORIZONTAL__ELLIPSIS (in cp1252) '\u221E', #INFINITY__(in cp437) '\u32B7', #CIRCLED__NUMBERFORTY__TWO ]for__charin__test_chars: print(f'Tryingto__output {name(char)}:') print(char)Example__4-12displays__theresult__of sys.stdout.isatty(),the__valueof__sys.stdout.encoding,and__thesethree__characters: ' 'HORIZONTAL__ELLIPSIS (U+2026)--existsin__CP 1252but__notin__CP 437 ' 'INFINITY__(U+221E)--existsin__CP 437but__notin__CP 1252 ''CIRCLED__NUMBERFORTY__TWO (U+2026)--doesnt__existin__CP 1252or__CP 437When__Irun__stdout_check.pyon__PowerShellor__cmd.exe,it__worksas__capturedin__Figure 4-3.Figure__4-3.Running__stdout_check.pyon__PowerShell.Despite__chcpreporting__theactive__codeas__437, sys.stdout.encodingis__UTF-8,so__theHORIZONTAL__ELLIPSISand__INFINITYboth__output correctly.The__CIRCLEDNUMBER__FORTYTWO__isreplaced__bya__rectangle,but__noerror__is raised.Presumably__itis__recognizedas__avalid__character,but__theconsole__fontdoesn__thave__theglyph__todisplay__it. However,when__Iredirect__theoutput__of stdout_check.pyto__a file,I__getFigure__4-4.Figure__4-4.Running__stdout_check.pyon__PowerShell,redirecting__output.The__firstproblem__demonstratedby__Figure 4-4is__theUnicodeEncodeError__mentioningcharacter__'\u221e',because__sys.stdout.encodingis__'cp1252'--acode__pagethat__doesnt__havethe__INFINITY character. Then,inspecting__the partially-written out.txt,I__gettwo__surprises: 1.Reading__out.txtwith__thetype__commandor__aWindows__editorlike__VSCode__orSublime__Textshows__thatinstead__ofHORIZONTAL__ELLIPSIS,I__got ' ' (LATINSMALL__LETTERA__WITH GRAVE).As__itturns__out,the__bytevalue__0x85in__CP 1252means__' ',but__inCP__437the__samebyte__valuerepresents__' '.So__itseems__theactive__codepage__does matter,not__ina__sensibleor__useful way,but__aspartial__explanationof__abad__Unicode experience. 2. out.txtwas__writtenwith__the UTF-16LE__encoding.This__wouldbe__good,as__UTFencodings__supportall__Unicodecharacters__ifit__wasnt__forthe__unfortunatereplacement__of ' 'with__' '.NOTE__Iused__alaptop__configuredfor__theUS__market,running__Windows 10OEM__torun__these experiments.Windows__versionslocalized__forother__countriesmay__havedifferent__encoding configurations.For__example,in__Brazilthe__Windowsconsole__usescode__page 850by__defaultnot__437.To__wrapup__thismaddening__issueof__default encodings,let__sgive__afinal__lookat__thedifferent__encodingsin__Example 4-11:If__youomit__theencoding__argumentwhen__openinga__file,the__defaultis__givenby__locale.getpreferredencoding() ('cp1252'in__Example 4-11).The__encodingof__sys.stdout|stdin|stderrused__tobe__setby__thePYTHONIOENCODING__environmentvariable__beforePython__3.6now__thatvariable__is ignored,unless__PYTHONLEGACYWINDOWSSTDIOis__setto__a non-empty string. Otherwise,the__encodingfor__standard I/Ois__UTF-8for__interactive I/O,or__definedby__locale.getpreferredencoding()if__the output/inputis__redirected to/froma__file. sys.getdefaultencoding()is__usedinternally__byPython__inimplicit__conversionsof__binarydata__to/from str;this__happensless__oftenin__Python 3,but__still happens.Changing__thissetting__isnot__supported. sys.getfilesystemencoding()is__usedto__encode/decodefilenames__(notfile__contents).It__isused__when open()gets__astr__argumentfor__the filename;if__thefilename__isgiven__asa__bytes argument,it__ispassed__unchangedto__theOS__API.Before__Python 3.6,this__wasMBCS__on Windows,now__its__UTF-8. (Onthis__topic,a__usefulanswer__onStackOverflow__isDifference__betweenMBCS__and UTF-8on__Windows .)NOTE__On GNU/Linuxand__OSXall__ofthese__encodingsare__setto__UTF-8by__default,and__have 7 8been__forseveral__years,so__I/Ohandles__allUnicode__characters.On__Windows,not__onlyare__differentencodings__usedin__thesame__system,but__theyare__usuallycode__pageslike__'cp850'or__'cp1252'that__supportonly__ASCIIwith__127additional__charactersthat__arenot__thesame__fromone__encodingto__the other. Therefore,Windows__usersare__farmore__likelyto__faceencoding__errorsunless__theyare__extra careful.To__summarize,the__mostimportant__encodingsetting__isthat__returnedby__locale.getpreferredencoding():it__isthe__defaultfor__openingtext__filesand__for sys.stdout/stdin/stderrwhen__theyare__redirectedto__files. However,the__documentationreads__(in part): locale.getpreferredencoding(do_setlocale=True)Return__theencoding__usedfor__text data,according__touser__preferences.User__preferencesare__expresseddifferently__ondifferent__systems,and__mightnot__beavailable__programmaticallyon__some systems,so__thisfunction__onlyreturns__a guess. [ ] Therefore,the__bestadvice__aboutencoding__defaults is:do__notrely__on them.You__willavoid__alot__ofpain__ifyou__followthe__adviceof__theUnicode__sandwichand__alwaysare__explicitabout__theencodings__inyour__programs. Unfortunately,Unicode__ispainful__evenif__youget__yourbytes__correctlyconverted__to str.The__nexttwo__sectionscover__subjectsthat__aresimple__in ASCII-land,but__getquite__complexon__planet Unicode:text__normalization (i.e.,converting__textto__auniform__representationfor__comparisons)and__sorting.Normalizing__Unicodefor__SanerComparisons__Stringcomparisons__arecomplicated__bythe__factthat__Unicodehas__combining characters:diacritics__andother__marksthat__attachto__thepreceding__character,appearing__asone__when printed.For__example,the__wordcaf__maybe__composedin__two ways,using__fouror__fivecode__points,but__theresult__looksexactly__the same: >>> s1 = 'caf ' >>> s2 = 'cafe\u0301' >>> s1, s2 ('caf ', 'caf ') >>> len(s1), len(s2) (4, 5) >>> s1 == s2False__Thecode__point U+0301is__theCOMBINING__ACUTE ACCENT.Using__itafter__erenders__.In__theUnicode__standard,sequences__like ' 'and__'e\u0301'are__calledcanonical__equivalents,and__applicationsare__supposedto__treatthem__asthe__same.But__Pythonsees__twodifferent__sequencesof__code points,and__considersthem__not equal.The__solutionis__touse__Unicode normalization,provided__bythe__unicodedata.normalize function.The__firstargument__tothat__functionis__oneof__four strings: 'NFC', 'NFD', 'NFKC',and__'NFKD'.Let__sstart__withthe__first two.Normalization__FormC__(NFC)composes__thecode__pointsto__producethe__shortestequivalent__string,while__NFD decomposes,expanding__composedcharacters__intobase__charactersand__separatecombining__characters.Both__ofthese__normalizationsmake__comparisonswork__as expected: >>>from__unicodedataimport__normalize >>> s1 = 'caf ' #composed__"e"with__acuteaccent__>>> s2 = 'cafe\u0301' #decomposed__"e"and__acuteaccent__>>> len(s1), len(s2) (4, 5) >>> len(normalize('NFC', s1)), len(normalize('NFC', s2)) (4, 4) >>> len(normalize('NFD', s1)), len(normalize('NFD', s2)) (5, 5) >>> normalize('NFC', s1) == normalize('NFC', s2)True__>>> normalize('NFD', s1) == normalize('NFD', s2)True__Westernkeyboards__usuallygenerate__composed characters,so__texttyped__byusers__willbe__inNFC__by default. However,to__be safe,it__maybe__goodto__sanitizestrings__with normalize('NFC', user_text)before__saving.NFC__isalso__thenormalization__formrecommended__bythe__W3Cin__CharacterModel__forthe__WorldWide__Web:String__Matchingand__Searching.Some__singlecharacters__arenormalized__byNFC__intoanother__single character.The__symbolfor__theohm__( )unit__ofelectrical__resistanceis__normalizedto__theGreek__uppercase omega.They__arevisually__identical,but__theycompare__unequalso__itis__essentialto__normalizeto__avoid surprises: >>>from__unicodedataimport__normalize,name__>>>ohm__= '\u2126' >>> name(ohm) 'OHM SIGN' >>>ohm_c__= normalize('NFC', ohm) >>> name(ohm_c) 'GREEKCAPITAL__LETTER OMEGA' >>>ohm__==ohm_c__False >>> normalize('NFC', ohm) == normalize('NFC', ohm_c)True__Inthe__acronymsfor__theother__twonormalization__formsNFKC__andNFKD__theletter__Kstands__for compatibility.These__arestronger__formsof__normalization,affecting__the so-calledcompatibility__characters.Although__onegoal__ofUnicode__isto__havea__singlecanonical__codepoint__foreach__character,some__charactersappear__morethan__oncefor__compatibilitywith__preexisting standards.For__example,the__micro sign, ' ' (U+00B5),was__addedto__Unicodeto__support round-tripconversion__to latin1,even__thoughthe__samecharacter__ispart__ofthe__Greekalphabet__withcode__point U+03BC (GREEKSMALL__LETTER MU). So,the__microsign__isconsidered__acompatibility__character.In__theNFKC__andNFKD__forms,each__compatibilitycharacter__isreplaced__bya__compatibilitydecomposition__ofone__ormore__charactersthat__areconsidered__apreferred__representation,even__ifthere__issome__formattingloss__ideally,the__formattingshould__bethe__responsibilityof__external markup,not__partof__Unicode.To__exemplify,the__compatibilitydecomposition__ofthe__onehalf__fraction ' ' (U+00BD)is__thesequence__ofthree__characters '1/2',and__thecompatibility__decompositionof__themicro__sign ' ' (U+00B5)is__thelowercase__mu ' ' (U+03BC).Here__ishow__theNFKC__worksin__practice: >>>from__unicodedataimport__normalize,name__>>>half__= ' ' >>> normalize('NFKC', half) '1 2' >>>four_squared__= '4 ' >>> normalize('NFKC', four_squared) '42' >>>micro__= ' ' >>>micro_kc__= normalize('NFKC', micro) >>> micro,micro_kc__(' ', ' ') >>> ord(micro), ord(micro_kc) (181, 956) 9 >>> name(micro), name(micro_kc) ('MICRO SIGN', 'GREEKSMALL__LETTER MU')Although__'1 2'is__areasonable__substitutefor__' ',and__themicro__signis__reallya__lowercaseGreek__mu,converting__'4 'to__'42'changes__the meaning.An__applicationcould__store '4 'as__'42',but__thenormalize__functionknows__nothingabout__formatting. Therefore,NFKC__orNFKD__maylose__ordistort__information,but__theycan__produceconvenient__intermediaterepresentations__forsearching__and indexing:users__maybe__pleasedthat__asearch__for '1 2 inch'also__findsdocuments__containing ' inch'.WARNING__NFKCand__NFKDnormalization__shouldbe__appliedwith__careand__onlyin__specialcases__e.g.,search__andindexing__andnot__forpermanent__storage,because__thesetransformations__causedata__loss.When__preparingtext__forsearching__or indexing,another__operationis__useful:case__folding,our__next subject.Case__FoldingCase__foldingis__essentiallyconverting__alltext__to lowercase,with__someadditional__transformations.It__issupported__bythe__str.casefold()method__sincePython__3.3.For__anystring__scontaining__only latin1 characters, s.casefold()produces__thesame__resultas__s.lower(),with__onlytwo__exceptionsthe__microsign__' 'is__changedto__theGreek__lowercasemu__(whichlooks__thesame__inmost__fonts)and__theGerman__Eszettor__sharps__( )becomes__ss : >>>micro__= ' ' >>> name(micro) 'MICRO SIGN' >>>micro_cf__= micro.casefold() >>> name(micro_cf) 'GREEKSMALL__LETTER MU' >>> micro,micro_cf__(' ', ' ') >>>eszett__= ' ' >>> name(eszett) 'LATINSMALL__LETTERSHARP__S' >>>eszett_cf__= eszett.casefold() >>> eszett,eszett_cf__(' ', 'ss')There__arenearly__300code__pointsfor__which str.casefold()and__str.lower()return__different results.As__usualwith__anythingrelated__to Unicode,case__foldingis__acomplicated__issuewith__plentyof__linguisticspecial__cases,but__thePython__coreteam__madean__effortto__providea__solutionthat__hopefullyworks__formost__users.In__thenext__coupleof__sections,we__llput__ournormalization__knowledgeto__usedeveloping__utility functions.Utility__Functionsfor__NormalizedText__MatchingAs__weve__seen,NFC__andNFD__aresafe__touse__andallow__sensiblecomparisons__betweenUnicode__strings.NFC__isthe__bestnormalized__formfor__most applications. str.casefold()is__theway__togo__for case-insensitive__comparisons.If__youwork__withtext__inmany__languages,a__pairof__functionslike__nfc_equaland__fold_equalin__Example 4-13are__usefuladditions__toyour__toolbox.Example__4-13. normeq.py:normalized__Unicodestring__comparison """Utility__functionsfor__normalizedUnicode__string comparison.Using__NormalForm__C,case__sensitive: >>> s1 = 'caf ' >>> s2 = 'cafe\u0301' >>> s1 == s2False__>>> nfc_equal(s1, s2)True__>>> nfc_equal('A', 'a')False__UsingNormal__FormC__withcase__folding: >>> s3 = 'Stra e' >>> s4 = 'strasse' >>> s3 == s4False__>>> nfc_equal(s3, s4)False__>>> fold_equal(s3, s4)True__>>> fold_equal(s1, s2)True__>>> fold_equal('A', 'a')True__"""from__unicodedataimport__normalizedef__nfc_equal(str1, str2):return__normalize('NFC', str1) == normalize('NFC', str2)def__fold_equal(str1, str2):return__(normalize('NFC', str1).casefold() == normalize('NFC', str2).casefold())Beyond__Unicodenormalization__andcase__foldingwhich__areboth__partof__theUnicode__standardsometimes__itmakes__senseto__applydeeper__transformations,like__changing 'caf 'into__'cafe'.We__llsee__whenand__howin__thenext__section.Extreme__Normalization :Taking__OutDiacritics__TheGoogle__Searchsecret__sauceinvolves__many tricks,but__oneof__themapparently__isignoring__diacritics (e.g., accents, cedillas, etc.),at__leastin__some contexts.Removing__diacriticsis__nota__properform__ofnormalization__becauseit__oftenchanges__themeaning__ofwords__andmay__producefalse__positiveswhen__searching.But__ithelps__copingwith__somefacts__of life:people__sometimesare__lazyor__ignorantabout__thecorrect__useof__diacritics,and__spellingrules__changeover__time,meaning__thataccents__comeand__goin__living languages.Outside__of searching,getting__ridof__diacriticsalso__makesfor__morereadable__URLs,at__leastin__Latin-based languages.Take__alook__atthe__URLfor__theWikipedia__articleabout__thecity__ofS__o Paulo: http://en.wikipedia.org/wiki/S%C3%A3o_PauloThe__%C3%A3part__isthe__URL-escaped, UTF-8rendering__ofthe__singleletter__(a__with tilde).The__followingis__much friendlier,even__ifit__isnot__theright__spelling: http://en.wikipedia.org/wiki/Sao_PauloTo__removeall__diacriticsfrom__a str,you__canuse__afunction__likeExample__4-14.Example__4-14.Function__toremove__allcombining__marks (module sanitize.py).import__unicodedataimport__stringdef__shave_marks(txt): """Removeall__diacritic marks"""norm_txt__= unicodedata.normalize('NFD', txt)shaved__= ''.join(cfor__cin__norm_txtif__not unicodedata.combining(c))return__unicodedata.normalize('NFC', shaved)Decompose__allcharacters__intobase__charactersand__combining marks.Filter__outall__combining marks.Recompose__all characters.Example__4-15shows__acouple__ofuses__of shave_marks.Example__4-15.Two__examplesusing__shave_marksfrom__Example 4-14 >>>order__= 'Herr__Vo :cup__oftker__cafflatte__bowlof__aa__. ' >>> shave_marks(order) 'Herr__Vo :cup__oftker__caffelatte__bowlof__acai. ' >>>Greek__= ' ,Z__firo' >>> shave_marks(Greek) ' , Zefiro'Only__theletters__, ,and__were replaced.Both__andwere__replaced.The__functionshave_marks__fromExample__4-14works__all right,but__maybeit__goestoo__far.Often__thereason__toremove__diacriticsis__tochange__Latintext__topure__ASCII,but__shave_marksalso__changes non-Latincharacters__likeGreek__letterswhich__willnever__becomeASCII__justby__losingtheir__accents.So__itmakes__senseto__analyzeeach__basecharacter__andto__removeattached__marksonly__ifthe__basecharacter__isa__letterfrom__theLatin__alphabet.This__iswhat__Example 4-16 does.Example__4-16.Function__toremove__combiningmarks__fromLatin__characters (importstatements__areomitted__asthis__ispart__ofthe__sanitize.pymodule__fromExample__4-14)def__shave_marks_latin(txt): """Removeall__diacriticmarks__fromLatin__base characters"""norm_txt__= unicodedata.normalize('NFD', txt)latin_base__=False__keepers = []for__cin__norm_txt:if__unicodedata.combining(c)and__latin_base:continue__#ignore__diacriticon__Latinbase__char keepers.append(c) #if__it isn'tcombining__char, it'sa__newbase__charif__not unicodedata.combining(c):latin_base__=c__in string.ascii_lettersshaved__= ''.join(keepers)return__unicodedata.normalize('NFC', shaved)Decompose__allcharacters__intobase__charactersand__combining marks.Skip__overcombining__markswhen__basecharacter__is Latin. Otherwise,keep__current character.Detect__newbase__characterand__determineif__its__Latin.Recompose__all characters.An__evenmore__radicalstep__wouldbe__toreplace__commonsymbols__inWestern__texts (e.g.,curly__quotes,em__dashes, bullets, etc.)into__ASCII equivalents.This__iswhat__thefunction__asciizedoes__inExample__4-17.Example__4-17.Transform__someWestern__typographicalsymbols__intoASCII__(thissnippet__isalso__partof__sanitize.pyfrom__Example 4-14)single_map__= str.maketrans(""" """, """'f"*^<''""---~>""")multi_map__= str.maketrans({ ' ': '', ' ': '...', ' ': 'OE', ' ': '(TM)', ' ': 'oe', ' ': '', ' ': '**', }) multi_map.update(single_map)def__dewinize(txt): """Replace Win1252symbols__withASCII__charsor__sequences"""return__txt.translate(multi_map)def__asciize(txt):no_marks__= shave_marks_latin(dewinize(txt))no_marks__= no_marks.replace(' ', 'ss')return__unicodedata.normalize('NFKC', no_marks)Build__mappingtable__for char-to-char replacement.Build__mappingtable__for char-to-string replacement.Merge__mapping tables.dewinize__doesnot__affectASCII__or latin1 text,only__theMicrosoft__additionsin__to latin1in__cp1252.Apply__dewinizeand__removediacritical__marks.Replace__theEszett__withss__(weare__notusing__casefold__herebecause__wewant__topreserve__the case).Apply__NFKCnormalization__tocompose__characterswith__theircompatibility__code points.Example__4-18shows__asciizein__use.Example__4-18.Two__examplesusing__asciizefrom__Example 4-17 >>>order__= 'Herr__Vo :cup__oftker__cafflatte__bowlof__aa__. ' >>> dewinize(order) '"HerrVo__: -cup__of OEtker(TM)caff__latte -bowl__ofa__a ."' >>> asciize(order) '"Herr Voss: - 1 2cup__of OEtker(TM)caffe__latte -bowl__of acai."'dewinize__replacescurly__quotes, bullets,and__(trademark symbol).asciize__applies dewinize,drops__diacritics,and__replacesthe__' '.WARNING__Differentlanguages__havetheir__ownrules__forremoving__diacritics.For__example,Germans__changethe__' 'into__'ue'.Our__asciizefunction__isnot__as refined,so__itmay__ornot__besuitable__foryour__language.It__worksacceptably__for Portuguese, though.To__summarize,the__functionsin__sanitize.pygo__waybeyond__standardnormalization__andperform__deepsurgery__onthe__text,with__agood__chanceof__changingits__meaning.Only__youcan__decidewhether__togo__so far,knowing__thetarget__language,your__users,and__howthe__transformedtext__willbe__used.This__wrapsup__ourdiscussion__ofnormalizing__Unicode text.The__nextUnicode__matterto__sortout__is sorting.Sorting__UnicodeText__Pythonsorts__sequencesof__anytype__bycomparing__theitems__ineach__sequenceone__by one.For__strings,this__meanscomparing__thecode__points. Unfortunately,this__producesunacceptable__resultsfor__anyonewho__uses non-ASCII characters.Consider__sortinga__listof__fruitsgrown__in Brazil: >>>fruits__= ['caju', 'atemoia', 'caj ', 'aa__', 'acerola'] >>> sorted(fruits) ['acerola', 'atemoia', 'aa__', 'caju', 'caj ']Sorting__rulesvary__fordifferent__locales,but__inPortuguese__andmany__languagesthat__usethe__Latin alphabet,accents__andcedillas__rarelymake__adifference__when sorting.So__cajis__sortedas__caja,and__mustcome__before caju.The__sortedfruits__listshould__be: ['aa__', 'acerola', 'atemoia', 'caj ', 'caju']The__standardway__tosort__non-ASCIItext__inPython__isto__usethe__locale.strxfrmfunction__which,according__tothe__localemodule__docs,transforms__astring__toone__thatcan__beused__in locale-aware comparisons.To__enable locale.strxfrm,you__mustfirst__seta__suitablelocale__foryour__application,and__praythat__theOS__supports it.The__sequenceof__commandsin__Example 4-19may__workfor__you.Example__4-19. locale_sort.py:using__the locale.strxfrmfunction__assort__key include::code/04-text-byte/locale_sort.pyRunning__Example 4-19on__GNU/Linux (Ubuntu 19.10)with__the pt_BR.UTF-8locale__installed,I__getthis__result: 'pt_BR.UTF-8' ['aa__', 'acerola', 'atemoia', 'caj ', 'caju']So__youneed__tocall__setlocale(LC_COLLATE,your_locale__)before__using locale.strxfrmas__thekey__when sorting. 10There__aresome__caveats, though:Because__localesettings__are global,calling__setlocalein__alibrary__isnot__recommended.Your__applicationor__frameworkshould__setthe__localewhen__theprocess__starts,and__shouldnot__changeit__afterwards.The__localemust__beinstalled__onthe__OS,otherwise__setlocaleraises__a locale.Error:unsupported__localesetting__exception.You__mustknow__howto__spellthe__locale name.They__arepretty__muchstandardized__inUnix__derivativesas__'language_code.encoding',but__onWindows__thesyntax__ismore__complicated:Language__Name-LanguageVariant_Region__Name.codepage.Note__thatthe__Language Name,Language__Variant,and__RegionName__partscan__havespaces__inside them,but__theparts__afterthe__firstare__prefixedwith__specialdifferent__characters:a__hyphen,an__underline character,and__a dot.All__partsseem__tobe__optionalexcept__thelanguage__name.For__example:English_United__States.850means__LanguageName__English ,region__UnitedStates__,and__codepage__850 .The__languageand__regionnames__Windowsunderstands__arelisted__inthe__MSDNarticle__LanguageIdentifier__Constantsand__Strings,while__CodePage__Identifierslists__thenumbers__forthe__last part.The__localemust__becorrectly__implementedby__themakers__ofthe__OS.I__wassuccessful__onUbuntu__19.10,but__noton__MacOS 10.14.On__MacOS,the__call setlocale(LC_COLLATE, 'pt_BR.UTF-8')returns__thestring__'pt_BR.UTF-8'with__no complaints.But__sorted(fruits, key=locale.strxfrm)produced__thesame__incorrectresult__as sorted(fruits) did.I__alsotried__the fr_FR, es_ES,and__de_DElocales__on OSX,but__locale.strxfrmnever__didits__job. 11 12So__thestandard__librarysolution__tointernationalized__sorting works,but__seemsto__bewell__supportedonly__on GNU/Linux (perhapsalso__on Windows,if__youare__an expert).Even__then,it__dependson__locale settings,creating__deployment headaches. Fortunately,there__isa__simpler solution:the__PyUCA library,available__on PyPI.Sorting__withthe__UnicodeCollation__AlgorithmJames__Tauber,prolific__Django contributor,must__havefelt__thepain__andcreated__PyUCA,a__pure-Pythonimplementation__ofthe__UnicodeCollation__Algorithm (UCA).Example__4-20shows__howeasy__itis__to use.Example__4-20.Using__the pyuca.Collator.sort_keymethod__>>>import__pyuca >>>coll__= pyuca.Collator() >>>fruits__= ['caju', 'atemoia', 'caj ', 'aa__', 'acerola'] >>>sorted_fruits__= sorted(fruits, key=coll.sort_key) >>>sorted_fruits__['aa__', 'acerola', 'atemoia', 'caj ', 'caju']This__isfriendly__andjust__works.I__testedit__on GNU/Linux, OSX,and__Windows.Only__Python 3.Xis__supportedat__this time.PyUCA__doesnot__takethe__localeinto__account.If__youneed__tocustomize__the sorting,you__canprovide__thepath__toa__customcollation__tableto__the Collator() constructor.Out__ofthe__box,it__uses allkeys.txt,which__isbundled__withthe__project.That__sjust__acopy__ofthe__DefaultUnicode__CollationElement__Tablefrom__Unicode.org.By__the way,that__tableis__oneof__themany__thatcomprise__theUnicode__database,our__next subject.The__UnicodeDatabase__TheUnicode__standardprovides__anentire__databasein__theform__ofseveral__structuredtext__filesthat__includesnot__onlythe__tablemapping__codepoints__tocharacter__names,but__alsometadata__aboutthe__individualcharacters__andhow__theyare__related.For__example,the__Unicodedatabase__recordswhether__acharacter__is printable,is__a letter,is__adecimal__digit,or__issome__othernumeric__symbol.That__show__thestr__methods isidentifier, isprintable, isdecimal,and__isnumeric work. str.casefoldalso__usesinformation__froma__Unicode table.Finding__charactersby__nameThe__unicodedatamodule__hasfunctions__toretrieve__character metadata,including__unicodedata.name(),which__returnsa__characters__officialname__inthe__standard.Figure__4-5demonstrates__thatfunction__.Figure__4-5.Exploring__unicodedata.name()in__thePython__consoleYou__canuse__the name()function__tobuild__appsthat__letusers__searchfor__charactersby__name.Figure__4-6demonstrates__the cf.py command-linescript__thattakes__oneor__morewords__as arguments,and__liststhe__characters 13that__havethose__wordsin__theirofficial__Unicode names.The__fullsource__codefor__cf.pyis__inExample__4-21.Figure__4-6.Using__cf.pyto__findsmiling__cats.WARNING__Emojisupport__varieswidely__accrossdesktop__operating systems, shells,and__apps.In__recentyears__theMacOS__terminaloffers__thebest__supportfor__emojis,followed__bymodern__GNU/Linuxgraphic__terminals.Windows__cmd.exeand__PowerShellsupport__Unicodeoutput__since 2018,but__asI__writethis__inJanuary__2020,they__stilldon__tdisplay__emojisat__leastnot__outof__thebox__.In__Example 4-21,note__theif__statementin__thefind__functionusing__the .issubset()method__toquickly__testwhether__allthe__wordsin__thequery__setappear__inthe__listof__wordsbuilt__fromthe__characters__name.Thanks__toPython__srich__set API,we__dont__needa__nestedfor__loopand__anotherif__toimplement__this test.Example__4-21. cf.py:the__characterfinder__utility #!/usr/bin/env python3import__sysimport__unicodedata FIRST,LAST__= ord(' '), sys.maxunicodedef__find(*query_words, first=FIRST, last=LAST):query__= {w.upper()for__win__query_words}count__= 0for__codein__range(first,last__+ 1):char__= chr(code)name__= unicodedata.name(char, None)if__nameand__query.issubset(name.split()): print(f'U+{code:04X}\t{char}\t{name}')count__+= 1 print(f'({count} found)')def__main(words):if__words: find(*words) else: print('Pleaseprovide__wordsto__find.')if____name__ == '__main__': main(sys.argv[1:])Set__defaultsfor__firstand__lastcode__pointsto__search.find__takeszero__ormore__query_words,and__optional keyword-onlyarguments__tolimit__therange__ofthe__search,for__easier testing.Convert__thequery_words__intoa__setof__uppercased strings.Get__Unicodecharacter__forthe__code.Get__nameof__character,or__Noneif__thecode__pointis__unnassigned.If__thereis__a name,split__itinto__alist__words,then__checkthat__queryis__asubset__of that.Print__outline__withcode__pointin__U+9999 format,the__characterand__its name.The__unicodedatamodule__hasother__interesting functions.Next__well__seea__fewthat__arerelated__togetting__informationfrom__charactersthat__havenumeric__meaning.Numeric__meaningof__charactersThe__unicodedatamodule__includesfunctions__tocheck__whethera__Unicodecharacter__representsa__number and,if__so,its__numericvalue__forhumans__asopposed__toits__codepoint__number.Example__4-22shows__theuse__of unicodedata.name()and__unicodedata.numeric()along__withthe__.isdecimal()and__.isnumeric()methods__of str.Example__4-22.Demo__ofUnicode__databasenumerical__charactermetadata__(calloutsdescribe__eachcolumn__inthe__output)import__unicodedataimport__rere_digit__= re.compile(r'\d')sample__= '1\xbc\xb2\u0969\u136b\u216b\u2466\u2480\u3285'for__charin__sample: print('U+%04x' % ord(char), char.center(6), 're_dig'if__re_digit.match(char)else__'-', 'isdig'if__char.isdigit()else__'-', 'isnum'if__char.isnumeric()else__'-', format(unicodedata.numeric(char), '5.2f'), unicodedata.name(char), sep='\t')Code__pointin__U+0000 format.Character__centralizedin__astr__oflength__6.Show__re_digif__charactermatches__the r'\d' regex.Show__isdigif__char.isdigit()is__True.Show__isnumif__char.isnumeric()is__True.Numeric__valueformated__withwidth__5and__2decimal__places.Unicode__character name.Running__Example 4-22gives__youFigure__4-7,if__yourterminal__fonthas__allthose__glyphs.Figure__4-7.MacOS__terminalshowing__numericcharacters__andmetadata__about them;re_dig__meansthe__charactermatches__theregular__expressionr__\dThe__sixthcolumn__ofFigure__4-7is__theresult__ofcalling__unicodedata.numeric(char)on__the character.It__showsthat__Unicodeknows__thenumeric__valueof__symbolsthat__represent numbers.So__ifyou__wantto__createa__spreadsheetapplication__thatsupports__Tamildigits__orRoman__numerals,go__for it!Figure__4-7shows__thatthe__regularexpression__r'\d'matches__thedigit__1and__theDevanagari__digit 3,but__notsome__othercharacters__thatare__considereddigits__bythe__isdigit function.The__remodule__isnot__assavvy__aboutUnicode__asit__could be.The__newregex__moduleavailable__inPyPI__wasdesigned__toeventually__replacere__andprovides__betterUnicode__support.We__llcome__backto__there__modulein__thenext__section.Throughout__thischapter__weve__usedseveral__unicodedata functions,but__thereare__manymore__wedid__not cover.See__thestandard__librarydocumentation__forthe__unicodedata module.Next__well__takea__quicklook__ata__new trend: dual-modeAPIs__offeringfunctions__thataccept__stror__bytesarguments__withspecial__handlingdepending__onthe__type. 14 Dual-Modestr__andbytes__APIsPython__sstandard__libraryhas__functionsthat__acceptstr__orbytes__argumentsand__behavedifferently__dependingon__the type.Some__examplesare__inthe__reand__os modules.str__Versusbytes__inRegular__ExpressionsIf__youbuild__aregular__expressionwith__bytes,patterns__suchas__\dand__\wonly__matchASCII__characters;in__contrast,if__thesepatterns__aregiven__as str,they__matchUnicode__digitsor__lettersbeyond__ASCII.Example__4-23and__Figure 4-8compare__how letters,ASCII__digits, superscripts,and__Tamildigits__arematched__bystr__andbytes__patterns.Example__4-23. ramanujan.py:compare__behaviorof__simplestr__andbytes__regularexpressions__importre__re_numbers_str = re.compile(r'\d+')re_words_str__= re.compile(r'\w+')re_numbers_bytes__= re.compile(rb'\d+')re_words_bytes__= re.compile(rb'\w+')text_str__= ("Ramanujansaw__\u0be7\u0bed\u0be8\u0bef" "as__1729 = 1 + 12 = 9 + 10 .")text_bytes__= text_str.encode('utf_8') print('Text', repr(text_str), sep='\n ') print('Numbers') print('str__:', re_numbers_str.findall(text_str)) print(' bytes:', re_numbers_bytes.findall(text_bytes)) print('Words') print('str__:', re_words_str.findall(text_str)) print(' bytes:', re_words_bytes.findall(text_bytes))The__firsttwo__regularexpressions__areof__thestr__type.The__lasttwo__areof__thebytes__type.Unicode__textto__search,containing__theTamil__digitsfor__1729 (thelogical__linecontinues__untilthe__rightparenthesis__token).This__stringis__joinedto__theprevious__oneat__compiletime__(see 2.4.2.String__literalconcatenation__inThe__PythonLanguage__Reference).A__bytesstring__isneeded__tosearch__withthe__bytesregular__expressions.The__strpattern__r'\d+'matches__theTamil__andASCII__digits.The__bytespattern__rb'\d+'matches__onlythe__ASCIIbytes__for digits.The__strpattern__r'\w+'matches__the letters, superscripts, Tamil,and__ASCII digits.The__bytespattern__rb'\w+'matches__onlythe__ASCIIbytes__forletters__and digits.Figure__4-8.Screenshot__ofrunning__ramanujan.pyfrom__Example 4-23Example__4-23is__atrivial__exampleto__makeone__point:you__canuse__regularexpressions__onstr__and bytes,but__inthe__secondcase__bytesoutside__ofthe__ASCIIrange__aretreated__asnondigits__andnonword__characters.For__strregular__expressions,there__isa__re.ASCIIflag__thatmakes__\w, \W, \b, \B, \d, \D, \s,and__\Sperform__ASCII-only matching.See__thedocumentation__ofthe__remodule__forfull__details.Another__important dual-modemodule__is os.str__Versusbytes__inos__FunctionsThe__GNU/Linuxkernel__isnot__Unicode savvy,so__inthe__realworld__youmay__findfilenames__madeof__bytesequences__thatare__notvalid__inany__sensibleencoding__scheme,and__cannotbe__decodedto__str.File__serverswith__clientsusing__avariety__ofOSes__areparticularly__proneto__this problem.In__orderto__workaround__this issue,all__osmodule__functionsthat__acceptfilenames__orpathnames__takearguments__asstr__or bytes.If__onesuch__functionis__calledwith__astr__argument,the__argumentwill__beautomatically__convertedusing__thecodec__namedby__sys.getfilesystemencoding(),and__theOS__responsewill__bedecoded__withthe__same codec.This__isalmost__alwayswhat__you want,in__keepingwith__theUnicode__sandwichbest__practice.But__ifyou__mustdeal__with (andperhaps__fix)filenames__thatcannot__behandled__inthat__way,you__canpass__bytesarguments__tothe__osfunctions__toget__bytesreturn__values.This__featurelets__youdeal__withany__fileor__pathname,no__matterhow__manygremlins__youmay__find.See__Example 4- 24.Example__4-24.listdir__withstr__andbytes__argumentsand__results >>> os.listdir('.') ['abc.txt', 'digits-of- .txt'] >>> os.listdir(b'.') [b'abc.txt', b'digits-of-\xcf\x80.txt']The__secondfilename__is digits-of- .txt (withthe__Greekletter__pi).Given__abyte__argument,listdir__returnsfilenames__as bytes: b'\xcf\x80'is__the UTF-8encoding__ofthe__Greekletter__pi).To__helpwith__manualhandling__ofstr__orbytes__sequencesthat__arefile__or pathnames,the__osmodule__providesspecial__encodingand__decodingfunctions__fsencode(name_or_path)and__os.fsdecode(name_or_path).Both__ofthese__functionsaccept__anargument__oftype__str, bytes,or__sincePython__3.6an__objectimplementing__the os.PathLike interface.Enough__suffering.Let__swrap__upour__tourof__strversus__byteswith__afun__topic:building__emojis. Multi-characteremojis__Aswe__sawin__NormalizingUnicode__forSaner__Comparisons ,it__salways__beenpossible__toproduce__accentedcharacters__bycombining__Unicodeletters__and diacritics.To__accomodatethe__growingdemand__for emojis,this__ideahas__beenextended__toproduce__differentpictographs__bycombining__specialmarkers__andemoji__characters.Let__sstart__withthe__simplestkind__ofcombined__emoji:flags__of countries.Country__flagsThroughout__history,countries__split, join,mutate__orsimply__adoptnew__flags.The__Unicodeconsortium__founda__wayto__avoidkeeping__upwith__thosechanges__andoutsource__theproblem__tothe__systemsthat__claimUnicode__support:its__characterdatabase__hasno__country flags.Instead__thereis__aset__of 26regional__indicatorsymbols__letters ,from__A (U+1F1E6)to__Z (U+1F1FF).When__youcombine__twoof__thoseindicator__lettersto__forman__ISO 3166-1country__code,you__getthe__correspondingcountry__flagif__theUI__supports it.Example__4-25shows__how.Example__4-25. two_flags.py:combining__regionalindicators__toproduce__flags #REGIONAL__INDICATORSYMBOLS__RIS_A = '\U0001F1E6' #LETTER__ARIS_U__= '\U0001F1FA' #LETTER__U print(RIS_A + RIS_U) # AU:Australia__print(RIS_U + RIS_A) # UA:Ukraine__print(RIS_A + RIS_A) # AA:no__suchcountry__Figure 4-9shows__theoutput__ofExample__4-25on__aMacOS__10.14 terminal.Figure__4-9.Screenshot__ofrunning__two_flags.pyfrom__Example 4-25.The__AAcombination__isshown__astwo__lettersA__insidedashed__squares.If__yourprogram__outputsa__combinationof__indicatorletters__thatis__notrecognized__bythe__app,you__getthe__indicatorsdisplayed__asletters__insidedashed__squares again,depending__onthe__UI.See__thelast__linein__Figure 4- 9.NOTE__Europeand__theUnited__Nationsare__not countries,but__theirflags__aresupported__bythe__regionalindicator__pairsEU__and UN, respectively. England, Scotland,and__Walesmay__ormay__notbe__separatecountries__bythe__timeyou__read this,but__theyalso__haveflags__supportedby__Unicode. However,instead__ofregional__indicator letters,those__flagsrequire__amore__complicated scheme.Read__EmojiFlags__Explainedon__Emojipediato__learnhow__that works.Now__lets__seehow__emojimodifiers__canbe__usedto__setthe__skintone__ofemojis__thatshow__human faces, hands,noses__etc.Skin__tonesUnicode__providesa__setof__5emoji__modifiersto__setskin__tonefrom__paleto__dark brown.They__arebased__onthe__Fitzpatrickscale__developedto__studythe__effectsof__ultravioletlight__onhuman__skin.Example__4-26shows__theuse__ofthose__modifiersto__setthe__skintone__ofthe__thumbsup__emoji.Example__4-26. skin.py:the__thumbsup__emojiby__itself,followed__byall__availableskin__tone modifiers.from__unicodedataimport__name SKIN1 = 0x1F3FB #EMOJI__MODIFIERFITZPATRICK__TYPE-1-2SKINS__= [chr(i)for__iin__range(SKIN1, SKIN1 + 5)]THUMB__= '\U0001F44d' #THUMBS__UPSIGN__examples = [THUMB] examples.extend(THUMB +skin__forskin__in SKINS)for__examplein__examples: print(example, end='\t') print(' + '.join(name(char)for__charin__example))EMOJI__MODIFIERFITZPATRICK__TYPE-1-2is__thefirst__modifier.Build__listwith__allfive__modifiers.Start__listwith__theunmodified__THUMBSUP__SIGN.Extend__listwith__thesame__emojifollowed__byeach__ofthe__modifiers.Display__emojiand__tab.Display__namesof__characterscombined__inthe__emoji,joined__by ' + '.The__outputof__Example 4-26looks__likeFigure__4-10on__MacOS.As__youcan__see,the__unmodifiedemoji__hasa__cartoonishyellow__color,while__theothers__havemore__realisticskin__tones.Figure__4-10.Screenshot__ofExample__4-26in__theMacOS__10.14 terminal.Let__snow__moveto__morecomplex__emojicombinations__usingspecial__markers.Rainbow__flagand__otherZWJ__sequencesBesides__thespecial__purposeindicators__andmodifiers__weve__seen,Unicode__providesa__markerthat__isused__asglue__betweenemojis__andother__characters,to__producenew__combinations: U+200D,ZERO__WIDTHJOINER__a.k.a.ZWJ__inmany__Unicode documents.For__examplerainbow__flagis__builtby__joiningthe__emojisWAVING__WHITEFLAG__and RAINBOW,as__Figure 4-11 shows.Figure__4-11.Making__therainbow__flagin__thePython__console.Unicode__13supports__morethan__1100ZWJ__emojisequences__asRGI__recommendedfor__generalinterchange__[ ]intended__tobe__widelysupported__acrossmultiple__platforms .You__canfind__thefull__listof__RGIZWJ__emojisequences__in emoji-zwj-sequences.txtand__asmall__samplein__Figure 4-12. 15Figure__4-12.Sample__ZWJsequences__generatedby__Example 4-27,running__ina__Jupyter Notebook,viewed__onFirefox__72on__Ubuntu 19.10.This__browser/OScombo__candisplay__allthe__emojisfrom__this sample,including__the newest:people__holdinghands__andtransgender__flag ,added__inEmoji__12.0and__13.0.Example__4-27is__thesource__codethat__producedFigure__4-12.You__canrun__itfrom__your shell,but__forbetter__resultsI__recommendpasting__itinside__aJupyter__Notebookto__runit__ina__browser.Browsers__oftenlead__theway__inUnicode__support,and__provideprettier__emoji pictographs.Example__4-27. zwj_sample.py:produce__listingwith__afew__ZWJ characters.from__unicodedataimport__namezwg_sample__= """ 1F468 200D 1F9B0 |man:red__hair |E11.0 1F9D1 200D 1F91D 200D 1F9D1 |peopleholding__hands |E12.0 1F3CA 1F3FF 200D 2640 FE0F |woman swimming:dark__skintone__|E4.0 1F469 1F3FE 200D 2708 FE0F |woman pilot: medium-darkskin__tone |E4.0 1F468 200D 1F469 200D 1F467 |family: man, woman,girl__|E2.0 1F3F3 FE0F 200D 26A7 FE0F |transgenderflag__|E13.0 1F469 200D 2764 FE0F 200D 1F48B 200D 1F469 |kiss: woman,woman__|E2.0 """markers__= {'\u200D': 'ZWG', #ZERO__WIDTHJOINER__'\uFE0F': 'V16', #VARIATION__SELECTOR-16 }for__linein__zwg_sample.strip().split('\n'): code, descr,version__= (s.strip()for__sin__line.split('|'))chars__= [chr(int(c, 16))for__cin__code.split()] print(''.join(chars), version, descr, sep='\t', end='')while__chars:char__= chars.pop(0)if__charin__markers: print(' + ' + markers[char], end='') else:ucode__= f'U+{ord(char):04X}' print(f'\n\t{char}\t{ucode}\t{name(char)}', end='') print()One__trendin__modernUnicode__isthe__additionof__gender-neutralemojis__suchas__SWIMMER (U+1F3CA)or__ADULT (U+1F9D1),which__canthen__beshown__asthey__are,or__withdifferent__genderin__ZWJsequences__withthe__femalesign__(U+2640)or__themale__sign (U+2642).The__UnicodeConsortium__isalso__movingtowards__morediversity__inthe__supportedfamily__emojis.Figure__4-13is__amatrix__offamily__emojisshowing__currentsupport__forfamilies__withdifferent__combinationsof__parentsand__childrenas__of January, 2020.Figure__4-13.The__tableshows__adultsingles__andcouples__atthe__top,and__boysand__girlson__theleft__side.Cells__havethe__combinedemoji__ofa__familywith__the parent(s)from__thetop__and kid(s)from__the left.If__acombination__isnot__supportedby__the browser,more__thanone__emojiwill__appearinside__a cell.Firefox__72on__Windows 10is__ableto__showall__combinations.The__codeI__wroteto__buildFigure__4-13is__mostlyconcerned__withHTML__formatting,but__islisted__in [Linkto__Come]for__completeness.Example__4-28.Browsers__followthe__evolutionof__UnicodeEmoji__closely,and__hereno__OShas__aclear__advantage.While__preparingthis__chapter,I__capturedFigure__4-12on__Ubuntu 19.10and__Figure 4-13on__Windows 10,using__Firefox 72on__both,because__thosewere__the OS/browsercombinations__withthe__mostcomplete__supportfor__theemojis__inthose__examples.Unicode__isa__fascinating topic. However,now__istime__towrap__upour__explorationof__strand__bytes.Chapter__SummaryWe__startedthe__chapterby__dismissingthe__notionthat__1character__== 1 byte.As__theworld__adopts Unicode,we__needto__keepthe__conceptof__textstrings__separatedfrom__thebinary__sequencesthat__representthem__in files,and__Python 3enforces__this separation.After__abrief__overviewof__thebinary__sequencedata__types bytes, bytearray,and__memoryviewwe__jumpedinto__encodingand__decoding,with__asampling__ofimportant__codecs,followed__byapproaches__toprevent__ordeal__withthe__infamous UnicodeEncodeError, UnicodeDecodeError,and__theSyntaxError__causedby__wrongencoding__inPython__source files.While__onthe__subjectof__source code,I__presentedmy__opinionon__thedebate__about non-ASCII identifiers:if__themaintainers__ofthe__codebase__wantto__usea__humanlanguage__thatis__notlimited__toASCII__characters,the__identifiersshould__bespelled__correctly.That__sprecisely__whyPython__3accepts__non-ASCII identifiers.We__thenconsidered__thetheory__andpractice__ofencoding__detectionin__theabsence__of metadata:in__theory,it__cant__be done,but__inpractice__theChardet__packagepulls__itoff__prettywell__fora__numberof__popular encodings.Byte__ordermarks__werethen__presentedas__theonly__encodinghint__commonlyfound__in UTF-16and__UTF-32files__sometimesin__UTF-8files__as well.In__thenext__section,we__demonstratedopening__text files,an__easytask__exceptfor__one pitfall:the__encoding=keyword__argumentis__notmandatory__whenyou__opena__text file,but__itshould__be.If__youfail__tospecify__the encoding,you__endup__witha__programthat__managesto__generateplain__textthat__isincompatible__across platforms,due__toconflicting__default encodings.We__thenexposed__thedifferent__encodingsettings__thatPython__usesas__defaultsand__howto__detect them: locale.getpreferredencoding(), sys.getfilesystemencoding(), sys.getdefaultencoding(),and__theencodings__forthe__standard I/Ofiles__(e.g., sys.stdout.encoding).A__sadrealization__forWindows__usersis__thatthese__settingsoften__havedistinct__valueswithin__thesame__machine,and__thevalues__aremutually__incompatible; GNU/Linuxand__OSX users,in__contrast,live__ina__happierplace__where UTF-8is__thedefault__prettymuch__everywhere.Text__comparisonsare__surprisinglycomplicated__becauseUnicode__providesmultiple__waysof__representingsome__characters,so__normalizingis__aprerequisite__totext__matching.In__additionto__explainingnormalization__andcase__folding,we__presentedsome__utilityfunctions__thatyou__mayadapt__toyour__needs,including__drastictransformations__likeremoving__all accents.We__thensaw__howto__sortUnicode__textcorrectly__byleveraging__thestandard__localemodule__withsome__caveatsand__analternative__thatdoes__notdepend__ontricky__locale configurations:the__externalPyUCA__package.Then__weleveraged__theUnicode__databaseto__builda__command-lineutility__tosearch__forcharacters__byname__in 28lines__of code,thanks__tothe__powerof__Python.We__glancedat__otherUnicode__metadata,and__hada__briefoverview__of dual-modeAPIs__(e.g.,the__reand__os modules,where__somefunctions__canbe__calledwith__stror__bytes arguments,prompting__differentyet__fitting results). Finally,we__sawhow__toproduce__flags,hands__withdifferent__skin tones,family__iconsand__otheremoji__combinationssupported__by Unicode.Further__ReadingNed__Batchelders__2012PyCon__UStalk__PragmaticUnicode__orHow__DoI__Stopthe__Pain?was__outstanding.Ned__isso__professionalthat__heprovides__afull__transcriptof__thetalk__alongwith__theslides__and video.Esther__Namand__TravisFischer__gavean__excellentPyCon__2014talk__Characterencoding__andUnicode__in Python:How__to ( )with__dignity (slides, video),from__whichI__quotedthis__chapters__shortand__sweet epigraph:Humans__use text.Computers__speak bytes.Lennart__Regebroone__ofthis__books__technicalreviewers__presentshis__UsefulMental__Modelof__Unicode (UMMU)in__theshort__postUnconfusing__Unicode:What__Is Unicode? .Unicode__isa__complex standard,so__Lennarts__UMMUis__areally__usefulstarting__point.The__officialUnicode__HOWTOin__thePython__docsapproaches__thesubject__fromseveral__different angles,from__agood__historicintro__tosyntax__details, codecs,regular__expressions, filenames,and__bestpractices__for Unicode-aware__I/O (i.e.,the__Unicode sandwich),with__plentyof__additionalreference__linksfrom__each section.Chapter__4,Strings__,of__MarkPilgrim__sawesome__bookDive__intoPython__3also__providesa__verygood__introto__Unicodesupport__inPython__3.In__thesame__book,Chapter__15describes__howthe__Chardetlibrary__wasported__fromPython__2to__Python 3,a__valuablecase__studygiven__thatthe__switchfrom__theold__strto__thenew__bytesis__thecause__ofmost__migration pains,and__thatis__acentral__concernin__alibrary__designedto__detect encodings.If__youknow__Python 2but__arenew__toPython__3,Guido__vanRossum__sWhat__sNew__inPython__3.0has__15bullet__pointsthat__summarizewhat__changed,with__lotsof__links.Guido__startswith__theblunt__statement:Everything__youthought__youknew__aboutbinary__dataand__Unicodehas__changed.Armin__Ronachers__blogpost__TheUpdated__Guideto__Unicodeon__Pythonis__deepand__highlightssome__ofthe__pitfallsof__Unicodein__Python 3 (Arminis__nota__bigfan__ofPython__3).Chapter__2,Strings__and Text,of__thePython__Cookbook,Third__Edition (O Reilly),by__DavidBeazley__andBrian__K. Jones,has__severalrecipes__dealingwith__Unicode normalization,sanitizing__text,and__performing text-oriented__operationson__byte sequences.Chapter__5covers__filesand__I/O,and__itincludes__Recipe 5.17.Writing__Bytesto__aText__File,showing__thatunderlying__anytext__filethere__isalways__abinary__streamthat__maybe__accesseddirectly__when needed.Later__inthe__cookbook,the__structmodule__isput__touse__inRecipe__6.11.Reading__andWriting__BinaryArrays__of Structures.Nick__Coghlans__PythonNotes__bloghas__twoposts__veryrelevant__tothis__chapter:Python__3and__ASCIICompatible__BinaryProtocols__andProcessing__TextFiles__inPython__3 .Highly__recommended.A__listof__encodingssupported__byPython__isavailable__atStandard__Encodingsin__thecodecs__module documentation.If__youneed__toget__thatlist__programmatically,see__howit__sdone__inthe__/Tools/unicode/listcodecs.pyscript__thatcomes__withthe__CPythonsource__code.Martijn__Faassens__Changingthe__PythonDefault__EncodingConsidered__Harmfuland__TarekZiad__s sys.setdefaultencodingIs__Evilexplain__whythe__defaultencoding__youget__from sys.getdefaultencoding()should__neverbe__changed,even__ifyou__discover how.The__booksUnicode__Explainedby__Jukka K.Korpela__(O Reilly)and__UnicodeDemystified__byRichard__Gillam (Addison-Wesley)are__not Python-specificbut__werevery__helpfulas__Istudied__Unicode concepts.Programming__withUnicode__byVictor__Stinneris__a free, self-publishedbook__(CreativeCommons__BY-SA)covering__Unicodein__generalas__wellas__toolsand__APIsin__thecontext__ofthe__mainoperating__systemsand__afew__programming languages,including__Python.The__W3Cpages__Case Folding:An__Introductionand__CharacterModel__forthe__WorldWide__Web:String__Matchingand__Searchingcover__normalization concepts,with__theformer__beinga__gentleintroduction__andthe__lattera__workinggroup__notewritten__indry__standard-speakthe__sametone__ofthe__UnicodeStandard__Annex #15Unicode__Normalization Forms.The__FrequentlyAsked__Questions /Normalization__from Unicode.orgis__more readable,as__isthe__NFCFAQ__byMark__Davisauthor__ofseveral__Unicodealgorithms__andpresident__ofthe__UnicodeConsortium__atthe__timeof__this writing.To__learnmore__aboutUnicode__Emoji standards,visit__theUnicode__Emojiindex__page,which__linksto__theTechnical__Standard #51:Unicode__Emojiand__theemoji__data files,where__youll__find emoji-zwj-sequences.txtthe__sourceof__thesamples__Iused__inFigure__4-12.Emojipedia__isthe__bestsite__tofind__emojisand__learnabout__them.Besides__acomprehensive__searchable database,Emojipedia__alsohas__ablog__includingports__likeEmoji__ZWJ Sequences:Three__Letters,Many__Possibilitiesand__EmojiFlags__Explained.In__2016,the__Museumof__ModernArt__(MoMA)in__NYCadded__toits__collectionThe__Original Emoji,the__176emojis__designedby__ShigetakaKurita__in 1999for__NTTDOCOMO__theJapanese__mobile carrier.Going__furtherback__in history,Emojipedia__publishedCorrecting__theRecord__onthe__FirstEmoji__Set,crediting__Japans__SoftBankfor__theearliest__knownemoji__set,deployed__incell__phonesin__1997.SoftBank__sset__isthe__sourceof__90emojis__nowin__Unicode,including__U+1F4A9 (PILEOF__POO).The__cultureand__politicsof__emojievolution__inthe__2010-2019decade__arethe__subjectof__PaddyJohnson__sarticle__EmojiWe__Lostfor__Gizmodo.Matthew__Rothenbergs__emojitracker.comis__alive__dashboardshowing__countsof__emojiusage__on Twitter,updated__inreal__time.As__Iwrite__this,FACE__WITHTEARS__OFJOY__(U+1F602)is__themost__popularemoji__on Twitter,with__2,693,102,686recorded__occurrences.SOAPBOX__WhatIs__PlainText__?For__anyonewho__dealswith__non-Englishtext__ona__daily basis,plain__textdoes__notimply__ASCII.The__UnicodeGlossary__definesplain__textlike__this: Computer-encodedtext__thatconsists__onlyof__asequence__ofcode__pointsfrom__agiven__standard,with__noother__formattingor__structural information.That__definitionstarts__very well,but__Idon__tagree__withthe__partafter__the comma.HTML__isa__greatexample__ofa__plain-textformat__thatcarries__formattingand__structural information.But__its__stillplain__textbecause__everybyte__insuch__afile__isthere__torepresent__atext__character,usually__using UTF-8.There__areno__byteswith__nontext meaning,as__youcan__findin__a .pngor__.xlsdocument__wheremost__bytesrepresent__packedbinary__valueslike__RGBvalues__and floating-point numbers.In__plain text,numbers__arerepresented__assequences__ofdigit__characters.I__amwriting__thisbook__ina__plain-textformat__calledironically__AsciiDoc,which__ispart__ofthe__toolchainof__OReilly__sexcellent__Atlasbook__publishing platform.AsciiDoc__sourcefiles__areplain__text,but__theyare__UTF-8,not__ASCII. Otherwise,writing__thischapter__wouldhave__beenreally__painful.Despite__the name,AsciiDoc__isjust__great.The__worldof__Unicodeis__constantlyexpanding__and,at__the edges,tool__supportis__notalways__there.Not__allcharacters__Iwanted__toshow__wereavailable__inthe__fontsused__torender__the book.That__swhy__Ihad__touse__imagesfor__insteadof__listingsin__severalexamples__inthis__chapter.On__theother__hand,the__Ubuntuand__MacOSterminals__displaymost__Unicodetext__verywell__includingthe__Japanesecharacters__forthe__wordmojibake__: .Unicode__RiddlesImprecise__qualifierssuch__as often, most,and__usuallyseem__topop__upwhenever__Iwrite__aboutUnicode__normalization.I__regretthe__lackof__moredefinitive__advice,but__thereare__somany__exceptionsto__therules__inUnicode__thatit__ishard__tobe__absolutely positive.For__example,the__(micro sign)is__considereda__compatibilitycharacter__butthe__(ohm)and__(ngstr__m)symbols__are not.The__differencehas__practical consequences:NFC__normalizationrecommended__fortext__matchingreplaces__the (ohm)by__(uppercaseGrek__omega)and__the (ngstr__m)by__(uppercaseA__withring__above).But__asa__compatibilitycharacter__the (micro sign)is__notreplaced__bythe__visuallyidentical__(lowercaseGreek__mu),except__whenthe__strongerNFKC__orNFKD__normalizationsare__applied,and__thesetransformations__are lossy.I__understandthe__(micro sign)is__inUnicode__becauseit__appearsin__the latin1encoding__andreplacing__itwith__theGreek__muwould__break round-trip conversion.After__all,that__swhy__themicro__signis__acompatibility__character.But__ifthe__ohmand__ngstrm__symbolsare__notin__Unicodefor__compatibility reasons,then__whyhave__themat__all?There__arealready__codepoints__forthe__GREEKCAPITAL__LETTEROMEGA__andthe__LATINCAPITAL__LETTERA__WITHRING__ABOVE,which__lookthe__sameand__replacethem__onNFC__normalization.Go__figure.My__takeafter__manyhours__studying Unicode:it__ishugely__complexand__fullof__special cases,reflecting__thewonderful__varietyof__humanlanguages__andthe__politicsof__industry standards.The__powerof__soccerHere__isanother__Unicode mystery:why__are England, Scotland,and__Walesentitled__totheir__ownUnicode__flags,but__Catalonia, Pernambuco,and__Texasare__not?Because__thefirst__threeare__permanentmembers__ofthe__InternationalFootball__AssociationBoard__whichcontrols__therules__of soccer.As__such,they__areallowed__toenter__theirnational__teamsin__theFIFA__WorldCup__thereforemedia__outletsneed__theirflags__todisplay__tournament charts.At__leastthat__sis__my theory.How__Arestr__Representedin__RAM?The__officialPython__docsavoid__theissue__ofhow__thecode__pointsof__astr__arestored__in memory.This__is,after__all,an__implementation detail.In__theory,it__doesnt__matter:whatever__theinternal__representation,every__strmust__beencoded__tobytes__on output.In__memory,Python__3stores__eachstr__asa__sequenceof__codepoints__usinga__fixednumber__ofbytes__percode__point,to__allowefficient__directaccess__toany__characteror__slice.Before__Python 3.3,CPython__couldbe__compiledto__useeither__16or__32bits__percode__pointin__RAM;the__formerwas__anarrow__build,and__thelatter__awide__build.To__knowwhich__you have,check__thevalue__of sys.maxunicode: 65535implies__anarrow__buildthat__cant__handlecode__pointsabove__U+FFFF transparently.A__widebuild__doesnt__havethis__limitation,but__useda__lotof__more memory: 4bytes__per character,even__whilethe__vastmajority__ofcode__pointsfor__Chineseideographs__fitin__2 bytes.Neither__optionwas__great,so__youhad__tochoose__dependingon__your needs.Since__Python 3.3,when__creatinga__newstr__object,the__interpreterchecks__thecharacters__init__andchooses__themost__economicmemory__layoutthat__issuitable__forthat__particular str:if__thereare__onlycharacters__inthe__latin1 range,that__strwill__usejust__onebyte__percode__point. Otherwise, 2or__4bytes__percode__pointmay__be used,depending__onthe__str.This__isa__simplification;for__thefull__details,look__upPEP__393Flexible__String Representation.The__flexiblestring__representationis__similarto__theway__theint__typeworks__inPython__3:if__theinteger__fitsin__amachine__word,it__isstored__inone__machine word. Otherwise,the__interpreterswitches__toa__variable-lengthrepresentation__likethat__ofthe__Python 2long__type.It__isnice__tosee__thespread__ofgood__ideas. However,we__canalways__counton__ArminRonacher__tofind__problemsin__Python 3.He__explainedto__mepersonally__whythat__wasnot__suchas__greatidea__in practice:it__takesa__singleRAT__(U+1F400)to__inflatean__otherwise all-ASCIItext__intoa__memory-hogginginternal__arrayusing__4bytes__per character.In__addition,because__ofall__theways__Unicodecharacters__combine,the__abilityto__retrievean__arbitrarycharacter__byposition__isoverrated__andextracting__arbitraryslices__fromUnicode__textis__nave__at best,and__often wrong.As__emojisbecome__more popular,these__problemswill__onlyget__worse. 1Slide__12of__PyCon 2014talk__CharacterEncoding__andUnicode__inPython__(slides, video). 2Python__2.6and__2.7also__have bytes,but__its__justan__aliasto__thestr__type,and__doesnot__behavelike__thePython__3bytes__type. 3It__didnot__workin__Python 3.0to__3.4,causing__muchpain__todevelopers__dealingwith__binary data.The__reversalis__documentedin__PEP 461Adding__%formatting__tobytes__and bytearray. 4I__firstsaw__theterm__Unicodesandwich__inNed__Batchelders__excellentPragmatic__Unicodetalk__atUS__PyCon 2012. 5Python__2.6or__2.7users__haveto__use io.open()to__getautomatic__decoding/encodingwhen__reading/writing. 6 Source:Windows__Command-Line:Unicode__and UTF-8Output__Text Buffer. 7While__researchingthis__subject,I__didnot__finda__listof__situationswhen__Python 3internally__convertsbytes__to str.Python__coredeveloper__AntoinePitrou__sayson__the comp.python.devellist__thatCPython__internalfunctions__thatdepend__onsuch__conversionsdon__tget__alot__ofuse__in py3k. 8The__Python 2 sys.setdefaultencodingfunction__wasmisused__andis__nolonger__documentedin__Python 3.It__wasintended__foruse__bythe__coredevelopers__whenthe__internaldefault__encodingof__Pythonwas__still undecided.In__thesame__comp.python.devel thread, Marc-AndrLemburg__statesthat__the sys.setdefaultencodingmust__neverbe__calledby__usercode__andthe__onlyvalues__supportedby__CPythonare__'ascii'in__Python 2and__'utf-8'in__Python 3. 9 Curiously,the__microsign__isconsidered__acompatibility__characterbut__theohm__symbolis__not.The__endresult__isthat__NFCdoesn__ttouch__themicro__signbut__changesthe__ohmsymbol__tocapital__omega,while__NFKCand__NFKDchange__boththe__ohmand__themicro__intoGreek__characters. 10Diacritics__affectsorting__onlyin__therare__casewhen__theyare__theonly__differencebetween__twowords__inthat__case,the__wordwith__adiacritic__issorted__afterthe__plain word. 11Thanks__toLeonardo__Rochaelwho__wentbeyond__hisduties__astech__reviewerand__researchedthese__Windows details,even__thoughhe__isa__GNU/Linuxuser__himself. 12 Again,I__couldnot__finda__solution,but__didfind__otherpeople__reportingthe__same problem.Alex__Martelli,one__ofthe__tech reviewers,had__noproblem__usingsetlocale__and locale.strxfrmon__hisMac__withOSX__10.9.In__summary:your__mileagemay__vary. 13That__san__imagenot__acode__listingbecause__emojisare__notwell__supportedby__OReilly__sdigital__publishingtoolchain__asI__write this. 14Although__itwas__notbetter__thanre__atidentifying__digitsin__thisparticular__sample. 15Definition__quotedfrom__TechnicalStandard__#51Unicode__Emoji.Chapter__5. Record-likedata__structuresA__NOTEFOR__EARLYRELEASE__READERSWith__EarlyRelease__ebooks,you__getbooks__intheir__earliestform__theauthor__sraw__andunedited__contentas__theywrite__soyou__cantake__advantageof__thesetechnologies__longbefore__theofficial__releaseof__these titles.This__willbe__the 5thchapter__ofthe__final book.Please__notethat__theGitHub__repowill__bemade__activelater__on.If__youhave__commentsabout__howwe__mightimprove__thecontent__and/orexamples__inthis__book,or__ifyou__noticemissing__materialwithin__this chapter,please__reachout__tothe__authorat__fluentpython2e@ramalho.org.Data__classesare__like children.They__areokay__asa__starting point,but__toparticipate__asa__grownup object,they__needto__takesome__responsibility.Martin__Fowlerand__KentBeck__Pythonoffers__afew__waysto__builda__simpleclass__thatis__justa__bunchof__fields,with__littleor__noextra__funcionality.That__patternis__knownas__adata__classand__dataclassis__thename__ofa__Pythondecorator__thatsupports__it.This__chaptercovers__threedifferent__classbuilders__thatyou__mayuse__asshortcuts__towrite__data classes: collections.namedtuple:the__simplestway__sincePython__2.6; typing.NamedTuple:an__alternativethat__allowstype__annotationson__thefields__sincePython__3.5;class__syntaxsupported__since 3.6; @dataclasses.dataclass:a__classdecorator__thatallows__morecustomization__thanprevious__alternatives,adding__lotsof__optionsand__potentialcomplexity__sincePython__3.7. 1After__coveringthose__class builders,we__willdiscuss__whyData__Classis__alsothe__nameof__acode__smell:a__codingpattern__thatmay__bea__symptomof__poor object-oriented design.The__chapterends__witha__sectionon__avery__different topic,but__stillclosely__relatedto__record-like data:the__struct module,designed__toparse__andbuild__packedbinary__recordsthat__youmay__findin__legacy flat-file databases,network__protocols,and__file headers.NOTE__typing.TypeDict (sincePython__3.8)may__seemlike__anotherdata__classbuilder__its__describedright__after typing.NamedTuplein__thetyping__module documentation,and__usessimilar__syntax. However,TypedDict__doesnot__buildconcrete__classesthat__youcan__instantiate.It__sjust__away__towrite__staticannotations__forvariables__andfunction__argumentsthat__areexpected__toaccept__plaindictionaries__witha__fixedset__ofkeys__anda__specifictype__forthe__valuemapped__toeach__key.What__snew__inthis__chapterThis__chapteris__newin__FluentPython__2 edition.The__sectionsClassic__NamedTuples__andStructs__andMemory__Viewsappeared__inchapters__2and__4in__the 1 edition,but__therest__ofthe__chapteris__completely new.We__beginwith__ahigh__leveloverview__ofthe__threeclass__builders.Overview__ofdata__classbuilders__Considera__simpleclass__torepresent__ageographic__coordinate pair:Example__5-1. class/coordinates.pynd__stclass__Coordinate:def____init__(self, lat, long): self.lat =lat__self.long =long__ThatCoordinate__classdoes__thejob__ofholding__latitudeand__longitude attributes.Writing__the__init____boilerplatebecomes__oldreal__fast,especially__ifyour__classhas__morethan__acouple__of attributes:each__ofthem__ismentioned__three times!And__thatboilerplate__doesnt__buyus__basicfeatures__wed__expectfrom__aPython__object: >>>from__coordinatesimport__Coordinate >>>moscow__= Coordinate(55.76, 37.62) >>>moscow__>>>location__= Coordinate(55.76, 37.62) >>>location__==moscow__False >>> (location.lat, location.long) == (moscow.lat, moscow.long)True____repr__inherited__fromobject__isnot__very helpful.Meaningless__equality;the____eq__method__inheritedfrom__objectcompares__object ids.Comparing__twocoordinates__requiresexplicit__comparisonof__each attribute.The__dataclass__builderscovered__inthis__chapterprovide__thenecessary____init__, __repr__,and____eq__methods__automatically,as__wellas__otheruseful__features.NOTE__Noneof__theclass__buildersdiscussed__heredepend__oninheritance__todo__their work.Both__collections.namedtupleand__typing.NamedTuplebuild__classesthat__aretuple__subclasses. @dataclassis__aclass__decoratorthat__doesnot__affectthe__classhierarchy__inany__way.Each__ofthem__usedifferent__metaprogrammingtechniques__toinject__methodsand__dataattributes__intothe__classunder__construction.Here__isa__Coordinateclass__builtwith__namedtuplea__factoryfunction__thatbuilds__asubclass__oftuple__withthe__nameand__fieldsyou__specify: >>>from__collectionsimport__namedtuple >>>Coordinate__= namedtuple('Coordinate', 'lat long') >>> issubclass(Coordinate, tuple)True__>>>moscow__= Coordinate(55.756, 37.617) >>>moscow__Coordinate(lat=55.756, long=37.617) >>>moscow__== Coordinate(lat=55.756, long=37.617)True__Useful __repr__.Meaningful____eq__.The__newer typing.NamedTupleprovides__thesame__funcionality,adding__atype__annotationto__each field: >>>import__typing >>>Coordinate__= typing.NamedTuple('Coordinate', [('lat', float), ('long', float)]) >>> issubclass(Coordinate, tuple)True__>>> Coordinate.__annotations__ {'lat': , 'long': }TIP__Atyped__namedtuple__canalso__beconstructed__withthe__fieldsgiven__askeyword__arguments,like__this:Coordinate__= typing.NamedTuple('Coordinate', lat=float, long=float)This__ismore__readable,and__alsolets__youprovide__themapping__offields__andtypes__as **fields_and_types.Since__Python 3.6, typing.NamedTuplecan__alsobe__usedin__aclass__statement,with__typeannotations__writtenas__describedin__PEP 526Syntax__forVariable__Annotations.This__ismuch__more readable,and__makesit__easyto__overridemethods__oradd__new ones.Example__5-2is__thesame__Coordinate class,with__apair__offloat__attributesand__acustom____str__to__displaya__coordinateformatted__like 55.8 N, 37.6 E:Example__5-2. typing_namedtuple/coordinates.pyfrom__typingimport__NamedTupleclass__Coordinate(NamedTuple): lat:float__long:float__def __str__(self):ns__= 'N'if__self.lat >= 0else__'S'we__= 'E'if__self.long >= 0else__'W'return__f'{abs(self.lat):.1f} {ns}, {abs(self.long):.1f} {we}'WARNING__AlthoughNamedTuple__appearsin__theclass__statementas__a superclass,it__sactually__not. typing.NamedTupleuses__theadvanced__functionalityof__ametaclass__tocustomize__thecreation__ofthe__users__class.Check__this out: >>> issubclass(Coordinate, typing.NamedTuple)False__2 >>> issubclass(Coordinate, tuple)True__Inthe____init__method__generatedby__typing.NamedTuple,the__fieldsappear__asparameters__inthe__sameorder__theyappear__inthe__class statement.Like__typing.NamedTuple,the__dataclassdecorator__supportsPEP__526syntax__todeclare__instance attributes.The__decoratorreads__thevariable__annotationsand__automaticallygenerates__methodsfor__your class.For__comparison,check__outthe__equivalentCoordinate__classwritten__withthe__helpof__thedataclass__decorator:Example__5-3. dataclass/coordinates.pyfrom__dataclassesimport__dataclass @dataclass(frozen=True)class__Coordinate: lat:float__long:float__def __str__(self):ns__= 'N'if__self.lat >= 0else__'S'we__= 'E'if__self.long >= 0else__'W'return__f'{abs(self.lat):.1f} {ns}, {abs(self.long):.1f} {we}'Note__thatthe__bodyof__theclasses__inExample__5-2and__Example 5-3are__identicalthe__differenceis__inthe__classstatement__itself.The__@dataclassdecorator__doesnot__dependon__inheritanceor__a metaclass,so__itshould__notinterfere__withyour__ownuse__ofthese__mechanisms.The__Coordinateclass__inExample__5-3is__asubclass__of object. 3Main__featuresThe__differentdata__classbuilders__havea__lotof__common.Here__well__discussthe__mainfeatures__they share.Table__5-1 summarizes.Table__5-1.Selected__featurescompared__accrossthe__threedata__class builders.x__standsfor__aninstance__ofa__dataclass__ofthat__kind.namedtuple__NamedTupledataclass__mutableinstances__NONO__YESclass__statementsyntax__NOYES__YESconstruct__dict x._asdict() x._asdict() dataclasses.as_dict(x)get__fieldnames__x._fields x._fields [f.namefor__fin__dataclasses.fields(x)]get__defaults x._field_defaults x._field_defaults [f.defaultfor__fin__dataclasses.fields(x)]get__fieldtypes__N/A x.__annotations__ x.__annotations__new__instancewith__changes x._replace( ) x._replace( ) dataclasses.replace(x, )new__classat__runtime namedtuple( ) NamedTuple( ) dataclasses.make_dataclass( )MUTABLE__INSTANCESA__keydifference__betweenthese__classbuilders__isthat__collections.namedtupleand__typing.NamedTuplebuild__tuple subclasses,therefore__theinstances__are immutable.By__default, @dataclassproduces__mutable classes.But__thedecorator__acceptsseveral__keywordarguments__toconfigure__the class,including__frozenshown__inExample__5-3.When__frozen=True,the__classwill__raisean__exceptionif__youtry__toassign__valuesto__thefields__afterthe__instanceis__initialized.CLASS__STATEMENTSYNTAX__typing.NamedTupleand__dataclasssupport__theregular__classstatement__syntax,making__iteasier__toadd__methodsand__docstringsto__theclass__youare__creating; collections.namedtupledoes__notsupport__that syntax.CONSTRUCT__DICTBoth__namedtuple__variantsprovide__aninstance__method (._as_dict)to__toconstruct__adict__objectfrom__thefields__ina__dataclass__instance.dataclass__avoidsinjecting__asimilar__methodin__thedata__class,but__providesa__module-levelfunction__todo__it: dataclasses.as_dict.GET__FIELDNAMES__ANDDEFAULT__VALUESAll__threeclass__builderslet__youget__thefield__namesand__defaultvalues__thatmay__beconfigured__for them.In__namedtuple__classes,that__metadatais__inthe__._fieldsand__._fields_defaultsclass__attributes.You__canget__thesame__metadatafrom__adataclass__decoratedclass__usingthe__fieldsfunction__fromthe__dataclasses module.It__returnsa__tupleof__Fieldobjects__whichhave__several attributes,including__nameand__default.GET__FIELDTYPES__Amapping__offield__namesto__typeannotations__isstored__inthe____annotations__class__atributein__classesdefined__withthe__helpof__typing.NamedTupleand__dataclass.NEW__INSTANCEWITH__CHANGESGiven__anamed__tupleinstance__x,the__call x._replace(**kwargs)returns__anew__instancewith__someattribute__valuesreplaced__accordingto__thekeyword__arguments given.The__dataclasses.replace(x, **kwargs) module-levelfunction__doesthe__samefor__aninstance__ofa__dataclassdecorated__class.NEW__CLASSAT__RUNTIMEAlthough__theclass__statementsyntax__ismore__readable,it__is hard-coded.A__frameworkmay__needto__builddata__classeson__the fly,at__runtime.For__that,you__canuse__thedefault__functioncall__syntaxof__collections.namedtuple,which__islikewise__supportedby__typing.NamedTuple.The__dataclassesmodule__providesa__make_dataclassfunction__forthe__same purpose.After__thisoverview__ofthe__mainfeatures__ofthe__dataclass__builders,let__sfocus__oneach__ofthem__in turn,starting__withthe__simplest.Classic__NamedTuples__The collections.namedtuplefunction__isa__factorythat__buildssubclasses__oftuple__enhancedwith__field names,a__class name,and__anice____repr__--whichhelps__debugging.Classes__builtwith__namedtuplecan__beused__anywherewhere__tuplesare__needed,and__infact__manyfunctions__ofthe__Pythonstandard__librarythat__usedto__returntuples__nowreturn__namedtuples__for convenience,without__affectinguser__scode__at all.TIP__Eachinstance__ofa__classbuilt__bynamedtuple__takesexactly__thesame__amountof__memorya__tuplebecause__thefield__namesare__storedin__the class.They__useless__memorythan__aregular__objectbecause__theydon__tstore__attributesas__key-valuepairs__inone____dict__for__each instance.Example__5-4shows__howwe__coulddefine__anamed__tupleto__holdinformation__abouta__city.Example__5-4.Defining__andusing__anamed__tupletype__>>>from__collectionsimport__namedtuple >>>City__= namedtuple('City', 'namecountry__population coordinates') >>>tokyo__= City('Tokyo', 'JP', 36.933, (35.689722, 139.691667)) >>>tokyo__City(name='Tokyo', country='JP', population=36.933, coordinates= (35.689722, 139.691667)) >>> tokyo.population 36.933 >>> tokyo.coordinates (35.689722, 139.691667) >>> tokyo[1] 'JP'Two__parametersare__requiredto__createa__named tuple:a__classname__anda__listof__field names,which__canbe__givenas__aniterable__ofstrings__oras__asingle__space-delimited string.Field__valuesmust__bepassed__asseparete__positionalarguments__tothe__constructor (in contrast,the__tupleconstructor__takesa__single iterable).You__canaccess__thefields__byname__or position.As__atuple__subclass,City__inheritsuseful__methodssuch__as__eq____andthe__specialmethods__forcomparison__operators (__gt__, __ge__, etc.)which__areuseful__forsorting__sequencesof__City.In__additionto__themethods__inheritedfrom__tuple,a__namedtuple__offersa__fewattributes__and methods.Example__5-5shows__themost__useful:the___fieldsclass__attribute,the__classmethod___make(iterable),and__the _asdict()instance__method.Example__5-5.Named__tupleattributes__andmethods__(continuedfrom__theprevious__example) >>> City._fields ('name', 'country', 'population', 'location') >>>Coordinate__= namedtuple('Coordinate', 'lat long') >>>delhi_data__= ('Delhi NCR', 'IN', 21.935, Coordinate(28.613889, 77.208889)) >>>delhi__= City._make(delhi_data) >>> delhi._asdict() {'name': 'Delhi NCR', 'country': 'IN', 'population': 21.935, 'location': Coordinate(lat=28.613889, long=77.208889)} >>>import__json >>> json.dumps(delhi._asdict()) '{"name": "Delhi NCR", "country": "IN", "population": 21.935, "location": [28.613889, 77.208889]}' ._fieldsis__atuple__withthe__fieldnames__ofthe__class. ._make()builds__Cityfrom__an iterable; City(*delhi_data)would__dothe__same. ._asdict()returns__adict__builtfrom__thenamed__tuple instance. ._asdict()is__usefulto__serializethe__datain__JSON format,for__example.WARNING__The_asdict__methodreturned__anOrderedDict__inPython__2.7,and__inPython__3.1to__3.7.Since__Python 3.8,a__regulardict__isreturned__whichis__probablyfine__nowthat__wecan__relyon__keyinsertion__order.If__youmust__havean__OrderedDict,the___asdictdocumentation__recommendsbuilding__onefrom__the result: OrderedDict(x._asdict()).Since__Python 3.7,namedtuple__acceptsthe__defaults keyword-onlyargument__providingan__iterableof__Ndefault__valuesfor__eachof__theN__rightmostfields__ofthe__class.Example__5-6show__howto__definea__Coordinatenamed__tuplewith__adefault__valuefor__areference__field:Example__5-6.Named__tupleattributes__andmethods__(continuedfrom__theprevious__example) >>>Coordinate__= namedtuple('Coordinate', 'latlong__reference', defaults=['WGS84']) >>> Coordinate(0, 0) Coordinate(lat=0, long=0, reference='WGS84') >>> Coordinate._field_defaults {'reference': 'WGS84'}In__Classstatement__syntaxI__mentionedit__seasier__tocode__methodswith__theclass__syntaxsupported__by typing.NamedTupleand__@dataclass.You__canalso__addmethods__toa__namedtuple,but__its__a hack.Skip__thefollowing__boxif__youre__notinterested__in hacks.HACKING__ANAMEDTUPLE__TOINJECT__AMETHOD__Recallhow__webuilt__theCard__classin__Example 1-1in__Chapter 1:Card__= collections.namedtuple('Card', ['rank', 'suit'])Later__Chapter 1I__wrotea__spades_highfunction__for sorting.It__wouldbe__niceif__thatlogic__wasencapsulated__inmethod__of Card,but__addingspades_high__toCard__withoutthe__benefitof__aclass__statementrequires__aquick__hack:define__thefunction__andthen__assignit__toa__class attribute.Example__5-7shows__how.Example__5-7. frenchdeck.doctest:Adding__aclass__attributeand__amethod__to Card,the__namedtuplefrom__APythonic__CardDeck__>>> Card.suit_values = dict(spades=3, hearts=2, diamonds=1, clubs=0) >>>def__spades_high(card): ...rank_value__= FrenchDeck.ranks.index(card.rank) ...suit_value__= card.suit_values[card.suit] ...return__rank_value * len(card.suit_values) +suit_value__... >>> Card.overall_rank =spades_high__>>>lowest_card__= Card('2', 'clubs') >>>highest_card__= Card('A', 'spades') >>> lowest_card.overall_rank() 0 >>> highest_card.overall_rank() 51Attach__aclass__attributewith__valuesfor__each suit.spades_high__willbecome__a method;the__firstargument__doesnt__needto__benamed__self,but__itmust__referto__thereceiver__(thetarget__instance,which__weusually__call self).Attach__thefunction__tothe__Cards class.It__becomesa__methodnamed__overall_rank.It__works!For__readabilityand__future maintenance,its__muchbetter__tobe__ableto__codemethods__insidea__class statement.But__its__goodto__knowthis__hackis__possible,because__itmay__comein__handy.This__wassmall__detourto__showcasethe__powerof__adynamic__language. Now,on__tothe__nextfeatures__ofthe__dataclass__builders.Now__lets__checkout__the typing.NamedTuple variation.Typed__NamedTuples__TheCoordinate__classwith__adefault__fieldfrom__Example 5-6can__bewritten__likethis__using typing.NamedTuple:Example__5-8. typing_namedtuple/coordinates2.pyfrom__typingimport__NamedTupleclass__Coordinate(NamedTuple): lat:float__long:float__reference:str__= 'WGS84'Every__instancefield__mustbe__annotatedwith__a type.The__referenceinstance__fieldis__annotatedwith__atype__anda__defaultvalue__Classesbuilt__by typing.NamedTupledon__thave__anymethods__beyondthose__that collections.namedtuplealso__generatesand__thosethat__areinherited__from tuple.The__onlydifference__atruntime__isthe__presence 4of__the__attributes____classfield__whichPython__completelyignores__at runtime.WARNING__Classesbuilt__with typing.NamedTuplealso__havea___field_types attribute.Since__Python 3.8,that__attributeis__deprecatedin__favorof____annotations__which__hasthe__sameinformation__andis__thecanonical__placeto__findtype__hintsin__Pythonobjects__thathave__them.Given__thatthe__mainfeature__of typing.NamedTupleare__thetype__annotations,we__lltake__abrief__lookat__thembefore__resumingour__explorationof__dataclass__builders.Type__hints 101Type__hints a.k.a.type__annotationsare__waysto__declarethe__expectedtype__offunction__arguments,return__values,and__variables.NOTE__Thisis__avery__briefintroduction__totype__hints,just__enoughto__makesense__ofthe__syntaxand__meaningof__theannotations__used typing.NamedTupleand__@dataclass declarations.We__willcover__typehints__forfunction__signaturesin__[Linkto__Come]and__moreadvanced__annotationslike__generics,unions__etc.in__[Linkto__Come].Here__well__mostlysee__hintswith__built-in types,such__as str, int,and__float,which__areprobably__themost__commontypes__usedto__annotatefields__ofdata__classes.The__firstthing__youneed__toknow__abouttype__hintsis__thatthey__arenot__enforcedat__allby__thePython__bytecodecompiler__andruntime__interpreter.No__runtimeeffect__Typeannotations__dont__haveany__impacton__theruntime__behaviorof__Python programs.Check__this out:Example__5-9.Python__doesnot__enforcetype__hintsat__runtime. >>>import__typing >>>class__Coordinate(typing.NamedTuple): ... lat:float__... long:float__... >>>trash__= Coordinate('foo', None) >>> print(trash) Coordinate(lat='Ni!', long=None)I__told you:no__typechecking__at runtime!If__youtype__thecode__ofExample__5-9in__aPython__module,replacing__thelast__linewith__print(trash),it__willhappily__runand__displaya__meaningless Coordinate,with__noerror__or warning: $ python3 nocheck_demo.py Coordinate(lat='Ni!', long=None)The__typehints__areintended__primarilyto__support third-partytype__checkers,like__Mypyor__thePyCharm__IDE built-intype__checker.These__arestatic__analysis tools:they__checkPython__sourcecode__atrest__,not__running code.To__seethe__effectof__type hints,you__mustrun__oneof__thosetools__onyour__codelike__a linter.For__instance,here__iswhat__Mypyhas__tosay__aboutthe__previous example: $mypy__nocheck_demo.py nocheck_demo.py:8: error:Argument__1to__"Coordinate"has__incompatibletype__"str";expected__"float" nocheck_demo.py:8: error:Argument__2to__"Coordinate"has__incompatibletype__"None";expected__"float"As__youcan__see,given__thedefinition__of Coordinate,Mypy__knowsthat__botharguments__tocreate__aninstance__mustbe__oftype__float,but__theassignment__totrash__usesa__strand__None.Now__lets__talkabout__thesyntax__andmeaning__oftype__hints.Variable__annotationSyntax__Both typing.NamedTupleand__@dataclassuse__thesyntax__ofvariable__annotationsdefined__inPEP__526.This__isquick__introductionto__thatsyntax__inthe__contextdefining__attributesin__class statements.The__basicsyntax__ofvariable__annotation is: var_name:some_type__Thetype__thatgoes__afterthe__:must__bean__identifierfor__oneof__these:a__concrete class,for__examplestr__or FrenchDeck;an__ABCabstract__base class;a__typedefined__inthe__typing module,including__specialtypes__andconstructs__like Any, Optional, Union, etc.;a__typealias__asdescribed__inthe__Typealiases__sectionof__thetyping__moduledocumentation__SeeAcceptable__typehints__inPEP__484for__all details.You__canalso__initializethe__variablewith__a value.In__a typing.NamedTupleor__@dataclass declaration,that__valuewill__5become__thedefault__forthat__attribute,if__thecorresponding__argumentis__ommittedin__theconstructor__call. var_name:some_type__=a_value__Themeaning__ofvariable__annotationsWe__sawin__Noruntime__effectthat__typehints__haveno__effectat__runtime.But__atimport__timewhen__amodule__isloaded__Pythondoes__readthem__tobuild__the__annotations____dictionarythat__typing.NamedTupleand__@dataclassthen__useto__enhancethe__class.We__llstart__thisexploration__witha__simple class,so__thatwe__canlater__seewhat__extrafeatures__areadded__by typing.NamedTupleand__@dataclass.Example__5-10. meaning/demo_plain.py:a__plainclass__withtype__hintsclass__DemoPlainClass: a:int__b:float__= 1.1c__= 'spam'a__becomesan__annotation,but__isotherwise__discarded.b__issaved__asan__annotation,and__alsobecomes__aclass__attributewith__value 1.1.c__isjust__aplain__oldclass__attribute,not__an annotation.We__canverify__thatin__the console,first__readingthe____annotations__of__the DemoPlainClass,then__tryingto__getits__attributesnamed__a, b,and__c: >>>from__demo_plainimport__DemoPlainClass >>> DemoPlainClass.__annotations__ {'a': , 'b': } >>> DemoPlainClass.aTraceback__(mostrecent__call last):File__"",line__1,in__AttributeError:type__object 'DemoPlainClass'has__noattribute__'a' >>> DemoPlainClass.b 1.1 >>> DemoPlainClass.c 'spam'Note__thatthe____annotations__special__attributeis__createdby__theinterpreter__torecord__thetype__hintsthat__appearin__thesource__codeeven__ina__plain class.The__asurvives__onlyas__an annotation.It__doesnt__becomea__classattribute__becauseno__valueis__boundto__it.The__band__care__storedas__classattributes__becausethey__arebound__to values.None__ofthose__threeattributes__willbe__ina__newinstance__of DemoPlainClass.If__youcreate__anobject__o = DemoPlainClass(), o.awill__raise AttributeError,while__o.band__o.cwill__retrievethe__classattributes__withvalues__1.1and__'spam'that__sjust__normalPython__object behavior.INSPECTING__A TYPING.NAMEDTUPLENow__lets__examinea__classbuilt__with typing.NamedTuple,using__thesame__attributesand__annotationsas__DemoPlainClassfrom__Example 5- 10.Example__5-11. meaning/demo_nt.py:a__classbuilt__with typing.NamedTuple.import__typing 6class__DemoNTClass(typing.NamedTuple): a:int__b:float__= 1.1c__= 'spam'a__becomesan__annotationand__alsoan__instance attribute.b__isanother__annotation,and__alsobecomes__aninstance__attributewith__defaultvalue__1.1.c__isjust__aplain__oldclass__attribute;no__annotationwill__referto__it.Inspecting__the DemoNTClass,we__get: >>>from__demo_ntimport__DemoNTClass >>> DemoNTClass.__annotations__ {'a': , 'b': } >>> DemoNTClass.a <_collections._tuplegetterobject__at 0x101f0f940> >>> DemoNTClass.b <_collections._tuplegetterobject__at 0x101f0f8b0> >>> DemoNTClass.c 'spam'Here__wesee__thesame__annotationsfor__aand__bas__wesaw__inExample__5-10.But__DemoNTClasshas__threeclass__attributes a, b,and__c.The__cattribute__isjust__aplain__classattribute__withthe__value 'spam'.The__aand__bclass__attributesare__actuallydescriptors__anadvanced__featurecovered__in [Linkto__Come].For__now,think__ofthem__assimilar__toproperty__getters:methods__thatdon__trequire__theexplicit__calloperator__()to__retrievean__instance attribute.In__practice,this__meansa__andb__willwork__as read-only__instanceattributes__whichmakes__sensewhen__werecall__thatDemoNTClass__instancesare__justa__fancy tuples,and__tuplesare__immutable.DemoNTClass__alsogets__acustom__docstring: >>> DemoNTClass.__doc__ 'DemoNTClass(a, b)'Let__sinspect__aninstance__of DemoNTClass: >>>nt__= DemoNTClass(8) >>> nt.a 8 >>> nt.b 1.1 >>> nt.c 'spam'To__construct nt,we__needto__giveat__leastthe__aargument__to DemoNTClass.The__constructoralso__takesa__b argument,but__ithas__adefault__valueof__1.1,so__its__optional.The__ntobject__hasthe__aand__battributes__as expected;it__doesnt__havea__c attribute,but__Pythonretrieves__itfrom__the class,as__usual.If__youtry__toassign__valuesto__nt.a, nt.b, nt.cor__even nt.zyou__llget__AttributeError,with__subtlydifferent__error messages.Try__thatand__reflecton__the messages.INSPECTING__ACLASS__DECORATEDWITH__DATACLASSNow__well__examineExample__5-12:Example__5-12. meaning/demo_dc.py:a__classdecorated__with @dataclassfrom__dataclassesimport__dataclass @dataclassclass__DemoDataClass: a:int__b:float__= 1.1c__= 'spam'a__becomesan__annotationand__alsoan__instance attribute.b__isanother__annotation,and__alsobecomes__aninstance__attributewith__defaultvalue__1.1.c__isjust__aplain__oldclass__attribute;no__annotationwill__referto__it.Now__lets__checkout____annotations__, __doc__,and__the a, b,c__attributeson__DemoDataClass: >>>from__demo_dcimport__DemoDataClass >>> DemoDataClass.__annotations__ {'a': , 'b': } >>> DemoDataClass.__doc__ 'DemoDataClass(a: int, b:float__= 1.1)' >>> DemoDataClass.aTraceback__(mostrecent__call last):File__"",line__1,in__AttributeError:type__object 'DemoDataClass'has__noattribute__'a' >>> DemoDataClass.b 1.1 >>> DemoDataClass.c 'spam'The____annotations__and____doc__are__not surprising. However,there__isno__attributenamed__ain__DemoDataClassin__contrastwith__DemoNTClassfrom__Example 5-11,which__hasa__descriptorto__geta__fromthe__instancesas__read-onlyattributes__(thatmysterious__<_collections._tuplegetter>).That__sbecause__thea__attributewill__onlyexist__ininstances__of DemoDataClass.It__willbe__apublic__attributethat__wecan__getand__set,unless__theclass__is frozen.But__band__cexist__asclass__attributes,with__bholding__thedefault__valuefor__theb__instance attribute,while__cis__justa__classattribute__thatwill__notbe__boundto__the instances.Now__lets__seehow__aDemoDataClass__instancelooks__like: >>>dc__= DemoDataClass(9) >>> dc.a 9 >>> dc.b 1.1 >>> dc.c 'spam' Again,a__andb__areinstance__attributes,and__cis__aclass__attributewe__getvia__the instance.As__mentioned,DemoDataClass__instancesare__mutableand__notype__checkingis__doneat__runtime: >>> dc.a = 10 >>> dc.b = 'oops'We__cando__evensillier__assignments: >>> dc.c = 'whatever' >>> dc.z = 'secret stash'Now__thedc__instancehas__ac__attributebut__thatdoes__notchange__thec__class attribute.And__wecan__adda__newz__attribute.This__isnormal__Python behavior:regular__instancescan__havetheir__ownattributes__thatdon__tappear__inthe__class.More__about @dataclassWe__veonly__seensimple__examplesof__@dataclassuse__so far.The__decoratoraccepts__several arguments.This__isits__signature: 7 @dataclass(*, init=True, repr=True, eq=True, order=False, unsafe_hash=False, frozen=False)The__*in__thefirst__positionmeans__theremaining__parametersare__keyword- only.Table__5-2describes__them.Table__5-2.Keyword__parametersaccepted__bythe__@dataclassdecorator__optiondefault__meaningnotes__initTrue__generate__init____Ignored__if__init____isimplemented__by user.repr__Truegenerate____repr____Ignoredif____repr__is__implementedby__user.eq__Truegenerate____eq__Ignored__if__eq____isimplemented__by user.order__Falsegenerate____lt__, __le__, __gt__,__ge____Raisesexceptions__if eq=Falseor__anyof__thelisted__specialmethods__areimplemented__by user.unsafe_hash__Falsegenerate____hash____Complexsemantics__andseveral__caveats see:dataclass__documentation.frozen__Falsemake__instancesimmutable__instanceswill__bereasonably__safefrom__accidental change,but__notreally__immutable .a__@dataclassemulates__imutabilityby__generating__setattr____and__delattr____whichraise__dataclass.FrozenInstanceErrora__subclassof__AttributeErrorwhen__theuser__attemptsto__setor__deletea__field.The__defaultsare__reallythe__mostuseful__settingsfor__commonuse__cases.The__optionsyou__aremore__likelyto__changefrom__thedefaults__are: order=True:to__allowsorting__ofinstances__ofthe__data class;a__frozen=True:to__protectagainst__accidentalchanges__tothe__class instances.Given__thedynamic__natureof__Python objects,it__snot__toohard__fora__nosyprogrammer__togo__aroundthe__protectionafforded__by frozen=True.But__thenecessary__tricksshould__beeasy__tospot__ona__code review.If__eqand__frozenare__both true, @dataclasswill__producea__suitable__hash____method,so__theinstances__willbe__hashabke.The__generated__hash____willuse__datafrom__allfields__thatare__notindividually__excludedusing__afield__optionwe__llsee__in Key-sharingdictionary__.If__frozen=False (the default), @dataclasswill__set__hash____to None,signalling__thatthe__instancesare__unhashable,therefore__overriding__hash____fromany__superclass.Regarding__unsafe_hash,PEP__557has__thisto__say:Although__not recommended,you__canforce__DataClasses__tocreate__a__hash____methodwith__unsafe_hash=True.This__mightbe__thecase__ifyour__classis__logicallyimmutable__butcan__nonethelessbe__mutated.This__isa__specializeduse__caseand__shouldbe__considered carefully.I__willleave__unsafe_hashat__that.If__youfell__youmust__usethat__option,check__the dataclasses.dataclass documentation.Further__customizationof__thegenerated__dataclass__canbe__doneat__afield__level.Field__optionsWe__vealready__seenmost__basicfield__option:providing__ornot__adefault__valuewith__thetype__hint.Note__thatfields__areread__in order,and__afteryou__declarea__fieldwith__adefault__value,all__remainingfields__mustalso__havedefault__values.This__limitationmakes__sense:the__fieldswill__becomeparameters__inthe__generated __init__,and__Pythondoes__notallow__non-default__parametersfollowing__parameterswith__defaults.Mutable__defaultvalues__area__commonsource__ofbugs__forbeginning__Python developers.In__function definitions,a__mutabledefault__valueis__easilycorrupted__whenone__invocationof__thefunction__mutatesthe__default,changing__thebehavior__offurther__invocationsan__issuewe__llexplore__inMutable__Typesas__Parameter Defaults:Bad__Idea (Chapter 6).Class__atributesare__oftenused__asdefault__attributevalues__for instances,including__indata__classes.And__@dataclassuses__thedefault__valuesin__thetype__hintsto__generateparameters__withdefaults__for __init__.To__prevent bugs, @dataclassrejects__theclass__definitionin__Example 5-13.Example__5-13. dataclass/club_wrong.py:this__classraises__ValueError @dataclassclass__ClubMember: name:str__guests:list__= []If__youload__themodule__withthat__ClubMember class,this__iswhat__you get: $ python3 club_wrong.pyTraceback__(mostrecent__call last):File__"club_wrong.py",line__4,in__class ClubMember: ...severallines__ommitted... ValueError:mutable__defaultfor__fieldguests__isnot__allowed:use__default_factoryThe__ValueErrormessage__explainsthe__problemand__suggestsa__solution:use__default_factory.This__ishow__tocorrect__ClubMember:Example__5-14. dataclass/club.py:this__ClubMemberdefinition__works.from__dataclassesimport__dataclass,field__@dataclassclass__ClubMember: name:str__guests:list__= field(default_factory=list)In__theguests__fieldof__Example 5-14,instead__ofa__literal list,the__defaultvalue__isset__bycalling__the dataclasses.fieldfunction__with default_factory=list.The__default_factoryparameter__letsyou__providea__function, class,or__anyother__callable,which__willbe__invokedwith__zeroarguments__tobuild__adefault__valueeach__timean__instanceof__thedata__classis__created.This__way,each__instanceof__ClubMemberwill__haveits__ownlist__insteadof__allinstances__sharingthe__samelist__fromthe__class,which__israrely__whatwe__wantand__isoften__a bug.WARNING__Its__goodthat__@dataclassrejects__classdefinitions__witha__listdefault__valuein__a field. However,be__awarethat__itis__apartial__solutionthat__onlyapplies__to list,dict__and set.Other__mutablevalues__usedas__defaultswill__notbe__flaggedby__@dataclass.It__sup__toyou__tounderstand__theproblem__andremember__touse__adefault__factoryto__setmutable__default values.If__youbrowse__thedataclasses__module documentation,you__llsee__alist__fielddefined__witha__novel syntax,as__inExample__5-15.Example__5-15. dataclass/club_generic.py:this__ClubMemberdefinition__ismore__precisefrom__dataclassesimport__dataclass,field__fromtyping__importList__@dataclassclass__ClubMember: name:str__guests: List[str] = field(default_factory=list)Import__theList__typefrom__typing. List[str]means__alist__ofstr__.The__newsyntax__List[str]is__ageneric__type definition:the__Listclass__fromtyping__acceptsthat__bracketnotation__tospecify__thetype__ofthe__list items.We__llcover__genericsin__[Linkto__Come].For__now,note__thatboth__Example 5-14and__Example 5-15are__correct,and__theMypy__typechecker__doesnot__complainabout__eitherof__thoseclass__definitions.But__thesecond__oneis__more precise,and__willallow__thetype__checkerto__verifycode__thatputs__itemsin__the list,or__thatread__itemsfrom__it.The__default_factoryis__byfar__themost__frequentlyused__optionof__thefield__function,but__thereare__several others,listed__inTable__5-3.Table__5-3.Keyword__argumentsaccepted__bythe__fieldfunction__optiondefault__meaningdefault___MISSING_TYPEdefault__valuefor__fielddefault_factory___MISSING_TYPE 0-parameterfunction__usedto__producea__defaultinit__Trueinclude__fieldin__parametersto____init__repr__Trueinclude__field__repr____ahash__Noneuse__fieldto__compute __hash__`footnote:[ `hash=Nonemeans__thefield__willbe__usedin____hash____onlyif__compare=True.]compare__Trueuse__fieldin__comparisonmethods____eq__,__gt____ etc.metadata__Nonemapping__with user-defined data;ignored__bythe__@dataclass__a dataclass._MISSING_TYPEis__asentinel__valueindicating__theoption__wasnot__provided.It__existsso__wecan__setNone__asan__actualdefault__value,a__commonuse__case.The__defaultoption__existsbecause__thefield__calltakes__theplace__ofthe__defaultvalue__inthe__field annotation.If__youwant__tocreate__anathlete__fieldwith__defaultvalue__of False,and__alsoommit__thatfield__fromthe____repr__ method,you__dwrite__this: @dataclassclass__ClubMember: name:str__guests:list__= field(default_factory=list) athlete:bool__= field(default=False, repr=False) Post-initprocessing__The__init____methodgenerated__by @dataclassonly__takesthe__argumentspassed__andassigns__themor__theirdefault__values,if__missingto__theinstance__attributesthat__areinstance__fields.But__youmay__needto__domore__thanthat__toinitialize__the instance.If__thats__the case,you__canprovide__a__post_init____method.When__thatmethod__exists, @dataclasswill__addcode__tothe__generated__init____tocall____post_init__as__thelast__step.Common__usecases__for__post_init____arevalidation__andcomputing__fieldvalues__basedon__other fields.We__llstudy__asimple__examplethat__uses__post_init____forboth__ofthese__reasons. First,let__slook__atthe__expectedbehavior__ofa__ClubMembersubclass__named HackerClubMember,as__describedby__doctestsin__Example 5-16.Example__5-16. dataclass/hackerclub.py:doctests__forHackerClubMember__""" ``HackerClubMember``objects__acceptan__optional ``handle`` argument:: >>>anna__= HackerClubMember('Anna Ravenscroft', handle='AnnaRaven') >>>anna__HackerClubMember(name='Anna Ravenscroft', guests=[], handle='AnnaRaven')If__``handle``is__ommitted, it'sset__tothe__firstpart__ofthe__member's name:: >>>leo__= HackerClubMember('Leo Rochael') >>>leo__HackerClubMember(name='Leo Rochael', guests=[], handle='Leo')Members__musthave__aunique__handle.The__following ``leo2``will__notbe__created,because__its ``handle``would__be 'Leo',which__wastaken__by ``leo``:: >>> leo2 = HackerClubMember('Leo DaVinci')Traceback__(mostrecent__call last): ... ValueError:handle__'Leo'already__exists.To__fix, ``leo2``must__becreated__withan__explicit ``handle``:: >>> leo2 = HackerClubMember('Leo DaVinci', handle='Neo') >>> leo2 HackerClubMember(name='Leo DaVinci', guests=[], handle='Neo') """Note__thatwe__mustprovide__handleas__akeyword__argument,because__HackerClubMemberinherits__nameand__guestsfrom__ClubMember,and__addsthe__handle field.The__generateddocstring__forHackerClubMember__showsthe__orderof__thefields__inthe__constructor call: >>> HackerClubMember.__doc__ "HackerClubMember(name: str, guests:list__= , handle:str__= '')" Here,is__ashort__wayof__sayingthat__somecallable__willproduce__thedefault__valuefor__guests (inour__case,the__factoryis__thelist__class).The__point is:to__providea__handlebut__no guests,we__mustpass__handleas__akeyword__argument.The__Inheritancesection__ofthe__dataclassesmodule__documentationexplains__howthe__orderof__thefields__iscomputed__whenthere__areseveral__levelsof__inheritance.NOTE__In [Linkto__Come]we__lltalk__aboutmisusing__inheritance,particularly__whenthe__superclassesare__not abstract.Creating__ahierarchy__ofdata__classesis__usuallya__bad idea,but__itserved__uswell__hereto__makeExample__5-17 shorter,focusing__onthe__handlefield__declarationand____post_init__ validation.Example__5-17is__the implementation:Example__5-17. dataclass/hackerclub.py:code__for HackerClubMember.from__dataclassesimport__dataclassfrom__clubimport__ClubMember @dataclassclass__HackerClubMember(ClubMember):all_handles__= set() handle:str__= ''def____post_init__(self):cls__= self.__class__if__self.handle == '': self.handle = self.name.split()[0]if__self.handlein__cls.all_handles:msg__= f'handle {self.handle!r}already__exists.'raise__ValueError(msg) cls.all_handles.add(self.handle)HackerClubMember__extends ClubMember.all_handles__isa__class attribute.handle__isan__instancefield__oftype__strwith__emptystring__asits__default value;this__makesit__optional.Get__theclass__ofthe__instance.If__self.handleis__theempty__string,set__itto__thefirst__partof__name.If__self.handleis__in cls.all_handles,raise__ValueError.Add__thenew__handleto__cls.all_handles.Example__5-17works__as intended,but__isnot__satisfactoryto__astatic__type checker. Next,we__llsee__why,and__howto__fix it.Typed__classattributes__Ifwe__typecheckExample__5-17with__Mypy,we__are reprimanded: $mypy__hackerclub.py hackerclub.py:38: error:Need__typeannotation__for 'all_handles' (hint: "all_handles: Set[] = ...")Found__1error__in 1file__(checked 1source__file) Unfortunately,the__hintprovided__byMypy__(version 0.750as__Iwrite__this)is__nothelpful__inthe__contextof__@dataclass usage.If__weadd__atype__hintlike__Set[ ]to__all_handles, @dataclasswill__findthat__annotationand__makeall_handles__aninstance__field.We__sawthis__happeningin__Inspectinga__classdecorated__withdataclass__.The__work-arounddefined__inPEP__526Syntax__forVariable__Annotationsis__aclass__variable annotation,written__witha__pseudo-typenamed__typing.ClassVar,which__leveragesthe__generics []notation__toset__thetype__ofthe__variableand__alsodeclare__ita__class attribute.To__makethe__typechecker__happy,this__ishow__weare__supposedto__declareall_handles__inExample__5-17: all_handles: ClassVar[Set[str]] = set()That__typehint__is saying:all_handles__isa__classattribute__oftype__set-of-str,with__anempty__setas__itsdefault__value.To__codethat__annotation,we__mustimport__ClassVarand__Setfrom__thetyping__module.The__@dataclassdecorator__doesnt__careabout__thetypes__inthe__annotations,except__intwo__cases,and__thisis__oneof__them:if__thetype__is ClassVar,an__instancefield__willnot__begenerated__forthat__attribute.The__othercase__wherethe__typeof__thefield__isrelevant__to @dataclassis__whendeclaring__init-only variables,our__next topic.Initialization__variablesthat__arenot__fieldsSometimes__youmay__neetto__passarguments__to__init____thatare__notinstance__fields.Such__argumentsare__called init-onlyvariables__bythe__dataclasses documentation.To__declarean__argumentlike__that,dataclasses__moduleprovides__the pseudo-type InitVar,which__usesthe__samesyntax__of typing.ClassVar.The__examplegiven__inthe__documentationis__adata__classthat__hasa__fieldinitialized__froma__database,and__thedatabase__objectmust__bepassed__tothe__constructor.This__isthe__codethat__illustratesthe__Init-onlyvariables__section:Example__5-18.Example__fromthe__dataclassesmodule__documentation. @dataclassclass__C: i:int__j:int__=None__database: InitVar[DatabaseType] =None__def __post_init__(self, database):if__self.jis__Noneand__databaseis__not None: self.j = database.lookup('j')c__= C(10, database=my_database)Note__howthe__databaseattribute__is declared.InitVar__willprevent__@dataclassfrom__treatingdatabase__asa__regular field.It__willnot__beset__asan__instance attribute,and__the dataclasses.fieldsfunction__willnot__list it. However,database__willbe__oneof__thearguments__thatthe__generated__init____will accept,and__itwill__bealso__passedto____post_init__if__youwrite__that method,you__mustadd__acorresponding__argumentto__themethod__signature,as__shownin__Example 5- 18This__ratherlong__overviewof__@dataclasscovered__themost__usefulfeatures__someof__themappeared__inprevious__sections,like__Mainfeatures__wherewe__coveredall__threedata__classbuilders__in parallel.The__dataclassesdocumentation__andPEP__526Syntax__forVariable__Annotationshave__all details. @dataclass Example:Dublin__CoreResource__Record Often,classes__builtwith__@dataclasswill__havemore__fieldsthan__thevery__shortexamples__presentedso__far.Dublin__Coreprovides__thefoundation__fora__moretypical__@dataclass example.The__DublinCore__Schemais__asmall__setof__vocabularyterms__thatcan__beused__todescribe__digitalresources__(video, images,web__pages, etc.),as__wellas__physicalresources__suchas__booksor__CDs,and__objectslike__artworks.Dublin__Coreon__WikipediaThe__standarddefines__15optional__fields,the__Resourceclass__inExample__5-19uses__8of__them.Example__5-19. dataclass/resource.py:code__for Resource,a__classbased__onDublin__Core terms.from__dataclassesimport__dataclass,field__fromtyping__import List,Optional__fromenum__import Enum,auto__fromdatetime__importdate__class ResourceType(Enum):BOOK__= auto()EBOOK__= auto()VIDEO__= auto() @dataclassclass__Resource: """Mediaresource__description.""" identifier:str__title:str__= '' creators: List[str] = field(default_factory=list) date: Optional[date] =None__type:ResourceType__= ResourceType.BOOK description:str__= '' language:str__= '' subjects: List[str] = field(default_factory=list)This__Enumwill__provide type-safevalues__forthe__Resource.type field.identifier__isthe__onlyrequired__field.title__isthe__firstfield__witha__default.This__forcesall__fieldsbelow__toprovide__defaults.The__valueof__datecan__bea__datetime.date instance,or__None.The__typefield__defaultis__ResourceType.BOOK.Example__5-20is__adoctest__todemonstrate__howa__Resourcerecord__appearsin__code:Example__5-20. dataclass/resource.py:code__for Resource,a__classbased__onDublin__Core terms. >>>description__= 'Improvingthe__designof__existing code' >>>book__= Resource('978-0-13-475759-9', 'Refactoring, 2nd Edition', ... ['Martin Fowler', 'Kent Beck'], date(2018, 11, 19), ... ResourceType.BOOK, description, 'EN', ... ['computer programming', 'OOP']) >>>book__# doctest: +NORMALIZE_WHITESPACE Resource(identifier='978-0-13-475759-9', title='Refactoring, 2nd Edition', creators=['Martin Fowler', 'Kent Beck'], date=datetime.date(2018, 11, 19), type=, description='Improvingthe__designof__existing code', language='EN', subjects=['computer programming', 'OOP'])The____repr__generated__by @dataclassis__OK,but__wecan__do better.This__isthe__formatwe__wantfrom__repr(book): >>>book__# doctest: +NORMALIZE_WHITESPACE Resource(identifier__= '978-0-13-475759-9',title__= 'Refactoring, 2nd Edition',creators__= ['Martin Fowler', 'Kent Beck'],date__= datetime.date(2018, 11, 19),type__= ,description__= 'Improvingthe__designof__existing code',language__= 'EN',subjects__= ['computer programming', 'OOP'], )Example__5-21is__thecode__of__repr____toproduce__theformat__above.This__exampleuses__doctest.fieldsto__getthe__namesof__thedata__class fields.Example__5-21. dataclass/resource_repr.py:code__for__repr____methodimplemented__inthe__Resourceclass__fromExample__5-19.def____repr__(self):cls__= self.__class__cls_name__= cls.__name__indent__= ' ' * 4res__= [f'{cls_name}(']for__fin__fields(cls):value__= getattr(self, f.name) res.append(f'{indent}{f.name} = {value!r},') res.append(')')return__'\n'.join(res)Start__theres__listto__buildthe__outputstring__withthe__classname__andopen__parenthesis.For__eachfield__fin__theclass__Getthe__namedattribute__fromthe__instance.Append__anindented__linewith__thename__ofthe__fieldand__repr(value)that__swhat__the !r does.Append__closing parenthesis.Build__multilinestring__fromres__andreturn__it.With__thisexample__inspiredby__thesoul__of Dublin, Ohio,we__concludeour__tourof__Pythons__dataclass__builders.Data__classesare__handy,but__yourproject__maysuffer__ifyou__overuse them.The__nextsection__explains.Data__classas__acode__smellWhether__youimplement__adata__classwriting__allthe__codeyourself__orleveraging__oneof__theclass__buildersdescribed__inthis__chapter,be__awarethat__itmay__signala__problemin__your design.In__Refactoring,Second__Edition,Martin__Fowlerand__KentBeck__presenta__catalogof__codesmells__patternsin__codethat__mayindicate__theneed__for refactoring.The__entrytitled__DataClass__startslike__this:These__areclasses__thathave__fields,getting__andsetting__methodsfor__fields,and__nothing else.Such__classesare__dumbdata__holdersand__areoften__beingmanipulated__infar__toomuch__detailby__other classes.In__Fowlers__personalWeb__sitethere__san__illuminatingpost__explainingwhat__isa__codesmell__.That__postis__veryrelevant__toour__discussionbecause__heuses__dataclass__asone__exampleof__acode__smelland__suggestshow__todeal__with it.Here__isthe__post,reproduced__in full.8CODE__SMELLBy__MartinFowler__Acode__smellis__asurface__indicationthat__usuallycorresponds__toa__deeperproblem__inthe__system.The__termwas__firstcoined__byKent__Beckwhile__helpingme__withmy__Refactoring book.The__quickdefinition__abovecontains__acouple__ofsubtle__points.Firstly__asmell__isby__definitionsomething__thats__quickto__spotor__sniffableas__Ive__recentlyput__it.A__longmethod__isa__goodexample__ofthis__justlooking__atthe__codeand__mynose__twitchesif__Isee__morethan__adozen__linesof__Java.The__secondis__thatsmells__dont__alwaysindicate__a problem.Some__longmethods__arejust__fine.You__haveto__lookdeeper__tosee__ifthere__isan__underlyingproblem__theresmells__arent__inherentlybad__ontheir__ownthey__areoften__anindicator__ofa__problemrather__thanthe__problem themselves.The__bestsmells__aresomething__thats__easyto__spotand__mostof__timelead__youto__reallyinteresting__problems.Data__classes (classeswith__alldata__andno__behavior)are__goodexamples__of this.You__lookat__themand__askyourself__whatbehavior__shouldbe__inthis__class.Then__youstart__refactoringto__movethat__behaviorin__there.Often__simplequestions__andinitial__refactoringscan__bethe__vitalstep__inturning__anemicobjects__intosomething__thatreally__has class.One__ofthe__nicethings__aboutsmells__isthat__its__easyfor__inexperiencedpeople__tospot__them,even__ifthey__dont__knowenough__toevaluate__ifthere__sa__realproblem__orto__correct them.I__veheard__oflead__developerswho__willpick__asmell__ofthe__weekand__askpeople__tolook__forthe__smelland__bringit__upwith__thesenior__membersof__the team.Doing__itone__smellat__atime__isa__goodway__ofgradually__teachingpeople__onthe__teamto__bebetter__programmers.The__mainidea__ofObject__OrientedProgramming__isto__placebehavior__anddata__togetherin__thesame__code unit:a__class.If__aclass__iswidely__usedbut__hasno__significantbehavior__ofits__own,it__spossible__thatcode__dealingwith__itsinstances__isscattered__(andeven__duplicated)in__methodsand__functionsthroughout__thesystem__arecipe__formaintenance__headaches.That__swhy__Fowlers__refactoringsto__dealwith__adata__classinvolve__bringingresponsibilities__backinto__it.Taking__thatinto__account,there__area__coupleof__commonscenarios__whereit__makessense__tohave__adata__classwith__littleor__no behavior.Data__classas__scaffoldingIn__this scenario,the__dataclass__isan__initial,simplistic__implementationof__aclass__tojump__starta__newproject__or module.With__time,the__classshould__getits__own methods,instead__ofrelying__onmethods__ofother__classesto__operateon__its instances.Scaffolding__is temporary;eventually__yourcustom__classmay__becomefully__independentfrom__thebuilder__youused__tostart__it.Python__isalso__usedfor__quickproblem__solvingand__experimentation,and__thenit__sOK__leavethe__scaffoldingin__place.Data__classas__intermediaterepresentation__Adata__classcan__beuseful__tobuild__recordsabout__tobe__exportedto__JSONor__someother__interchange format,or__tohold__datathat__wasjust__imported,crossing__somesystem__boundary.Python__sdata__classbuilders__allprovide__amethod__orfunction__toconvert__aninstance__toa__plain dict,and__youcan__alwaysinvoke__theconstructor__witha__dictused__askeyword__argumentsexpanded__with **.Such__adict__isvery__closeto__aJSON__record.In__this scenario,the__dataclass__instancesshould__behandled__asimmutable__objectseven__ifthe__fieldsare__mutable,you__shouldnot__changethem__whilethey__arein__thisintermediate__form.If__you do,you__relosing__thekey__benefitof__havingdata__andbehavior__close together.When__importing/exportingrequires__changing values,you__shouldimplement__yourown__buildermethods__insteadof__usingthe__givenas__dictmethods__orstandard__constructors.After__reviewingPython__sdata__class builders,we__llend__thechapter__withthe__struct module,also__usedfor__importing/exporting records,but__ata__muchlower__level.Parsing__binaryrecords__withstruct__Thestruct__moduleprovides__functionsto__parsefields__ofbytes__intoa__tupleof__Python objects,and__toperform__theopposite__conversion,from__atuple__intopacked__bytes.struct__canbe__usedused__with bytes, bytearray,and__memoryview objects.Suppose__youneed__toread__abinary__filecontaining__dataabout__metropolitan areas,produced__bya__programin__Cwith__arecord__definedas__Example 5-22Example__5-22. MetroArea:a__structin__theC__language.struct__MetroArea {int__year;char__name[12];char__country[2];float__population; };Here__ishow__toread__onerecord__inthat__format,using__struct.unpack:Example__5-23.Reading__aC__structin__thePython__console. >>>from__structimport__unpack >>>FORMAT__= 'i12s2sf' >>>data__= open('metro_areas.bin', 'rb').read(24) >>>data__b"\xe2\x07\x00\x00Tokyo\x00\xc5\x05\x01\x00\x00\x00JP\x00\x00\x11X' >>> unpack(FORMAT, data) (2018, b'Tokyo\x00\xc5\x05\x01\x00\x00\x00', b'JP', 43868228.0)Note__howunpack__returnsa__tuplewith__four fields,as__specifiedby__theFORMAT__string.The__lettersand__numbersin__FORMATare__FormatCharacters__describedin__thestruct__module documentation.Table__5-4explains__theelements__ofthe__formatstring__fromExample__5-23.Table__5-4.Parts__ofthe__formatstring__'i12s2sf'.f__fg__partsize__Ctype__Pythontype__limitsto__actualcontent__i 4bytes__intint__32 bits;range__-2,147,483,648to__2,147,483,647 12s 12bytes__char[12 ]bytes__length = 12 2s 2bytes__char[2]bytes__length = 2f__4bytes__floatfloat__32-bits;approximante__range 3.4 10One__detailabout__thelayout__of metro_areas.binis__notclear__fromthe__codein__Example 5-22:size__isnot__theonly__differencebettween__thename__andcountry__fields.The__countryfield__alwaysholds__a 2-lettercountry__code,but__nameis__a null-terminatedsequence__withup__to 12bytes__includingthe__terminating b'\0'which__youcan__seein__Example 5-23right__afterthe__word Tokyo.Now__lets__reviewa__scriptto__extractall__recordsfrom__metro_areas.binand__producea__simplereport__like this: $ python3 metro_read.py 2018 Tokyo,JP__43,868,228 2015 Shanghai,CN__38,700,000 2015 Jakarta,ID__31,689,592Example__5-24showcases__thehandy__struct.iter_unpack function.Example__5-24. metro_read.py:list__allrecords__from metro_areas.binfrom__structimport__iter_unpackFORMAT__= 'i12s2sf'def__text(field: bytes) -> str: 38 9octets__= field.split(b'\0', 1)[0]return__octets.decode('cp437')with__open('metro_areas.bin', 'rb')as__fp:data__= fp.read()for__fieldsin__iter_unpack(FORMAT, data): year, name, country,pop__=fields__place = text(name) + ', ' + text(country) print(f'{year}\t{place}\t{pop:,.0f}')The__struct format.Utility__functionto__decodeand__cleanup__thebytes__fields;returns__a str.Handle__null-terminatedC__string:split__onceon__b'\0',then__takethe__first part.Decode__bytesinto__str.Open__andread__thewhole__filein__binary mode;data__isa__bytes object. iter_unpack( )returns__agenerator__thatproduces__onetuple__offields__foreach__sequenceof__bytesmatching__theformat__string.The__nameand__countryfields__needfurther__processingby__thetext__function.The__structmodule__providesno__wayto__specify null-terminatedstring__fields.When__processinga__fieldlike__namein__theexample__above,after__unpackingwe__needto__inspectthe__returnedbytes__todiscard__thefirst__b'\0'and__allbytes__afterit__inthat__field.It__isquite__possiblethat__bytesafter__thefirst__b'\0'and__upto__theend__ofthe__fieldare__garbage.You__canactually__seethat__inExample__5-23.Memory__viewscan__makeit__easierto__experimentand__debugprograms__using struct,as__thenext__section explains. 10Structs__andMemory__ViewsWe__sawin__MemoryViews__thatthe__memoryviewtype__doesnot__letyou__createor__storebyte__sequences,but__providesshared__memoryaccess__toslices__ofdata__fromother__binary sequences,packed__arrays,and__bufferssuch__asPython__ImagingLibrary__(PIL) images,without__copyingthe__bytes.Example__5-25shows__theuse__ofmemoryview__andstruct__togetherto__extractthe__widthand__heightof__aGIF__image.Example__5-25.Using__memoryviewand__structto__inspecta__GIFimage__header >>>import__struct >>>fmt__= '<3s3sHH' >>>with__open('filter.gif', 'rb')as__fp: ...img__= memoryview(fp.read()) ... >>>header__= img[:10] >>> bytes(header) b'GIF89a+\x02\xe6\x00' >>> struct.unpack(fmt, header) (b'GIF', b'89a', 555, 230) >>>del__header >>>del__imgstruct__format: < little-endian; 3s3stwo__sequencesof__3 bytes;HH__two 16-bit integers.Create__memoryviewfrom__filecontents__inmemory__thenanother__memoryviewby__slicingthe__first one;no__bytesare__copied here.Convert__tobytes__fordisplay__only; 10bytes__arecopied__here.Unpack__memoryviewinto__tuple of: type, version, width,and__height.Delete__referencesto__releasethe__memoryassociated__withthe__memoryview instances.Note__thatslicing__amemoryview__returnsa__new memoryview,without__11copying__bytes.I__willnot__godeeper__intomemoryview__orthe__struct module,but__ifyou__workwith__binary data,you__llfind__itworthwhile__tostudy__their docs: Built-in__TypesMemory__Viewsand__structInterpret__bytesas__packedbinary__data.Should__weuse__struct?I__onlyrecommend__structto__handledata__fromlegacy__systemsor__standardizedbinary__formats.Proprietary__binaryrecords__inthe__realworld__arebrittle__andcan__becorrupted__easily.Our__supersimple__exampleexposed__oneof__many caveats:a__stringfield__maybe__limitedonly__byits__sizein__bytes,it__maybe__paddedby__spaces,or__itmay__containa__null-terminatedstring__followedby__randomgarbage__upto__acertain__size.There__isalso__theproblem__of endianness:the__orderof__thebytes__usedto__representintegers__and floats,which__dependson__theCPU__architecture.If__youneed__toexchange__binarydata__amongPython__systems,the__picklemodule__isthe__easiest way,by__far.If__theexchange__involvesprograms__inother__languages,use__JSONor__a multi-platformbinary__serializationformat__likeMessagePack__orProtocol__Buffers. 12Chapter__SummaryThe__maintopic__ofthis__chapterwere__thedata__classbuilders__collections.namedtuple, typing.NamedTupleand__dataclasses.dataclass.We__sawthat__eachof__themgenerate__dataclasses__fromdescriptions__providedas__argumentsto__afactory__functionor__fromclass__statementswith__typehints__inthe__caseof__thelatter__two.In__particular,both__namedtuple__variantsproduce__tuple subclasses,adding__onlythe__abilityto__accessfields__by name,and__providinga___fieldsclass__attributelisting__thefield__namesas__atuple__of strings.Next__westudied__themain__featuresof__thethree__classbuilders__sideby__side,including__howto__extractinstance__dataas__a dict,how__toget__thenames__anddefault__valuesof__fiels,and__howto__makea__newinstance__froman__existing one.This__promptedour__firstlook__intotype__hints,particularly__thoseused__toannotate__attributesin__aclass__statement,using__thenotation__introducedin__Python 3.6with__PEP 526Syntax__forVariable__Annotations.Probably__themost__surprisingaspect__oftype__hintsin__generalis__thefact__thatthey__haveno__effectat__allat__runtime.Python__remainsa__dynamic language.External__tools,like__Mypy,are__neededto__takeadvantage__oftyping__informationdo__detecterrors__viastatic__analysisof__thesource__code.After__abasic__overviewof__thesyntax__fromPEP__526,we__studiedthe__effectof__annotationsin__aplain__classand__inclasses__builtby__typing.NamedTupleand__@dataclass.Next__wecovered__themost__commonlyused__featuresprovided__by @dataclassand__thedefault_factory__optionof__the dataclasses.field function.We__alsolooked__intothe__special pseudo-typehints__typing.ClassVarand__dataclasses.InitVarthat__areimportant__inthe__contextof__data classes.This__maintopic__concludedwith__anexample__basedon__theDublin__Core Schema,which__illustratedhow__touse__dataclassess.fieldsto__iterateover__theattributes__ofa__Resourceinstance__ina__custom __repr__.The__Dataclass__asa__codesmell__cameafter__that,warning__againstpossible__abuseof__dataclasses__defeatinga__basicprinciple__ofObject__Oriented Programming:data__andthe__functionsthat__touchit__shouldbe__togetherin__thesame__class.Classes__withno__logicmay__bea__signof__misplaced logic.The__finaltopic__wasa__briefoverview__ofthe__struct package,used__toread__andwrite__recordsencoded__aspacked__byte sequences.That__sectionended__withsuggestion__foralternative__librariesfor__binarydata__exchange,including__Pythons__pickleand__language-independend alternatives.Further__ReadingPython__sstandard__documentationfor__thedata__classbuilders__wecovered__isvery__good,and__hasquite__afew__small examples.For__@dataclassin__particular,most__ofPEP__557Data__Classeswas__copiedinto__thedataclasses__module documentaion.But__PEP 557has__afew__veryinformative__sectionsthat__werenot__copied,including__Whynot__justuse__namedtuple?,Why__notjust__use typing.NamedTuple?and__theRationale__sectionwhich__concludeswith__this Q&A:Where__isit__notappropriate__touse__Data Classes?API__compatibilitywith__tuplesor__dictsis__required.Type__validationbeyond__thatprovided__byPEPs__484and__526is__required,or__valuevalidation__orconversion__is required.Eric__V. Smith,PEP__557Rationale__Overat__RealPython.com,Geir__ArneHjelle__wrotea__verycomplete__UltimateGuide__toData__Classesin__Python 3.7.At__PyConUS__2018,Raymond__Hettingerpresented__Dataclasses:The__codegenerator__toend__allcode__generators (video).For__morefeatures__andadvanced__functionality,including__validation,the__attrsproject__ledby__HynekSchlawack__goesway__beyond dataclasses,promising__classeswithout__boilerplateand__tobring__backthe__joyof__writingclasses__byrelieving__youfrom__thedrudgery__ofimplementing__objectprotocols__(akadunder__methods).The__influenceof__attrson__@dataclassis__acknowledgedby__Eric V.Smith__inPEP__557.This__probablyincludes__Smiths__mostimportant__architectural decision:the__useof__aclass__decoratorinstead__ofinheritance__and/ora__metaclassto__dothe__job.Glyph__founderof__theTwisted__projectwrote__anexcellent__introductionto__attrsin__TheOne__PythonLibrary__Everyone Needs.The__attrsdocumentation__includesa__discussionof__alternatives.Regarding__DataClass__asa__code smell,the__bestsource__Ifound__wasMartin__Fowlers__book Refactoring,Second__Edition.This__newestversion__ismissing__thequote__fromthe__epigraphof__this chapter,Data__classesare__likechildren__,but__otherwiseit__sthe__bestedition__ofFowler__smost__famous book,particularly__forPythonistas__becausethe__examplesare__inmodern__JavaScript,which__iscloser__toPython__thanJava__thelanguage__ofthe__first edition.The__Website__RefactoringGuru__alsohas__adescription__ofthe__DataClass__code smell.For__thestruct__module,again__thePython__docsare__goodand__includesimple__examples.But__beforeusing__structyou__shouldseriously__considerwhether__its__feasibleto__usePython__sjson__or pickle,or__multi-languagebinary__serializationlibraries__suchas__MessagePackand__Protocol Buffers.SOAPBOX__Theentry__forGuido__inthe__Jargonfile__isabout__Guidovan__Rossum.It__says,among__other things: Mythically,Guido__smost__importantattribute__besidesPython__itselfis__Guidos__time machine,a__devicehe__isreputed__topossess__becauseof__theunnerving__frequencywith__whichuser__requestsfor__newfeatures__havebeen__metwith__theresponse__Ijust__implementedthat__lastnight__Forthe__longest time,one__ofthe__missingpieces__inPython__ssyntax__hasbeen__a quick,standard__wayto__declareinstance__attributesin__a class.Many__Object-Orientedlanguages__have that.Here__ispart__ofa__Pointclass__definitionin__Smalltalk:Object__subclass: #Point instanceVariableNames: 'x y' classVariableNames: '' package: 'Kernel-BasicObjects'The__secondline__liststhe__namesof__theinstance__attributesx__and y.If__therewere__class attributes,they__wouldbe__inthe__third line.Python__hasalways__offeredan__easyway__todeclare__class attributes,if__theyhave__aninitial__value.But__instanceattributes__aremuch__more common,and__Pythoncoders__havebeen__forcedto__lookinto__the__init____methodto__find them,always__afraidthat__theremay__beinstance__attributescreated__elsewherein__theclass__oreven__createdby__externalfunctions__ormethods__ofother__classes.Now__wehave__@dataclass, yay!But__theybring__theirown__problems. First:when__youuse__@dataclass,type__hintsare__not optional.We__vebeen__promisedfor__thelast__7years__sincePEP__484Type__Hintsthat__theywould__alwaysbe__optional.Now__wehave__amajor__newlanguage__featurethat__requires them.If__youdon__tlike__thewhole__statictyping__trend,you__maywant__touse__attrs instead. Second:the__PEP 526syntax__forannotating__instanceand__classattributes__reversesthe__establishedconvention__ofclass__statements:everything__declaredat__the top-levelof__aclass__blockwas__aclass__attribute (methodsare__classattributes__too).With__PEP 526and__@dataclass,any__attributedeclared__atthe__toplevel__witha__typehint__becomesan__instance attribute.If__ithas__adefault__value,then__itwill__alsobe__aclass__attribute.But__ifyou__writelimit__= 99at__the top-levelof__a dataclass,with__notype__hints,suddenly__youare__backin__therealm__wheredeclarations__atthe__top-levelof__theclass__belongto__the class. Finally,if__youwant__toannotate__thatclass__attributewith__a type,you__cant__useregular__typesbecause__thenit__willbecome__aninstance__attribute.You__mustresort__tothat__pseudo-typeClassVar__annotation: limit: ClassVar[int] = 99Here__weare__talkingabout__theexception__tothe__exceptionto__theexception__tothe__rule.This__seemsrather__unpythonicto__me.I__didnot__takepart__inthe__discussionsleading__toPEP__526or__PEP 557Data__Classes,but__hereis__analternative__syntaxthat__Id__liketo__see: @dataclassclass__HackerClubMember: .name:str__.guests:list__= field(default_factory=list) .handle:str__= ''all_handles__= set()Instance__attributesmust__bedeclared__witha__. prefix.The__dotis__notpart__ofthe__nameit__sonly__usedin__thiscontext__todenote__aninstance__attribute.Any__attributename__thatdoesn__thave__a .prefix__isa__classattribute__(asthey__alwayshave__been).The__parserwould__haveto__changeto__accept that.I__findthis__quite readable,and__itavoids__the triple- exception-to-the-rule issue.I__wishI__couldborrow__Guidos__timemachine__togo__backto__2017and__sellthis__ideado__thecore__team. 1From__Refactoring,First__Edition,chapter__3,Bad__Smellsin__Code,Data__Class section,page__87. 2Metaclasses__areone__ofthe__subjectscovered__in [Linkto__Come]Class__Metaprogramming. 3Class__decoratorsare__coveredin__[Linkto__Come]Class__Metaprogramming,along__with metaclasses.Both__areways__ofcustomizing__classbehavior__beyondwhat__ispossible__with inheritance. 4If__youknow__Ruby,you__knowthat__injectingmethods__isa__well-knownbut__controversialtechnique__among Rubyists.In__Python,it__snot__as common,because__itdoesn__twork__withany__built-intype__str, list, etc.I__considerthis__limitationof__Pythona__blessing. 5In__thecontext__oftype__hints,None__isnot__theNoneType__singleton,but__analias__forNoneType__itself.This__isstrange__whenwe__stopto__thinkabout__it,but__appealsto__ourintuition__andmakes__functionreturn__annotationseasier__toread__inthe__commoncase__offunctions__thatreturn__None. 6Python__hasno__conceptof__undefined,one__ofthe__silliestmistakes__inthe__designof__JavaScript.Thank__Guido! 7 However,almost__alwayswhen__Isee__thisin__realcode__its__abad__idea.I__oncespent__hourschasing__abug__thatwas__causedby__attributessneakily__stashedin__instances,like__contrabandacross__module borders. Also,setting__anattribute__after__init____mayhave__ahigh__memory cost,defeating__the__dict____optimizationwe__sawin__Key-sharingdictionary__. 8I__amfortunate__tohave__MartinFowler__asa__colleagueat__ThoughtWorks,so__ittook__just 20minutes__toget__his permission. 9 \0and__\x00are__twovalid__escapesequences__forthe__null character, chr(0),in__aPython__stror__bytes literal. 10This__isthe__firstexample__usingtype__hintsin__afunction__signaturein__this book.Simple__typehints__likethese__arequite__readableand__almost intuitive. 11Pillow__isPIL__smost__active fork. 12Leonardo__Rochaelone__ofthe__technicalreviewers__pointedout__thateven__lessbyte__copyingwould__happenif__Iused__themmap__moduleto__openthe__imageas__a memory-mapped file.That__moduleis__outsidethe__scopeof__this book,but__ifyou__readand__changebinary__files frequently,learning__moreabout__mmap Memory-mappedfile__supportwill__bevery__fruitful.Chapter__6.Object__References, Mutability,and__RecyclingA__NOTEFOR__EARLYRELEASE__READERSWith__EarlyRelease__ebooks,you__getbooks__intheir__earliestform__theauthor__sraw__andunedited__contentas__theywrite__soyou__cantake__advantageof__thesetechnologies__longbefore__theofficial__releaseof__these titles.This__willbe__the 6thchapter__ofthe__final book.Please__notethat__theGitHub__repowill__bemade__activelater__on.If__youhave__commentsabout__howwe__mightimprove__thecontent__and/orexamples__inthis__book,or__ifyou__noticemissing__materialwithin__this chapter,please__reachout__tothe__authorat__fluentpython2e@ramalho.org.You__are sad,the__Knightsaid__inan__anxious tone:let__mesing__youa__songto__comfort you. [ ]The__nameof__thesong__iscalled__HADDOCKSEYES__. Oh,that__sthe__nameof__the song,is__it?Alice__said,trying__tofeel__interested. No,you__dont__understand,the__Knight said,looking__alittle__vexed.That__swhat__thename__is CALLED.The__namereally__ISTHE__AGEDAGED__MAN." (adaptedfrom__Chapter VIII.It__smy__ownInvention__).Lewis__Carroll,Through__the Looking-Glass,and__WhatAlice__FoundThere__Aliceand__theKnight__setthe__toneof__whatwe__willsee__inthis__chapter.The__themeis__thedistinction__betweenobjects__andtheir__names.A__nameis__notthe__object;a__nameis__aseparate__thing.We__startthe__chapterby__presentinga__metaphorfor__variablesin__Python:variables__are labels,not__boxes.If__referencevariables__areold__newsto__you,the__analogymay__stillbe__handyif__youneed__toexplain__aliasingissues__to others.We__thendiscuss__theconcepts__ofobject__identity, value,and__aliasing.A__surprisingtrait__oftuples__is revealed:they__areimmutable__buttheir__valuesmay__change.This__leadsto__adiscussion__ofshallow__anddeep__copies.References__andfunction__parametersare__ournext__theme:the__problemwith__mutableparameter__defaultsand__thesafe__handlingof__mutablearguments__passedby__clientsof__our functions.The__lastsections__ofthe__chaptercover__garbage collection,the__del command,and__howto__useweak__referencesto__rememberobjects__withoutkeeping__them alive.This__isa__ratherdry__chapter,but__itstopics__lieat__theheart__ofmany__subtlebugs__inreal__Python programs.What__snew__inthis__chapterThe__topicscovered__hereare__veryfundamental__and stable.There__wereno__changessince__Python 3.4that__areworth__mentioningin__this 2 edition.I__addeda__anexample__ofusing__isto__testfor__asentinel__object,and__awarning__aboutmisuses__ofthe__isoperator__atthe__endof__ChoosingBetween__==and__is .This__chapterused__tobe__inPart__IV,but__Idecided__tobring__itup__earlierbecause__itworks__betteras__anending__toPart__IIData__Structuresthan__anopening__to Object-Oriented Idioms.Let__sstart__byunlearning__thata__variableis__likea__boxwhere__youstore__data.nd__VariablesAre__NotBoxes__In 1997,I__tooka__summercourse__onJava__at MIT.The__professor,Lynn__AndreaStein__an award-winningcomputer__scienceeducator__whocurrently__teachesat__OlinCollege__ofEngineering__madethe__pointthat__theusual__variablesas__boxesmetaphor__actuallyhinders__theunderstanding__ofreference__variablesin__OO languages.Python__variablesare__likereference__variablesin__Java,so__its__betterto__thinkof__themas__labelsattached__to objects.Example__6-1is__asimple__interactionthat__thevariables__asboxes__ideacannot__explain.Figure__6-1illustrates__whythe__boxmetaphor__iswrong__for Python,while__stickynotes__providea__helpfulpicture__ofhow__variablesactually__work.Example__6-1.Variables__aand__bhold__referencesto__thesame__list,not__copiesof__thelist__>>>a__= [1, 2, 3] >>>b__=a__>>> a.append(4) >>>b__[1, 2, 3, 4]Figure__6-1.If__youimagine__variablesare__like boxes,you__cant__makesense__ofassignment__in Python; instead,think__ofvariables__assticky__notesExample__6-1then__becomeseasy__toexplain__Prof.Stein__alsospoke__aboutassignment__ina__verydeliberate__way.For__example,when__talkingabout__aseesaw__objectin__a simulation,she__would say:Variable__sis__assignedto__the seesaw,but__neverThe__seesawis__assignedto__variable s.With__reference variables,it__makesmuch__moresense__tosay__thatthe__variableis__assignedto__an object,and__notthe__otherway__around.After__all,the__objectis__createdbefore__the assignment.Example__6-2proves__thatthe__righthandside__ofan__assignmenthappens__first.Example__6-2.Variables__areassigned__toobjects__onlyafter__theobjects__arecreated__>>>class__Gizmo: ...def____init__(self): ... print('Gizmo id: %d' % id(self)) ... >>>x__= Gizmo()Gizmo__id: 4301489152 >>>y__= Gizmo() * 10Gizmo__id: 4301489432Traceback__(mostrecent__call last):File__"",line__1,in__TypeError:unsupported__operand type(s)for__*: 'Gizmo'and__'int' >>> >>> dir() ['Gizmo', '__builtins__', '__doc__', '__loader__', '__name__', '__package__', '__spec__', 'x']The__outputGizmo__id: ...is__aside__effectof__creatinga__Gizmo instance.Multiplying__aGizmo__instancewill__raisean__exception.Here__isproof__thata__secondGizmo__wasactually__instantiatedbefore__themultiplication__was attempted.But__variabley__wasnever__created,because__theexception__happenedwhile__the right-handside__ofthe__assignmentwas__being evaluated.TIP__Tounderstand__anassignment__in Python,always__readthe__right-handside__first:that__swhere__theobject__iscreated__or retrieved.After__that,the__variableon__theleft__isbound__tothe__object,like__alabel__stuckto__it.Just__forgetabout__the boxes.Because__variablesare__mere labels,nothing__preventsan__objectfrom__havingseveral__labelsassigned__to it.When__that happens,you__have aliasing,our__next topic. Identity, Equality,and__AliasesLewis__Carrollis__thepen__nameof__Prof.Charles__Lutwidge Dodgson. Mr.Carroll__isnot__onlyequal__to Prof. Dodgson:they__areone__andthe__same.Example__6-3expresses__thisidea__in Python.Example__6-3.charles__andlewis__referto__thesame__object >>>charles__= {'name': 'Charles L. Dodgson', 'born': 1832} >>>lewis__=charles__>>>lewis__ischarles__True >>> id(charles), id(lewis) (4300473992, 4300473992) >>> lewis['balance'] = 950 >>>charles__{'name': 'Charles L. Dodgson', 'balance': 950, 'born': 1832}lewis__isan__aliasfor__charles.The__isoperator__andthe__idfunction__confirm it.Adding__anitem__tolewis__isthe__sameas__addingan__itemto__charles. However,suppose__animpostor__lets__callhim__Dr.Alexander__Pedachenkoclaims__heis__Charles L. Dodgson,born__in 1832.His__credentialsmay__bethe__same,but__Dr.Pedachenko__isnot__Prof. Dodgson.Figure__6-2illustrates__this scenario.Figure__6-2.charles__andlewis__arebound__tothe__same object;alex__isbound__toa__separateobject__ofequal__contentsExample__6-4implements__andtests__thealex__objectdepicted__inFigure__6-2.Example__6-4.alex__andcharles__compare equal,but__alexis__notcharles__>>>alex__= {'name': 'Charles L. Dodgson', 'born': 1832, 'balance': 950} >>>alex__==charles__True >>>alex__isnot__charlesTrue__alexrefers__toan__objectthat__isa__replicaof__theobject__assignedto__charles.The__objectscompare__equal,because__ofthe____eq__implementation__inthe__dict class.But__theyare__distinct objects.This__isthe__Pythonicway__ofwriting__thenegative__identity comparison:a__isnot__b.Example__6-3is__anexample__of aliasing.In__that code,lewis__andcharles__are aliases:two__variablesbound__tothe__same object.On__theother__hand,alex__isnot__analias__for charles:these__variablesare__boundto__distinct objects.The__objectsbound__toalex__andcharles__havethe__samevalue__thats__what ==compares__butthey__havedifferent__identities.In__ThePython__Language Reference, 3.1. Objects,values__andtypes__states:Every__objecthas__an identity,a__typeand__a value.An__objects__identitynever__changesonce__ithas__been created;you__maythink__ofit__asthe__objects__addressin__memory.The__isoperator__comparesthe__identityof__two objects;the__id()function__returnsan__integerrepresenting__its identity.The__realmeaning__ofan__objects__IDis__implementation-dependent.In__CPython, id()returns__thememory__addressof__the object,but__itmay__besomething__elsein__anotherPython__interpreter.The__keypoint__isthat__theID__isguaranteed__tobe__aunique__numeric label,and__itwill__neverchange__duringthe__lifeof__the object.In__practice,we__rarelyuse__the id()function__while programming.Identity__checksare__mostoften__donewith__theis__operator,and__notby__comparing IDs. Next,we__lltalk__aboutis__versus ==.Choosing__Between ==and__isThe__==operator__comparesthe__valuesof__objects (thedata__they hold),while__iscompares__their identities.We__oftencare__aboutvalues__andnot__identities,so__==appears__morefrequently__thanis__inPython__code. However,if__youare__comparinga__variableto__a singleton,then__itmakes__senseto__use is.By__far,the__mostcommon__caseis__checkingwhether__avariable__isbound__to None.This__isthe__recommendedway__todo__it:x__isNone__Andthe__properway__towrite__itsnegation__is:x__isnot__NoneNone__byfar__themost__commonsingleton__wetest__with is.Sentinel__objectsare__anotherexample__ofsingletons__wetest__with is.Here__ishow__youcould__createand__testa__sentinel object:END_OF_DATA__= object() # ...many__linesdef__traverse(...): # ...more__linesif__nodeis__END_OF_DATA:raise__StopIteration # etc.The__isoperator__isfaster__than ==,because__itcannot__be overloaded,so__Pythondoes__nothave__tofind__andinvoke__specialmethods__toevaluate__it,and__computingis__assimple__ascomparing__twointeger__IDs.In__contrast,a__==b__issyntactic__sugarfor__a.__eq__(b).The____eq__method__inheritedfrom__objectcompares__object IDs,so__itproduces__thesame__resultas__is.But__most built-intypes__override__eq____withmore__meaningfulimplementations__thatactually__takeinto__accountthe__valuesof__theobject__attributes.Equality__mayinvolve__alot__ofprocessing__for example,when__comparinglarge__collectionsor__deeplynested__structures.WARNING__Usuallywe__aremore__interestedin__objectequality__than identity.The__onlycommon__propercase__ofis__ischecking__for None.Most__otheruses__Isee__whilereviewing__codeare__wrong.If__youare__not sure,use__==.It__susually__whatyou__want,and__alsoworks__withNone__albeitnot__as fast.To__wrapup__thisdiscussion__ofidentity__versus equality,we__llsee__thatthe__famouslyimmutable__tupleis__notas__rigidas__youmay__expect.The__RelativeImmutability__ofTuples__Tuples,like__mostPython__collections lists, dicts, sets, etc.are__containers:they__holdreferences__to objects.If__thereferenced__itemsare__mutable,they__maychange__evenif__thetuple__itselfdoes__not.In__other words,the__immutabilityof__tuplesreally__refersto__thephysical__contentsof__thetuple__datastructure__(i.e.,the__referencesit__holds),and__doesnot__extendto__thereferenced__objects.Example__6-5illustrates__thesituation__inwhich__thevalue__ofa__tuplechanges__asresult__ofchanges__toa__mutableobject__referencedin__it.What__cannever__changein__atuple__isthe__identityof__theitems__it contains.Example__6-5. t1and__t2initially__compare equal,but__changinga__mutableitem__insidetuple__t1makes__itdifferent__>>> t1 = (1, 2, [30, 40]) >>> t2 = (1, 2, [30, 40]) >>> t1 == t2True__>>> id(t1[-1]) 4302515784 >>> t1[-1].append(99) >>> t1 (1, 2, [30, 40, 99]) >>> id(t1[-1]) 4302515784 >>> t1 == t2False__t1is__immutable,but__t1[-1]is__mutable.Build__atuple__t2whose__itemsare__equalto__thoseof__t1.Although__distinct objects, t1and__t2compare__equal,as__expected.Inspect__theidentity__ofthe__listat__t1[-1].Modify__the t1[-1]list__in place. 1The__identityof__t1[-1]has__not changed,only__its value. t1and__t2are__now different.This__relativeimmutability__oftuples__isbehind__theriddle__A +=Assignment__Puzzler .It__salso__thereason__whysome__tuplesare__unhashable,as__weve__seenin__WhatIs__Hashable? .The__distinctionbetween__equalityand__identityhas__furtherimplications__whenyou__needto__copyan__object.A__copyis__anequal__objectwith__adifferent__ID.But__ifan__objectcontains__other objects,should__thecopy__alsoduplicate__theinner__objects,or__isit__OKto__share them?There__sno__single answer.Read__onfor__a discussion.Copies__AreShallow__byDefault__Theeasiest__wayto__copya__list (ormost__built-inmutable__collections)is__touse__the built-inconstructor__forthe__type itself.For__example: >>> l1 = [3, [55, 44], (7, 8, 9)] >>> l2 = list(l1) >>> l2 [3, [55, 44], (7, 8, 9)] >>> l2 == l1True__>>> l2is__l1False__list(l1)creates__acopy__of l1.The__copiesare__equal.But__referto__twodifferent__objects.For__listsand__othermutable__sequences,the__shortcut l2 = l1[:]also__makesa__copy. However,using__theconstructor__or [:]produces__ashallow__copy (i.e.,the__outermostcontainer__is duplicated,but__thecopy__isfilled__withreferences__tothe__sameitems__heldby__theoriginal__container).This__savesmemory__andcauses__noproblems__ifall__theitems__are immutable.But__ifthere__aremutable__items,this__maylead__tounpleasant__surprises.In__Example 6-6,we__createa__shallowcopy__ofa__listcontaining__anotherlist__anda__tuple,and__thenmake__changesto__seehow__theyaffect__thereferenced__objects.TIP__Ifyou__havea__connectedcomputer__on hand,I__highlyrecommend__watchingthe__interactiveanimation__forExample__6-6at__theOnline__Python Tutor.As__Iwrite__this,direct__linkingto__aprepared__exampleat__pythontutor.comis__notworking__reliably,but__thetool__is awesome,so__takingthe__timeto__copyand__pastethe__codeis__worthwhile.Example__6-6.Making__ashallow__copyof__alist__containinganother__list;copy__andpaste__thiscode__tosee__itanimated__atthe__OnlinePython__Tutor l1 = [3, [66, 55, 44], (7, 8, 9)] l2 = list(l1) l1.append(100) l1[1].remove(55) print('l1:', l1) print('l2:', l2) l2[1] += [33, 22] l2[2] += (10, 11) print('l1:', l1) print('l2:', l2) l2is__ashallow__copyof__l1.This__stateis__depictedin__Figure 6-3.Appending__100to__l1has__noeffect__on l2.Here__weremove__55from__theinner__list l1[1].This__affects l2because__l2[1]is__boundto__thesame__listas__l1[1].For__amutable__objectlike__thelist__referredby__l2[1],the__operator +=changes__thelist__in place.This__changeis__visibleat__l1[1],which__isan__aliasfor__l2[1]. +=on__atuple__createsa__newtuple__andrebinds__thevariable__l2[2] here.This__isthe__sameas__doing l2[2] = l2[2] + (10, 11).Now__thetuples__inthe__lastposition__of l1and__l2are__nolonger__thesame__object.See__Figure 6-4.The__outputof__Example 6-6is__Example 6-7,and__thefinal__stateof__theobjects__isdepicted__inFigure__6-4.Example__6-7.Output__ofExample__6-6 l1: [3, [66, 44], (7, 8, 9), 100] l2: [3, [66, 44], (7, 8, 9)] l1: [3, [66, 44, 33, 22], (7, 8, 9), 100] l2: [3, [66, 44, 33, 22], (7, 8, 9, 10, 11)]Figure__6-3.Program__stateimmediately__afterthe__assignment l2 = list(l1)in__Example 6-6. l1and__l2refer__todistinct__lists,but__thelists__sharereferences__tothe__sameinner__listobject__[66, 55, 44]and__tuple (7, 8, 9). (Diagramgenerated__bythe__OnlinePython__Tutor.)Figure__6-4.Final__stateof__l1and__l2:they__stillshare__referencesto__thesame__list object,now__containing [66, 44, 33, 22],but__theoperation__l2[2] += (10, 11)created__anew__tuplewith__content (7, 8, 9, 10, 11),unrelated__tothe__tuple (7, 8, 9)referenced__by l1[2]. (Diagramgenerated__bythe__OnlinePython__Tutor.)It__shouldbe__clearnow__thatshallow__copiesare__easyto__make,but__theymay__ormay__notbe__whatyou__want.How__tomake__deepcopies__isour__next topic.Deep__andShallow__Copiesof__ArbitraryObjects__Workingwith__shallowcopies__isnot__alwaysa__problem,but__sometimesyou__needto__makedeep__copies (i.e.,duplicates__thatdo__notshare__referencesof__embedded objects).The__copymodule__providesthe__deepcopyand__copyfunctions__thatreturn__deepand__shallowcopies__ofarbitrary__objects.To__illustratethe__useof__copy()and__deepcopy(),Example__6-8defines__asimple__class, Bus,representing__aschool__busthat__isloaded__withpassengers__andthen__picksup__ordrops__offpassengers__onits__route.Example__6-8.Bus__picksup__anddrops__offpassengers__class Bus:def____init__(self, passengers=None):if__passengersis__None: self.passengers = [] else: self.passengers = list(passengers)def__pick(self, name): self.passengers.append(name)def__drop(self, name): self.passengers.remove(name)Now__inthe__interactiveExample__6-9we__willcreate__abus__object (bus1)and__twoclones__ashallow__copy (bus2)and__adeep__copy (bus3)to__observewhat__happensas__bus1drops__offa__student.Example__6-9.Effects__ofusing__copyversus__deepcopy >>>import__copy >>> bus1 = Bus(['Alice', 'Bill', 'Claire', 'David']) >>> bus2 = copy.copy(bus1) >>> bus3 = copy.deepcopy(bus1) >>> id(bus1), id(bus2), id(bus3) (4301498296, 4301499416, 4301499752) >>> bus1.drop('Bill') >>> bus2.passengers ['Alice', 'Claire', 'David'] >>> id(bus1.passengers), id(bus2.passengers), id(bus3.passengers) (4302658568, 4302658568, 4302657800) >>> bus3.passengers ['Alice', 'Bill', 'Claire', 'David']Using__copyand__deepcopy,we__createthree__distinctBus__instances.After__bus1drops__'Bill',he__isalso__missingfrom__bus2.Inspection__ofthe__passengersatributes__showsthat__bus1and__bus2share__thesame__list object,because__bus2is__ashallow__copyof__bus1. bus3is__adeep__copyof__bus1,so__itspassengers__attributerefers__toanother__list.Note__thatmaking__deepcopies__isnot__asimple__matterin__thegeneral__case.Objects__mayhave__cyclicreferences__thatwould__causea__nave__algorithmto__enteran__infinite loop.The__deepcopyfunction__remembersthe__objectsalready__copiedto__handlecyclic__references gracefully.This__isdemonstrated__inExample__6-10.Example__6-10.Cyclic__references:b__refersto__a,and__thenis__appendedto__a;deepcopy__stillmanages__tocopy__a >>>a__= [10, 20] >>>b__= [a, 30] >>> a.append(b) >>>a__[10, 20, [[...], 30]] >>>from__copyimport__deepcopy >>>c__= deepcopy(a) >>>c__[10, 20, [[...], 30]] Also,a__deepcopy__maybe__toodeep__insome__cases.For__example,objects__mayrefer__toexternal__resourcesor__singletonsthat__shouldnot__be copied.You__cancontrol__thebehavior__ofboth__copyand__deepcopyby__implementingthe____copy__()and____deepcopy__()special__methodsas__describedin__thecopy__module documentation.The__sharingof__objectsthrough__aliasesalso__explainshow__parameterpassing__worksin__Python,and__theproblem__ofusing__mutabletypes__asparameter__defaults.These__issueswill__becovered__next.Function__Parametersas__ReferencesThe__onlymode__ofparameter__passingin__Pythonis__callby__sharing.That__isthe__samemode__usedin__mostOO__languages,including__Ruby, Smalltalk,and__Java (thisapplies__toJava__reference types;primitive__typesuse__callby__value).Call__bysharing__meansthat__eachformal__parameterof__thefunction__getsa__copyof__eachreference__inthe__arguments.In__other words,the__parametersinside__thefunction__becomealiases__ofthe__actual arguments.The__resultof__thisscheme__isthat__afunction__maychange__anymutable__objectpassed__asa__parameter,but__itcannot__changethe__identityof__thoseobjects__(i.e.,it__cannotaltogether__replacean__objectwith__another).Example__6-11shows__asimple__functionusing__+=on__oneof__its parameters.As__wepass__numbers, lists,and__tuplesto__the function,the__actualarguments__passedare__affectedin__different ways.Example__6-11.A__functionmay__changeany__mutableobject__itreceives__>>>def__f(a, b): ...a__+=b__...return__a ... >>>x__= 1 >>>y__= 2 >>> f(x, y) 3 >>> x,y__(1, 2) >>>a__= [1, 2] >>>b__= [3, 4] >>> f(a, b) [1, 2, 3, 4] >>> a,b__([1, 2, 3, 4], [3, 4]) >>>t__= (10, 20) >>>u__= (30, 40) >>> f(t, u) (10, 20, 30, 40) >>> t,u__((10, 20), (30, 40))The__numberx__is unchanged.The__lista__is changed.The__tuplet__is unchanged.Another__issuerelated__tofunction__parametersis__theuse__ofmutable__valuesfor__defaults,as__discussed next.Mutable__Typesas__Parameter Defaults:Bad__IdeaOptional__parameterswith__defaultvalues__area__greatfeature__ofPython__function definitions,allowing__ourAPIs__toevolve__whileremaining__backward-compatible. However,you__shouldavoid__mutableobjects__asdefault__valuesfor__parameters.To__illustratethis__point,in__Example 6-12,we__takethe__Busclass__fromExample__6-8and__changeits____init__method__tocreate__HauntedBus.Here__wetried__tobe__cleverand__insteadof__havinga__defaultvalue__of passengers=None,we__have passengers=[],thus__avoidingthe__ifin__theprevious____init__.This__clevernessgets__usinto__trouble.Example__6-12.A__simpleclass__toillustrate__thedanger__ofa__mutabledefault__class HauntedBus: """Abus__modelhaunted__byghost__passengers"""def____init__(self, passengers=[]): self.passengers =passengers__def pick(self, name): self.passengers.append(name)def__drop(self, name): self.passengers.remove(name)When__thepassengers__argumentis__not passed,this__parameteris__boundto__thedefault__list object,which__isinitially__empty.This__assignmentmakes__self.passengersan__aliasfor__passengers,which__isitself__analias__forthe__default list,when__nopassengers__argumentis__given.When__themethods__.remove()and__.append()are__usedwith__self.passengerswe__areactually__mutatingthe__default list,which__isan__attributeof__thefunction__object.Example__6-13shows__theeerie__behaviorof__the HauntedBus.Example__6-13.Buses__hauntedby__ghostpassengers__>>> bus1 = HauntedBus(['Alice', 'Bill']) >>> bus1.passengers ['Alice', 'Bill'] >>> bus1.pick('Charlie') >>> bus1.drop('Alice') >>> bus1.passengers ['Bill', 'Charlie'] >>> bus2 = HauntedBus() >>> bus2.pick('Carrie') >>> bus2.passengers ['Carrie'] >>> bus3 = HauntedBus() >>> bus3.passengers ['Carrie'] >>> bus3.pick('Dave') >>> bus2.passengers ['Carrie', 'Dave'] >>> bus2.passengersis__bus3.passengersTrue__>>> bus1.passengers ['Bill', 'Charlie']So__far,so__good:no__surpriseswith__bus1. bus2starts__empty,so__thedefault__emptylist__isassigned__to self.passengers. bus3also__starts empty,again__thedefault__listis__assigned.The__defaultis__nolonger__empty!Now__Dave,picked__by bus3,appears__in bus2.The__problem: bus2.passengersand__bus3.passengersrefer__tothe__same list.But__bus1.passengersis__adistinct__list.The__problemis__thatHauntedBus__instancesthat__dont__getan__initialpassenger__listend__upsharing__thesame__passengerlist__among themselves.Such__bugsmay__be subtle.As__Example 6-13 demonstrates,when__aHauntedBus__isinstantiated__with passengers,it__worksas__expected.Strange__thingshappen__onlywhen__aHauntedBus__starts empty,because__then self.passengersbecomes__analias__forthe__defaultvalue__ofthe__passengers parameter.The__problemis__thateach__defaultvalue__isevaluated__whenthe__functionis__defined i.e.,usually__whenthe__moduleis__loadedand__thedefault__valuesbecome__attributesof__thefunction__object.So__ifa__defaultvalue__isa__mutable object,and__youchange__it,the__changewill__affectevery__futurecall__ofthe__function.After__runningthe__linesin__Example 6-13,you__caninspect__the HauntedBus.__init__object__andsee__theghost__studentshaunting__its__defaults____attribute: >>> dir(HauntedBus.__init__) # doctest: +ELLIPSIS ['__annotations__', '__call__', ..., '__defaults__', ...] >>> HauntedBus.__init__.__defaults__ (['Carrie', 'Dave'],) Finally,we__canverify__that bus2.passengersis__analias__boundto__thefirst__elementof__the HauntedBus.__init__.__defaults__ attribute: >>> HauntedBus.__init__.__defaults__[0]is__bus2.passengersTrue__Theissue__withmutable__defaultsexplains__whyNone__isoften__usedas__thedefault__valuefor__parametersthat__mayreceive__mutable values.In__Example 6-8,__init____checkswhether__thepassengers__argumentis__None,and__assignsa__newempty__listto__self.passengers.As__explainedin__thefollowing__section,if__passengersis__not None,the__correctimplementation__assignsa__copyof__itto__self.passengers.Let__snow__takea__closer look.Defensive__Programmingwith__MutableParameters__Whenyou__arecoding__afunction__thatreceives__amutable__parameter,you__shouldcarefully__considerwhether__thecaller__expectsthe__argumentpassed__tobe__changed.For__example,if__yourfunction__receivesa__dictand__needsto__modifyit__whileprocessing__it,should__thisside__effectbe__visibleoutside__ofthe__functionor__not?Actually__itdepends__onthe__context.It__sreally__amatter__ofaligning__theexpectation__ofthe__coderof__thefunction__andthat__ofthe__caller.The__lastbus__examplein__thischapter__showshow__aTwilightBus__breaksexpectations__bysharing__itspassenger__listwith__its clients.Before__studyingthe__implementation,see__inExample__6-14how__theTwilightBus__classworks__fromthe__perspectiveof__aclient__ofthe__class.Example__6-14.Passengers__disappearwhen__droppedby__aTwilightBus__>>>basketball_team__= ['Sue', 'Tina', 'Maya', 'Diana', 'Pat'] >>>bus__= TwilightBus(basketball_team) >>> bus.drop('Tina') >>> bus.drop('Pat') >>>basketball_team__['Sue', 'Maya', 'Diana']basketball_team__holdsfive__student names.A__TwilightBusis__loadedwith__the team.The__busdrops__one student,then__another.The__droppedpassengers__vanishedfrom__thebasketball__team!TwilightBus__violatesthe__Principleof__least astonishment,a__bestpractice__ofinterface__design.It__surelyis__astonishingthat__whenthe__busdrops__a student,her__nameis__removedfrom__thebasketball__team roster.Example__6-15is__theimplementation__TwilightBusand__anexplanation__ofthe__problem.Example__6-15.A__simpleclass__toshow__theperils__ofmutating__receivedarguments__class TwilightBus: """Abus__modelthat__makespassengers__vanish"""def____init__(self, passengers=None):if__passengersis__None: self.passengers = [] else: self.passengers =passengers__def pick(self, name): self.passengers.append(name)def__drop(self, name): self.passengers.remove(name)Here__weare__carefulto__createa__newempty__listwhen__passengersis__None. However,this__assignmentmakes__self.passengersan__aliasfor__passengers,which__isitself__analias__forthe__actualargument__passedto____init__ (i.e.,basketball_teamin__Example 6-14).When__themethods__.remove()and__.append()are__usedwith__self.passengers,we__areactually__mutatingthe__originallist__receivedas__argumentto__the constructor.The__problemhere__isthat__thebus__isaliasing__thelist__thatis__passedto__the constructor. Instead,it__shouldkeep__itsown__passenger list.The__fixis__simple:in____init__,when__thepassengers__parameteris__provided, self.passengersshould__beinitialized__witha__copyof__it,as__wedid__correctlyin__Example 6-8 (Deep__andShallow__Copiesof__ArbitraryObjects__):def____init__(self, passengers=None):if__passengersis__None: self.passengers = [] else: self.passengers = list(passengers)Make__acopy__ofthe__passengers list,or__convertit__toa__listif__its__not one.Now__ourinternal__handlingof__thepassenger__listwill__notaffect__theargument__usedto__initializethe__bus.As__a bonus,this__solutionis__more flexible:now__theargument__passedto__thepassengers__parametermay__bea__tupleor__anyother__iterable,like__aset__oreven__database results,because__thelist__constructoraccepts__any iterable.As__wecreate__ourown__listto__manage,we__ensurethat__itsupports__thenecessary__.remove()and__.append()operations__weuse__inthe__.pick()and__.drop() methods.TIP__Unlessa__methodis__explicitlyintended__tomutate__anobject__receivedas__argument,you__shouldthink__twicebefore__aliasingthe__argumentobject__bysimply__assigningit__toan__instancevariable__inyour__class.If__in doubt,make__a copy.Your__clientswill__oftenbe__happier.del__andGarbage__CollectionObjects__arenever__explicitly destroyed; however,when__theybecome__unreachablethey__maybe__garbage-collected.Data__Model,chapter__ofThe__PythonLanguage__ReferenceThe__delstatement__deletes names,not__objects.An__objectmay__begarbage__collectedas__resultof__adel__command,but__onlyif__thevariable__deletedholds__thelast__referenceto__the object,or__ifthe__objectbecomes__unreachable.Rebinding__avariable__mayalso__causethe__numberof__referencesto__anobject__toreach__zero,causing__its destruction.WARNING__Thereis__a__del____special method,but__itdoes__notcause__thedisposal__ofthe__instance,and__shouldnot__becalled__byyour__code.__del____isinvoked__bythe__Pythoninterpreter__whenthe__instanceis__aboutto__bedestroyed__togive__ita__chanceto__releaseexternal__resources.You__willseldom__needto__implement__del____inyour__own code,yet__somePython__beginnersspend__timecoding__itfor__nogood__reason.The__properuse__of__del____israther__tricky.See__the__del____specialmethod__documentationin__theData__Modelchapter__ofThe__PythonLanguage__Reference.In__CPython,the__primaryalgorithm__forgarbage__collectionis__reference counting. Essentially,each__objectkeeps__countof__howmany__referencespoint__to it.As__soonas__thatrefcount__reaches zero,the__objectis__immediately destroyed:CPython__callsthe____del__method__onthe__object (if defined)and__thenfrees__thememory__allocatedto__the object.In__CPython 2.0,a__generationalgarbage__collectionalgorithm__wasadded__todetect__groupsof__objectsinvolved__inreference__cycleswhich__maybe__unreachableeven__withoutstanding__referencesto__them,when__allthe__mutualreferences__arecontained__withinthe__group.Other__implementationsof__Pythonhave__moresophisticated__garbagecollectors__thatdo__notrely__onreference__counting,which__meansthe____del__method__maynot__becalled__immediatelywhen__thereare__nomore__referencesto__the object.See__PyPy,Garbage__Collection, 2and__aDeadlock__by A.Jesse__JiryuDavis__fordiscussion__ofimproper__andproper__useof____del__.To__demonstratethe__endof__anobject__s life,Example__6-16uses__weakref.finalizeto__registera__callbackfunction__tobe__calledwhen__anobject__is destroyed.Example__6-16.Watching__theend__ofan__objectwhen__nomore__referencespoint__toit__>>>import__weakref >>> s1 = {1, 2, 3} >>> s2 = s1 >>>def__bye(): ... print('Gonewith__the wind...') ... >>>ender__= weakref.finalize(s1, bye) >>> ender.aliveTrue__>>>del__s1 >>> ender.aliveTrue__>>> s2 = 'spam'Gone__withthe__wind... >>> ender.aliveFalse__s1and__s2are__aliasesreferring__tothe__same set, {1, 2, 3}.This__functionmust__notbe__abound__methodof__theobject__aboutto__bedestroyed__orotherwise__holda__referenceto__it.Register__thebye__callbackon__theobject__referredby__s1.The__.aliveattribute__isTrue__beforethe__finalizeobject__is called.As__discussed,del__doesnot__deletean__object,just__areference__to it.Rebinding__thelast__reference, s2,makes__{1, 2, 3} unreachable.It__is destroyed,the__byecallback__is invoked,and__ender.alivebecomes__False.The__pointof__Example 6-16is__tomake__explicitthat__deldoes__notdelete__objects,but__objectsmay__bedeleted__asa__consequenceof__beingunreachable__afterdel__is used.You__maybe__wonderingwhy__the {1, 2, 3}object__wasdestroyed__inExample__6-16.After__all,the__s1reference__waspassed__tothe__finalize function,which__musthave__heldon__toit__inorder__tomonitor__theobject__andinvoke__the callback.This__worksbecause__finalizeholds__aweak__referenceto__{1, 2, 3},as__explainedin__thenext__section.Weak__ReferencesThe__presenceof__referencesis__whatkeeps__anobject__alivein__memory.When__thereference__countof__anobject__reaches zero,the__garbagecollector__disposesof__it.But__sometimesit__isuseful__tohave__areference__toan__objectthat__doesnot__keepit__aroundlonger__than necessary.A__commonuse__caseis__a cache.Weak__referencesto__anobject__donot__increaseits__reference count.The__objectthat__isthe__targetof__areference__iscalled__the referent. Therefore,we__saythat__aweak__referencedoes__notprevent__thereferent__frombeing__garbage collected.Weak__referencesare__usefulin__cachingapplications__becauseyou__dont__wantthe__cachedobjects__tobe__keptalive__justbecause__theyare__referencedby__the cache.Example__6-17shows__howa__weakref.refinstance__canbe__calledto__reachits__referent.If__theobject__is alive,calling__theweak__referencereturns__it,otherwise__Noneis__returned.TIP__Example 6-17is__aconsole__session,and__thePython__consoleautomatically__bindsthe___variable__tothe__resultof__expressionsthat__arenot__None.This__interferedwith__myintended__demonstrationbut__alsohighlights__apractical__matter:when__tryingto__micro-manage__memorywe__areoften__surprisedby__hidden,implicit__assignmentsthat__createnew__referencesto__our objects.The___console__variableis__one example.Traceback__objectsare__anothercommon__sourceof__unexpected references.Example__6-17.A__weakreference__isa__callablethat__returnsthe__referencedobject__orNone__ifthe__referentis__nomore__>>>import__weakref >>>a_set__= {0, 1} >>>wref__= weakref.ref(a_set) >>>wref__>>> wref() {0, 1} >>>a_set__= {2, 3, 4} >>> wref() {0, 1} >>> wref()is__NoneFalse__>>> wref()is__NoneTrue__Thewref__weakreference__objectis__createdand__inspectedin__thenext__line.Invoking__wref()returns__thereferenced__object, {0, 1}.Because__thisis__aconsole__session,the__result {0, 1}is__boundto__the___variable.a_set__nolonger__refersto__the {0, 1} set,so__itsreference__countis__decreased.But__the___variablestill__refersto__it.Calling__wref()still__returns {0, 1}.When__thisexpression__is evaluated, {0, 1} lives,therefore__wref()is__not None.But___is__thenbound__tothe__resulting value, False.Now__thereare__nomore__strongreferences__to {0, 1}.Because__the {0, 1}object__isnow__gone,this__lastcall__to wref()returns__None.The__weakrefmodule__documentationmakes__thepoint__thatthe__weakref.refclass__isactually__a low-levelinterface__intendedfor__advanced uses,and__thatmost__programsare__betterserved__bythe__useof__theweakref__collectionsand__finalize.In__other words,consider__using WeakKeyDictionary, WeakValueDictionary, WeakSet,and__finalize (whichuse__weakreferences__internally)instead__ofcreating__andhandling__yourown__weakref.refinstances__by hand.We__justdid__thatin__Example 6-17in__thehope__thatshowing__asingle__weakref.refin__actioncould__takeaway__someof__themystery__around them.But__in practice,most__ofthe__timePython__programsuse__theweakref__collections.The__nextsubsection__brieflydiscusses__theweakref__collections.The__WeakValueDictionarySkit__Theclass__WeakValueDictionaryimplements__amutable__mappingwhere__thevalues__areweak__referencesto__objects.When__areferred__objectis__garbagecollected__elsewherein__the program,the__correspondingkey__isautomatically__removedfrom__WeakValueDictionary.This__iscommonly__usedfor__caching.Our__demonstrationof__aWeakValueDictionary__isinspired__bythe__classicCheese__Shopskit__byMonty__Python,in__whicha__customerasks__formore__than 40kinds__of cheese,including__cheddarand__mozzarella,but__noneare__in stock.Example__6-18implements__atrivial__classto__representeach__kindof__cheese. 3Example__6-18.Cheese__hasa__kindattribute__anda__standardrepresentation__class Cheese:def____init__(self, kind): self.kind =kind__def __repr__(self):return__'Cheese(%r)' % self.kindIn__Example 6-19,each__cheeseis__loadedfrom__acatalog__toa__stockimplemented__asa__WeakValueDictionary. However,all__butone__disappearfrom__thestock__assoon__asthe__catalogis__deleted.Can__youexplain__whythe__Parmesancheese__lastslonger__thanthe__others?The__tipafter__thecode__hasthe__answer.Example__6-19. Customer:Have__youin__factgot__anycheese__hereat__all? >>>import__weakref >>>stock__= weakref.WeakValueDictionary() >>>catalog__= [Cheese('Red Leicester'), Cheese('Tilsit'), ... Cheese('Brie'), Cheese('Parmesan')] ... >>>for__cheesein__catalog: ... stock[cheese.kind] =cheese__... >>> sorted(stock.keys()) ['Brie', 'Parmesan', 'Red Leicester', 'Tilsit'] >>>del__catalog >>> sorted(stock.keys()) ['Parmesan'] >>>del__cheese >>> sorted(stock.keys()) []stock__isa__WeakValueDictionary.The__stockmaps__thename__ofthe__cheeseto__aweak__referenceto__thecheese__instancein__the catalog.The__stockis__complete.After__thecatalog__is deleted,most__cheesesare__gonefrom__the 4 stock,as__expectedin__WeakValueDictionary.Why__not all,in__this case?TIP__Atemporary__variablemay__causean__objectto__lastlonger__thanexpected__byholding__areference__to it.This__isusually__nota__problemwith__local variables:they__aredestroyed__whenthe__function returns.But__inExample__6-19,the__forloop__variablecheese__isa__globalvariable__andwill__nevergo__awayunless__explicitly deleted.A__counterpartto__theWeakValueDictionary__isthe__WeakKeyDictionaryin__whichthe__keysare__weak references.The__weakref.WeakKeyDictionarydocumentation__hintson__possible uses: [A WeakKeyDictionary]can__beused__toassociate__additionaldata__withan__objectowned__byother__partsof__anapplication__withoutadding__attributesto__those objects.This__canbe__especiallyuseful__withobjects__thatoverride__attribute accesses.The__weakrefmodule__alsoprovides__a WeakSet,simply__describedin__thedocs__asSet__classthat__keepsweak__referencesto__its elements.An__elementwill__bediscarded__whenno__strongreference__toit__existsany__more.If__youneed__tobuild__aclass__thatis__awareof__everyone__ofits__instances,a__goodsolution__isto__createa__classattribute__witha__WeakSetto__holdthe__referencesto__the instances. Otherwise,if__aregular__setwas__used,the__instanceswould__neverbe__garbage collected,because__theclass__itselfwould__havestrong__referencesto__them,and__classeslive__aslong__asthe__Pythonprocess__unlessyou__deliberatelydelete__them.These__collections,and__weakreferences__in general,are__limitedin__thekinds__ofobjects__theycan__handle.The__nextsection__explains.Limitations__ofWeak__ReferencesNot__everyPython__objectmay__bethe__target,or__referent,of__aweak__reference.Basic__listand__dictinstances__maynot__be referents,but__aplain__subclassof__eithercan__solvethis__problem easily:class__MyList(list): """listsubclass__whoseinstances__maybe__weakly referenced"""a_list__= MyList(range(10)) #a_list__canbe__thetarget__ofa__weakreference__wref_to_a_list = weakref.ref(a_list)A__setinstance__canbe__a referent,and__thats__whya__setwas__usedin__Example 6-17. User-definedtypes__alsopose__no problem,which__explainswhy__thesilly__Cheeseclass__wasneeded__inExample__6-19.But__intand__tupleinstances__cannotbe__targetsof__weak references,even__ifsubclasses__ofthose__typesare__created.Most__ofthese__limitationsare__implementationdetails__ofCPython__thatmay__notapply__toother__Python interpreters.They__arethe__resultof__internal optimizations,some__ofwhich__arediscussed__inthe__following (highly optional) section.Tricks__PythonPlays__withImmutables__NOTEThis__optionalsection__discussessome__Pythondetails__thatare__notreally__importantfor__usersof__Python,and__thatmay__notapply__toother__Pythonimplementations__oreven__futureversions__of CPython. Nevertheless,I__veseen__peoplestumble__uponthese__cornercases__andthen__startusing__theis__operator incorrectly,so__Ifelt__theywere__worth mentioning.I__wassurprised__tolearn__that,for__atuple__t, t[:]does__notmake__a copy,but__returnsa__referenceto__thesame__object.You__alsoget__areference__tothe__sametuple__ifyou__write tuple(t).Example__6-20proves__it.Example__6-20.A__tuplebuilt__fromanother__isactually__thesame__exacttuple__>>> t1 = (1, 2, 3) >>> t2 = tuple(t1) >>> t2is__t1True__>>> t3 = t1[:] >>> t3is__t1True__t1and__t2are__boundto__thesame__object.And__sois__t3.The__samebehavior__canbe__observedwith__instancesof__str, bytes,and__frozenset.Note__thata__frozensetis__nota__sequence,so__fs[:]does__notwork__iffs__isa__frozenset.But__fs.copy()has__thesame__effect:it__cheatsand__returnsa__referenceto__thesame__object,and__nota__copyat__all,as__Example 6-21 shows.Example__6-21.String__literalsmay__createshared__objects >>> t1 = (1, 2, 3) >>> t3 = (1, 2, 3) >>> t3is__t1False__>>> s1 = 'ABC' >>> s2 = 'ABC' >>> s2is__s1True__5 6Creating__anew__tuplefrom__scratch. t1and__t3are__equal,but__notthe__same object.Creating__asecond__strfrom__scratch. Surprise:a__andb__referto__thesame__str!The__sharingof__stringliterals__isan__optimizationtechnique__called interning.CPython__usesthe__sametechnique__withsmall__integersto__avoidunnecessary__duplicationof__numbersthat__appearfrequently__inprograms__like 0, 1, 1, etc.Note__thatCPython__doesnot__internall__stringsor__integers,and__thecriteria__ituses__todo__sois__anundocumented__implementation detail.WARNING__Neverdepend__onstr__orint__interning!Always__use ==and__notis__tocompare__themfor__equality.Interning__isan__optimizationfor__internaluse__ofthe__Python interpreter.The__tricksdiscussed__inthis__section,including__thebehavior__of frozenset.copy(),are__harmlesslies__;they__savememory__andmake__theinterpreter__faster.Do__notworry__about them,they__shouldnot__giveyou__anytrouble__becausethey__onlyapply__toimmutable__types.Probably__thebest__useof__thesebits__oftrivia__isto__winbets__withfellow__Pythonistas.Chapter__SummaryEvery__Pythonobject__hasan__identity,a__type,and__a value.Only__thevalue__ofan__objectchanges__over time.If__twovariables__referto__immutableobjects__thathave__equalvalues__(a ==b__is True),in__practiceit__rarelymatters__ifthey__referto__copiesor__arealiases__referringto__thesame__objectbecause__thevalue__ofan__immutableobject__doesnot__change,with__one exception.The__exceptionis__immutablecollections__suchas__tuplesand__frozensets:if__animmutable__collectionholds__referencesto__mutable items,then__itsvalue__mayactually__changewhen__thevalue__ofa__mutableitem__changes.In__practice,this__scenariois__notso__common.What__neverchanges__inan__immutablecollection__arethe__identitiesof__theobjects__within.The__factthat__variableshold__referenceshas__manypractical__consequencesin__Python programming:Simple__assignmentdoes__notcreate__copies.Augmented__assignmentwith__+=or__*=creates__newobjects__ifthe__lefthandvariable__isbound__toan__immutable object,but__maymodify__amutable__objectin__place.Assigning__anew__valueto__anexisting__variabledoes__notchange__theobject__previouslybound__to it.This__iscalled__a rebinding:the__variableis__nowbound__toa__different object.If__thatvariable__wasthe__lastreference__tothe__previous object,that__objectwill__begarbage__collected.Function__parametersare__passedas__aliases,which__meansthe__functionmay__changeany__mutableobject__receivedas__an argument. 7There__isno__wayto__prevent this,except__makinglocal__copiesor__usingimmutable__objects (e.g.,passing__atuple__insteadof__a list).Using__mutableobjects__asdefault__valuesfor__functionparameters__isdangerous__becauseif__theparameters__arechanged__in place,then__thedefault__is changed,affecting__everyfuture__callthat__relieson__the default.In__CPython,objects__arediscarded__assoon__asthe__numberof__referencesto__themreaches__zero.They__mayalso__bediscarded__ifthey__formgroups__withcyclic__referencesbut__nooutside__references.In__some situations,it__maybe__usefulto__holda__referenceto__anobject__thatwill__notby__itselfkeep__anobject__alive.One__exampleis__aclass__thatwants__tokeep__trackof__allits__current instances.This__canbe__donewith__weak references,a__low-levelmechanism__underlyingthe__moreuseful__collections WeakValueDictionary, WeakKeyDictionary, WeakSet,and__thefinalize__functionfrom__theweakref__module.Further__ReadingThe__DataModel__chapterof__ThePython__LanguageReference__startswith__aclear__explanationof__objectidentities__and values.Wesley__Chun,author__ofthe__CorePython__seriesof__books,made__agreat__presentationabout__manyof__thetopics__coveredin__thischapter__duringOSCON__2013.You__candownload__theslides__fromthe__Python 103:Memory__Model &Best__Practicestalk__page.There__isalso__aYouTube__videoof__alonger__presentationWesley__gaveat__EuroPython 2011,covering__notonly__thetheme__ofthis__chapterbut__alsothe__useof__special methods.Doug__Hellmannwrote__along__seriesof__excellentblog__poststitled__PythonModule__ofthe__Week,which__becamea__book,The__PythonStandard__Libraryby__Example.His__postscopy__DuplicateObjects__andweakref__Garbage-CollectableReferences__toObjects__coversome__ofthe__topicswe__just discussed.More__informationon__theCPython__generationalgarbage__collectorcan__befound__inthe__gcmodule__documentation,which__startswith__thesentence__Thismodule__providesan__interfaceto__theoptional__garbage collector.The__optionalqualifier__heremay__be surprising,but__theData__Modelchapter__also states:An__implementationis__allowedto__postponegarbage__collectionor__omitit__altogetherit__isa__matterof__implementationquality__howgarbage__collectionis__implemented,as__longas__noobjects__arecollected__thatare__still reachable.Fredrik__Lundhcreator__ofkey__librarieslike__ElementTree, Tkinter,and__thePIL__imagelibrary__hasa__shortpost__aboutthe__Pythongarbage__collectortitled__HowDoes__PythonManage__Memory?He__emphasizesthat__thegarbage__collectoris__animplementation__featurethat__behavesdifferently__acrossPython__interpreters.For__example,Jython__usesthe__Javagarbage__collector.The__CPython 3.4garbage__collectorimproved__handlingof__objectswith__a__del____method,as__describedin__PEP 442Safe__object finalization.Wikipedia__hasan__articleabout__string interning,mentioning__theuse__ofthis__techniquein__several languages,including__Python.SOAPBOX__EqualTreatment__toAll__ObjectsI__learnedJava__beforeI__discovered Python.The__==operator__inJava__neverfelt__rightfor__me.It__ismuch__morecommon__forprogrammers__tocare__aboutequality__than identity,but__forobjects__(notprimitive__types)the__Java ==compares__references,and__notobject__values.Even__forsomething__asbasic__ascomparing__strings,Java__forcesyou__touse__the .equals method.Even__then,there__isanother__catch:if__youwrite__a.equals(b)and__ais__null,you__geta__nullpointer__exception.The__Javadesigners__feltthe__needto__overload +for__strings,so__whynot__goahead__andoverload__==as__well?Python__getsthis__right.The__==operator__comparesobject__valuesand__iscompares__references.And__becausePython__hasoperator__overloading, ==works__sensiblywith__allobjects__inthe__standard library,including__None,which__isa__proper object,unlike__Javas__null.And__of course,you__candefine____eq__in__yourown__classesto__decidewhat__==means__foryour__instances.If__youdon__toverride____eq__,the__methodinherited__fromobject__comparesobject__IDs,so__thefallback__isthat__everyinstance__ofa__user-definedclass__isconsidered__different.These__aresome__ofthe__thingsthat__mademe__switchfrom__Javato__Pythonas__soonas__Ifinished__readingthe__PythonTutorial__oneafternoon__inSeptember__1998.Mutability__Thischapter__wouldbe__redundantif__allPython__objectswere__immutable.When__youare__dealingwith__unchanging objects,it__makesno__differencewhether__variableshold__theactual__objectsor__referencesto__shared objects.If__a ==b__is true,and__neitherobject__can change,they__mightas__wellbe__the same.That__swhy__stringinterning__is safe.Object__identitybecomes__importantonly__whenobjects__are mutable.In__purefunctional__programming,all__datais__immutable:appending__toa__collectionactually__createsa__new collection. Python, however,is__nota__functional language,much__lessa__pure one.Instances__of user-definedclasses__aremutable__bydefault__inPython__asin__most object-oriented languages.When__creatingyour__own objects,you__haveto__beextra__carefulto__makethem__immutable,if__thatis__a requirement.Every__attributeof__theobject__mustalso__be immutable,otherwise__youend__upwith__somethinglike__the tuple:immutable__asfar__asobject__IDs go,but__thevalue__ofa__tuplemay__changeif__itholds__amutable__object.Mutable__objectsare__alsothe__mainreason__whyprogramming__withthreads__isso__hardto__get right:threads__mutatingobjects__withoutproper__synchronizationproduce__corrupted data.Excessive__synchronization,on__theother__hand,causes__deadlocks.Object__Destructionand__GarbageCollection__Thereis__nomechanism__inPython__todirectly__destroyan__object,and__thisomission__isactually__agreat__feature:if__youcould__destroyan__objectat__any time,what__wouldhappen__toexisting__strongreferences__pointingto__it?Garbage__collectionin__CPythonis__doneprimarily__byreference__counting,which__iseasy__to implement,but__isprone__tomemory__leakingwhen__thereare__reference cycles,so__withversion__2.0 (October 2000)a__generationalgarbage__collectorwas__implemented,and__itis__ableto__disposeof__unreachableobjects__keptalive__byreference__cycles.But__thereference__countingis__stillthere__asa__baseline,and__itcauses__theimmediate__disposalof__objectswith__zero references.This__means that,in__CPythonat__leastfor__nowit__ssafe__towrite__this: open('test.txt', 'wt', encoding='utf-8').write('1, 2, 3')That__codeis__safebecause__thereference__countof__thefile__objectwill__bezero__afterthe__writemethod__returns,and__Pythonwill__immediatelyclose__thefile__beforedestroying__theobject__representingit__in memory. However,the__sameline__isnot__safein__Jythonor__IronPythonthat__usethe__garbagecollector__oftheir__hostruntimes__(theJava__VMand__the .NET CLR),which__aremore__sophisticatedbut__donot__relyon__referencecounting__andmay__takelonger__todestroy__theobject__andclose__the file.In__all cases,including__CPython,the__bestpractice__isto__explicitlyclose__the file,and__themost__reliableway__ofdoing__itis__usingthe__with statement,which__guaranteesthat__thefile__willbe__closedeven__ifexceptions__areraised__whileit__is open.Using__with,the__previoussnippet__becomes:with__open('test.txt', 'wt', encoding='utf-8')as__fp: fp.write('1, 2, 3')If__youare__intothe__subjectof__garbage collectors,you__maywant__toread__ThomasPerl__spaper__PythonGarbage__Collector Implementations: CPython,PyPy__andGaS__,from__whichI__learnedthe__bitabout__thesafety__ofthe__open().write()in__CPython.Parameter__Passing:Call__bySharing__Apopular__wayof__explaininghow__parameterpassing__worksin__Pythonis__the phrase:Parameters__arepassed__by value,but__thevalues__are references.This__not wrong,but__causesconfusion__becausethe__mostcommon__parameterpassing__modesin__olderlanguages__arecall__byvalue__(thefunction__getsa__copyof__the argument)and__callby__reference (thefunction__getsa__pointerto__the argument).In__Python,the__functiongets__acopy__ofthe__arguments,but__thearguments__arealways__references.So__thevalue__ofthe__referencedobjects__maybe__changed,if__theyare__mutable,but__theiridentity__cannot. Also,because__thefunction__getsa__copyof__thereference__inan__argument,rebinding__ithas__noeffect__outsideof__the function.I__adoptedthe__termcall__bysharing__afterreading__upon__thesubject__inProgramming__Language Pragmatics,Third__Editionby__Michael L.Scott__(Morgan Kaufmann),particularly__8.3.1:Parameter__Modes.The__FullQuote__ofAlice__andthe__Knightss__SongI__lovethis__passage,but__itwas__toolong__asa__chapter opener.So__hereis__thecomplete__dialogabout__theKnight__s song,its__name,and__howthe__songand__itsname__are called:You__are sad,the__Knightsaid__inan__anxious tone:let__mesing__youa__songto__comfort you.Is__itvery__long?Alice__asked,for__shehad__hearda__gooddeal__ofpoetry__that day.It__s long,said__the Knight,but__very,VERY__beautiful.Everybody__thathears__mesing__iteither__itbrings__theTEARS__intotheir__eyes,or__elseOr__else what?said__Alice,for__theKnight__hadmade__asudden__pause.Or__elseit__doesn t,you__know.The__nameof__thesong__iscalled__HADDOCKSEYES__. Oh,that__sthe__nameof__the song,is__it?Alice__said,trying__tofeel__interested. No,you__dont__understand,the__Knight said,looking__alittle__vexed.That__swhat__thename__is CALLED.The__namereally__ISTHE__AGEDAGED__MAN .Then__Iought__tohave__saidThat__swhat__theSONG__iscalled__?Alice__corrected herself. No,you__oughtn t:that__squite__another thing!The__SONGis__calledWAYS__ANDMEANS__:but__thats__onlywhat__its__CALLED,you__know! Well,what__ISthe__song, then?said__Alice,who__wasby__thistime__completely bewildered.I__wascoming__to that,the__Knight said.The__songreally__IS A-SITTINGON__AGATE__:and__thetune__smy__own invention.Lewis__Carroll,Through__the Looking-Glass,Chapter__VIII,It__sMy__OwnInvention__1On__theother__hand,flat__sequenceslike__str, bytes,and__array.arraydon__tcontain__referencesbut__physicallyhold__theirdata__characters, bytes,and__numbersin__contiguous memory. 2If__twoobjects__referto__each other,as__inExample__6-10,they__maybe__destroyedif__thegarbage__collectordetermines__thatthey__areotherwise__unreachablebecause__theironly__referencesare__theirmutual__references. 3 cheeseshop.python.orgis__alsoan__aliasfor__PyPIthe__PythonPackage__Indexsoftware__repositorywhich__startedits__lifequite__empty.At__thetime__ofthis__writing,the__PythonCheese__Shophas__41,426 packages.Not__bad,but__stillfar__fromthe__morethan__131,000modules__availablein__CPANthe__ComprehensivePerl__ArchiveNetwork__theenvy__ofall__dynamiclanguage__communities. 4Parmesan__cheeseis__agedat__leasta__yearat__the factory,so__itis__moredurable__thanfresh__cheese,but__thisis__notthe__answerwe__arelooking__for. 5This__isclearly__documented.Type__help(tuple)in__thePython__consoleto__read:If__theargument__isa__tuple,the__returnvalue__isthe__same object.I__thoughtI__kneweverything__abouttuples__beforewriting__this book. 6The__harmlesslie__ofhaving__thecopy__methodnot__copyinganything__canis__justifiedby__interface compatibility:it__makesfrozenset__morecompatible__with set. Anyway,it__makesno__differenceto__theend__userwhether__twoidentical__immutableobjects__arethe__sameor__are copies. 7Actually__thetype__ofan__objectmay__bechanged__bymerely__assigninga__differentclass__toits____class__ attribute,but__thatis__pureevil__andI__regretwriting__this footnote.